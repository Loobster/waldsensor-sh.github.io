<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MINT-FW Schulwaldkarte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .layer-control {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 1000;
    }
  </style>
  <script src="data/gateways_SH_NETZ.js"></script>
  <script src="data/mint_schulen.js"></script>
  <script src="data/schulwaelder.js"></script>
  <script src="data/feuerwehren.js"></script>
</head>
<body>
<div id="map"></div>
<div class="layer-control">
  <label><input type="checkbox" id="toggleMint" checked> MINT-Schulen</label><br>
  <label><input type="checkbox" id="toggleGateways" checked> Gateways</label><br>
  <label><input type="checkbox" id="toggleWald"> Schulwälder</label><br>
  <label><input type="checkbox" id="toggleFW"> Feuerwehren</label>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
  const map = L.map('map').setView([54.3, 10.1], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  const checkboxes = {
    mint: 'toggleMint',
    gateways: 'toggleGateways',
    schulwald: 'toggleWald',
    feuerwehr: 'toggleFW'
  };

  const farben = {
    mint: 'orange',
    gateways: 'blue',
    schulwald: 'green',
    feuerwehr: 'red'
  };

  const layers = {};
  const linien = {
    mint: [],
    feuerwehr: []
  };

  function entfernung(p1, p2) {
    const R = 6371e3;
    const rad = deg => deg * Math.PI / 180;
    const φ1 = rad(p1.lat), φ2 = rad(p2.lat);
    const Δφ = rad(p2.lat - p1.lat), Δλ = rad(p2.lng - p1.lng);
    const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function findeNaechstesGateway(lat, lng) {
    if (!gateways?.features?.length) return null;
    let minDist = Infinity;
    let nearest = null;
    for (const gw of gateways.features) {
      const [lon, latGw] = gw.geometry.coordinates;
      const dist = entfernung({lat, lng}, {lat: latGw, lng: lon});
      if (dist < minDist) {
        minDist = dist;
        nearest = { dist, gw };
      }
    }
    return nearest;
  }

  function createClusterLayer(data, typ) {
    const cluster = L.markerClusterGroup();
    const geo = L.geoJSON(data, {
      pointToLayer: (feature, latlng) => {
        const marker = L.circleMarker(latlng, {
          radius: 6,
          color: farben[typ],
          fillColor: farben[typ],
          fillOpacity: 0.7
        });

        marker.bindPopup(() => {
          const name = feature.properties.name || "unbekannt";
          const [lon, lat] = feature.geometry.coordinates;

          if (typ === "gateways") {
            const alt = feature.properties.alt ?? "–";
            const updated = feature.properties.updated ?? "–";
            return `<b>📡 Gateway:</b> ${name}<br><b>🌍 Koordinaten:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}<br><b>🗻 Höhe:</b> ${alt} m<br><b>🕒 Letztes Update:</b> ${updated}`;
          }

          if (typ === "mint" || typ === "feuerwehr") {
            const result = findeNaechstesGateway(lat, lon);
            if (result) {
              const distKm = (result.dist / 1000).toFixed(2);
              return `<b>🏫 ${typ === "mint" ? "MINT-Schule" : "Feuerwehr"}:</b> ${name}<br><b>🌍 Koordinaten:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}<br><b>➡️ Nächstes Gateway:</b> ${result.gw.properties.name} (${distKm} km)`;
            }
            return `<b>${typ}:</b> ${name}<br><i>Kein Gateway gefunden</i>`;
          }

          if (typ === "schulwald") {
            return `<b>🌳 Schulwald:</b> ${name}`;
          }

          return `<b>${typ}:</b> ${name}`;
        });

        if (typ === "mint" || typ === "feuerwehr") {
          const result = findeNaechstesGateway(latlng.lat, latlng.lng);
          if (result) {
            const [lon2, lat2] = result.gw.geometry.coordinates;
            const line = L.polyline([[latlng.lat, latlng.lng], [lat2, lon2]], {
              color: farben[typ],
              weight: 1.5,
              opacity: 0.7
            });
            linien[typ].push(line);
            line.addTo(map);
          }
        }

        return marker;
      }
    });
    cluster.addLayer(geo);
    return cluster;
  }

  if (typeof gateways !== 'undefined') {
    layers.gateways = createClusterLayer(gateways, 'gateways');
    if (document.getElementById(checkboxes.gateways).checked) map.addLayer(layers.gateways);
  } else {
    document.getElementById(checkboxes.gateways).disabled = true;
  }

  if (typeof mint_schulen !== 'undefined') {
    layers.mint = createClusterLayer(mint_schulen, 'mint');
    if (document.getElementById(checkboxes.mint).checked) map.addLayer(layers.mint);
  } else {
    document.getElementById(checkboxes.mint).disabled = true;
  }

  if (typeof feuerwehren !== 'undefined') {
    layers.feuerwehr = createClusterLayer(feuerwehren, 'feuerwehr');
    if (document.getElementById(checkboxes.feuerwehr).checked) map.addLayer(layers.feuerwehr);
  } else {
    document.getElementById(checkboxes.feuerwehr).disabled = true;
  }

  if (typeof schulwaelder !== 'undefined') {
    layers.schulwald = createClusterLayer(schulwaelder, 'schulwald');
    if (document.getElementById(checkboxes.schulwald).checked) map.addLayer(layers.schulwald);
  } else {
    document.getElementById(checkboxes.schulwald).disabled = true;
  }

  for (const [key, checkboxId] of Object.entries(checkboxes)) {
    const cb = document.getElementById(checkboxId);
    if (!cb) continue;

    if (key === 'gateways') {
      cb.addEventListener('change', (e) => {
        if (!layers[key]) return;
        if (e.target.checked) {
          map.addLayer(layers[key]);
          ['mint', 'feuerwehr'].forEach(k => {
            if (linien[k]) linien[k].forEach(l => l.addTo(map));
          });
        } else {
          map.removeLayer(layers[key]);
          ['mint', 'feuerwehr'].forEach(k => {
            if (linien[k]) linien[k].forEach(l => map.removeLayer(l));
          });
        }
      });
    } else {
      cb.addEventListener('change', (e) => {
        if (!layers[key]) return;
        if (e.target.checked) {
          map.addLayer(layers[key]);
          if (linien[key]) linien[key].forEach(l => l.addTo(map));
        } else {
          map.removeLayer(layers[key]);
          if (linien[key]) linien[key].forEach(l => map.removeLayer(l));
        }
      });
    }
  }
</script>
</body>
</html>