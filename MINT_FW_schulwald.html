<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>MINT-FW Schulwaldkarte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .layer-control {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      font-family: sans-serif;
      z-index: 1000;
    }
  </style>
  <script src="data/gateways_SH_NETZ.js"></script>
  <script src="data/mint_schulen.js"></script>
  <script src="data/schulwaelder.js"></script>
  <script src="data/feuerwehren.js"></script>
</head>
<body>
<div id="map"></div>
<div class="layer-control">
  <label><input type="checkbox" id="toggleMint" checked> MINT-Schulen</label><br>
  <label><input type="checkbox" id="toggleGateways" checked> Gateways</label><br>
  <label><input type="checkbox" id="toggleWald"> SchulwÃ¤lder</label><br>
  <label><input type="checkbox" id="toggleFW"> Feuerwehren</label>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script>
  const map = L.map('map').setView([54.3, 10.1], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  const layers = {};
  const checkboxes = {
    mint: 'toggleMint',
    gateways: 'toggleGateways',
    schulwald: 'toggleWald',
    feuerwehr: 'toggleFW'
  };

  function createClusterLayer(data, farbe, typ = 'generic') {
    const cluster = L.markerClusterGroup();
    const geo = L.geoJSON(data, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 6,
        color: farbe,
        fillColor: farbe,
        fillOpacity: 0.7
      }).bindPopup(() => {
        const name = feature.properties.name || "unbekannt";
        const [lon, lat] = feature.geometry.coordinates;

        if (typ === 'gateway') {
          const alt = feature.properties.alt !== null ? `${feature.properties.alt}â€¯m` : "â€“";
          const updated = feature.properties.updated || "â€“";
          return `
            <b>ğŸ›° Gateway:</b> ${name}<br>
            <b>ğŸŒ Koordinaten:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>
            <b>ğŸ—» HÃ¶he:</b> ${alt}<br>
            <b>ğŸ•’ Letztes Update:</b> ${updated}
          `;
        }

        if (typ === 'mint') {
          return `
            <b>ğŸ« MINT-Schule:</b> ${name}<br>
            <b>ğŸ“ Lage:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}
          `;
        }

        if (typ === 'feuerwehr') {
          return `
            <b>ğŸš’ Feuerwehr:</b> ${name}<br>
            <b>ğŸ“ Lage:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}
          `;
        }

        if (typ === 'schulwald') {
          return `
            <b>ğŸŒ³ Schulwald:</b> ${name}<br>
            <b>ğŸ“ Lage:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}
          `;
        }

        return `<b>${name}</b>`;
      })
    });
    cluster.addLayer(geo);
    return cluster;
  }

  if (typeof mint_schulen !== 'undefined') {
    layers.mint = createClusterLayer(mint_schulen, 'orange', 'mint');
    map.addLayer(layers.mint);
  } else {
    document.getElementById(checkboxes.mint).disabled = true;
  }

  if (typeof gateways !== 'undefined') {
    layers.gateways = createClusterLayer(gateways, 'blue', 'gateway');
    map.addLayer(layers.gateways);
  } else {
    document.getElementById(checkboxes.gateways).disabled = true;
  }

  if (typeof schulwaelder !== 'undefined') {
    layers.schulwald = createClusterLayer(schulwaelder, 'green', 'schulwald');
  } else {
    document.getElementById(checkboxes.schulwald).disabled = true;
  }

  if (typeof feuerwehren !== 'undefined') {
    layers.feuerwehr = createClusterLayer(feuerwehren, 'red', 'feuerwehr');
  } else {
    document.getElementById(checkboxes.feuerwehr).disabled = true;
  }

  for (const [key, checkboxId] of Object.entries(checkboxes)) {
    const cb = document.getElementById(checkboxId);
    if (!cb) continue;
    cb.addEventListener('change', (e) => {
      if (!layers[key]) return;
      if (e.target.checked) {
        map.addLayer(layers[key]);
      } else {
        map.removeLayer(layers[key]);
      }
    });
  }
</script>
</body>
</html>