<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ³ Sensor Kropp â€“ Temperatur, Luftfeuchtigkeit & Batterie</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      margin: 2em;
    }
    h1 { margin-top: 0; }
    .chart-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 1em;
      margin-bottom: 2em;
      height: 320px;
      overflow: hidden;
    }
    canvas {
      max-width: 100%;
      height: 100%;
    }
    .linkbox {
      font-size: 0.9em;
      margin-top: 1em;
      margin-bottom: 3em;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ³ Sensor Kropp â€“ Temperatur, Luftfeuchtigkeit & Batterie</h1>
  <p>Datenquelle: Automatisch erzeugte CSV-Datei des aktuellen Monats.<br>
  Download: <a id="csv-link" href="#" target="_blank">CSV anzeigen</a></p>
  <div class="chart-container">
    <h3>ğŸŒ¡ï¸ Temperatur (Â°C)</h3>
    <canvas id="tempChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>ğŸ’§ Luftfeuchtigkeit (%)</h3>
    <canvas id="humChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>ğŸ”‹ Batteriespannung (V)</h3>
    <canvas id="batChart"></canvas>
  </div>
  <div class="linkbox">ğŸ“‘ Ã„ltere CSV-Dateien: <a href="csv/index.html" target="_blank">CSV-Archiv anzeigen</a></div>
  <script>
    async function fetchData() {
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const filename = `csv/${year}-${month}.csv`;

        try {
            const response = await fetch(filename);
            if (!response.ok) {
                throw new Error(`Fehler beim Laden der Datei: ${filename}`);
            }
            const data = await response.text();
            const lines = data.trim().split('\n').slice(1);
            const labels = [], temp = [], hum = [], bat = [];

            lines.forEach(line => {
                const parts = line.split(',');
                if (!line || parts.length < 5) return;
                const timestamp = parts[1].slice(0, 16).replace('T', ' ');
                labels.push(timestamp);
                temp.push(parseFloat(parts[2]));
                hum.push(parseFloat(parts[3]));
                bat.push(parseFloat(parts[4]));
            });

            createChart('tempChart', labels, temp, 'Temperatur (Â°C)', 'red');
            createChart('humChart', labels, hum, 'Luftfeuchtigkeit (%)', 'blue');
            createChart('batChart', labels, bat, 'Batteriespannung (V)', 'green');
        } catch (error) {
            console.error(error);
            alert(`Es konnten keine Daten fÃ¼r den aktuellen Monat (${filename}) geladen werden. Bitte Ã¼berprÃ¼fen Sie, ob die Datei existiert.`);
        }
    }

    function createChart(id, labels, data, label, color) {
        new Chart(document.getElementById(id), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    pointRadius: 1,
                    pointHoverRadius: 6,
                    fill: false,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 12, // Mehr Ticks anzeigen
                            maxRotation: 45, // Beschriftung um 45 Grad drehen
                            minRotation: 45,
                            font: {
                                size: 10 // SchriftgrÃ¶ÃŸe der Ticks reduzieren
                            }
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            boxWidth: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    fetchData();
</script>
</body>
</html>
