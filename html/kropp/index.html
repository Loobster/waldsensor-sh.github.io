<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>🌳 Sensor Kropp – Temperatur, Luftfeuchtigkeit & Batterie</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      margin: 2em;
    }
    h1 { margin-top: 0; }
    .chart-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 1em;
      margin-bottom: 2em;
      height: 320px;
      overflow: hidden;
    }
    canvas {
      max-width: 100%;
      height: 100%;
    }
    .linkbox {
      font-size: 0.9em;
      margin-top: 1em;
      margin-bottom: 3em;
    }
    .controls {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <h1>🌳 Sensor Kropp – Temperatur, Luftfeuchtigkeit & Batterie</h1>
  
  <div class="controls">
    <label for="time-range">Zeitraum anzeigen:</label>
    <select id="time-range">
      <option value="30">Letzte 30 Tage</option>
      <option value="60">Letzte 60 Tage</option>
      <option value="90">Letzte 90 Tage</option>
    </select>
  </div>
  
  <p>Datenquelle: Automatisch erzeugte CSV-Datei der letzten <span id="days-span">30</span> Tage.<br>
  Download: <a id="csv-link" href="#" target="_blank">CSV anzeigen</a></p>
  
  <div class="chart-container">
    <h3>🌡️ Temperatur (°C)</h3>
    <canvas id="tempChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>💧 Luftfeuchtigkeit (%)</h3>
    <canvas id="humChart"></canvas>
  </div>
  <div class="chart-container">
    <h3>🔋 Batteriespannung (V)</h3>
    <canvas id="batChart"></canvas>
  </div>
  <div class="linkbox">📑 Ältere CSV-Dateien: <a href="csv/index.html" target="_blank">CSV-Archiv anzeigen</a></div>
  
  <script>
    async function fetchData(daysToShow = 30) {
        // UI-Texte anpassen
        document.getElementById('days-span').textContent = daysToShow;
        document.getElementById('csv-link').href = `csv/${new Date().getFullYear()}-${(new Date().getMonth() + 1).toString().padStart(2, '0')}.csv`;

        // 1. Startdatum basierend auf der Auswahl ermitteln
        const now = new Date();
        const startDate = new Date(now.getTime() - (daysToShow * 24 * 60 * 60 * 1000));
        
        // 2. Erforderliche Dateipfade ermitteln
        const filesToFetch = [];
        let currentDate = new Date(now);
        while (currentDate >= startDate) {
            const year = currentDate.getFullYear();
            const month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            const filename = `csv/${year}-${month}.csv`;
            if (!filesToFetch.includes(filename)) {
                filesToFetch.push(filename);
            }
            // Gehe zum vorherigen Monat
            currentDate.setMonth(currentDate.getMonth() - 1);
        }
        filesToFetch.reverse(); // Älteste Datei zuerst laden
        
        try {
            // 3. Alle benötigten Dateien parallel laden
            const responses = await Promise.all(filesToFetch.map(url => fetch(url).catch(e => ({ok: false}))));
            
            let combinedData = "";
            let hasHeader = false;

            for (const response of responses) {
                if (response.ok) {
                    let dataText = await response.text();
                    const lines = dataText.split('\n');
                    if (!hasHeader) {
                        combinedData += lines[0] + '\n'; // Header hinzufügen
                        hasHeader = true;
                    }
                    combinedData += lines.slice(1).join('\n') + '\n';
                }
            }

            const lines = combinedData.trim().split('\n').slice(1);
            const labels = [], temp = [], hum = [], bat = [];
            
            // 4. Daten im gewünschten Zeitraum filtern
            lines.forEach(line => {
                const parts = line.split(',');
                if (!line || parts.length < 5) return;
                const timestamp = new Date(parts[1]);

                if (timestamp >= startDate) {
                  labels.push(parts[1].slice(0, 16).replace('T', ' '));
                  temp.push(parseFloat(parts[2]));
                  hum.push(parseFloat(parts[3]));
                  bat.push(parseFloat(parts[4]));
                }
            });

            createChart('tempChart', labels, temp, 'Temperatur (°C)', 'red');
            createChart('humChart', labels, hum, 'Luftfeuchtigkeit (%)', 'blue');
            createChart('batChart', labels, bat, 'Batteriespannung (V)', 'green');
        } catch (error) {
            console.error(error);
            alert(`Es konnten nicht alle Daten für den ausgewählten Zeitraum geladen werden.`);
        }
    }
    
    function createChart(id, labels, data, label, color) {
        new Chart(document.getElementById(id), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    pointRadius: 1,
                    pointHoverRadius: 6,
                    fill: false,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 12,
                            maxRotation: 45,
                            minRotation: 45,
                            font: {
                                size: 10
                            }
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            boxWidth: 15,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    // Event-Listener für das Dropdown-Menü hinzufügen
    document.addEventListener('DOMContentLoaded', () => {
        const timeRangeSelect = document.getElementById('time-range');
        timeRangeSelect.addEventListener('change', (event) => {
            const selectedDays = parseInt(event.target.value);
            fetchData(selectedDays);
        });

        // Initiales Laden der Daten (standardmäßig 30 Tage)
        fetchData();
    });
  </script>
</body>
</html>
