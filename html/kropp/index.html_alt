<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ³ Sensor Kropp â€“ Temperatur, Luftfeuchtigkeit, Wind & Batterie</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9f9f9;
      margin: 2em;
    }
    h1 { margin-top: 0; }
    .chart-container {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      padding: 1em;
      margin-bottom: 2em;
      height: 320px;
      overflow: hidden;
    }
    canvas {
      max-width: 100%;
      height: 100%;
    }
    .linkbox {
      font-size: 0.9em;
      margin-top: 1em;
      margin-bottom: 3em;
    }
    .controls {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>

<h1>ğŸŒ³ Sensor Kropp â€“ Temperatur, Luftfeuchtigkeit, Wind & Batterie</h1>

<div class="controls">
  <label for="time-range">Zeitraum anzeigen:</label>
  <select id="time-range">
    <option value="30">Letzte 30 Tage</option>
    <option value="60">Letzte 60 Tage</option>
    <option value="90">Letzte 90 Tage</option>
  </select>
</div>

<p>
  Datenquelle: Automatisch erzeugte CSV-Dateien der letzten
  <span id="days-span">30</span> Tage.<br>
  Download:
  <a id="csv-link" href="#" target="_blank">CSV anzeigen</a>
</p>

<div class="chart-container">
  <h3>ğŸŒ¡ï¸ Temperatur (Â°C)</h3>
  <canvas id="tempChart"></canvas>
</div>

<div class="chart-container">
  <h3>ğŸ’§ Luftfeuchtigkeit (%)</h3>
  <canvas id="humChart"></canvas>
</div>

<div class="chart-container">
  <h3>ğŸ’¨ Wind (ADC1_V)</h3>
  <canvas id="windChart"></canvas>
</div>

<div class="chart-container">
  <h3>ğŸ”‹ Batteriespannung (V)</h3>
  <canvas id="batChart"></canvas>
</div>

<div class="linkbox">
  ğŸ“‘ Ã„ltere CSV-Dateien:
  <a href="csv/index.html" target="_blank">CSV-Archiv anzeigen</a>
</div>

<script>
async function fetchData(daysToShow = 30) {
  document.getElementById('days-span').textContent = daysToShow;

  const now = new Date();
  const startDate = new Date(now.getTime() - (daysToShow * 24 * 60 * 60 * 1000));

  document.getElementById('csv-link').href =
    `csv/${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}.csv`;

  const filesToFetch = [];
  let currentDate = new Date(now);

  while (currentDate >= startDate) {
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const filename = `csv/${year}-${month}.csv`;
    if (!filesToFetch.includes(filename)) {
      filesToFetch.push(filename);
    }
    currentDate.setMonth(currentDate.getMonth() - 1);
  }

  filesToFetch.reverse();

  try {
    const responses = await Promise.all(
      filesToFetch.map(url => fetch(url).catch(() => ({ ok: false })))
    );

    let combinedData = "";
    let hasHeader = false;

    for (const response of responses) {
      if (response.ok) {
        const text = await response.text();
        const lines = text.split('\n');
        if (!hasHeader) {
          combinedData += lines[0] + '\n';
          hasHeader = true;
        }
        combinedData += lines.slice(1).join('\n') + '\n';
      }
    }

    const lines = combinedData.trim().split('\n').slice(1);

    const labels = [];
    const wind = [];
    const temp = [];
    const hum = [];
    const bat = [];

    lines.forEach(line => {
      if (!line) return;
      const parts = line.split(',');
      if (parts.length < 6) return;

      const timestamp = new Date(parts[1]);

if (timestamp >= startDate) {
  labels.push(parts[1].slice(0, 16).replace('T', ' '));
  temp.push(parseFloat(parts[2]));
  hum.push(parseFloat(parts[3]));
  wind.push(parseFloat(parts[4]));
  bat.push(parseFloat(parts[5]));
}}
    });

    createChart('tempChart', labels, temp, 'Temperatur (Â°C)', 'red');
    createChart('humChart', labels, hum, 'Luftfeuchtigkeit (%)', 'blue');
    createChart('windChart', labels, wind, 'Wind (ADC1_V)', 'orange');
    createChart('batChart', labels, bat, 'Batteriespannung (V)', 'green');

  } catch (e) {
    console.error(e);
    alert('Fehler beim Laden der CSV-Daten.');
  }
}

function createChart(id, labels, data, label, color) {
  new Chart(document.getElementById(id), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: color,
        pointRadius: 1,
        pointHoverRadius: 6,
        fill: false,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'nearest',
        intersect: false
      },
      scales: {
        x: {
          ticks: {
            autoSkip: true,
            maxTicksLimit: 12,
            maxRotation: 45,
            minRotation: 45,
            font: { size: 10 }
          }
        },
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('time-range').addEventListener('change', e => {
    fetchData(parseInt(e.target.value));
  });
  fetchData();
});
</script>

</body>
</html>
