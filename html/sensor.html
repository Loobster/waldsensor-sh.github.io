<script>
// ===== Kleine Helfer (falls schon vorhanden, nicht doppeln) =====
const $ = id => document.getElementById(id);
const setTxt = (id, v) => { const el = $(id); if (el) el.textContent = v; };
const fmtNum = (v, d=1, suf="") =>
  (v==null || !isFinite(+v)) ? "—" : (Number(v).toFixed(d).replace(".", ",") + suf);
const fmtDate = ts => {
  if (!ts) return "—";
  const d = new Date(ts);
  return isNaN(d) ? "—" : d.toLocaleString("de-DE");
};
const qp = new URLSearchParams(location.search);
const nodeParamRaw = qp.get("node") || "";
const nodeParam = nodeParamRaw.toLowerCase();

// ===== Robustes Laden der „latest“-Daten (enriched dann normal) =====
async function loadLatest() {
  const urls = [
    "/data/v2/latest/all_enriched.json",
    "/data/v2/latest/all.json"
  ];
  for (const u of urls) {
    try {
      const r = await fetch(u + "?_=" + Date.now(), { cache: "no-store" });
      if (!r.ok) continue;
      const data = await r.json();
      if (Array.isArray(data) && data.length) return data;
    } catch (_) { /* noop */ }
  }
  return [];
}

// Werte aus beiden Schemata ziehen (enriched/normal)
const pick = (o, ...keys) => {
  for (const k of keys) if (o && o[k] != null) return o[k];
  return null;
};
function extractValues(n) {
  const f = n.fields || n;
  return {
    // Blatt
    leafTemp:  pick(f, "Leaf_Temperature", "leaf_temp_c"),
    leafMoist: pick(f, "Leaf_Moisture",    "leaf_moist_pct"),
    // Luft
    airTemp:   pick(f, "TempC_SHT", "TempC_SHT31", "temp_c"),
    airHum:    pick(f, "Hum_SHT",   "Hum_SHT31",   "hum_pct"),
    // Boden
    soilTemp:  pick(f, "temp_SOIL",  "temp_soil_c"),
    soilWater: pick(f, "water_SOIL", "water_soil"),
    // Batterie + Zeit
    bat: pick(f, "BatV", "bat_v"),
    ts:  pick(n, "ts", "ts_iso", "time")
  };
}
const getId = o => (o?.id || o?.device_id || "").toLowerCase();

// ===== Linke Seite rendern (nur dieser Block ist neu/ersetzt) =====
(async function renderLeft() {
  try {
    const data = await loadLatest();
    if (!data.length) return;

    // Schacht-Audorf (Multi-Sensor) vs. Einzel-Node
    const isAudorf = /schacht[_-]?audorf/.test(nodeParam);

    // HTML-Sektionen (sind in v0.12 vorhanden)
    const secLeaf = $("secLeaf");
    const secAir  = $("secAir");
    const secSoil = $("secSoil");
    const secWx   = $("secWx");

    // Alles erstmal ausblenden
    if (secLeaf) secLeaf.style.display = "none";
    if (secAir)  secAir.style.display  = "none";
    if (secSoil) secSoil.style.display = "none";
    if (secWx)   secWx.style.display   = "none";

    // Hilfsfinder
    const byExact = (id) => data.find(o => getId(o) === id.toLowerCase());

    let leafNode, airNode, soilNode;

    if (isAudorf) {
      // Fixe Zuordnung wie in v0.12
      leafNode = byExact("schacht_audorf_llms01");
      airNode  = byExact("schacht_audorf_s31lb");
      soilNode = byExact("schacht_audorf_se01lb");
    } else {
      // Einzel-Standorte: nimm den angefragten Eintrag, klassifiziere simpel
      const single = data.find(o => getId(o) === nodeParam) ||
                     data.find(o => getId(o).includes(nodeParam));
      if (single) {
        const id = getId(single);
        if (/llms01/i.test(id))      leafNode = single;
        else if (/se01lb/i.test(id)) soilNode = single;
        else                         airNode  = single; // Standard: Luft
      }
    }

    // Werte ziehen & anzeigen
    const valsLeaf = leafNode ? extractValues(leafNode) : {};
    const valsAir  = airNode  ? extractValues(airNode)  : {};
    const valsSoil = soilNode ? extractValues(soilNode) : {};

    // „Stand:“ = jüngster Timestamp der vorhandenen Sensoren
    const tsCandidates = [valsLeaf.ts, valsAir.ts, valsSoil.ts].filter(Boolean);
    if (tsCandidates.length) setTxt("stand", "Stand: " + fmtDate(
      tsCandidates.sort((a,b)=> new Date(b) - new Date(a))[0]
    ));

    // Blatt
    if (leafNode && secLeaf) {
      secLeaf.style.display = "";
      setTxt("leafTemp",  fmtNum(valsLeaf.leafTemp, 1, " °C"));
      setTxt("leafMoist", fmtNum(valsLeaf.leafMoist,1, " %"));
      setTxt("leafBat",   fmtNum(valsLeaf.bat,      2, " V"));
    }
    // Luft
    if (airNode && secAir) {
      secAir.style.display = "";
      setTxt("airTemp", fmtNum(valsAir.airTemp, 1, " °C"));
      setTxt("airHum",  fmtNum(valsAir.airHum,  1, " %"));
      setTxt("airBat",  fmtNum(valsAir.bat,     2, " V"));
    }
    // Boden
    if (soilNode && secSoil) {
      secSoil.style.display = "";
      setTxt("soilTemp",  fmtNum(valsSoil.soilTemp,  1, " °C"));
      setTxt("soilWater", fmtNum(valsSoil.soilWater, 1, " %"));
      setTxt("soilBat",   fmtNum(valsSoil.bat,       2, " V"));
    }
    // Wetter-Box nur bei Audorf (wie vorher)
    if (isAudorf && secWx) secWx.style.display = "";

  } catch (e) {
    console.warn("Linke Seite (Multi-Sensor) – Fehler:", e);
  }
})();
</script>
