<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Waldsensor.SH – Sensor</title>
<style>
  body{font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;margin:0;padding:16px;color:#111}
  .wrap{max-width:900px;margin:0 auto}
  .badge{display:inline-block;background:#d4edda;color:#155724;border:1px solid #c3e6cb;border-radius:8px;padding:6px 10px;font-weight:600}
  .muted{color:#555}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .card{border:1px solid #eee;border-radius:12px;padding:12px}
  h1{margin:0 0 8px}
  canvas{width:100%;height:280px}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Sensor</h1>
  <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
    <span id="status" class="badge">Stand: —</span>
    <span id="search" class="muted">Sucht: —</span>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Temperatur / Feuchte (24h)</h3>
      <canvas id="chart" aria-label="Verlauf" role="img"></canvas>
      <div id="note" class="muted" style="margin-top:8px;"></div>
    </div>
    <div class="card">
      <h3>Aktuelle Werte</h3>
      <div id="current">—</div>
    </div>
  </div>
</div>

<script>
(async function(){
  // --- Helpers ---
  const qp = new URLSearchParams(location.search);
  const nodeParam = (qp.get('node') || '').trim();
  const statusEl = document.getElementById('status');
  const searchEl = document.getElementById('search');
  const titleEl  = document.getElementById('title');
  const currentEl= document.getElementById('current');
  const noteEl   = document.getElementById('note');

  function fmtNum(v,unit=''){
    if (v==null || Number.isNaN(Number(v))) return '—';
    return (typeof v==='number'? v.toLocaleString('de-DE'): String(v)) + (unit?(' '+unit):'');
  }

  // 1) vollen Device-Namen ermitteln (Prefix → Vollname) über _all.json
  const ALL_URL = '/data/v2/latest/_all.json';
  let fullId = nodeParam;
  try{
    if (!fullId.includes('-')) {
      const res = await fetch(ALL_URL+'?t='+Date.now(), {cache:'no-store'});
      if (res.ok) {
        const arr = await res.json();
        if (Array.isArray(arr)) {
          // suche erstes id, das mit nodeParam beginnt (case-sensitiv)
          const hit = arr.find(r => typeof r.id === 'string' && r.id.startsWith(nodeParam));
          if (hit) fullId = hit.id;
        }
      }
    }
  }catch(e){ /* egal – wir probieren mit nodeParam weiter */ }

  if (!fullId){
    titleEl.textContent = 'Sensor (unbekannt)';
    searchEl.textContent = 'Sucht: (kein Parameter)';
    noteEl.textContent = 'Kein Node-Parameter übergeben.';
    return;
  }

  titleEl.textContent = fullId;
  // Anzeige des gesuchten Pfads (absolut, mit führendem Slash)
  const histUrl = `/data/v2/history/${fullId}.json`;
  const histAlt = `/data/v2/history_${fullId}.json`;
  searchEl.textContent = `Sucht: ${histUrl} oder ${histAlt}`;

  // 2) History laden
  let hist = null;
  async function tryFetch(url){
    const r = await fetch(url+'?t='+Date.now(), {cache:'no-store'});
    if (!r.ok) return null;
    const j = await r.json();
    return Array.isArray(j) ? j : null;
  }
  hist = await tryFetch(histUrl);
  if (!hist) hist = await tryFetch(histAlt);

  // 3) Aktuelle Werte (aus _all.json)
  try{
    const res = await fetch(ALL_URL+'?t='+Date.now(), {cache:'no-store'});
    if (res.ok){
      const arr = await res.json();
      const rec = Array.isArray(arr) ? arr.find(r => r.id === fullId) : null;
      if (rec){
        statusEl.textContent = 'Stand: ' + new Date(rec.ts).toLocaleString('de-DE',{hour12:false});
        const f = rec.fields || {};
        const temp = (f.TempC_SHT31 ?? f.TempC_SHT ?? f.temp_SOIL);
        const hum  = (f.Hum_SHT31   ?? f.Hum_SHT   ?? f.water_SOIL);
        const bat  = f.BatV;
        currentEl.innerHTML =
          `<div><b>Temperatur:</b> ${fmtNum(temp,'°C')}</div>`+
          `<div><b>Feuchte:</b> ${fmtNum(hum,'%')}</div>`+
          `<div><b>Batterie:</b> ${fmtNum(bat,'V')}</div>`;
      }
    }
  }catch(e){ /* ignore */ }

  // 4) Verlauf anzeigen (ab 2 Punkten Linie; bei 1 Punkt Hinweis)
  const ctx = document.getElementById('chart').getContext('2d');

  function drawAxes(ctx, W, H){
    ctx.strokeStyle = '#ddd';
    ctx.beginPath();
    ctx.moveTo(40,10); ctx.lineTo(40,H-30); ctx.lineTo(W-10,H-30);
    ctx.stroke();
  }

  function simpleLine(ctx, pts, color, W, H, minY, maxY){
    if (pts.length<2) return;
    const left=40, bottom=H-30, top=10, right=W-10;
    const w = right-left, h = bottom-top;
    const xs = pts.map(p=>new Date(p.t).getTime());
    const minX = Math.min(...xs), maxX = Math.max(...xs)|| (minX+1);
    ctx.beginPath();
    for (let i=0;i<pts.length;i++){
      const x = left + w * ((new Date(pts[i].t).getTime() - minX) / (maxX - minX || 1));
      const yVal = pts[i].y;
      const y = bottom - h * ((yVal - minY)/(maxY-minY || 1));
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function drawChart(hist){
    const W = ctx.canvas.width  = ctx.canvas.clientWidth;
    const H = ctx.canvas.height = ctx.canvas.clientHeight;

    ctx.clearRect(0,0,W,H);
    drawAxes(ctx, W, H);

    if (!hist || hist.length===0){
      noteEl.textContent = 'Kein Verlauf verfügbar.';
      return;
    }
    // temp/hum Arrays bauen (nur Punkte mit Zahlen)
    const tPts = hist.filter(p=> typeof p.t === 'number' && typeof p.h === 'number' ? false : true); // Platzhalter
    // Korrigiert: wir erwarten p.temp/p.hum (siehe History-Writer)
    const TT  = hist.filter(p=> typeof p.temp === 'number').map(p=>({t:p.ts||p.t, y:p.temp}));
    const HH  = hist.filter(p=> typeof p.h   === 'number').map(p=>({t:p.ts||p.t, y:p.h}));

    const combined = TT.concat(HH);
    if (combined.length===0){
      noteEl.textContent = 'Kein Verlauf verfügbar.';
      return;
    }
    const ys = combined.map(p=>p.y);
    const minY = Math.min(...ys), maxY = Math.max(...ys);

    // Hinweise
    if (TT.length+HH.length === 1){
      noteEl.textContent = 'Hinweis: Nur ein Datenpunkt vorhanden (Linie ab 2 Punkten).';
    } else {
      noteEl.textContent = '';
    }

    // Zeichnen
    if (TT.length>=2) simpleLine(ctx, TT, '#1565c0', W, H, minY, maxY); // blau
    if (HH.length>=2) simpleLine(ctx, HH, '#2e7d32', W, H, minY, maxY); // grün
  }

  drawChart(hist||[]);
})();
</script>
</body>
</html>
