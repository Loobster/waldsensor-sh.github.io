<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH ‚Äì Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="version" content="v0.11" />
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --bg:#f6f8fa;
      --card:#ffffff;
      --leaf:#e6f4ea;
      --air:#eaf2ff;
      --soil:#f7f1e6;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --tile-bg:#f4f6f8;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#004d46;color:#fff;padding:.8em 1em;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    header a{color:#fff;text-decoration:none}
    main{padding:1em;display:grid;grid-template-columns:1fr 1fr;gap:1em}
    .card{background:var(--card);border-radius:12px;padding:1em;box-shadow:var(--shadow)}
    .pill{display:inline-block;background:#dff6e6;color:#135e3d;padding:.25em .8em;border-radius:999px;font-size:.9em;margin-bottom:.6em}
    .section{border-radius:10px;padding:.8em 1em;margin:.6em 0}
    .section.leaf{background:var(--leaf)}
    .section.air{background:var(--air)}
    .section.soil{background:var(--soil)}
    .section h4{margin:.2em 0 .6em;font-size:1.05em}
    /* 3 Tiles nebeneinander, ohne Wrap (damit nichts untereinander rutscht) */
    .tiles{display:flex;gap:12px;flex-wrap:nowrap}
    .tile{flex:1 1 0;background:var(--tile-bg);border-radius:8px;padding:.7em;text-align:center;min-width:120px}
    .tile h3{margin:0 0 .25em;font-size:.85em;color:#4b5563;font-weight:600}
    .tile p{margin:0;font-size:1.1em;font-weight:800}
    .small-note{font-size:.85em;color:#6b7280}
    footer{margin-top:8px;text-align:center;color:#666;padding:1em;font-size:.9em}
    /* schmale Viewports: 1 Spalte */
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>
  <a href="../v2.html">&larr; Zur Karte</a>
  <div>Schulwaldsensor ‚Äî <span id="nodeName"></span> <small>v0.11</small></div>
</header>

<main>
  <!-- LEFT: Sensor-Werte -->
  <div class="card" id="leftCard">
    <div id="stand" class="pill">Stand: ‚Äî</div>

    <!-- Schacht-Audorf (Multi-Sensor) Sektionen -->
    <div class="section leaf" id="secLeaf" style="display:none">
      <h4>üåø Blatt-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="leafTemp">‚Äî</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="leafMoist">‚Äî</p></div>
        <div class="tile"><h3>Batterie</h3><p id="leafBat">‚Äî</p></div>
      </div>
    </div>

    <div class="section air" id="secAir" style="display:none">
      <h4>üå°Ô∏è Luft-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="airTemp">‚Äî</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="airHum">‚Äî</p></div>
        <div class="tile"><h3>Batterie</h3><p id="airBat">‚Äî</p></div>
      </div>
    </div>

    <div class="section soil" id="secSoil" style="display:none">
      <h4>üå± Boden-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Bodentemperatur</h3><p id="soilTemp">‚Äî</p></div>
        <div class="tile"><h3>Bodenfeuchte</h3><p id="soilWater">‚Äî</p></div>
        <div class="tile"><h3>Batterie</h3><p id="soilBat">‚Äî</p></div>
      </div>
    </div>

    <!-- Wetterstation-Hinweis (future) -->
    <div class="section" id="secWx" style="display:none;background:#eef2f7">
      <h4>‚õÖ Wetterstation (SenseCAP S2120)</h4>
      <div class="small-note">Noch keine Daten verf√ºgbar ‚Äì Schl√ºssel ausstehend.</div>
    </div>

    <div class="small-note">Quelle: /data/v2/latest/all.json</div>
  </div>

  <!-- RIGHT: Netz & Gateways -->
  <div class="card">
    <h3>Netz & Gateways</h3>
    <p>Letzte 24 h: <span id="frames24">‚Äî</span> Uplinks</p>
    <p>Letzter Uplink: <span id="lastUplink">‚Äî</span></p>
    <p>Gateways: <span id="gwCount">‚Äî</span></p>
    <p>√ò Batterie: <span id="avgBat">‚Äî</span></p>
    <p>Bestes Signal: <span id="bestSig">‚Äî</span></p>
    <p>ADR: <span id="adr">‚Äî</span></p>
    <div class="small-note" id="netSource">Quelle: ‚Äî</div>
  </div>
</main>

<footer>WALDSENSOR.SH ‚Äì Sensordetails</footer>

<script>
  // --- helpers -------------------------------------------------------------
  const $ = id => document.getElementById(id);
  const setText = (id, txt) => { const el=$(id); if(el) el.textContent = txt; };
  const fmtNum = (v,d=1,suf="") => (v==null||Number.isNaN(+v)) ? "‚Äî" : (Number(v).toFixed(d).replace(".",",")+suf);
  const fmtDate = ts => { if(!ts) return "‚Äî"; const d=new Date(ts); return Number.isNaN(d.getTime())?"‚Äî":d.toLocaleString("de-DE"); };

  const qp = new URLSearchParams(location.search);
  const nodeIdRaw = qp.get("node") || "unknown";
  const nodeId = nodeIdRaw.toLowerCase();
  setText("nodeName", nodeIdRaw);

  // Utility: finds entry of a specific device id (exact match)
  const findById = (arr, id) => arr.find(x => String(x.device_id||x.id||"").toLowerCase() === String(id).toLowerCase());

  // --- latest (All/Enriched) ----------------------------------------------
  // F√ºr Multi-Sensor bauen wir drei Sektionen; sonst eine einfache Zeile (3 Tiles).
  fetch("/data/v2/latest/all_enriched.json", {cache:"no-store"})
    .then(r=>r.ok?r.json():Promise.reject(r.status))
    .then(data=>{
      if(!Array.isArray(data)) throw new Error("invalid latest json");

      const isSchachtAudorf = /^schacht[_-]?audorf/.test(nodeId);
      const nowItem = findById(data, nodeId) || {};
      const ts = nowItem.ts_iso || nowItem.ts || nowItem.time;
      setText("stand", "Stand: "+fmtDate(ts));

      if(isSchachtAudorf){
        // Blatt
        const leaf = findById(data, "schacht_audorf_llms01");
        if(leaf){
          $("secLeaf").style.display="";
          setText("leafTemp",  fmtNum(leaf.leaf_temp_c,1," ¬∞C"));
          setText("leafMoist", fmtNum(leaf.leaf_moist_pct,1," %"));
          setText("leafBat",   fmtNum(leaf.bat_v,2," V"));
        }
        // Luft
        const air = findById(data, "schacht_audorf_s31lb") || findById(data, "schacht_audorf_sn50v3") || findById(data, "schacht_audorf_lsn50v2");
        if(air){
          $("secAir").style.display="";
          const temp = air.temp_c ?? air.TempC_SHT ?? air.TempC_SHT31;
          const hum  = air.hum_pct ?? air.Hum_SHT ?? air.Hum_SHT31;
          setText("airTemp", fmtNum(temp,1," ¬∞C"));
          setText("airHum",  fmtNum(hum,1," %"));
          setText("airBat",  fmtNum(air.bat_v,2," V"));
        }
        // Boden
        const soil = findById(data, "schacht_audorf_se01lb");
        if(soil){
          $("secSoil").style.display="";
          setText("soilTemp",  fmtNum(soil.temp_soil_c ?? soil.temp_SOIL,1," ¬∞C"));
          setText("soilWater", fmtNum(soil.water_soil ?? soil.water_SOIL,1," %"));
          setText("soilBat",   fmtNum(soil.bat_v,2," V"));
        }
        // Wetterstation Platzhalter (ausblendbar)
        $("secWx").style.display="";
      }else{
        // Single-Node: drei Tiles in einer Zeile (Temp | Feuchte | Batterie)
        const left = $("leftCard");
        const f = nowItem.fields || {};
        const temp = nowItem.temp_c ?? f.TempC_SHT ?? f.TempC_SHT31 ?? f.temp_SOIL ?? null;
        const hum  = nowItem.hum_pct ?? f.Hum_SHT ?? f.Hum_SHT31 ?? f.water_SOIL ?? null;
        const bat  = nowItem.bat_v ?? f.BatV ?? null;

        // Ersetze Inhalt dynamisch:
        left.innerHTML = `
          <div id="stand" class="pill">Stand: ${fmtDate(ts)}</div>
          <div class="section" style="background:#eef2f7">
            <div class="tiles">
              <div class="tile"><h3>Temperatur</h3><p>${fmtNum(temp,1," ¬∞C")}</p></div>
              <div class="tile"><h3>Feuchte</h3><p>${fmtNum(hum,(hum!=null&&hum<10)?1:1," %")}</p></div>
              <div class="tile"><h3>Batterie</h3><p>${fmtNum(bat,2," V")}</p></div>
            </div>
          </div>
          <div class="small-note">Quelle: /data/v2/latest/all_enriched.json</div>
        `;
      }
    })
    .catch(e=>{
      console.warn("latest load failed", e);
    });

  // --- netstats ------------------------------------------------------------
  const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeIdRaw)}.json`;
  setText("netSource", "Quelle: "+netUrl);

  fetch(netUrl, { cache:"no-store" })
    .then(r=>r.ok?r.json():Promise.reject(r.status))
    .then(ns=>{
      if(!ns || typeof ns!=="object") return;
      if(ns.frames24!=null) setText("frames24", ns.frames24);
      setText("lastUplink", fmtDate(ns.last_ts));

      // Gateways
      let gw = "‚Äî";
      if (typeof ns.gateways === "number") gw = ns.gateways;
      else if (Array.isArray(ns.gateways)) gw = ns.gateways.length;
      setText("gwCount", gw);

      if (ns.best && (ns.best.rssi!=null || ns.best.snr!=null)){
        const rssi = (ns.best.rssi!=null)?`${ns.best.rssi} dBm`:"‚Äî";
        const snr  = (ns.best.snr !=null)?`${ns.best.snr} dB` :"‚Äî";
        setText("bestSig", `${rssi} / ${snr}`);
      }
      if (ns.adr != null) setText("adr", String(ns.adr));
      else if (ns.adr_enabled != null) setText("adr", String(ns.adr_enabled));

      // √ò Batterie, falls vorhanden (von Enrich-Job bef√ºllt); andernfalls "‚Äî"
      if (ns.avg_bat_v != null) setText("avgBat", fmtNum(ns.avg_bat_v,2," V"));
    })
    .catch(e=>console.warn("netstats load failed", e));
</script>
</body>
</html>
