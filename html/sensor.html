<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH – Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f8fa; }
    header { background:#004d46; color:#fff; padding:0.8em 1em; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#fff; text-decoration:none; }
    main { padding:1em; display:grid; grid-template-columns:1fr 1fr; gap:1em; }
    .card { background:#fff; border-radius:12px; padding:1em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .pill { display:inline-block; background:#e6f4ea; color:#1a6334; padding:0.2em 0.8em; border-radius:999px; font-size:0.9em; margin-bottom:0.5em; }
    .tiles { display:flex; gap:0.8em; flex-wrap:wrap; }
    .tile { flex:1 1 30%; background:#f4f6f8; border-radius:8px; padding:0.8em; text-align:center; }
    .tile h3 { margin:0; font-size:0.9em; color:#555; }
    .tile p { margin:0.2em 0 0; font-size:1.2em; font-weight:bold; }
    .sensor-block { margin-top:0.8em; padding-top:0.6em; border-top:1px solid #eee; }
    .sensor-block h4 { margin:0.3em 0; color:#004d46; font-size:1em; }
    footer { text-align:center; color:#666; padding:1em; font-size:0.9em; }
    .inactive { color:#999; background:#eee; }
  </style>
</head>
<body>
  <header>
    <a href="../v2.html">&larr; Zur Karte</a>
    <div>Schulwaldsensor — <span id="nodeName"></span> <small>v0.09</small></div>
  </header>

  <main>
    <div class="card" id="sensorCard">
      <div id="stand" class="pill">Stand: —</div>
      <div id="sensorContainer"></div>
      <small>Quelle: /data/v2/latest/all.json</small>
    </div>

    <div class="card">
      <h3>Netz & Gateways</h3>
      <p>Letzte 24 h: <span id="frames24">—</span> Uplinks</p>
      <p>Letzter Uplink: <span id="lastUplink">—</span></p>
      <p>Gateways: <span id="gwCount">—</span></p>
      <p>Ø Batterie: <span id="avgBat">—</span></p>
      <p>Bestes Signal: <span id="bestSig">—</span></p>
      <p>ADR: <span id="adr">—</span></p>
      <small id="netSource">Quelle: —</small>
    </div>
  </main>

  <footer>WALDSENSOR.SH – Sensordetails</footer>

  <script>
    // --- Helper-Funktionen ---------------------------------------------------
    const byId = id => document.getElementById(id);
    const safeSet = (id, text) => { const el = byId(id); if(el) el.textContent = text; };
    const fmtNum = (v, d=1, suf="") => (v==null || Number.isNaN(+v)) ? "—" : Number(v).toFixed(d).replace(".",",")+suf;
    const fmtDate = ts => ts ? new Date(ts).toLocaleString("de-DE") : "—";

    // --- Parameter aus URL ---------------------------------------------------
    const urlParams = new URLSearchParams(location.search);
    const nodeId = (urlParams.get("node") || "unknown");
    safeSet("nodeName", nodeId);

    const baseId = nodeId.split("_").slice(0,2).join("_"); // z. B. schacht_audorf
    const isMulti = /schacht[_-]?audorf/i.test(nodeId);

    // --- Daten laden ---------------------------------------------------------
    fetch("/data/v2/latest/all.json", { cache:"no-store" })
      .then(r => r.json())
      .then(all => {
        if(!Array.isArray(all)) return;

        const related = isMulti
          ? all.filter(x => x.id?.startsWith(baseId))
          : all.filter(x => (x.id||"").toLowerCase() === nodeId.toLowerCase());

        if(related.length === 0) return;

        // Zeit: Jüngster Zeitstempel
        const latest = related.reduce((a,b)=> Date.parse(a.ts||0)>Date.parse(b.ts||0)?a:b);
        safeSet("stand", "Stand: "+fmtDate(latest.ts));

        // Sensor-Datenblock
        const container = byId("sensorContainer");
        container.innerHTML = "";

        related.forEach(n => {
          const f = n.fields||{};
          const id = n.id.toLowerCase();
          let type = "Unbekannt";
          if(/llms01/.test(id)) type = "🍃 Blatt-Sensor";
          else if(/se01/.test(id)) type = "🌱 Boden-Sensor";
          else if(/s31|sn50|lsn50/.test(id)) type = "🌡️ Luft-Sensor";
          else if(/s2120/.test(id)) type = "🌦 Wetterstation (8-in-1)";

          const block = document.createElement("div");
          block.className = "sensor-block";
          block.innerHTML = `<h4>${type}</h4>
            <div class="tiles">
              <div class="tile"><h3>Temperatur</h3><p>${fmtNum(f.TempC_SHT||f.TempC_SHT31||f.temp_SOIL||f.Leaf_Temperature,1," °C")}</p></div>
              <div class="tile"><h3>Feuchte</h3><p>${fmtNum(f.Hum_SHT||f.Hum_SHT31||f.water_SOIL||f.Leaf_Moisture,1," %")}</p></div>
              <div class="tile"><h3>Batterie</h3><p>${fmtNum(f.BatV,2," V")}</p></div>
            </div>`;
          container.appendChild(block);
        });

        // --- Wetterstation-Placeholder --------------------------------------
        if(isMulti && !related.some(x=>/s2120/.test(x.id))){
          const ph = document.createElement("div");
          ph.className = "sensor-block inactive";
          ph.innerHTML = `<h4>🌦 Wetterstation (SenseCAP S2120)</h4>
            <p>Noch keine Daten verfügbar – Schlüssel ausstehend.</p>`;
          container.appendChild(ph);
        }

        // --- Netz & Gateways-Auswertung -------------------------------------
        const bats = related.map(r => +r.fields?.BatV || 0).filter(v => v>0);
        const avgBat = bats.length ? bats.reduce((a,b)=>a+b,0)/bats.length : null;
        safeSet("avgBat", fmtNum(avgBat,2," V"));

        const gws = new Set();
        related.forEach(n => (n.fields?.gateway_details||[]).forEach(g => gws.add(g.id)));
        safeSet("gwCount", gws.size || "—");
      })
      .catch(e => console.warn("Fehler beim Laden all.json", e));

    // --- Netstats laden ------------------------------------------------------
    const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeId)}.json`;
    safeSet("netSource", "Quelle: "+netUrl);

    fetch(netUrl,{cache:"no-store"})
      .then(r=>r.json())
      .then(ns=>{
        if(!ns) return;
        safeSet("frames24", ns.frames24 ?? "—");
        safeSet("lastUplink", fmtDate(ns.last_ts));
        if(ns.best){
          const rssi = ns.best.rssi!=null?`${ns.best.rssi} dBm`:"—";
          const snr = ns.best.snr!=null?`${ns.best.snr} dB`:"—";
          safeSet("bestSig", `${rssi} / ${snr}`);
        }
        safeSet("adr", ns.adr ?? ns.adr_enabled ?? "—");
      })
      .catch(e=>console.warn("Fehler beim Laden netstats", e));
  </script>
</body>
</html>
