<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî ‚Ä¶</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#fff;--muted:#8a93a3;--ink:#0d1b2a;--ok:#dff6e5;--pad:16px;--radius:14px}
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    h1{font-weight:800;letter-spacing:.2px;margin:6px 0 18px;font-size:clamp(26px,4vw,40px)}
    .ver{font-size:13px;color:var(--muted);font-weight:700;margin-left:8px}
    .row{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:980px){.row{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15);padding:var(--pad)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--ok);color:#115e59;font-weight:700;font-size:14px}
    .grid3{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:700px){.grid3{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:980px){.grid3{grid-template-columns:repeat(3,1fr)}}
    .tile{background:#eef2f7;border-radius:12px;padding:14px 16px;min-height:86px;display:flex;flex-direction:column;justify-content:center}
    .k{color:var(--muted);font-size:14px;margin-bottom:6px}
    .v{font-size:22px;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    canvas{max-height:360px} .hint{margin-top:8px;font-size:13px;color:var(--muted)}
    .section-title{font-weight:800;margin:0 0 10px}
    a.back{text-decoration:none;color:#2563eb;font-weight:600}
    .err{color:#b91c1c;font-weight:700}
    /* Neu f√ºrs Netz-Panel */
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef2f7;margin:2px 6px 2px 0;font-size:12px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom:8px;"><a class="back" href="/v2.html">‚Üê Zur Karte</a></div>
    <h1>Schulwaldsensor ‚Äî <span id="nodeTitle">‚Ä¶</span><span class="ver">v0.4</span></h1>

    <div class="row">
      <div class="card">
        <div style="margin-bottom:10px;">
          <span class="pill">Stand: <span id="stand">‚Äî</span></span>
        </div>
        <div class="grid3">
          <div class="tile"><div class="k">Temperatur</div><div class="v" id="temp">‚Äî</div></div>
          <div class="tile"><div class="k" id="humLabel">Luftfeuchte</div><div class="v" id="hum">‚Äî</div></div>
          <div class="tile" style="grid-column:1/-1"><div class="k">Batterie</div><div class="v" id="bat">‚Äî</div></div>
        </div>
        <div class="hint">Quelle: <span class="mono">/data/v2/latest/_all.json</span></div>
      </div>

      <div class="card">
        <div class="section-title">Aktuelle Werte</div>
        <div class="muted" id="aktuell">‚Äî</div>

        <hr style="border:none;height:1px;background:#eef2f7;margin:14px 0">

        <div class="section-title">Netz & Gateways</div>
        <div id="netz" class="muted">lade‚Ä¶</div>
        <div id="netzErr" class="hint err" style="display:none"></div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</div>
      <canvas id="chartHourly"></canvas>
      <div class="hint">Sucht: <span id="histPath" class="mono">/data/v2/history/&lt;node&gt;.json</span></div>
      <div class="hint err" id="histErr" style="display:none"></div>
      <div class="hint" id="noHourly" style="display:none">Kein Verlauf gefunden.</div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <canvas id="chartDaily"></canvas>
      <div class="hint" id="noDaily" style="display:none">Keine Tageswerte m√∂glich (es fehlt Verlauf).</div>
    </div>
  </div>

  <script>
    const byId = (id) => document.getElementById(id);
    const fmt = (n, d=1) => (n==null || Number.isNaN(n)) ? "‚Äî" : Number(n).toFixed(d).replace(".",",");
    const isSoilNode = (id) => id === "se01";

    function detectNode(){
      const u = new URL(location.href);
      let raw = (u.searchParams.get("node")||u.searchParams.get("id")||"").trim();
      if(!raw && location.hash){
        const sp = new URLSearchParams(location.hash.slice(1));
        raw = (sp.get("node")||"").trim();
      }
      if(!raw){
        let p = (location.pathname.split("/").pop()||"").replace(/\.html?$/,"");
        raw = (p==="sensor") ? "" : p;
      }
      return (raw||"").replace(/[\r\n]+/g,"").trim() || null;
    }

    async function loadLatest(){
      const r = await fetch("/data/v2/latest/_all.json",{cache:"no-store"});
      if(!r.ok) throw new Error("Live-Quelle nicht erreichbar: "+r.status);
      const arr = await r.json();
      return arr.map(x=>({...x,id:(x.id||"").replace(/[\r\n]+/g,"").trim()}));
    }

    function pickFields(entry){
      const f = entry.fields||{};
      if(isSoilNode(entry.id)){
        return {temp: f.temp_SOIL ?? null, hum: f.water_SOIL ?? null, bat: f.BatV ?? null, humLabel:"Bodenwasser"};
      }
      return {
        temp: f.TempC_SHT ?? f.TempC_SHT31 ?? null,
        hum:  f.Hum_SHT   ?? f.Hum_SHT31   ?? null,
        bat:  f.BatV ?? null,
        humLabel:"Luftfeuchte"
      };
    }

    async function loadHistory(node){
      const url = `/data/v2/history/${encodeURIComponent(node)}.json`;
      byId("histPath").textContent = url;
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok){
        byId("histErr").style.display="block";
        byId("histErr").textContent = `Fehler beim Laden (${r.status}) von ${url}`;
        return [];
      }
      byId("histErr").style.display="none";
      let data = await r.json();
      if(!Array.isArray(data)) return [];
      data = data.filter(x=>x && x.ts).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
      return data;
    }

    let chH, chD;
    function makeHourlyChart(ctx, items, soil){
      const labels = items.map(x=>x.ts);
      const temps  = items.map(x=>x.t);
      const hums   = items.map(x=>x.h);
      const tLabel = soil? "Bodentemperatur [¬∞C]":"Temperatur [¬∞C]";
      const hLabel = soil? "Bodenwasser [%]"    :"Luftfeuchte [%]";
      if(ctx._chart) ctx._chart.destroy();
      ctx._chart = new Chart(ctx,{type:'line',data:{
        labels,
        datasets:[{label:tLabel,data:temps,yAxisID:'y1'},{label:hLabel,data:hums,yAxisID:'y2'}]
      },options:{
        responsive:true,interaction:{mode:'index',intersect:false},
        scales:{
          x:{ticks:{callback:(v,i)=>{const d=new Date(labels[i]);return d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"})+" "+d.toLocaleTimeString("de-DE",{hour:"2-digit"})+"h"}}},
          y1:{position:'left',title:{display:true,text:tLabel},grid:{drawOnChartArea:false}},
          y2:{position:'right',title:{display:true,text:hLabel},min:0,max:100}
        },plugins:{legend:{position:'top'}}
      }});
      return ctx._chart;
    }

    function makeDailyChart(ctx, days, soil){
      const labels = days.map(x=>x.day), temps=days.map(x=>x.t), hums=days.map(x=>x.h);
      const tLabel = soil? "√ò Bodentemperatur [¬∞C]":"√ò Temperatur [¬∞C]";
      const hLabel = soil? "√ò Bodenwasser [%]"    :"√ò Luftfeuchte [%]";
      if(ctx._chart) ctx._chart.destroy();
      ctx._chart = new Chart(ctx,{type:'bar',data:{
        labels,
        datasets:[{type:'bar',label:hLabel,data:hums,yAxisID:'y2'},{type:'line',label:tLabel,data:temps,yAxisID:'y1'}]
      },options:{
        responsive:true,interaction:{mode:'index',intersect:false},
        scales:{y1:{position:'left',title:{display:true,text:tLabel},grid:{drawOnChartArea:false}},y2:{position:'right',title:{display:true,text:hLabel},min:0,max:100}},
        plugins:{legend:{position:'top'}}
      }});
      return ctx._chart;
    }

    function groupDaily(items){
      const m = new Map();
      for(const it of items){
        const d = new Date(it.ts);
        const key = d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,"0")+"-"+String(d.getUTCDate()).padStart(2,"0");
        if(!m.has(key)) m.set(key,{n:0,tsum:0,hsum:0});
        const o = m.get(key);
        if(typeof it.t==="number") o.tsum+=it.t;
        if(typeof it.h==="number") o.hsum+=it.h;
        o.n++;
      }
      const out=[];
      for(const [k,v] of m.entries()) out.push({day:k,t:v.n? v.tsum/v.n:null,h:v.n? v.hsum/v.n:null});
      out.sort((a,b)=>a.day.localeCompare(b.day));
      return out.slice(-31);
    }

    /* ---------- Neu: Netzwerk/CSV laden und anzeigen ---------- */
    async function loadRawCsv(){
      const r = await fetch("/data/v2/latest/_raw.csv",{cache:"no-store"});
      if(!r.ok) throw new Error("raw.csv "+r.status);
      const txt = await r.text();
      const lines = txt.trim().split(/\r?\n/);
      if(lines.length < 2) return [];
      const head = lines[0].split(",").map(s=>s.trim());
      const idx = (name) => head.findIndex(h => h.toLowerCase()===name.toLowerCase());
      const ix = {
        ts:    [idx("ts"), idx("_time")].find(i=>i>=0),
        node:  [idx("id"), idx("device_id"), idx("dev_id")].find(i=>i>=0),
        gw:    [idx("gateway_id"), idx("gw"), idx("gateway")].find(i=>i>=0),
        rssi:  idx("rssi"),
        snr:   idx("snr"),
        dr:    [idx("dr"), idx("datarate")].find(i=>i>=0),
        sf:    idx("sf"),
        bw:    idx("bw"),
        fcnt:  [idx("fcnt"), idx("frame_counter")].find(i=>i>=0)
      };
      const out=[];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(",");
        const get=(j)=> j>=0 && j<cols.length ? cols[j].trim() : "";
        out.push({
          ts:   get(ix.ts),
          node: get(ix.node),
          gw:   get(ix.gw),
          rssi: Number(get(ix.rssi)),
          snr:  Number(get(ix.snr)),
          dr:   get(ix.dr)||"",
          sf:   get(ix.sf)||"",
          bw:   get(ix.bw)||"",
          fcnt: Number(get(ix.fcnt))
        });
      }
      return out;
    }

    function renderNetPanel(node, rows){
      const box = byId("netz");
      const err = byId("netzErr");
      err.style.display="none";

      if(!rows.length){ box.textContent="Keine Rohdaten gefunden."; return; }

      // nur letzte 24h
      const since = Date.now()-24*3600*1000;
      rows = rows.filter(r => r.node===node && new Date(r.ts).getTime()>=since);
      if(!rows.length){ box.textContent="Letzte 24 h: keine Eintr√§ge."; return; }

      // Gateways + Stats
      const gws = new Map(); // gw -> {n, rssiSum, snrSum, lastTs}
      let last = rows[0];
      for(const r of rows){
        if(new Date(r.ts) > new Date(last.ts)) last = r;
        if(!r.gw) continue;
        if(!gws.has(r.gw)) gws.set(r.gw,{n:0,rssiSum:0,snrSum:0,lastTs:r.ts});
        const g = gws.get(r.gw);
        g.n++; g.rssiSum += isFinite(r.rssi)?r.rssi:0; g.snrSum += isFinite(r.snr)?r.snr:0;
        if(new Date(r.ts)>new Date(g.lastTs)) g.lastTs=r.ts;
      }

      const uniqGws = [...gws.keys()];
      const avg = arr => arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;

      const rssiAvg = avg(rows.map(r=>isFinite(r.rssi)?r.rssi:NaN).filter(n=>!Number.isNaN(n)));
      const snrAvg  = avg(rows.map(r=>isFinite(r.snr)?r.snr:NaN).filter(n=>!Number.isNaN(n)));

      // HTML
      const parts = [];
      parts.push(`<div class="kv"><div>Uplinks (24 h)</div><div>${rows.length}</div>`);
      parts.push(`<div>Gateways</div><div>${uniqGws.map(g=>`<span class="badge">${g}</span>`).join(" ")||"‚Äî"}</div>`);
      parts.push(`<div>√ò RSSI</div><div>${rssiAvg!=null? fmt(rssiAvg,1)+" dBm":"‚Äî"}</div>`);
      parts.push(`<div>√ò SNR</div><div>${snrAvg!=null? fmt(snrAvg,1)+" dB":"‚Äî"}</div>`);
      parts.push(`<div>Letzter Uplink</div><div>${last?.ts ? new Date(last.ts).toLocaleString("de-DE") : "‚Äî"}</div>`);
      const drText = last?.dr || (last?.sf && last?.bw ? `SF${last.sf}/${last.bw}` : "");
      parts.push(`<div>Datenrate</div><div>${drText || "‚Äî"}</div>`);
      parts.push(`</div>`);

      box.innerHTML = parts.join("");
    }
    /* ---------- Ende Netz ---------- */

    (async ()=>{
      try{
        const wanted = detectNode();
        const latest = await loadLatest();
        let entry = null;
        if(wanted){
          entry = latest.find(x=>x.id===wanted) || latest.find(x=>x.id.toLowerCase()===wanted.toLowerCase());
        }
        if(!entry) entry = latest[0];
        const node = entry.id;
        const soil = isSoilNode(node);

        byId("nodeTitle").textContent = node;
        byId("stand").textContent = entry.ts ? new Date(entry.ts).toLocaleString("de-DE") : "‚Äî";

        const {temp,hum,bat,humLabel} = pickFields(entry);
        byId("temp").textContent = temp!=null ? fmt(temp,1)+" ¬∞C" : "‚Äî";
        byId("hum").textContent  = hum!=null  ? fmt(hum,1)+" %"  : "‚Äî";
        byId("humLabel").textContent = humLabel;
        byId("bat").textContent  = bat!=null  ? fmt(bat,3)+" V"  : "‚Äî";
        byId("aktuell").innerHTML = `üå°Ô∏è Temperatur: <b>${byId("temp").textContent}</b><br>${soil?"üíß Bodenwasser":"üíß Luftfeuchte"}: <b>${byId("hum").textContent}</b><br>ü™´ Batterie: <b>${byId("bat").textContent}</b>`;

        // Historie & Charts
        const hist = await loadHistory(node);
        const seven = Date.now() - 7*24*3600*1000;
        const recent = hist.filter(x=>new Date(x.ts).getTime() >= seven);
        if(recent.length){
          byId("noHourly").style.display="none";
          makeHourlyChart(byId("chartHourly").getContext("2d"), recent, soil);
        }else{
          byId("noHourly").style.display="block";
        }
        const days = groupDaily(hist);
        if(days.length){
          byId("noDaily").style.display="none";
          makeDailyChart(byId("chartDaily").getContext("2d"), days, soil);
        }else{
          byId("noDaily").style.display="block";
        }

        // Netz-Panel
        try{
          const raw = await loadRawCsv();
          renderNetPanel(node, raw);
        }catch(ne){
          byId("netzErr").style.display="block";
          byId("netzErr").textContent = "Netz-Infos: "+(ne?.message||ne);
          byId("netz").textContent = "‚Äî";
        }
      }catch(e){
        console.error(e);
        byId("histErr").style.display="block";
        byId("histErr").textContent = "Fehler: "+(e?.message||e);
      }
    })();
  </script>
</body>
</html>
