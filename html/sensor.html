<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Schulwaldsensor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 2em; background: #f5f7fa; }
    .wrap { max-width: 800px; margin: auto; }
    h1 { font-size: 1.6em; }
    .card { background: white; padding: 1em 1.5em; margin: 1em 0; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .muted { color: #666; font-size: 0.9em; }
    .values { display: flex; gap: 2em; }
    .values div { flex: 1; font-size: 1.2em; }
    canvas { width: 100% !important; height: 320px !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="https://www.waldsensor.sh/html/">‚Üê Zur Karte</a>
    <h1 id="title">Schulwaldsensor</h1>

    <div class="card">
      <div>üïí <b>Stand: <span id="standzeit">‚Äî</span></b></div>
      <div class="values">
        <div>üå°Ô∏è <span id="val-temp">‚Äî</span></div>
        <div>üíß <span id="val-hum">‚Äî</span></div>
        <div>üîã <span id="val-bat">‚Äî</span></div>
      </div>
      <div class="muted">Quelle: /data/v2/latest/_all.json</div>
    </div>

    <div class="card">
      <h3>üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</h3>
      <canvas id="chart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // Chart-Renderer
  function renderChart(xs, ysT, ysH) {
    const ctx = document.getElementById('chart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: xs.map(d => d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})),
        datasets: [
          { label: 'Temperatur (¬∞C)', data: ysT, borderColor: 'blue', fill: false, yAxisID: 'y1' },
          { label: 'Luftfeuchte (%)', data: ysH, borderColor: 'green', fill: false, yAxisID: 'y2' }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          y1: { type: 'linear', position: 'left', ticks: { callback: v => v+' ¬∞C' } },
          y2: { type: 'linear', position: 'right', ticks: { callback: v => v+' %' },
                grid: { drawOnChartArea: false } }
        }
      }
    });
  }
  </script>

  <script>
  (async () => {
    // Node-ID robust bestimmen
    function getNodeId() {
      const p = new URLSearchParams(location.search);
      for (const k of ['node','id','dev','sensor']) {
        const v = (p.get(k) || '').trim();
        if (v) return v;
      }
      const m = location.pathname.split('/').pop().replace(/\.html$/,'');
      return (m && m !== 'sensor') ? m : '';
    }

    const nodeId = getNodeId();
    if (!nodeId) {
      document.body.innerHTML = `<div class="wrap"><h2>‚ùå Keine Node-ID angegeben.</h2></div>`;
      return;
    }
    document.getElementById('title').textContent = "Schulwaldsensor ‚Äî " + nodeId;

    // Helper zum Laden von JSON mit Cache-Busting
    async function getJSON(url) {
      const u = `${url}${url.includes('?') ? '&' : '?'}t=${Date.now()}`;
      const res = await fetch(u, { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      if (!txt) throw new Error("Leere Antwort");
      return JSON.parse(txt);
    }

    // Latest laden: erst _all.json, sonst Einzeldatei
    let latestRec = null;
    try {
      const all = await getJSON('/data/v2/latest/_all.json');
      if (Array.isArray(all)) {
        latestRec = all.find(r => r && r.id === nodeId) || null;
      }
    } catch(e) { console.warn("_all.json Fehler:", e.message); }

    if (!latestRec) {
      try {
        const single = await getJSON(`/data/v2/latest/${nodeId}.json`);
        if (single && single.id) latestRec = single;
        else if (Array.isArray(single) && single[0]) latestRec = single[0];
      } catch(e) { console.warn("Fallback latest/<id>.json Fehler:", e.message); }
    }

    if (!latestRec) {
      document.body.innerHTML =
        `<div class="wrap"><h2>‚ùå Keine Daten f√ºr ${nodeId}</h2></div>`;
      return;
    }

    // History laden
    async function loadHistory(id) {
      const tries = [
        `/data/v2/history/${id}.json`,
        `/data/v2/history_${id}.json`
      ];
      for (const u of tries) {
        try {
          const h = await getJSON(u);
          if (Array.isArray(h) && h.length) return h;
        } catch {}
      }
      return [];
    }
    const history = await loadHistory(nodeId);

    // Zeit formatieren
    function fmtTS(s) {
      try {
        const d = new Date(s);
        return d.toLocaleDateString('de-DE') + ", " +
               d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      } catch { return s; }
    }

    document.getElementById('standzeit').textContent = fmtTS(latestRec.ts);

    const temp = latestRec.fields.TempC_SHT ?? latestRec.fields.TempC_SHT31 ?? latestRec.fields.TempC1;
    const hum  = latestRec.fields.Hum_SHT ?? latestRec.fields.Hum_SHT31;
    const bat  = latestRec.fields.BatV;

    if (temp!=null) document.getElementById('val-temp').textContent = temp + " ¬∞C";
    if (hum !=null) document.getElementById('val-hum').textContent  = hum  + " %";
    if (bat !=null) document.getElementById('val-bat').textContent  = bat  + " V";

    // Chart rendern
    const points = history.slice(-96);
    const xs  = points.map(p => new Date(p.ts));
    const ysT = points.map(p => p.TempC_SHT ?? p.TempC_SHT31 ?? p.TempC1 ?? p.temp ?? null);
    const ysH = points.map(p => p.Hum_SHT ?? p.Hum_SHT31 ?? p.hum ?? null);

    renderChart(xs, ysT, ysH);
  })();
  </script>
</body>
</html>
