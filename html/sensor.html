<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH â€“ Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="version" content="v0.21" />
  <style>
    :root{
      --ink:#0f172a;--muted:#64748b;--bg:#f6f8fa;--card:#ffffff;
      --leaf:#e6f4ea;--air:#eaf2ff;--soil:#f7f1e6;--shadow:0 2px 6px rgba(0,0,0,.08);
      --tile-bg:#f4f6f8;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{background:#004d46;color:#fff;padding:.8em 1em;
      font-weight:700;display:flex;justify-content:space-between;align-items:center}
    header a{color:#fff;text-decoration:none}
    main{padding:1em;display:grid;grid-template-columns:1fr 1fr;gap:1em}
    .card{background:var(--card);border-radius:12px;padding:1em;box-shadow:var(--shadow)}
    .pill{display:inline-block;background:#dff6e6;color:#135e3d;
      padding:.25em .8em;border-radius:999px;font-size:.9em;margin-bottom:.6em}
    .section{border-radius:10px;padding:.8em 1em;margin:.6em 0}
    .section.leaf{background:var(--leaf)}
    .section.air{background:var(--air)}
    .section.soil{background:var(--soil)}
    .section h4{margin:.2em 0 .6em;font-size:1.05em}
    .tiles{display:flex;gap:12px;flex-wrap:nowrap}
    .tile{flex:1 1 0;background:var(--tile-bg);border-radius:8px;padding:.7em;text-align:center;min-width:120px}
    .tile h3{margin:0 0 .25em;font-size:.85em;color:#4b5563;font-weight:600}
    .tile p{margin:0;font-size:1.1em;font-weight:800}
    .small-note{font-size:.85em;color:#6b7280}
    footer{margin-top:8px;text-align:center;color:#666;padding:1em;font-size:.9em}
    .bar{display:inline-block;padding:.15em .4em;border-radius:6px;color:#fff;font-weight:700;font-size:.9em}
    .bar.red{background:var(--bad)}.bar.yellow{background:var(--warn)}.bar.green{background:var(--ok)}
    @media (max-width:980px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <a href="../v2.html">&larr; Zur Karte</a>
  <div>Schulwaldsensor â€” <span id="nodeName"></span> <small>v0.21</small></div>
</header>

<main>
  <!-- linke seite = exakt wie v0.12 -->
  <div class="card" id="leftCard">
    <div id="stand" class="pill">Stand: â€”</div>

    <div class="section leaf" id="secLeaf" style="display:none">
      <h4>ğŸŒ¿ Blatt-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="leafTemp">â€”</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="leafMoist">â€”</p></div>
        <div class="tile"><h3>Batterie</h3><p id="leafBat">â€”</p></div>
      </div>
    </div>

    <div class="section air" id="secAir" style="display:none">
      <h4>ğŸŒ¡ï¸ Luft-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="airTemp">â€”</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="airHum">â€”</p></div>
        <div class="tile"><h3>Batterie</h3><p id="airBat">â€”</p></div>
      </div>
    </div>

    <div class="section soil" id="secSoil" style="display:none">
      <h4>ğŸŒ± Boden-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Bodentemperatur</h3><p id="soilTemp">â€”</p></div>
        <div class="tile"><h3>Bodenfeuchte</h3><p id="soilWater">â€”</p></div>
        <div class="tile"><h3>Batterie</h3><p id="soilBat">â€”</p></div>
      </div>
    </div>

    <div class="section" id="secWx" style="display:none;background:#eef2f7">
      <h4>â›… Wetterstation (SenseCAP S2120)</h4>
      <div class="small-note">Noch keine Daten verfÃ¼gbar â€“ SchlÃ¼ssel ausstehend.</div>
    </div>

    <div class="small-note">Quelle: /data/v2/latest/all.json</div>
  </div>

  <!-- rechte seite erweitert -->
  <div class="card">
    <h3>Netz & Ranking</h3>
    <p>Letzte 24 h: <span id="frames24">â€”</span> Uplinks</p>
    <p>Verlustquote: <span id="lossBadge" class="bar red">0 %</span></p>
    <p>Letzter Uplink: <span id="lastUplink">â€”</span></p>
    <p>Gateways: <span id="gwCount">â€”</span></p>
    <p>Bestes Signal: <span id="bestSig">â€”</span></p>
    <p>ADR: <span id="adr">â€”</span></p>
    <div class="small-note" id="netSource">Quelle: â€”</div>
    <hr>
    <h4>ğŸ† WALDSENSOR.SH-Liga</h4>
    <p>Rang: <span id="rank">â€”</span> / <span id="rankTotal">â€”</span></p>
    <p>Gesamt-Score: <strong id="score">0 Punkte</strong></p>
    <p class="small-note">70 % Ãœbertragung + 20 % Signal + 10 % Batterie</p>
  </div>
</main>

<footer>WALDSENSOR.SH â€“ Sensordetails</footer>

<script>
const $=id=>document.getElementById(id);
const fmtDate=ts=>{if(!ts)return"â€”";const d=new Date(ts);return isNaN(d)?"â€”":d.toLocaleString("de-DE")};
const fmtNum=(v,d=1,s="")=>v==null||!isFinite(+v)?"â€”":(+v).toFixed(d).replace(".",",")+s;
const setTxt=(id,v)=>{const e=$(id);if(e)e.textContent=v};
const qp=new URLSearchParams(location.search);
const nodeIdRaw=qp.get("node")||"unknown";
const nodeId=nodeIdRaw.toLowerCase();
setTxt("nodeName",nodeIdRaw);

// --- daten laden (wie v0.12) ---
async function fetchJson(){
 const urls=["/data/v2/latest/all_enriched.json","/data/v2/latest/all.json"];
 for(const u of urls){
   try{const r=await fetch(u+"?_="+Date.now(),{cache:"no-store"});
     if(r.ok){const j=await r.json();if(Array.isArray(j))return{data:j,url:u}}}
   catch(e){}
 }
 throw new Error("keine daten");
}
const pick=(o,...k)=>{for(const x of k)if(o&&o[x]!=null)return o[x];return null};
function extractValues(n){const f=n.fields||n;return{
  leafTemp:pick(f,"Leaf_Temperature","leaf_temp_c"),
  leafMoist:pick(f,"Leaf_Moisture","leaf_moist_pct"),
  airTemp:pick(f,"TempC_SHT","TempC_SHT31","temp_c"),
  airHum:pick(f,"Hum_SHT","Hum_SHT31","hum_pct"),
  soilTemp:pick(f,"temp_SOIL","temp_soil_c"),
  soilWater:pick(f,"water_SOIL","water_soil"),
  bat:pick(f,"BatV","bat_v"),
  ts:pick(n,"ts","ts_iso","time")
}}

// --- links rendern ---
(async()=>{
 try{
  const {data}=await fetchJson();
  const multi=/schacht[_-]?audorf/.test(nodeId);
  const getId=o=>(o.id||o.device_id||"").toLowerCase();
  const byId=id=>data.find(o=>getId(o)===id);
  const vals={leaf:{},air:{},soil:{}};
  if(multi){
    const leaf=byId("schacht_audorf_llms01"),air=byId("schacht_audorf_s31lb"),soil=byId("schacht_audorf_se01lb");
    if(leaf){$("secLeaf").style.display="";Object.assign(vals.leaf,extractValues(leaf));}
    if(air){$("secAir").style.display="";Object.assign(vals.air,extractValues(air));}
    if(soil){$("secSoil").style.display="";Object.assign(vals.soil,extractValues(soil));}
    $("secWx").style.display="";
  }else{
    const n=data.find(o=>getId(o).includes(nodeId));
    if(n){$("secAir").style.display="";Object.assign(vals.air,extractValues(n));}
  }
  const latest=[vals.leaf.ts,vals.air.ts,vals.soil.ts].filter(Boolean).sort((a,b)=>new Date(b)-new Date(a))[0];
  if(latest)setTxt("stand","Stand: "+fmtDate(latest));
  setTxt("leafTemp",fmtNum(vals.leaf.leafTemp,1," Â°C"));
  setTxt("leafMoist",fmtNum(vals.leaf.leafMoist,1," %"));
  setTxt("leafBat",fmtNum(vals.leaf.bat,2," V"));
  setTxt("airTemp",fmtNum(vals.air.airTemp,1," Â°C"));
  setTxt("airHum",fmtNum(vals.air.airHum,1," %"));
  setTxt("airBat",fmtNum(vals.air.bat,2," V"));
  setTxt("soilTemp",fmtNum(vals.soil.soilTemp,1," Â°C"));
  setTxt("soilWater",fmtNum(vals.soil.soilWater,1," %"));
  setTxt("soilBat",fmtNum(vals.soil.bat,2," V"));
 }catch(e){console.warn(e);}
})();

// --- netz + ranking ---
(async()=>{
 const base=nodeIdRaw.replace(/[-_](llms01|s31lb|se01lb)$/i,"");
 const netUrl=`/data/v2/net/netstats_${encodeURIComponent(base)}.json`;
 $("netSource").textContent="Quelle: "+netUrl;
 try{
  const r=await fetch(netUrl,{cache:"no-store"});
  if(!r.ok)throw new Error();
  const ns=await r.json();
  setTxt("frames24",ns.frames24??"0");
  setTxt("lastUplink",fmtDate(ns.last_ts));
  setTxt("gwCount",ns.gateways??"â€”");
  setTxt("bestSig",ns.best?`${ns.best.rssi??"â€”"} dBm / ${ns.best.snr??"â€”"} dB`:"â€”");
  setTxt("adr",ns.adr??"â€”");
  const exp=+ns.expected24||0,got=+ns.frames24||0,lost=Math.max(0,exp-got);
  let loss=exp>0?(lost/exp)*100:100;loss=Math.min(100,Math.max(0,loss));
  const b=$("lossBadge");b.textContent=loss.toFixed(0)+" %";
  b.className="bar "+(loss<=15?"green":loss<=35?"yellow":"red");
  // ranking
  const all=await fetch("/data/v2/latest/all.json",{cache:"no-store"}).then(r=>r.json());
  const ids=[...new Set(all.map(x=>(x.id||x.device_id||"").replace(/[-_](llms01|s31lb|se01lb)$/i,"")))];
  const scores=[];
  for(const id of ids){
    const n=all.filter(x=>(x.id||x.device_id||"").startsWith(id));
    const bats=n.map(x=>+x.BatV||+x.bat_v||0);
    const bat=bats.length?Math.max(...bats):0;
    let tScore=0,sScore=0;
    try{
      const r2=await fetch(`/data/v2/net/netstats_${id}.json`,{cache:"no-store"});
      if(r2.ok){const j=await r2.json();
        const e2=+j.expected24||0,g2=+j.frames24||0,snr=+j.best_snr||0;
        tScore=e2?Math.min(100,(g2/e2)*100):0;
        sScore=Math.min(100,Math.max(0,((snr+10)/20)*100)));
      }
    }catch{}
    const bScore=Math.min(100,Math.max(0,((bat-3.2)/0.6)*100)));
    scores.push({id,score:0.7*tScore+0.2*sScore+0.1*bScore});
  }
  scores.sort((a,b)=>b.score-a.score);
  const rank=scores.findIndex(x=>x.id===base)+1;
  setTxt("rank",rank||"â€”");
  setTxt("rankTotal",scores.length);
  const me=scores.find(x=>x.id===base);
  setTxt("score",me?me.score.toFixed(1)+" Punkte":"0 Punkte");
 }catch(e){console.warn("netz/rank fail",e);}
})();
</script>
</body>
</html>
