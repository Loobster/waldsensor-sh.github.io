<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî ‚Ä¶</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#f6f8fb; --card:#fff; --muted:#8a93a3; --ink:#0d1b2a;
      --ok:#dff6e5; --pill:#0f766e; --soft:#e9edf3;
      --pad:16px; --radius:14px;
    }
    html, body { margin:0; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif; }
    .wrap { max-width: 1180px; margin: 0 auto; padding: 20px; }
    h1 { font-weight: 800; letter-spacing: .2px; margin: 6px 0 18px; font-size: clamp(26px,4vw,40px); }
    .row { display: grid; gap: 18px; grid-template-columns: 1fr; }
    @media (min-width: 980px) { .row { grid-template-columns: 1.1fr .9fr; } }
    .card { background:var(--card); border-radius: var(--radius); box-shadow: 0 1px 0 rgba(0,0,0,.04), 0 10px 30px -20px rgba(0,0,0,.15); padding: var(--pad); }
    .pill { display:inline-block; padding:6px 10px; border-radius: 999px; background: var(--ok); color:#115e59; font-weight:700; font-size:14px; }
    .grid3 { display:grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 700px){ .grid3 { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 980px){ .grid3 { grid-template-columns: repeat(3, 1fr); } }
    .tile { background:#eef2f7; border-radius:12px; padding:14px 16px; min-height:86px; display:flex; flex-direction:column; justify-content:center; }
    .k { color: var(--muted); font-size: 14px; margin-bottom: 6px; }
    .v { font-size: 22px; font-weight: 800; letter-spacing:.2px; }
    .muted { color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    canvas { max-height: 360px; }
    .hint { margin-top: 8px; font-size: 13px; color: var(--muted); }
    .section-title { display:flex; align-items:center; gap:8px; font-weight:800; margin:0 0 10px; }
    .small { font-size:13px; color: var(--muted); }
    a.back { text-decoration:none; color:#2563eb; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom:8px;"><a class="back" href="/v2.html">‚Üê Zur Karte</a></div>
    <h1>Schulwaldsensor ‚Äî <span id="nodeTitle">‚Ä¶</span></h1>

    <div class="row">
      <div class="card">
        <div style="margin-bottom:10px;">
          <span class="pill">Stand: <span id="stand">‚Äî</span></span>
        </div>
        <div class="grid3">
          <div class="tile">
            <div class="k">Temperatur</div>
            <div class="v" id="temp">‚Äî</div>
          </div>
          <div class="tile">
            <div class="k" id="humLabel">Luftfeuchte</div>
            <div class="v" id="hum">‚Äî</div>
          </div>
          <div class="tile" style="grid-column:1/-1">
            <div class="k">Batterie</div>
            <div class="v" id="bat">‚Äî</div>
          </div>
        </div>
        <div class="hint">Quelle: <span class="mono">/data/v2/latest/_all.json</span></div>
      </div>

      <div class="card">
        <div class="section-title">Aktuelle Werte</div>
        <div class="small" id="aktuell">‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üìä Verlauf Temperatur & Luftfeuchtigkeit</div>
      <canvas id="chartHourly"></canvas>
      <div class="hint">Sucht: <span class="mono">/data/v2/history/&lt;node&gt;.json</span></div>
      <div class="small" id="noHourly" style="margin-top:8px; display:none;">Kein Verlauf gefunden.</div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <canvas id="chartDaily"></canvas>
      <div class="small" id="noDaily" style="margin-top:8px; display:none;">Keine Tageswerte m√∂glich (es fehlt Verlauf).</div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const byId = (id) => document.getElementById(id);
    const fmt = (n, digits=1) => (n===null||n===undefined||Number.isNaN(n)) ? "‚Äî" : Number(n).toFixed(digits).replace(".", ",");
    const parseTS = (s) => new Date(s);
    const isSoilNode = (id) => id === "se01"; // Sonderfall: Bodenf√ºhler
    const SHORT_LABELS = {
      "TempC_SHT": "Temperatur",
      "TempC_SHT31": "Temperatur",
      "Hum_SHT": "Luftfeuchte",
      "Hum_SHT31": "Luftfeuchte",
      "temp_SOIL": "Bodentemperatur",
      "water_SOIL": "Bodenwasser"
    };

    // Node-Name aus URL (query, hash, pfad) + s√§ubern
    function detectNode() {
      const url = new URL(window.location.href);
      const q = (url.searchParams.get("node") || url.searchParams.get("id") || "").trim();
      const h = (url.hash || "").replace(/^#/, "");
      const hashParam = new URLSearchParams(h).get("node") || "";
      let fromPath = (location.pathname.split("/").pop() || "").replace(/\.html?$/,"");
      if (fromPath === "sensor") fromPath = ""; // Standard-Dateiname

      let raw = q || hashParam || fromPath || "";
      raw = raw.replace(/[\r\n]+/g, "").trim();
      return raw || null;
    }

    // Live-Datei laden
    async function loadLatest() {
      const res = await fetch("/data/v2/latest/_all.json", {cache:"no-store"});
      if (!res.ok) throw new Error("Live-Datei nicht erreichbar");
      const arr = await res.json();
      // IDs s√§ubern
      return arr.map(x => ({...x, id: (x.id||"").replace(/[\r\n]+/g,"").trim()}));
    }

    function pickFieldsForNode(entry) {
      const f = entry.fields || {};
      // Standard
      let temp = f.TempC_SHT ?? f.TempC_SHT31 ?? null;
      let hum  = f.Hum_SHT   ?? f.Hum_SHT31   ?? null;
      let bat  = f.BatV ?? null;
      let humLabel = "Luftfeuchte";

      if (isSoilNode(entry.id)) {
        // Sonderfall Boden: eigene Labels und Werte
        temp = f.temp_SOIL ?? null;
        hum  = f.water_SOIL ?? null;
        humLabel = "Bodenwasser";
      }

      return { temp, hum, bat, humLabel };
    }

    // Historie laden (array von {ts, t, h})
    async function loadHistory(nodeId) {
      const url = `/data/v2/history/${encodeURIComponent(nodeId)}.json`;
      const res = await fetch(url, {cache:"no-store"});
      if (!res.ok) return [];
      let data = await res.json();
      // robust gegen Nulls / falsche Reihenfolge
      data = (Array.isArray(data) ? data : []).filter(x => x && x.ts);
      // sortieren nach Zeit
      data.sort((a,b) => new Date(a.ts) - new Date(b.ts));
      return data;
    }

    // Chart-Helfer
    let chartHourly, chartDaily;
    function ensureChart(ctx, type, data, options) {
      if (ctx._chart) ctx._chart.destroy();
      ctx._chart = new Chart(ctx, { type, data, options });
      return ctx._chart;
    }

    function makeHourlyChart(ctx, items, soilMode) {
      if (!items.length) return null;
      const labels = items.map(x => x.ts);
      const temps  = items.map(x => x.t);
      const hums   = items.map(x => x.h);

      const tLabel = soilMode ? "Bodentemperatur [¬∞C]" : "Temperatur [¬∞C]";
      const hLabel = soilMode ? "Bodenwasser [%]"     : "Luftfeuchte [%]";

      const data = {
        labels,
        datasets: [
          { label: tLabel, data: temps, yAxisID:'y1' },
          { label: hLabel, data: hums, yAxisID:'y2' }
        ]
      };
      const options = {
        responsive:true,
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ ticks:{ callback: (v, i) => {
            const d = new Date(labels[i]); 
            return d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"})+" "+d.toLocaleTimeString("de-DE",{hour:"2-digit"})+"h";
          }}},
          y1:{ position:'left', title:{display:true, text: tLabel}, suggestedMin: -10, suggestedMax: 40, grid:{drawOnChartArea:false}},
          y2:{ position:'right', title:{display:true, text: hLabel}, suggestedMin: 0, suggestedMax: 100 }
        },
        plugins:{ legend:{ position:'top' } }
      };
      return ensureChart(ctx, 'line', data, options);
    }

    function groupDailyMeans(items) {
      const m = new Map();
      for (const it of items) {
        const d = new Date(it.ts);
        const key = d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,"0")+"-"+String(d.getUTCDate()).padStart(2,"0");
        if (!m.has(key)) m.set(key, {n:0, tSum:0, hSum:0});
        const rec = m.get(key);
        if (typeof it.t === "number") { rec.tSum += it.t; }
        if (typeof it.h === "number") { rec.hSum += it.h; }
        rec.n++;
      }
      const out = [];
      for (const [k,v] of m.entries()) {
        out.push({ day:k, t: v.n? v.tSum/v.n : null, h: v.n? v.hSum/v.n : null });
      }
      // auf 31 Tage beschr√§nken (letzte 31)
      out.sort((a,b) => a.day.localeCompare(b.day));
      return out.slice(-31);
    }

    function makeDailyChart(ctx, days, soilMode) {
      if (!days.length) return null;
      const labels = days.map(x => x.day);
      const temps  = days.map(x => x.t);
      const hums   = days.map(x => x.h);

      const tLabel = soilMode ? "√ò Bodentemperatur [¬∞C]" : "√ò Temperatur [¬∞C]";
      const hLabel = soilMode ? "√ò Bodenwasser [%]"     : "√ò Luftfeuchte [%]";

      const data = {
        labels,
        datasets: [
          { type:'bar', label: hLabel, data: hums, yAxisID:'y2' },
          { type:'line', label: tLabel, data: temps, yAxisID:'y1' }
        ]
      };
      const options = {
        responsive:true,
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ ticks:{ maxRotation:0, autoSkip:true } },
          y1:{ position:'left', title:{display:true, text: tLabel}, suggestedMin:-10, suggestedMax:40, grid:{drawOnChartArea:false}},
          y2:{ position:'right', title:{display:true, text: hLabel}, suggestedMin:0, suggestedMax:100 }
        },
        plugins:{ legend:{ position:'top' } }
      };
      return ensureChart(ctx, 'bar', data, options);
    }

    // ---------- Hauptlogik ----------
    async function main() {
      // 1) Node bestimmen
      const requested = detectNode();

      // 2) Live-Liste laden + passenden Eintrag finden (mit Fallback auf ersten)
      const latest = await loadLatest();
      let entry = null;
      if (requested) {
        entry = latest.find(x => x.id === requested)
             || latest.find(x => x.id.toLowerCase() === requested.toLowerCase());
      }
      if (!entry) entry = latest[0]; // Fallback

      const nodeId = entry.id;
      const soilMode = isSoilNode(nodeId);

      // 3) Seitentitel & Pill
      byId("nodeTitle").textContent = nodeId;
      byId("stand").textContent = entry.ts
        ? new Date(entry.ts).toLocaleString("de-DE")
        : "‚Äî";

      // 4) Live-Werte aufbereiten
      const { temp, hum, bat, humLabel } = pickFieldsForNode(entry);
      byId("temp").textContent = temp!==null ? fmt(temp, 1) + " ¬∞C" : "‚Äî";
      byId("humLabel").textContent = humLabel;
      byId("hum").textContent  = hum!==null  ? fmt(hum, 1)  + " %"  : "‚Äî";
      byId("bat").textContent  = bat!==null  ? fmt(bat, 3)  + " V"  : "‚Äî";

      // Rechte Spalte kompakt
      const parts = [];
      parts.push(`üå°Ô∏è Temperatur: <b>${byId("temp").textContent}</b>`);
      parts.push(`${soilMode ? "üíß Bodenwasser" : "üíß Luftfeuchte"}: <b>${byId("hum").textContent}</b>`);
      parts.push(`ü™´ Batterie: <b>${byId("bat").textContent}</b>`);
      byId("aktuell").innerHTML = parts.join("<br>");

      // 5) Historie laden
      const hist = await loadHistory(nodeId);

      // 5a) Verlauf (letzte 7 Tage)
      const sevenDaysAgo = Date.now() - 7*24*3600*1000;
      const recent = hist.filter(x => new Date(x.ts).getTime() >= sevenDaysAgo);
      const ctxH = byId("chartHourly").getContext("2d");
      if (!recent.length) {
        byId("noHourly").style.display = "block";
      } else {
        byId("noHourly").style.display = "none";
        chartHourly = makeHourlyChart(ctxH, recent, soilMode);
      }

      // 5b) Tagesmittel 31 Tage
      const days = groupDailyMeans(hist);
      const ctxD = byId("chartDaily").getContext("2d");
      if (!days.length) {
        byId("noDaily").style.display = "block";
      } else {
        byId("noDaily").style.display = "none";
        chartDaily = makeDailyChart(ctxD, days, soilMode);
      }
    }

    // Fehlerfreundlich starten
    (async () => {
      try {
        await main();
      } catch (err) {
        console.error(err);
        alert("Fehler auf der Statistik-Seite: " + (err?.message || err));
      }
    })();
  </script>
</body>
</html>
