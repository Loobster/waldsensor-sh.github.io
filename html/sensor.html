<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH â€“ Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="version" content="v0.17" />
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bg:#f6f8fa;
      --card:#fff; --shadow:0 2px 6px rgba(0,0,0,.08);
      --leaf:#e6f4ea; --air:#eaf2ff; --soil:#f7f1e6; --other:#f2f2f2;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header{background:#004d46;color:#fff;padding:.8em 1em;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    header a{color:#fff;text-decoration:none}
    main{display:grid;grid-template-columns:1fr 1fr;gap:1em;padding:1em}
    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:1em;}
    .pill{display:inline-block;background:#dff6e6;color:#135e3d;padding:.25em .8em;border-radius:999px;font-size:.9em;margin-bottom:.6em}
    .section{border-radius:10px;padding:.8em 1em;margin:.6em 0;}
    .section h4{margin:.2em 0 .6em;font-size:1.05em}
    .tiles{display:flex;gap:12px;flex-wrap:wrap}
    .tile{flex:1 1 30%;background:#f4f6f8;border-radius:8px;padding:.7em;text-align:center;min-width:110px}
    .tile h3{margin:0 0 .25em;font-size:.85em;color:#4b5563;font-weight:600}
    .tile p{margin:0;font-size:1.1em;font-weight:800}
    .small-note{font-size:.85em;color:#6b7280}
    footer{text-align:center;padding:1em;color:#666;font-size:.9em}
    /* Neues Layout: max. 3 SensorblÃ¶cke pro Spalte */
    #sensorSections{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));
      gap:0.8em;
    }
    @media(max-width:980px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <a href="../v2.html">&larr; Zur Karte</a>
  <div>Schulwaldsensor â€” <span id="nodeName"></span> <small>v0.17</small></div>
</header>

<main>
  <div class="card" id="sensorCard">
    <div id="stand" class="pill">Stand: â€”</div>
    <div id="sensorSections"></div>
    <div class="small-note">Quelle: /data/v2/latest/all.json</div>
  </div>

  <div class="card" id="netCard">
    <h3>Netz & Gateways</h3>
    <p>Letzte 24 h: <span id="frames24">â€”</span> Uplinks</p>
    <p>Letzter Uplink: <span id="lastUplink">â€”</span></p>
    <p>Gateways: <span id="gwCount">â€”</span></p>
    <p>Ã˜ Batterie: <span id="avgBat">â€”</span></p>
    <p>Bestes Signal: <span id="bestSig">â€”</span></p>
    <p>ADR: <span id="adr">â€”</span></p>
    <div class="small-note" id="netSource">Quelle: â€”</div>
  </div>
</main>

<footer>WALDSENSOR.SH â€“ Sensordetails</footer>

<script>
const $=id=>document.getElementById(id);
const fmtNum=(v,d=1,s="")=>v==null||!isFinite(+v)?"â€”":(+v).toFixed(d).replace(".",",")+s;
const fmtDate=ts=>!ts?"â€”":new Date(ts).toLocaleString("de-DE");
const qp=new URLSearchParams(location.search);
const nodeIdRaw=qp.get("node")||"unknown"; $("nodeName").textContent=nodeIdRaw;

// Lade Daten
async function fetchJson(){
  const urls=["/data/v2/latest/all_enriched.json","/data/v2/latest/all.json"];
  for(const u of urls){
    try{const r=await fetch(u+"?_="+Date.now()); if(r.ok){const j=await r.json(); if(Array.isArray(j))return j;}}catch(e){}
  } throw new Error("keine Daten");
}

// Sensorwerte extrahieren
const pick=(o,...keys)=>{for(const k of keys)if(o&&o[k]!=null)return o[k];return null;};
function extractValues(n){
  const f=n.fields||n;
  return{
    temp:pick(f,"TempC_SHT","TempC_SHT31","temp_c","Leaf_Temperature","temp_SOIL"),
    hum :pick(f,"Hum_SHT","Hum_SHT31","hum_pct","Leaf_Moisture","water_SOIL"),
    bat :pick(f,"BatV","bat_v"),
    ts  :pick(n,"ts","ts_iso","time")
  };
}

// Kategorie anhand Feldnamen oder IDs
function detectType(id,fields){
  id=id.toLowerCase();
  const f=Object.keys(fields||{}).join(" ").toLowerCase();
  if(/leaf|llms/.test(id+f)) return "leaf";
  if(/sht|air|s31|sn50/.test(id+f)) return "air";
  if(/soil|se01|water/.test(id+f)) return "soil";
  return "other";
}

// Farben pro Typ
const colors={leaf:"var(--leaf)",air:"var(--air)",soil:"var(--soil)",other:"var(--other)"};
const titles={leaf:"ðŸŒ¿ Blatt-Sensor",air:"ðŸŒ¡ï¸ Luft-Sensor",soil:"ðŸŒ± Boden-Sensor",other:"ðŸ§© Sonstige Sensorik"};

// Render dynamisch
(async()=>{
  try{
    const all=await fetchJson();
    const base=nodeIdRaw.toLowerCase().split(/[_-]/)[0];  // Standortbasis
    const nodes=all.filter(o=>o.id?.toLowerCase().startsWith(base));
    if(nodes.length===0) throw new Error("kein Node gefunden");

    // Gruppiere nach Typ
    const grouped={};
    for(const n of nodes){
      const t=detectType(n.id,n.fields);
      grouped[t]=grouped[t]||[];
      grouped[t].push(n);
    }

    // Zeit bestimmen
    const latestTs=nodes.map(n=>extractValues(n).ts).filter(Boolean).sort((a,b)=>new Date(b)-new Date(a))[0];
    if(latestTs)$("stand").textContent="Stand: "+fmtDate(latestTs);

    // Rendering
    const container=$("sensorSections");
    container.innerHTML="";
    const typesOrder=["leaf","air","soil","other"]; // sortiert anzeigen

    let count=0;
    for(const typ of typesOrder){
      const arr=grouped[typ];
      if(!arr) continue;
      for(const n of arr){
        const vals=extractValues(n);
        const sec=document.createElement("div");
        sec.className="section";
        sec.style.background=colors[typ]||"var(--other)";
        sec.innerHTML=`
          <h4>${titles[typ]||typ}</h4>
          <div class="tiles">
            <div class="tile"><h3>Temperatur</h3><p>${fmtNum(vals.temp,1," Â°C")}</p></div>
            <div class="tile"><h3>Feuchte</h3><p>${fmtNum(vals.hum,1," %")}</p></div>
            <div class="tile"><h3>Batterie</h3><p>${fmtNum(vals.bat,2," V")}</p></div>
          </div>`;
        container.appendChild(sec);
        count++;
      }
    }
  }catch(e){console.error(e);}
})();

// Netzdaten
const netUrl=`/data/v2/net/netstats_${encodeURIComponent(nodeIdRaw)}.json`;
$("netSource").textContent="Quelle: "+netUrl;
fetch(netUrl).then(r=>r.ok?r.json():null).then(ns=>{
  if(!ns)return;
  if(ns.frames24!=null)$("frames24").textContent=ns.frames24;
  $("lastUplink").textContent=fmtDate(ns.last_ts);
  if(typeof ns.gateways==="number")$("gwCount").textContent=ns.gateways;
  if(ns.best)$("bestSig").textContent=`${ns.best.rssi??"â€”"} dBm / ${ns.best.snr??"â€”"} dB`;
  if(ns.adr!=null)$("adr").textContent=String(ns.adr);
  if(ns.avg_bat_v!=null)$("avgBat").textContent=fmtNum(ns.avg_bat_v,2," V");
});
</script>
</body>
</html>
