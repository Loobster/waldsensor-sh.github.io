<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>WALDSENSOR.SH â€“ Sensoransicht</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
    }
    header {
      background: #2c3e50;
      color: #fff;
      padding: 12px 20px;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    main {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 12px;
    }
    section {
      margin-bottom: 32px;
    }
    .card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸŒ³ WALDSENSOR.SH â€“ Sensoransicht</h1>
  </header>

  <main>
    <!-- Aktuelle Daten -->
    <section>
      <div class="card">
        <h2>Aktuelle Werte</h2>
        <pre id="latestBox">Lade aktuelle Datenâ€¦</pre>
      </div>
    </section>

    <!-- Verlauf -->
    <section id="history" style="max-width:1200px;margin:24px auto;padding:12px">
      <h2 style="margin:0 0 12px">Verlauf (7 Tage, 1h-Mittel)</h2>

      <label for="nodeSel" style="font-weight:600">Node:</label>
      <select id="nodeSel" style="margin:0 12px 12px 8px;padding:4px 6px">
        <option>breklum</option>
        <option>fahrdorf</option>
        <option>kropp</option>
        <option>lsn50</option>
        <option>s31</option>
        <option>se01</option>
      </select>
      <button id="reloadBtn" style="padding:4px 8px">Neu laden</button>

      <div id="histWrap" style="display:grid;gap:16px;grid-template-columns:1fr; margin-top:8px">
        <div style="background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <strong id="tTitle">Temperatur (Â°C)</strong>
            <small id="tMeta" style="opacity:.7"></small>
          </div>
          <canvas id="tChart" height="220" style="width:100%"></canvas>
        </div>

        <div style="background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <strong id="hTitle">rel. Feuchte (%)</strong>
            <small id="hMeta" style="opacity:.7"></small>
          </div>
          <canvas id="hChart" height="220" style="width:100%"></canvas>
        </div>
      </div>
    </section>
  </main>

<script>
(async function(){
  const $ = sel => document.querySelector(sel);
  const fmtDate = iso => {
    try { return new Date(iso).toLocaleString('de-DE'); } catch { return iso; }
  };

  // --- Aktuelle Daten aus _all.json laden ---
  async function loadLatest() {
    const url = "data/v2/latest/_all.json";
    const resp = await fetch(url,{cache:"no-store"});
    if(!resp.ok) throw new Error("Fehler beim Laden: "+resp.status);
    const arr = await resp.json();
    $("#latestBox").textContent = JSON.stringify(arr,null,2);
  }
  loadLatest();

  // --- History Charts ---
  function drawLineChart(canvas, series, {yLabel='', color='#1f77b4'}={}) {
    const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.clientWidth;
    const H = canvas.height;
    ctx.clearRect(0,0,W,H);
    ctx.font = '12px system-ui, sans-serif';
    ctx.fillStyle = '#222';

    if (!series || !series.length) {
      ctx.fillText('Keine Daten', 10, 18);
      return;
    }

    const P = {l:50,r:16,t:10,b:28};
    const xs = series.map(d => +new Date(d.ts));
    const ys = series.map(d => d.v);
    const minX=Math.min(...xs), maxX=Math.max(...xs);
    let minY=Math.min(...ys), maxY=Math.max(...ys);
    if(minY===maxY){minY-=1;maxY+=1;}
    const xToPx=x=>P.l+((x-minX)/(maxX-minX||1))*(W-P.l-P.r);
    const yToPx=y=>H-P.b-((y-minY)/(maxY-minY||1))*(H-P.t-P.b);

    ctx.strokeStyle='#ccc';ctx.beginPath();
    ctx.moveTo(P.l,H-P.b);ctx.lineTo(W-P.r,H-P.b);
    ctx.moveTo(P.l,P.t);ctx.lineTo(P.l,H-P.b);ctx.stroke();

    ctx.fillStyle='#666';ctx.textAlign='right';ctx.textBaseline='middle';
    for(let i=0;i<=5;i++){
      const yv=minY+i*(maxY-minY)/5;
      const py=yToPx(yv);
      ctx.strokeStyle='#eee';ctx.beginPath();ctx.moveTo(P.l,py);ctx.lineTo(W-P.r,py);ctx.stroke();
      ctx.fillText(yv.toFixed(0),P.l-6,py);
    }

    ctx.textAlign='center';ctx.textBaseline='top';
    const N=Math.max(1,Math.floor(series.length/8));
    for(let i=0;i<series.length;i+=N){
      const px=xToPx(+new Date(series[i].ts));
      ctx.fillText(new Date(series[i].ts).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'}),px,H-P.b+6);
    }

    ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();
    series.forEach((d,i)=>{const x=xToPx(+new Date(d.ts)), y=yToPx(d.v);if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
    ctx.stroke();
  }

  function pickFields(node,row){
    if('t' in row || 'h' in row) return {t:row.t??null,h:row.h??null};
    if(node==='se01'){
      const t=row.t_soil??row.temp_SOIL??null;
      const h=row.h_soil??row.water_SOIL??null;
      return {t,h};
    }
    const t=row.TempC_SHT31??row.TempC_SHT??null;
    const h=row.Hum_SHT31??row.Hum_SHT??null;
    return {t,h};
  }

  async function loadHistory(node){
    const url=`data/v2/history/${node}.json`;
    const r=await fetch(url,{cache:'no-store'});
    if(!r.ok) return [];
    const arr=await r.json();
    return arr.map(d=>{const {t,h}=pickFields(node,d);return{ts:d.ts,t:+t||null,h:+h||null};})
              .filter(d=>d.t!=null||d.h!=null);
  }

  function updateTitles(node){
    if(node==='se01'){
      $('#tTitle').textContent='Boden-Temperatur (Â°C)';
      $('#hTitle').textContent='Bodenfeuchte (%)';
    } else {
      $('#tTitle').textContent='Temperatur (Â°C)';
      $('#hTitle').textContent='rel. Feuchte (%)';
    }
  }

  async function renderNode(node){
    updateTitles(node);
    const data=await loadHistory(node);
    const tSeries=data.filter(d=>d.t!=null).map(d=>({ts:d.ts,v:d.t}));
    const hSeries=data.filter(d=>d.h!=null).map(d=>({ts:d.ts,v:d.h}));
    drawLineChart($('#tChart'),tSeries,{yLabel:'Temp'});
    drawLineChart($('#hChart'),hSeries,{yLabel:'Hum'});
    $('#tMeta').textContent=tSeries.length?`${tSeries.length} Punkte â€¢ bis ${fmtDate(tSeries.at(-1).ts)}`:'â€”';
    $('#hMeta').textContent=hSeries.length?`${hSeries.length} Punkte â€¢ bis ${fmtDate(hSeries.at(-1).ts)}`:'â€”';
  }

  const sel=$('#nodeSel');
  $('#reloadBtn').addEventListener('click',()=>renderNode(sel.value));
  sel.addEventListener('change',()=>renderNode(sel.value));
  renderNode(sel.value);
})();
</script>
</body>
</html>
