<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH – Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="version" content="v0.20-safe" />
  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --bg:#f6f8fa;
      --card:#ffffff;
      --leaf:#e6f4ea;
      --air:#eaf2ff;
      --soil:#f7f1e6;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --tile-bg:#f4f6f8;
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{
      background:#004d46;color:#fff;padding:.8em 1em;
      font-weight:700;display:flex;justify-content:space-between;align-items:center
    }
    header a{color:#fff;text-decoration:none}
    main{padding:1em;display:grid;grid-template-columns:1fr 1fr;gap:1em}
    .card{background:var(--card);border-radius:12px;padding:1em;box-shadow:var(--shadow)}
    .pill{display:inline-block;background:#dff6e6;color:#135e3d;
      padding:.25em .8em;border-radius:999px;font-size:.9em;margin-bottom:.6em}
    .section{border-radius:10px;padding:.8em 1em;margin:.6em 0}
    .section.leaf{background:var(--leaf)}.section.air{background:var(--air)}.section.soil{background:var(--soil)}
    .section h4{margin:.2em 0 .6em;font-size:1.05em}
    .tiles{display:flex;gap:12px;flex-wrap:nowrap}
    .tile{flex:1 1 0;background:var(--tile-bg);border-radius:8px;
      padding:.7em;text-align:center;min-width:100px}
    .tile h3{margin:0 0 .25em;font-size:.85em;color:#4b5563;font-weight:600}
    .tile p{margin:0;font-size:1.1em;font-weight:800}
    .small-note{font-size:.85em;color:#6b7280}
    footer{margin-top:8px;text-align:center;color:#666;padding:1em;font-size:.9em}
    @media (max-width:980px){main{grid-template-columns:1fr}}

    /* Zusatz: Rankingfarben & Liste */
    .loss-badge{display:inline-block;padding:.15em .5em;border-radius:8px;font-weight:700}
    .loss-ok{background:#e7f8ef;color:#0f6c3f}
    .loss-mid{background:#fff6db;color:#8a5300}
    .loss-bad{background:#ffe2e2;color:#992a2a}
    .liga-list{margin:.25rem 0 0 1.25rem;padding:0}
    .liga-list li{margin:.2rem 0}
    .liga-me{font-weight:800}
    .muted{color:#6b7280;font-size:.9em}
  </style>
</head>
<body>
<header>
  <a href="../v2.html">&larr; Zur Karte</a>
  <div>Schulwaldsensor — <span id="nodeName"></span> <small>v0.20</small></div>
</header>

<main>
  <!-- Linke Seite: unverändert aus v0.18 -->
  <div class="card" id="leftCard">
    <div id="stand" class="pill">Stand: —</div>

    <div class="section leaf" id="secLeaf" style="display:none">
      <h4>🌿 Blatt-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="leafTemp">—</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="leafMoist">—</p></div>
        <div class="tile"><h3>Batterie</h3><p id="leafBat">—</p></div>
      </div>
    </div>

    <div class="section air" id="secAir" style="display:none">
      <h4>🌡️ Luft-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="airTemp">—</p></div>
        <div class="tile"><h3>Feuchte</h3><p id="airHum">—</p></div>
        <div class="tile"><h3>Batterie</h3><p id="airBat">—</p></div>
      </div>
    </div>

    <div class="section soil" id="secSoil" style="display:none">
      <h4>🌱 Boden-Sensor</h4>
      <div class="tiles">
        <div class="tile"><h3>Bodentemperatur</h3><p id="soilTemp">—</p></div>
        <div class="tile"><h3>Bodenfeuchte</h3><p id="soilWater">—</p></div>
        <div class="tile"><h3>Batterie</h3><p id="soilBat">—</p></div>
      </div>
    </div>

    <div class="small-note">Quelle: /data/v2/latest/all.json</div>
  </div>

  <!-- Rechte Seite: erweiterter Netz & Ranking Block -->
  <div class="card" id="netCard">
    <h3>Netz & Gateways</h3>

    <p>Letzte 24 h: <strong><span id="u24">—</span></strong> / 72 Uplinks</p>
    <p>Verlustquote: <span id="lossBadge" class="loss-badge">—</span></p>
    <p>Letzter Uplink: <span id="lastUplink">—</span></p>
    <p>Gateways: <span id="gwCount">—</span></p>
    <p>Ø Batterie: <span id="avgBat">—</span></p>
    <p>Bestes Signal: <span id="bestSig">—</span></p>
    <p>ADR: <span id="adr">—</span></p>
    <div class="muted" id="netSource">Quelle: —</div>

    <hr/>

    <h3>🏆 WALDSENSOR.SH-Liga</h3>
    <p>Punkte gesamt: <strong><span id="ligaScore">—</span></strong></p>
    <p>Platz im Landesvergleich: <strong><span id="ligaPlace">—</span></strong></p>
    <ol id="ligaTop" class="liga-list"></ol>
    <div class="muted">70 % Übertragung + 20 % Signal + 10 % Batterie</div>
    <div class="muted" id="ligaSource">Quelle: —</div>
  </div>
</main>

<footer>WALDSENSOR.SH – Sensordetails</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = id => document.getElementById(id);
  const fmt = (v,d=1,s="") => (v==null||!isFinite(+v))?"—":(+v).toFixed(d).replace(".",",")+s;
  const fmtDate=ts=>{if(!ts)return"—";const d=new Date(ts);return isNaN(d)?"—":d.toLocaleString("de-DE")};
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const qp=new URLSearchParams(location.search);
  const nodeIdRaw=qp.get("node")||"unknown";
  const nodeId=nodeIdRaw.toLowerCase();
  const nodeName=$("nodeName"); if(nodeName) nodeName.textContent=nodeIdRaw;

  // ------- Netz & Gateways -------
  const netUrl=`/data/v2/net/netstats_${encodeURIComponent(nodeIdRaw)}.json`;
  const nsEl=$("netSource"); if(nsEl) nsEl.textContent="Quelle: "+netUrl;

  fetch(netUrl,{cache:"no-store"})
  .then(r=>r.ok?r.json():null)
  .then(ns=>{
    if(!ns)return;
    const frames=Number(ns.frames24??ns.uplinks24??0);
    if($("u24")) $("u24").textContent=isFinite(frames)?frames:"—";

    const loss=clamp((72-(isFinite(frames)?frames:0))/72*100,0,100);
    const badge=$("lossBadge");
    if(badge){
      badge.textContent=`${Math.round(loss)} %`;
      badge.classList.remove("loss-ok","loss-mid","loss-bad");
      if(loss<10)badge.classList.add("loss-ok");
      else if(loss<30)badge.classList.add("loss-mid");
      else badge.classList.add("loss-bad");
    }
    if($("lastUplink")) $("lastUplink").textContent=fmtDate(ns.last_ts||ns.lastTs||ns.last);
    if($("gwCount")) $("gwCount").textContent=
       (typeof ns.gateways==="number"?ns.gateways:(Array.isArray(ns.gateways)?ns.gateways.length:"—"));
    if($("avgBat")) $("avgBat").textContent=fmt(ns.avg_bat_v??ns.avg_bat??ns.bat_v,2," V");
    const best=ns.best||{};
    const rssi=best.rssi??ns.best_rssi,snr=best.snr??ns.best_snr;
    if($("bestSig")){
      $("bestSig").textContent=(rssi!=null||snr!=null)?
        `${rssi??"–"} dBm / ${snr??"–"} dB`:"—";
    }
    if($("adr")) $("adr").textContent=String(ns.adr??ns.adr_enabled??"—");
    const scoreSelf=computeScore({frames24:frames,rssi,snr,bat:(ns.avg_bat_v??ns.bat_v)});
    if($("ligaScore")) $("ligaScore").textContent=`${scoreSelf} Punkte`;
  });

  // ------- Landesliga Top-10 -------
  const allUrl="/data/v2/net/netstats_all.json";
  const ls=$("ligaSource"); if(ls) ls.textContent="Quelle: "+allUrl;

  fetch(allUrl,{cache:"no-store"})
  .then(r=>r.ok?r.json():null)
  .then(all=>{
    if(!all||!Array.isArray(all))return;
    const rows=all.map(x=>{
      const id=(x.id||x.device_id||x.node||"").toLowerCase();
      const frames24=Number(x.frames24??x.uplinks24??0);
      const rssi=(x.best?.rssi??x.rssi??x.best_rssi);
      const snr =(x.best?.snr ??x.snr ??x.best_snr);
      const bat =(x.avg_bat_v??x.bat_v??x.avg_battery);
      return{id,name:(x.name||x.id||x.device_id||id),frames24,rssi,snr,bat};
    });
    rows.forEach(r=>r.score=computeScore(r));
    rows.sort((a,b)=>b.score-a.score);
    const total=rows.length;
    const place=Math.max(1,rows.findIndex(r=>r.id.includes(nodeId))+1);
    if($("ligaPlace")) $("ligaPlace").textContent=`${place} / ${total}`;
    const top=rows.slice(0,10);
    const ol=$("ligaTop"); if(!ol)return;
    ol.innerHTML="";
    top.forEach((r,i)=>{
      const li=document.createElement("li");
      li.className=r.id.includes(nodeId)?"liga-me":"";
      const det=[];
      if(isFinite(r.frames24))det.push(`${r.frames24}/72`);
      if(r.rssi!=null)det.push(`RSSI ${r.rssi} dBm`);
      if(r.snr !=null)det.push(`SNR ${r.snr} dB`);
      if(r.bat !=null)det.push(`${r.bat.toFixed?r.bat.toFixed(2):r.bat} V`);
      li.textContent=`${i+1}. ${r.name} — ${r.score} Pkt (${det.join(", ")})`;
      ol.appendChild(li);
    });
  });

  function computeScore({frames24=0,rssi=null,snr=null,bat=null}){
    const tx=clamp(frames24/72,0,1)*100;
    let sigParts=[];
    if(rssi!=null&&isFinite(+rssi)){
      const r=clamp((+rssi-(-130))/(-60-(-130)),0,1);
      sigParts.push(r);
    }
    if(snr!=null&&isFinite(+snr)){
      const s=clamp((+snr-(-20))/(10-(-20)),0,1);
      sigParts.push(s);
    }
    const sig=(sigParts.length?(sigParts.reduce((a,b)=>a+b,0)/sigParts.length):0)*100;
    let batPct=0;
    if(bat!=null&&isFinite(+bat))batPct=clamp((+bat-2.8)/(3.8-2.8),0,1)*100;
    const total=0.7*tx+0.2*sig+0.1*batPct;
    return Math.round(total);
  }
});
</script>
</body>
</html>
