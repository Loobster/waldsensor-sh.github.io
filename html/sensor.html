<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH ‚Äì Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="version" content="v0.19" />
  <style>
    :root{
      --ink:#0f172a;--muted:#64748b;--bg:#f6f8fa;--card:#fff;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --leaf:#e6f4ea;--air:#eaf2ff;--soil:#f7f1e6;
      --badge-green:#22c55e;--badge-yellow:#eab308;--badge-red:#ef4444;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);}
    header{background:#004d46;color:#fff;padding:.8em 1em;display:flex;justify-content:space-between;align-items:center;font-weight:700}
    header a{color:#fff;text-decoration:none}
    main{display:grid;grid-template-columns:1fr 1fr;gap:1em;padding:1em}
    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:1em;}
    .pill{display:inline-block;background:#dff6e6;color:#135e3d;padding:.25em .8em;border-radius:999px;font-size:.9em;margin-bottom:.6em}
    .section{border-radius:10px;padding:.8em 1em;margin:.6em 0;}
    .tiles{display:flex;gap:12px;flex-wrap:nowrap;justify-content:space-between;}
    .tile{flex:1;background:#f4f6f8;border-radius:8px;padding:.7em;text-align:center;min-width:90px;}
    .tile h3{margin:0 0 .25em;font-size:.85em;color:#4b5563;font-weight:600}
    .tile p{margin:0;font-size:1.1em;font-weight:800}
    .small-note{font-size:.85em;color:#6b7280}
    footer{text-align:center;padding:1em;color:#666;font-size:.9em}
    .badge{
      display:inline-block;padding:.2em .6em;border-radius:6px;
      color:#fff;font-weight:700;font-size:.85em;
    }
    .divider{border-top:1px solid #e5e7eb;margin:1em 0;}
    @media(max-width:980px){main{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <a href="../v2.html">&larr; Zur Karte</a>
  <div>Schulwaldsensor ‚Äî <span id="nodeName"></span> <small>v0.19</small></div>
</header>

<main>
  <div class="card" id="sensorCard">
    <div id="stand" class="pill">Stand: ‚Äî</div>
    <div id="sensorSections"></div>
    <div class="small-note">Quelle: /data/v2/latest/all.json</div>
  </div>

  <div class="card" id="netCard">
    <h3>Netz & Gateways</h3>
    <p>Letzte 24 h: <span id="uplinks">‚Äî</span></p>
    <p>Verlustquote: <span id="lossBadge" class="badge" style="background:var(--badge-red)">‚Äî</span></p>
    <p>Letzter Uplink: <span id="lastUplink">‚Äî</span></p>
    <p>Gateways: <span id="gwCount">‚Äî</span></p>
    <p>√ò Batterie: <span id="avgBat">‚Äî</span></p>
    <p>Bestes Signal: <span id="bestSig">‚Äî</span></p>
    <p>ADR: <span id="adr">‚Äî</span></p>
    <div class="small-note" id="netSource">Quelle: ‚Äî</div>

    <div class="divider"></div>

    <h3>üèÜ WALDSENSOR.SH-Liga</h3>
    <p>Punkte gesamt: <strong id="score">‚Äî</strong></p>
    <p>Platz im Landesvergleich: <span id="rank">‚Äî</span></p>
    <p class="small-note">70 % √úbertragung + 20 % Signal + 10 % Batterie</p>
    <div class="small-note" id="rankingSource">Quelle: /data/v2/net/netstats_all.json</div>
  </div>
</main>

<footer>WALDSENSOR.SH ‚Äì Sensordetails</footer>

<script>
const $=id=>document.getElementById(id);
const fmtNum=(v,d=1,s="")=>v==null||!isFinite(+v)?"‚Äî":(+v).toFixed(d).replace(".",",")+s;
const fmtDate=ts=>!ts?"‚Äî":new Date(ts).toLocaleString("de-DE");
const qp=new URLSearchParams(location.search);
const nodeIdRaw=qp.get("node")||"unknown"; $("nodeName").textContent=nodeIdRaw;

// --- Netzstatistiken ---
const netUrl=`/data/v2/net/netstats_${encodeURIComponent(nodeIdRaw)}.json`;
$("netSource").textContent="Quelle: "+netUrl;

fetch(netUrl).then(r=>r.ok?r.json():null).then(ns=>{
  if(!ns)return;
  // 24h-Daten
  const frames=ns.frames24||0;
  const possible=72;
  const loss=Math.max(0,possible-frames);
  const lossPct=possible?Math.round((loss/possible)*100):0;
  $("uplinks").textContent=`${frames} / ${possible} Uplinks`;
  // Farbige Anzeige
  const badge=$("lossBadge");
  badge.textContent=`${lossPct} %`;
  badge.style.background=lossPct<10?"var(--badge-green)":lossPct<30?"var(--badge-yellow)":"var(--badge-red)";
  // Restliche Felder
  $("lastUplink").textContent=fmtDate(ns.last_ts);
  $("gwCount").textContent=ns.gateways??"‚Äî";
  $("bestSig").textContent=ns.best?`${ns.best.rssi??"‚Äî"} dBm / ${ns.best.snr??"‚Äî"} dB`:"‚Äî";
  $("adr").textContent=ns.adr??"‚Äî";
  $("avgBat").textContent=fmtNum(ns.avg_bat_v,2," V");

  // Ranking
  const sigScore=(ns.best?.rssi&&ns.best?.snr)?Math.min(100,((ns.best.snr+20)*2)):50;
  const batScore=(ns.avg_bat_v?Math.min(100,(ns.avg_bat_v-3.0)*200):50);
  const score=Math.round(0.7*(100-lossPct)+0.2*sigScore+0.1*batScore);
  $("score").textContent=score+" Punkte";
  $("rank").textContent="Berechne...";
  // Beispielhaft: Ranking simuliert (sp√§ter per netstats_all.json)
  fetch("/data/v2/net/netstats_all.json").then(r=>r.ok?r.json():null).then(list=>{
    if(!list)return;
    const arr=list.map(o=>({id:o.id,score:o.score??0})).sort((a,b)=>b.score-a.score);
    const pos=arr.findIndex(x=>x.id===nodeIdRaw);
    $("rank").textContent=pos>=0?(pos+1)+" / "+arr.length:"‚Äì";
  });
});
</script>
</body>
</html>
