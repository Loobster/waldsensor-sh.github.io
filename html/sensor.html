<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî ‚Ä¶</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="/html/js/ssi.js" defer></script>

  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--muted:#8a93a3;--ink:#0d1b2a;
      --ok:#dff6e5;--pad:16px;--radius:14px
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    h1{font-weight:800;letter-spacing:.2px;margin:6px 0 18px;font-size:clamp(26px,4vw,40px)}
    .ver{font-size:12px;font-weight:700;color:#94a3b8;margin-left:8px}
    .row{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:980px){.row{grid-template-columns:1.15fr .85fr}}
    .card{background:var(--card);border-radius:var(--radius);
      box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15);padding:var(--pad)}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--ok);
      color:#115e59;font-weight:700;font-size:14px}
    .tiles{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:700px){.tiles{grid-template-columns:repeat(3,1fr)}}
    .tile{background:#eef2f7;border-radius:12px;padding:14px 16px;min-height:86px;
      display:flex;flex-direction:column;justify-content:center}
    .k{color:var(--muted);font-size:14px;margin-bottom:6px}
    .v{font-size:22px;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    canvas{max-height:360px}
    .hint{margin-top:8px;font-size:13px;color:var(--muted)}
    .section-title{font-weight:800;margin:0 0 10px}
    a.back{text-decoration:none;color:#2563eb;font-weight:600}
    .err{color:#b91c1c;font-weight:700}
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px 16px;align-items:center}
    .kv .label{color:var(--muted)}
    .kv .value{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="margin-bottom:8px;"><a class="back" href="/v2.html">‚Üê Zur Karte</a></div>
    <h1>Schulwaldsensor ‚Äî <span id="nodeTitle">‚Ä¶</span><small class="ver">v0.7</small></h1>

    <div class="row">
      <!-- Linke kompakte Karte -->
      <div class="card">
        <div style="margin-bottom:10px;">
          <span class="pill">Stand: <span id="stand">‚Äî</span></span>
        </div>
        <div class="tiles">
          <div class="tile"><div class="k" id="tempLabel">Temperatur</div><div class="v" id="temp">‚Äî</div></div>
          <div class="tile"><div class="k" id="humLabel">Luftfeuchte</div><div class="v" id="hum">‚Äî</div></div>
          <div class="tile"><div class="k">Batterie</div><div class="v" id="bat">‚Äî</div></div>
        </div>
        <div class="hint">Quelle: <span class="mono">/data/v2/latest/all.json</span></div>
      </div>

      <!-- Rechte Netzkarte -->
      <div class="card">
        <div class="section-title">Netz &amp; Gateways</div>
        <div class="kv">
          <div class="label">Letzte 24 h</div><div class="value" id="net24h">‚Äî Uplinks</div>
          <div class="label">Letzter Uplink</div><div class="value" id="netLast">‚Äî</div>
          <div class="label">Gateways</div><div class="value" id="netGws">‚Äî</div>
          <div class="label">Bestes Signal</div><div class="value" id="netBest">‚Äî</div>
          <div class="label">ADR</div><div class="value" id="netADR">‚Äî</div>
        </div>
        <div class="hint">Quelle: <span class="mono" id="netPath">‚Äî</span></div>
      </div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</div>
      <canvas id="chartHourly"></canvas>
      <div class="hint">Sucht: <span id="histPath" class="mono">/data/v2/history/&lt;node&gt;.json</span></div>
      <div class="hint err" id="histErr" style="display:none"></div>
      <div class="hint" id="noHourly" style="display:none">Kein Verlauf gefunden.</div>
    </div>

    <div class="card" style="margin-top:18px;">
      <div class="section-title">üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <canvas id="chartDaily"></canvas>
      <div class="hint" id="noDaily" style="display:none">Keine Tageswerte m√∂glich (es fehlt Verlauf).</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (n, d=1) => (n==null || Number.isNaN(n)) ? "‚Äî" : Number(n).toFixed(d).replace(".",",");

    // erkennt se01 und se01lb ‚Äì auch mit Pr√§fix/Suffix (z.B. bredstedt_se01lb)
    const isSoilNode = (id) => /(se01(lb)?)/i.test(String(id||""));

    function detectNode(){
      const u = new URL(location.href);
      let raw = (u.searchParams.get("node")||u.searchParams.get("id")||"").trim();
      if(!raw && location.hash){
        const sp = new URLSearchParams(location.hash.slice(1));
        raw = (sp.get("node")||"").trim();
      }
      if(!raw){
        let p = (location.pathname.split("/").pop()||"").replace(/\.html?$/,"");
        raw = (p==="sensor") ? "" : p;
      }
      return (raw||"").replace(/[\r\n]+/g,"").trim() || null;
    }

    async function loadLatest(){
      const r = await fetch("/data/v2/latest/all.json",{cache:"no-store"});
      if(!r.ok) throw new Error("Live-Quelle nicht erreichbar: "+r.status);
      const arr = await r.json();
      return arr.map(x=>({...x,id:(x.id||"").replace(/[\r\n]+/g,"").trim()}));
    }

    // Netzstatistiken ‚Äì robust parsen
    async function loadNetstats(node){
      const url = `/data/v2/net/netstats_${encodeURIComponent(node)}.json`;
      $("netPath").textContent = url;
      try{
        const r = await fetch(url,{cache:"no-store"});
        if(!r.ok) throw new Error("Netz-Quelle nicht erreichbar");
        const d = await r.json();

        $("net24h").textContent = `${d.frames24 ?? 0} Uplinks`;

        const last = d.last_ts ? new Date(d.last_ts) : null;
        $("netLast").textContent = last ? last.toLocaleString("de-DE") : "‚Äî";

        // Gateways als Anzahl oder Liste
        const gws = Array.isArray(d.gateways) ? d.gateways
                 : Array.isArray(d.last_gateways) ? d.last_gateways
                 : [];
        $("netGws").textContent = gws.length ? `${gws.length} GW` : "‚Äî";

        // Bestes Signal
        const bestRssi = d.best_rssi ?? (d.last_rssi ?? null);
        const bestSnr  = d.best_snr  ?? (d.last_snr  ?? null);
        $("netBest").textContent = (bestRssi!=null || bestSnr!=null)
          ? `${bestRssi!=null?bestRssi+" dBm":"‚Äî"} / ${bestSnr!=null?bestSnr+" dB":"‚Äî"}`
          : "‚Äî";

        $("netADR").textContent = (d.adr==null) ? "‚Äî" : (d.adr ? "Ein" : "Aus");
      }catch(e){
        $("net24h").textContent = "‚Äî Uplinks";
        $("netLast").textContent = "‚Äî";
        $("netGws").textContent  = "‚Äî";
        $("netBest").textContent = "‚Äî";
        $("netADR").textContent  = "‚Äî";
      }
    }

    // aktuelle Felder je Node-Typ
    function pickFields(entry){
      const f = entry.fields||{};
      const soil = isSoilNode(entry.id);
      if(soil){
        $("tempLabel").textContent = "Bodentemperatur";
        $("humLabel").textContent  = "Bodenwasser";
        return {temp: f.temp_SOIL ?? null, hum: f.water_SOIL ?? null, bat: f.BatV ?? null};
      }
      $("tempLabel").textContent = "Temperatur";
      $("humLabel").textContent  = "Luftfeuchte";
      return {
        temp: f.TempC_SHT ?? f.TempC_SHT31 ?? null,
        hum:  f.Hum_SHT   ?? f.Hum_SHT31   ?? null,
        bat:  f.BatV ?? null
      };
    }

    // History-Item in {ts, t, h} f√ºr Charts mappen
    function mapHistoryItem(it, soil){
      const f = it?.fields || {};
      if(soil){
        return { ts: it.ts, t: f.temp_SOIL ?? null, h: f.water_SOIL ?? null };
      }
      return { ts: it.ts, t: f.TempC_SHT ?? f.TempC_SHT31 ?? null, h: f.Hum_SHT ?? f.Hum_SHT31 ?? null };
    }

    async function loadHistory(node){
      const url = `/data/v2/history/${encodeURIComponent(node)}.json`;
      $("histPath").textContent = url;
      const r = await fetch(url,{cache:"no-store"});
      if(!r.ok){
        $("histErr").style.display="block";
        $("histErr").textContent = `Fehler beim Laden (${r.status}) von ${url}`;
        return [];
      }
      $("histErr").style.display="none";
      let data = await r.json();
      if(!Array.isArray(data)) return [];
      data = data.filter(x=>x && x.ts).sort((a,b)=>new Date(a.ts)-new Date(b.ts));
      return data;
    }

    function makeHourlyChart(ctx, items, soil){
      const labels = items.map(x=>x.ts);
      const temps  = items.map(x=>x.t);
      const hums   = items.map(x=>x.h);
      const tLabel = soil? "Bodentemperatur [¬∞C]":"Temperatur [¬∞C]";
      const hLabel = soil? "Bodenwasser [%]"    :"Luftfeuchte [%]";
      if(ctx._chart) ctx._chart.destroy();
      ctx._chart = new Chart(ctx,{type:'line',data:{
        labels,
        datasets:[{label:tLabel,data:temps,yAxisID:'y1'},{label:hLabel,data:hums,yAxisID:'y2'}]
      },options:{
        responsive:true,interaction:{mode:'index',intersect:false},
        scales:{
          x:{ticks:{callback:(v,i)=>{
            const d=new Date(labels[i]);
            return d.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit"})+" "+
                   d.toLocaleTimeString("de-DE",{hour:"2-digit"})+"h";
          }}},
          y1:{position:'left',title:{display:true,text:tLabel},grid:{drawOnChartArea:false}},
          y2:{position:'right',title:{display:true,text:hLabel},min:0,max:100}
        },plugins:{legend:{position:'top'}}
      }});
      return ctx._chart;
    }

    function makeDailyChart(ctx, days, soil){
      const labels = days.map(x=>x.day), temps=days.map(x=>x.t), hums=days.map(x=>x.h);
      const tLabel = soil? "√ò Bodentemperatur [¬∞C]":"√ò Temperatur [¬∞C]";
      const hLabel = soil? "√ò Bodenwasser [%]"    :"√ò Luftfeuchte [%]";
      if(ctx._chart) ctx._chart.destroy();
      ctx._chart = new Chart(ctx,{type:'bar',data:{
        labels,
        datasets:[{type:'bar',label:hLabel,data:hums,yAxisID:'y2'},{type:'line',label:tLabel,data:temps,yAxisID:'y1'}]
      },options:{
        responsive:true,interaction:{mode:'index',intersect:false},
        scales:{y1:{position:'left',title:{display:true,text:tLabel},grid:{drawOnChartArea:false}},
                y2:{position:'right',title:{display:true,text:hLabel},min:0,max:100}},
        plugins:{legend:{position:'top'}}
      }});
      return ctx._chart;
    }

    function groupDaily(items){
      const m = new Map();
      for(const it of items){
        const d = new Date(it.ts);
        const key = d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,"0")+"-"+String(d.getUTCDate()).padStart(2,"0");
        if(!m.has(key)) m.set(key,{n:0,tsum:0,hsum:0});
        const o = m.get(key);
        if(typeof it.t==="number") o.tsum+=it.t;
        if(typeof it.h==="number") o.hsum+=it.h;
        o.n++;
      }
      const out=[];
      for(const [k,v] of m.entries()) out.push({day:k,t:v.n? v.tsum/v.n:null,h:v.n? v.hsum/v.n:null});
      out.sort((a,b)=>a.day.localeCompare(b.day));
      return out.slice(-31);
    }

    (async ()=>{
      try{
        const wanted = detectNode();
        const latest = await loadLatest();

        // passenden Eintrag finden (case-insensitive Fallback)
        let entry = null;
        if(wanted){
          entry = latest.find(x=>x.id===wanted) || latest.find(x=>x.id.toLowerCase()===wanted.toLowerCase());
        }
        if(!entry) entry = latest[0];

        const node = entry.id;
        const soil = isSoilNode(node);

        $("nodeTitle").textContent = node;
        $("stand").textContent = entry.ts ? new Date(entry.ts).toLocaleString("de-DE") : "‚Äî";

        const {temp,hum,bat} = pickFields(entry);
        $("temp").textContent = temp!=null ? fmt(temp,1)+" ¬∞C" : "‚Äî";
        $("hum").textContent  = hum!=null  ? fmt(hum,1)+" %"  : "‚Äî";
        $("bat").textContent  = bat!=null  ? fmt(bat,3)+" V"  : "‚Äî";

        await loadNetstats(node);

        // Verlauf laden & auf (t,h) mappen
        let hist = await loadHistory(node);
        hist = hist.map(x => mapHistoryItem(x, soil));

        // Verlauf 7 Tage
        const seven = Date.now() - 7*24*3600*1000;
        const recent = hist.filter(x=>new Date(x.ts).getTime() >= seven);
        if(recent.length){
          $("noHourly").style.display="none";
          makeHourlyChart($("chartHourly").getContext("2d"), recent, soil);
        }else{
          $("noHourly").style.display="block";
        }

        // Tagesmittel 31 Tage
        const days = groupDaily(hist);
        if(days.length){
          $("noDaily").style.display="none";
          makeDailyChart($("chartDaily").getContext("2d"), days, soil);
        }else{
          $("noDaily").style.display="block";
        }
      }catch(e){
        console.error(e);
        $("histErr").style.display="block";
        $("histErr").textContent = "Fehler: "+(e?.message||e);
      }
    })();
  </script>
</body>
</html>
