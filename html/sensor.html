<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî Detail</title>

  <!-- schlichtes, unaufdringliches Styling ‚Äì l√§sst dein bestehendes Layout in Ruhe -->
  <style>
    :root {
      --bg: #f7f9fb;
      --panel: #ffffff;
      --muted: #6b7280;
      --txt: #0f172a;
      --ok: #16a34a;
      --card: #eef2f7;
      --border: #e5e7eb;
      --accent: #0ea5e9;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--txt); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; }
    a { color:var(--accent); text-decoration:none; }
    .wrap { max-width:1200px; margin:0 auto; padding:20px; }
    .back { display:inline-flex; align-items:center; gap:.5rem; font-weight:600; color:#2563eb; }
    h1 { font-size:clamp(26px, 3.4vw, 44px); margin:18px 0 10px; letter-spacing:.4px; }
    .grid { display:grid; gap:14px; grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1.3fr; } }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:18px; }
    .muted { color:var(--muted); }
    .row { display:flex; gap:14px; flex-wrap:wrap; }
    .pill { display:inline-block; background:#eaf7ee; color:#155e31; border-radius:999px; padding:6px 12px; font-weight:700; }
    .kpi { flex:1 1 220px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px 16px; min-height:74px; }
    .kpi h3 { margin:0 0 8px; font-size:15px; color:#111827; font-weight:600; }
    .kpi .v { font-size:22px; font-weight:800; letter-spacing:.3px; }
    .src { font-size:13px; color:var(--muted); margin-top:6px; }
    .section-title { display:flex; align-items:center; gap:10px; font-weight:800; margin:2px 0 10px; }
    .empty { color:var(--muted); font-size:14px; padding:10px 0 4px; }
    canvas { width:100%; height:280px; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f3f4f6; border:1px solid var(--border); border-radius:8px; padding:2px 6px; }
  </style>

  <!-- Chart.js nur f√ºr die zwei Diagramme -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <a class="back" href="/v2.html">‚Üê Zur Karte</a>
    <h1>Schulwaldsensor ‚Äî <span id="nodeTitle">‚Ä¶</span></h1>

    <div class="grid">
      <!-- linke Spalte: Live-Infos -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div class="pill">Stand: <span id="stamp">‚Äî</span></div>
        </div>

        <div class="row" style="margin-top:12px;">
          <div class="kpi">
            <h3>Temperatur</h3>
            <div class="v" id="kpiTemp">‚Äî</div>
          </div>
          <div class="kpi">
            <h3>Luftfeuchte</h3>
            <div class="v" id="kpiHum">‚Äî</div>
          </div>
          <div class="kpi">
            <h3>Batterie</h3>
            <div class="v" id="kpiBat">‚Äî</div>
          </div>
        </div>

        <div class="src">Quelle: <span class="code">/data/v2/latest/_all.json</span></div>
      </div>

      <!-- rechte Spalte: Aktuelle Werte als Liste -->
      <div class="card">
        <div class="section-title">Aktuelle Werte</div>
        <div id="currentList" class="muted">‚Äî</div>
      </div>
    </div>

    <!-- Verlauf 7 Tage -->
    <div class="card" style="margin-top:14px;">
      <div class="section-title">üìä Verlauf Temperatur & Luftfeuchtigkeit</div>
      <div id="no7d" class="empty" style="display:none;">Kein Verlauf gefunden.</div>
      <canvas id="chart7d"></canvas>
    </div>

    <!-- 31 Tage Tagesmittel -->
    <div class="card" style="margin-top:14px;">
      <div class="section-title">üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <div id="no31" class="empty" style="display:none;">Keine Tageswerte m√∂glich (es fehlt Verlauf).</div>
      <canvas id="chart31d"></canvas>
    </div>
  </div>

  <script>
    // ------------------ Einstellungen ------------------
    const ALL_JSON_URL = "/data/v2/latest/_all.json";
    const HISTORY_DIR  = "/data/v2/history/"; // <node>.json
    const AUTO_REFRESH_MS = 5 * 60 * 1000;

    // Farben
    const COL_TEMP = "#2563eb";  // blau
    const COL_HUM  = "#16a34a";  // gr√ºn
    const COL_SOIL = "#8b5cf6";  // lila (Bodenserie)

    // Zahl-Formatter
    const fmt1 = new Intl.NumberFormat("de-DE", { maximumFractionDigits: 1 });
    const fmt0 = new Intl.NumberFormat("de-DE", { maximumFractionDigits: 0 });

    // Charts
    let chart7d = null;
    let chart31 = null;

    // Hilfen
    const byId = (id) => document.getElementById(id);
    const qs   = (s) => document.querySelector(s);

    // Node aus URL (?node=breklum)
    function getUrlNode() {
      const p = new URLSearchParams(location.search);
      const n = p.get("node");
      return n ? n.trim() : null;
    }

    // CR/LF etc. entfernen (Windows-Zeilenenden aus CSV/Perl-Pipe)
    function cleanId(id) { return String(id || "").replace(/[\r\n]+$/g,""); }

    // Latest JSON laden
    async function loadLatest() {
      const arr = await fetch(ALL_JSON_URL, { cache:"no-store" }).then(r=>r.json());
      // IDs s√§ubern
      arr.forEach(x => x.id = cleanId(x.id));
      return arr;
    }

    // History JSON laden
    async function loadHistory(node) {
      const url = `${HISTORY_DIR}${node}.json`;
      const arr = await fetch(url, { cache:"no-store" }).then(r=>r.json());
      return Array.isArray(arr) ? arr : [];
    }

    // Knoten ausw√§hlen
    function pickNode(latest) {
      const want = getUrlNode();
      if (want && latest.some(x => x.id === want)) return want;
      return latest.length ? latest[0].id : null;
    }

    // Batteriefeld ermitteln (kann fehlen)
    function findBattery(fields) {
      if (!fields) return null;
      if ("BatV" in fields) return fields.BatV;
      if ("batV" in fields) return fields.batV;
      return null;
    }

    // Felder f√ºr Anzeige (Temp/Hum ‚Äì oder Boden)
    function extractDisplayFields(history) {
      // Varianten:
      //  - t / h                     (Standard)
      //  - t_soil / water_SOIL      (Boden neu)
      //  - temp_SOIL / water_SOIL   (Boden alt)
      const hasTH      = history.some(x => x.t != null || x.h != null);
      const hasSoilNew = history.some(x => x.t_soil != null || x.water_SOIL != null);
      const hasSoilOld = history.some(x => x.temp_SOIL != null || x.water_SOIL != null);

      if (hasTH) {
        return { mode:"air", tempKey:"t", humKey:"h", tempLabel:"Temperatur (¬∞C)", humLabel:"Luftfeuchte (%)", colorT:COL_TEMP, colorH:COL_HUM };
      }
      if (hasSoilNew) {
        return { mode:"soil", tempKey:"t_soil", humKey:"water_SOIL", tempLabel:"Boden-Temp (¬∞C)", humLabel:"Boden-Feuchte (%)", colorT:COL_SOIL, colorH:COL_HUM };
      }
      if (hasSoilOld) {
        return { mode:"soil", tempKey:"temp_SOIL", humKey:"water_SOIL", tempLabel:"Boden-Temp (¬∞C)", humLabel:"Boden-Feuchte (%)", colorT:COL_SOIL, colorH:COL_HUM };
      }
      // Fallback (falls noch gar kein Verlauf existiert)
      return { mode:"air", tempKey:"t", humKey:"h", tempLabel:"Temperatur (¬∞C)", humLabel:"Luftfeuchte (%)", colorT:COL_TEMP, colorH:COL_HUM };
    }

    // Tagesmittel aus Stundenwerten bilden (clientseitig)
    function dailyMeans(rows, key) {
      const byDay = new Map(); // YYYY-MM-DD -> {sum, n}
      for (const r of rows) {
        const v = r[key];
        if (v == null) continue;
        const d = String(r.ts).slice(0,10); // YYYY-MM-DD
        const obj = byDay.get(d) || { sum:0, n:0 };
        obj.sum += Number(v);
        obj.n   += 1;
        byDay.set(d, obj);
      }
      const out = [];
      for (const [d, agg] of Array.from(byDay.entries()).sort()) {
        out.push({ d, mean: agg.n ? (agg.sum / agg.n) : null });
      }
      return out.slice(-31); // letzte 31 Tage
    }

    // Linien-Chart erzeugen/aktualisieren
    function drawLineChart(canvas, chartRef, labels, series) {
      if (chartRef && chartRef.data) {
        chartRef.data.labels = labels;
        chartRef.data.datasets = series;
        chartRef.update();
        return chartRef;
      }
      return new Chart(canvas.getContext("2d"), {
        type: "line",
        data: { labels, datasets: series },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y;
                  return `${ctx.dataset.label}: ${v == null ? "‚Äî" : fmt1.format(v)}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { maxRotation: 0, autoSkip: true },
              grid: { display:false }
            },
            y: {
              beginAtZero: false,
              grid: { color: "rgba(0,0,0,.06)" }
            }
          },
          elements: { line: { tension: .25 }, point: { radius: 0 } }
        }
      });
    }

    // Oberer Bereich f√ºllen
    function renderTop(latest, node, histInfo, lastRow) {
      byId("nodeTitle").textContent = node || "‚Äî";

      // Zeitstempel
      const entry = latest.find(x => x.id === node);
      const ts = entry?.ts ? new Date(entry.ts) : null;
      byId("stamp").textContent = ts ? ts.toLocaleString("de-DE") : "‚Äî";

      // aktuelle Werte
      const temp = lastRow?.[histInfo.tempKey];
      const hum  = lastRow?.[histInfo.humKey];
      const bat  = findBattery(entry?.fields);

      byId("kpiTemp").textContent = temp == null ? "‚Äî" : `${fmt1.format(temp)} ¬∞C`;
      byId("kpiHum").textContent  = hum  == null ? "‚Äî" : `${fmt1.format(hum)} %`;
      byId("kpiBat").textContent  = bat  == null ? "‚Äî" : `${fmt3(bat)} V`;

      // rechte Box (als kleine Liste)
      const list = [];
      if (temp != null) list.push(`üå°Ô∏è <strong>${histInfo.tempLabel.replace(/\s*$begin:math:text$.*$end:math:text$/,'')}</strong>: ${fmt1.format(temp)} ¬∞C`);
      if (hum  != null) list.push(`üíß <strong>${histInfo.humLabel.replace(/\s*$begin:math:text$.*$end:math:text$/,'')}</strong>: ${fmt1.format(hum)} %`);
      if (bat  != null) list.push(`ü™´ <strong>Batterie</strong>: ${fmt3(bat)} V`);
      byId("currentList").innerHTML = list.length ? ("‚Ä¢ " + list.join("<br>‚Ä¢ ")) : "‚Äî";
    }

    function fmt3(v){ return new Intl.NumberFormat("de-DE",{minimumFractionDigits:3, maximumFractionDigits:3}).format(v); }

    // Hauptlauf
    async function run() {
      try {
        const latest = await loadLatest();
        if (!latest.length) throw new Error("latest leer");

        // Node bestimmen
        const node = pickNode(latest);

        // Verlauf holen
        const hist = await loadHistory(node);

        // Diagramm-Felder erkennen
        const info = extractDisplayFields(hist);

        // 7d: wir nehmen die letzten ~7*24 Punkte (falls vorhanden)
        const rows7 = hist.slice(-7*24);
        // letzter Datensatz f√ºr Anzeige
        const lastRow = hist.at(-1) || null;

        // Oberer Block
        renderTop(latest, node, info, lastRow);

        // Labels (zeitachse)
        const labels7 = rows7.map(r => (new Date(r.ts)).toLocaleString("de-DE", { weekday:"short", hour:"2-digit" }).replace(" ", " "));
        const serieT7 = rows7.map(r => (r[info.tempKey] != null ? Number(r[info.tempKey]) : null));
        const serieH7 = rows7.map(r => (r[info.humKey]  != null ? Number(r[info.humKey])  : null));

        const has7 = serieT7.some(v => v != null) || serieH7.some(v => v != null);
        byId("no7d").style.display = has7 ? "none" : "block";

        if (has7) {
          const ds = [];
          if (serieT7.some(v => v != null)) {
            ds.push({ label: info.tempLabel, data: serieT7, borderColor: info.colorT, backgroundColor: info.colorT });
          }
          if (serieH7.some(v => v != null)) {
            ds.push({ label: info.humLabel,  data: serieH7, borderColor: info.colorH, backgroundColor: info.colorH });
          }
          chart7d = drawLineChart(byId("chart7d"), chart7d, labels7, ds);
        }

        // 31 Tage Tagesmittel
        const daysT = dailyMeans(hist, info.tempKey);
        const daysH = dailyMeans(hist, info.humKey);

        const labels31 = Array.from(new Set([...daysT.map(d=>d.d), ...daysH.map(d=>d.d)])).sort();
        const mapT = new Map(daysT.map(x => [x.d, x.mean == null ? null : Number(x.mean)]));
        const mapH = new Map(daysH.map(x => [x.d, x.mean == null ? null : Number(x.mean)]));

        const serieT31 = labels31.map(d => mapT.has(d) ? mapT.get(d) : null);
        const serieH31 = labels31.map(d => mapH.has(d) ? mapH.get(d) : null);

        const has31 = (serieT31.some(v => v != null) || serieH31.some(v => v != null));
        byId("no31").style.display = has31 ? "none" : "block";

        if (has31) {
          const ds31 = [];
          if (serieT31.some(v => v != null)) {
            ds31.push({ label: info.tempLabel + " (√ò)", data: serieT31, borderColor: info.colorT, backgroundColor: info.colorT });
          }
          if (serieH31.some(v => v != null)) {
            ds31.push({ label: info.humLabel + " (√ò)",  data: serieH31, borderColor: info.colorH, backgroundColor: info.colorH });
          }
          chart31 = drawLineChart(byId("chart31d"), chart31, labels31, ds31);
        }
      } catch (err) {
        console.error(err);
        byId("stamp").textContent = "‚Äî";
        byId("currentList").textContent = "‚Äî";
        byId("no7d").style.display = "block";
        byId("no31").style.display = "block";
      }
    }

    run();
    setInterval(run, AUTO_REFRESH_MS);
  </script>
</body>
</html>
