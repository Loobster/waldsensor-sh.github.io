<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH – Sensordetails</title>
  <meta name="version" content="v0.18" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f8fa; }
    header { background:#004d46; color:#fff; padding:0.8em 1em; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
    header a { color:#fff; text-decoration:none; font-weight:600; }
    main { padding:1em; display:grid; grid-template-columns:1fr 1fr; gap:1em; }
    .card { background:#fff; border-radius:12px; padding:1em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .pill { display:inline-block; background:#e6f4ea; color:#1a6334; padding:0.2em 0.8em; border-radius:999px; font-size:0.9em; margin-bottom:0.5em; }
    .tiles { display:flex; gap:0.6em; justify-content:space-between; }
    .tile { flex:1; background:#f4f6f8; border-radius:8px; padding:0.6em; text-align:center; min-width:0; }
    .tile h3 { margin:0; font-size:0.85em; color:#555; }
    .tile p { margin:0.2em 0 0; font-size:1.2em; font-weight:bold; }
    .tile.small { padding:0.4em; font-size:0.8em; }
    footer { text-align:center; color:#666; padding:1em; font-size:0.9em; }

    /* Rankingfarben */
    .rank-good { color:#0a0; font-weight:bold; }
    .rank-mid { color:#b58900; font-weight:bold; }
    .rank-bad { color:#d00; font-weight:bold; }
  </style>
</head>
<body>
  <header>
    <a href="../v2.html">&larr; Zur Karte</a>
    <div>Schulwaldsensor — <span id="nodeName"></span> <small>v0.18</small></div>
  </header>

  <main>
    <!-- Linke Karte: Sensordaten -->
    <div class="card">
      <div id="stand" class="pill">Stand: —</div>
      <div class="tiles">
        <div class="tile">
          <h3>Temperatur</h3>
          <p id="temp">—</p>
        </div>
        <div class="tile">
          <h3>Luftfeuchte</h3>
          <p id="hum">—</p>
        </div>
        <div class="tile">
          <h3>Batterie</h3>
          <p id="bat">—</p>
        </div>
      </div>
      <small>Quelle: /data/v2/latest/all.json</small>
    </div>

    <!-- Rechte Karte: Netzwerk + Ranking -->
    <div class="card">
      <h3>Netz & Ranking</h3>
      <p>Letzte 24 h: <span id="frames24">—</span> Uplinks</p>
      <p>Verlustquote: <span id="lossRate">—</span></p>
      <p>Gateways: <span id="gwCount">—</span></p>
      <p>Bestes Signal: <span id="bestSig">—</span></p>
      <p>ADR: <span id="adr">—</span></p>
      <hr/>
      <h4>📊 WALDSENSOR.SH Ranking</h4>
      <p>Punkte gesamt: <span id="rankScore">—</span></p>
      <p>🏆 Platz im Landesvergleich: <span id="rankPos">—</span></p>
      <p id="rankNote" style="font-size:0.9em;color:#666;">–</p>
      <small id="netSource">Quelle: —</small>
    </div>
  </main>

  <footer>WALDSENSOR.SH – Sensordetails</footer>

  <script>
    // Hilfsfunktionen
    const byId = id => document.getElementById(id);
    const safeSet = (id, text) => { const el = byId(id); if(el && text != null) el.textContent = text; };
    const fmtNum = (v, d=1, suf="") => (v==null || Number.isNaN(+v)) ? null : (Number(v).toFixed(d).replace(".",",") + (suf||""));
    const fmtDate = ts => { if(!ts) return null; const d=new Date(ts); return Number.isNaN(d.getTime())?null:d.toLocaleString("de-DE"); };
    const urlParams = new URLSearchParams(location.search);
    const nodeId = (urlParams.get("node") || "unknown");
    safeSet("nodeName", nodeId);

    // all.json laden
    fetch("/data/v2/latest/all.json", { cache: "no-store" })
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(all => {
        const n = Array.isArray(all) ? all.find(x => (x.id||"").toLowerCase() === nodeId.toLowerCase()) : null;
        if(!n) return;
        const ts = fmtDate(n.time || n.ts);
        if(ts) safeSet("stand", "Stand: " + ts);
        const f = n.fields || {};
        const t = f.TempC_SHT ?? f.TempC_SHT31 ?? f.temp_SOIL ?? null;
        const h = f.Hum_SHT ?? f.Hum_SHT31 ?? f.water_SOIL ?? null;
        const b = f.BatV ?? null;
        if(fmtNum(t,1," °C")) safeSet("temp", fmtNum(t,1," °C"));
        if(fmtNum(h,1," %")) safeSet("hum", fmtNum(h,1," %"));
        if(fmtNum(b,2," V")) safeSet("bat", fmtNum(b,2," V"));
      })
      .catch(err => console.warn("Fehler beim Laden all.json:", err));

    // netstats laden
    const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeId)}.json`;
    safeSet("netSource", "Quelle: " + netUrl);
    fetch(netUrl, { cache: "no-store" })
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(ns => {
        if(!ns || typeof ns !== "object") return;
        if(ns.frames24 != null) safeSet("frames24", ns.frames24);
        const exp = ns.expected24 || 72;
        if(ns.lost24 != null && exp>0) {
          const rate = (100*(1 - ns.lost24/exp)).toFixed(0);
          const color = rate>=80 ? "rank-good" : (rate>=50 ? "rank-mid" : "rank-bad");
          byId("lossRate").innerHTML = `<span class="${color}">${rate}%</span>`;
        }
        const last = fmtDate(ns.last_ts);
        if(last) safeSet("bestSig", last);
        let gw = "—";
        if (typeof ns.gateways === "number") gw = ns.gateways;
        else if (Array.isArray(ns.gateways)) gw = ns.gateways.length;
        safeSet("gwCount", gw);
        if (ns.best && (ns.best.rssi!=null || ns.best.snr!=null)) {
          const rssi = ns.best.rssi!=null ? `${ns.best.rssi} dBm` : "—";
          const snr = ns.best.snr!=null ? `${ns.best.snr} dB` : "—";
          safeSet("bestSig", `${rssi} / ${snr}`);
        }
        if (ns.adr != null) safeSet("adr", String(ns.adr));

        // Rankingberechnung
        const rate = ns.lost24!=null && exp>0 ? (100*(1 - ns.lost24/exp)) : 0;
        const sig = ns.best?.snr ?? 0;
        const bat = ns.best?.bat_v ?? 0;
        const score = rate*0.7 + sig*2 + bat*10;
        safeSet("rankScore", score.toFixed(1));
        safeSet("rankPos", "–");
        if(score>90) safeSet("rankNote", "Hervorragende Übertragungsqualität");
        else if(score>70) safeSet("rankNote", "Gute Verbindung mit stabilen Werten");
        else if(score>50) safeSet("rankNote", "Mittlere Datenqualität – optimierbar");
        else safeSet("rankNote", "Niedrige Übertragungsrate – prüfen empfohlen");
      })
      .catch(err => console.warn("Fehler beim Laden netstats:", err));
  </script>
</body>
</html>
