<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH â€“ Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f8fa; }
    header { background:#004d46; color:#fff; padding:0.8em 1em; font-weight:bold; display:flex; justify-content:space-between; }
    header a { color:#fff; text-decoration:none; }
    main { padding:1em; display:grid; grid-template-columns:1fr 1fr; gap:1em; }
    .card { background:#fff; border-radius:12px; padding:1em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .pill { display:inline-block; background:#e6f4ea; color:#1a6334; padding:0.2em 0.8em; border-radius:999px; font-size:0.9em; margin-bottom:0.5em; }
    .tiles { display:flex; gap:0.6em; }
    .tile { flex:1; background:#f4f6f8; border-radius:8px; padding:0.6em; text-align:center; }
    .tile h3 { margin:0; font-size:0.8em; color:#555; }
    .tile p { margin:0.2em 0 0; font-size:1.2em; font-weight:bold; }
    .ampel { font-weight:bold; padding:0.4em 0.8em; border-radius:6px; color:#fff; display:inline-block; }
    .ampel.red { background:#e11d48; }
    .ampel.yellow { background:#f59e0b; }
    .ampel.green { background:#16a34a; }
    footer { text-align:center; color:#666; padding:1em; font-size:0.9em; }
    ol { padding-left:1.2em; margin:0.4em 0; }
  </style>
</head>
<body>
  <header>
    <a href="../v2.html">&larr; Zur Karte</a>
    <div>Schulwaldsensor â€” <span id="nodeName"></span> <small>v0.13</small></div>
  </header>
  <main>
    <!-- Sensorwerte -->
    <div class="card">
      <div id="stand" class="pill">Stand: â€”</div>
      <div class="tiles">
        <div class="tile"><h3>Temperatur</h3><p id="temp">â€”</p></div>
        <div class="tile"><h3>Luftfeuchte</h3><p id="hum">â€”</p></div>
        <div class="tile"><h3>Batterie</h3><p id="bat">â€”</p></div>
      </div>
      <small>Quelle: /data/v2/latest/all.json</small>
    </div>

    <!-- Netz & Ranking -->
    <div class="card">
      <h3>Netz & Ranking</h3>
      <p>Letzte 24 h: <span id="frames24">â€”</span> Uplinks<br>
      Ãœbertragungsrate: <span id="txRate" class="ampel">â€”</span></p>
      <p>Letzter Uplink: <span id="lastUplink">â€”</span></p>
      <p>Gateways: <span id="gwCount">â€”</span></p>
      <p>Signal (SNR): <span id="snr">â€”</span></p>
      <p>ADR: <span id="adr">â€”</span></p>

      <hr>
      <h4>ğŸ† WALDSENSOR.SH-Liga</h4>
      <p id="rankInfo">Berechne Ranking â€¦</p>
      <ol id="rankingTop3"><li>â€“</li></ol>
      <small>70 % Ãœbertragung  +  20 % Signal  +  10 % Batterie</small><br>
      <small id="netSource">Quelle: â€”</small>
    </div>
  </main>
  <footer>WALDSENSOR.SH â€“ Sensordetails</footer>

  <script>
    const byId = id => document.getElementById(id);
    const safeSet = (id, t) => { const e=byId(id); if(e&&t!=null) e.textContent=t; };
    const fmtNum = (v,d=1,s="")=>v==null||isNaN(+v)?null:(+v).toFixed(d).replace(".",",")+s;
    const fmtDate = ts=>!ts?null:(new Date(ts)).toLocaleString("de-DE");
    const urlParams = new URLSearchParams(location.search);
    const nodeId = (urlParams.get("node")||"unknown");
    safeSet("nodeName",nodeId);

    // === Sensorwerte laden ===
    fetch("/data/v2/latest/all.json",{cache:"no-store"})
      .then(r=>r.json())
      .then(all=>{
        const n = all.find(x=>(x.id||x.device_id||"").toLowerCase()===nodeId.toLowerCase());
        if(!n) return;
        const f=n.fields||n;
        const ts=fmtDate(n.ts||n.time||n.ts_iso);
        if(ts) safeSet("stand","Stand: "+ts);
        const t=f.TempC_SHT??f.TempC_SHT31??f.temp_c??f.temp_SOIL??null;
        const h=f.Hum_SHT??f.Hum_SHT31??f.hum_pct??f.water_SOIL??null;
        const b=f.BatV??f.bat_v??null;
        if(t!=null) safeSet("temp",fmtNum(t,1," Â°C"));
        if(h!=null) safeSet("hum",fmtNum(h,0," %"));
        if(b!=null) safeSet("bat",fmtNum(b,2," V"));
      });

    // === Netzwerte + Ranking ===
    const netUrl=`/data/v2/net/netstats_${encodeURIComponent(nodeId)}.json`;
    safeSet("netSource","Quelle: "+netUrl);

    Promise.all([
      fetch(netUrl,{cache:"no-store"}).then(r=>r.json()).catch(()=>null),
      fetch("/data/v2/net/all.json",{cache:"no-store"}).then(r=>r.json()).catch(()=>[])
    ])
    .then(([ns,all])=>{
      if(!ns) return;

      if(ns.frames24!=null) safeSet("frames24",ns.frames24);
      const last=fmtDate(ns.last_ts); if(last) safeSet("lastUplink",last);
      const gw=(typeof ns.gateways==="number")?ns.gateways:(Array.isArray(ns.gateways)?ns.gateways.length:"â€”");
      safeSet("gwCount",gw);
      if(ns.best?.snr!=null) safeSet("snr",fmtNum(ns.best.snr,1," dB"));
      if(ns.adr!=null) safeSet("adr",String(ns.adr));

      // Ampel Ãœbertragungsrate
      const rate=Math.min(100,(ns.frames24/72)*100);
      const ampel=byId("txRate");
      if(rate<40) ampel.className="ampel red";
      else if(rate<75) ampel.className="ampel yellow";
      else ampel.className="ampel green";
      ampel.textContent=fmtNum(rate,0,"%");

      // === Ranking berechnen ===
      const scores=(Array.isArray(all)?all:[]).map(n=>{
        const tx=Math.min(100,(n.frames24/72)*100);
        const snr=Math.min(100,((n.best?.snr??0)+10)/20*100);
        const bat=Math.min(100,((n.BatV??n.bat_v??0)/4.2)*100);
        const score=tx*0.7+snr*0.2+bat*0.1;
        return {...n,score};
      }).sort((a,b)=>b.score-a.score);
      const me=scores.find(s=>s.id===nodeId||s.device_id===nodeId);
      const rank=me?scores.findIndex(s=>s===me)+1:null;
      if(me&&rank){
        safeSet("rankInfo",`ğŸ† Rang ${rank} von ${scores.length} (${fmtNum(me.score,1)} Punkte)`);
      }
      const top=scores.slice(0,3).map((s,i)=>
        `<li>${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]||""} ${s.id||s.device_id} â€“ ${fmtNum(s.score,1)} P</li>`).join("");
      byId("rankingTop3").innerHTML=top;
    })
    .catch(e=>console.warn("Fehler Ranking:",e));
  </script>
</body>
</html>
