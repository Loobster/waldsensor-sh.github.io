<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="version" content="v0.19">
  <title>WALDSENSOR.SH – Sensordetails</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f8fa; }
    header { background:#004d46; color:#fff; padding:0.8em 1em; font-weight:bold; display:flex; justify-content:space-between; }
    header a { color:#fff; text-decoration:none; }
    main { padding:1em; display:grid; grid-template-columns:1fr 1fr; gap:1em; }
    .card { background:#fff; border-radius:12px; padding:1em; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .pill { display:inline-block; background:#e6f4ea; color:#1a6334; padding:0.2em 0.8em; border-radius:999px; font-size:0.9em; margin-bottom:0.5em; }
    .sensor-block { margin-bottom:0.8em; border-radius:10px; padding:0.6em; }
    .sensor-block h3 { margin-top:0; }
    .tiles { display:flex; gap:0.8em; }
    .tile { flex:1; background:#f4f6f8; border-radius:8px; padding:0.8em; text-align:center; }
    .tile h3 { margin:0; font-size:0.9em; color:#555; }
    .tile p { margin:0.2em 0 0; font-size:1.2em; font-weight:bold; }
    footer { text-align:center; color:#666; padding:1em; font-size:0.9em; }
    .green { background:#e6f4ea; }
    .blue { background:#eaf2ff; }
    .beige { background:#fff3e0; }
    .grey { background:#e0e0e0; }
    .divider { border-top:1px solid #ccc; margin:1em 0; }
    .badge { display:inline-block; padding:0.2em 0.6em; border-radius:6px; color:#fff; font-weight:bold; }
    .badge-red { background:#d93025; }
    .badge-yellow { background:#fbbc04; color:#000; }
    .badge-green { background:#188038; }
  </style>
</head>
<body>
  <header>
    <a href="../v2.html">&larr; Zur Karte</a>
    <div>Schulwaldsensor — <span id="nodeName"></span> <small>v0.19</small></div>
  </header>
  <main>
    <div class="card">
      <div id="stand" class="pill">Stand: —</div>

      <!-- Blatt-Sensor -->
      <div class="sensor-block green">
        <h3>🌿 Blatt-Sensor</h3>
        <div class="tiles">
          <div class="tile"><h3>Temperatur</h3><p id="leaf_temp">—</p></div>
          <div class="tile"><h3>Feuchte</h3><p id="leaf_moist">—</p></div>
          <div class="tile"><h3>Batterie</h3><p id="leaf_bat">—</p></div>
        </div>
      </div>

      <!-- Luft-Sensor -->
      <div class="sensor-block blue">
        <h3>🌡️ Luft-Sensor</h3>
        <div class="tiles">
          <div class="tile"><h3>Temperatur</h3><p id="air_temp">—</p></div>
          <div class="tile"><h3>Feuchte</h3><p id="air_hum">—</p></div>
          <div class="tile"><h3>Batterie</h3><p id="air_bat">—</p></div>
        </div>
      </div>

      <!-- Boden-Sensor -->
      <div class="sensor-block beige">
        <h3>🌱 Boden-Sensor</h3>
        <div class="tiles">
          <div class="tile"><h3>Temperatur</h3><p id="soil_temp">—</p></div>
          <div class="tile"><h3>Feuchte</h3><p id="soil_moist">—</p></div>
          <div class="tile"><h3>Batterie</h3><p id="soil_bat">—</p></div>
        </div>
      </div>

      <small>Quelle: /data/v2/latest/all.json</small>
    </div>

    <!-- Rechte Seite: Netz & Ranking -->
    <div class="card">
      <h3>Netz & Ranking</h3>
      <p>Letzte 24 h: <span id="frames24">—</span> Uplinks</p>
      <p>Verlustquote: <span id="lossRate"><span class="badge badge-red">0%</span></span></p>
      <p>Gateways: <span id="gwCount">—</span></p>
      <p>Bestes Signal: <span id="bestSig">—</span></p>
      <p>ADR: <span id="adr">—</span></p>

      <div class="divider"></div>
      <h3>📊 WALDSENSOR.SH Ranking</h3>
      <p>Punkte gesamt: <span id="scoreTotal">0.0</span></p>
      <p>🏆 Platz im Landesvergleich: <span id="rankingPos">—</span></p>
      <p id="rankingNote">Niedrige Übertragungsrate – prüfen empfohlen</p>
      <small>Quelle: <span id="netSource">—</span></small>
    </div>
  </main>

  <footer>WALDSENSOR.SH – Sensordetails</footer>

  <script>
    const byId = id => document.getElementById(id);
    const safeSet = (id, text) => { const el = byId(id); if(el && text!=null) el.textContent = text; };
    const fmtNum = (v,d=1,suf="") => (v==null||isNaN(v))?"—":Number(v).toFixed(d).replace(".",",")+suf;
    const fmtDate = ts => { if(!ts) return "—"; const d = new Date(ts); return d.toLocaleString("de-DE"); };

    const urlParams = new URLSearchParams(location.search);
    const nodeId = urlParams.get("node") || "unknown";
    safeSet("nodeName", nodeId);

    // === Linke Seite: Sensorwerte ===
    fetch("/data/v2/latest/all.json", { cache: "no-store" })
      .then(r=>r.json())
      .then(all=>{
        const nArr = Array.isArray(all)?all.filter(x=>(x.device_id||"").includes("schacht_audorf_")):[];
        const byType = t => nArr.find(x=>x.device_id.includes(t))?.fields || {};

        const leaf = byType("llms01");
        safeSet("leaf_temp", fmtNum(leaf.leaf_temp_c,1," °C"));
        safeSet("leaf_moist", fmtNum(leaf.leaf_moist_pct,1," %"));
        safeSet("leaf_bat", fmtNum(leaf.BatV||leaf.bat_v,2," V"));

        const air = byType("s31lb");
        safeSet("air_temp", fmtNum(air.TempC_SHT||air.temp_c,1," °C"));
        safeSet("air_hum", fmtNum(air.Hum_SHT||air.hum_pct,1," %"));
        safeSet("air_bat", fmtNum(air.BatV||air.bat_v,2," V"));

        const soil = byType("se01lb");
        safeSet("soil_temp", fmtNum(soil.temp_SOIL||soil.temp_soil_c,1," °C"));
        safeSet("soil_moist", fmtNum(soil.water_SOIL||soil.water_soil,1," %"));
        safeSet("soil_bat", fmtNum(soil.BatV||soil.bat_v,2," V"));

        const ts = nArr[0]?.ts_iso || nArr[0]?.time;
        safeSet("stand", "Stand: "+fmtDate(ts));
      })
      .catch(e=>console.warn("Fehler beim Laden all.json:", e));

    // === Rechte Seite: Netz & Ranking ===
    const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeId)}.json`;
    safeSet("netSource", netUrl);
    fetch(netUrl,{cache:"no-store"})
      .then(r=>r.json())
      .then(ns=>{
        safeSet("frames24", ns.frames24 ?? 0);
        const loss = ns.lossRate ?? 0;
        const color = loss>30?"badge-red":loss>10?"badge-yellow":"badge-green";
        byId("lossRate").innerHTML = `<span class="badge ${color}">${loss.toFixed(1)}%</span>`;
        safeSet("gwCount", ns.gateways ?? "—");
        if(ns.best) safeSet("bestSig", `${ns.best.rssi??"—"} dBm / ${ns.best.snr??"—"} dB`);
        safeSet("adr", ns.adr ?? "—");
        safeSet("scoreTotal", ns.score ?? 0);
        safeSet("rankingPos", ns.rank ?? "—");
      })
      .catch(e=>console.warn("Fehler beim Laden netstats:", e));
  </script>
</body>
</html>
