<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî <span id="titleNode">‚Ä¶</span></title>
  <style>
    :root { --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --ink:#0f172a; --accent:#14532d; --chip:#dbefe0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--ink); }
    .page { max-width: 1100px; margin: 20px auto 64px; padding: 0 16px; }
    a.back { display:inline-flex; gap:8px; align-items:center; color:#2563eb; text-decoration:none; margin-bottom: 8px; }
    h1 { font-size: clamp(28px, 4vw, 40px); margin: 4px 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr 420px; gap: 16px; }
    @media (max-width: 980px){ .grid { grid-template-columns: 1fr; } }
    .card { background: var(--card); border-radius: 14px; padding: 16px; box-shadow: 0 1px 2px rgba(15,23,42,.05); }
    .chip { display:inline-block; padding: 6px 10px; border-radius: 999px; background: var(--chip); color: var(--accent); font-weight:600; }
    .kachelWrap { display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 12px; }
    .kachel { background:#eef2f7; border-radius:12px; padding:14px; min-height:84px; }
    .kachel h4 { margin:0 0 6px; font-size:14px; color: var(--muted); font-weight:600; }
    .kachel .val { font-size:22px; font-weight:700; }
    .muted { color: var(--muted); }
    .src { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color: var(--muted); }
    .sectionTitle { font-weight:800; margin: 8px 0 10px; display:flex; align-items:center; gap:8px; }
    .empty { color: var(--muted); font-size: 14px; }
    canvas { width:100%; height: 320px; }
  </style>
  <!-- Chart.js (leichtgewichtig per CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="page">
    <a class="back" href="../v2.html">‚Üê Zur Karte</a>
    <h1>Schulwaldsensor ‚Äî <span id="titleNode">‚Ä¶</span></h1>

    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <span id="stamp" class="chip">Stand: ‚Äî</span>
        </div>

        <div class="kachelWrap">
          <div class="kachel">
            <h4 id="labelTemp">Temperatur</h4>
            <div class="val" id="valTemp">‚Äî</div>
          </div>
          <div class="kachel">
            <h4 id="labelHum">Luftfeuchte</h4>
            <div class="val" id="valHum">‚Äî</div>
          </div>
          <div class="kachel" style="grid-column:1 / -1;">
            <h4>Batterie</h4>
            <div class="val" id="valBat">‚Äî</div>
          </div>
        </div>

        <div class="src" style="margin-top:10px;">Quelle: <code>/data/v2/latest/_all.json</code></div>
      </div>

      <div class="card">
        <div style="font-weight:700; margin-bottom:8px;">Aktuelle Werte</div>
        <div class="muted" id="listCurrent">‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="sectionTitle">üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</div>
      <div id="msgHistory" class="empty" style="margin-bottom:8px;">‚Äî</div>
      <canvas id="chartHourly"></canvas>
      <div class="src" style="margin-top:8px;">Sucht: <code>/data/v2/history/&lt;node&gt;.json</code></div>
    </div>

    <div class="card" style="margin-top:14px;">
      <div class="sectionTitle">üìÖ 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <div id="msgDaily" class="empty" style="margin-bottom:8px;">‚Äî</div>
      <canvas id="chartDaily"></canvas>
    </div>
  </div>

<script>
/* -------------------------- Hilfen & Konfiguration -------------------------- */
const ALL_JSON_URL = "/data/v2/latest/_all.json";
const HISTORY_URL   = id => `/data/v2/history/${encodeURIComponent(id)}.json`;

// IDs normalisieren (CR/LF, Whitespace, Case)
const norm = s => (s || "").replace(/[\r\n]+/g,"").trim().toLowerCase();

// Zahlen h√ºbsch formatieren
const fmt = (n, digits=1) => (n==null || Number.isNaN(n)) ? "‚Äî" : Number(n).toLocaleString("de-DE",{maximumFractionDigits:digits});

/* -------------------------- Node-Auswahl robust ---------------------------- */
function newestNode(rows){
  if (!Array.isArray(rows) || rows.length === 0) return null;
  return rows.reduce((a,b)=> (a.ts > b.ts ? a : b));
}
function pickNodeId(rows){
  const urlId = norm(new URLSearchParams(location.search).get("node"));
  const ids = new Set(rows.map(r => norm(r.id)));
  if (urlId && ids.has(urlId)) return urlId;
  const n = newestNode(rows);
  return n ? norm(n.id) : null;
}

/* -------------------------- Charts ----------------------------------------- */
let chartHourly, chartDaily;

function drawHourly(series){
  const ctx = document.getElementById("chartHourly").getContext("2d");
  if (chartHourly) chartHourly.destroy();

  const labels = series.map(p => p.ts.replace("T"," ").replace("Z",""));
  const dsT = series.map(p => p.t ?? null);
  const dsH = series.map(p => p.h ?? null);

  chartHourly = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Temperatur (¬∞C)", data: dsT, tension: .25, pointRadius: 0 },
        { label: "Feuchte (%)",     data: dsH, tension: .25, pointRadius: 0 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { ticks: { maxRotation: 0, autoSkip: true } } },
      plugins: { legend: { position: "bottom" } }
    }
  });
}

function drawDaily(series){
  const ctx = document.getElementById("chartDaily").getContext("2d");
  if (chartDaily) chartDaily.destroy();
  const byDay = new Map();
  for (const p of series){
    const d = p.ts.slice(0,10);
    if (!byDay.has(d)) byDay.set(d, []);
    byDay.get(d).push(p);
  }
  // Tagesmittel
  const days = [...byDay.keys()].sort();
  const avgT = days.map(d => {
    const arr = byDay.get(d).map(x => x.t).filter(v => v!=null);
    if (arr.length===0) return null;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  });
  const avgH = days.map(d => {
    const arr = byDay.get(d).map(x => x.h).filter(v => v!=null);
    if (arr.length===0) return null;
    return arr.reduce((a,b)=>a+b,0)/arr.length;
  });

  chartDaily = new Chart(ctx, {
    type: "line",
    data: {
      labels: days,
      datasets: [
        { label: "√ò Temp (¬∞C)", data: avgT, tension: .25, pointRadius: 0 },
        { label: "√ò Feuchte (%)", data: avgH, tension: .25, pointRadius: 0 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: "bottom" } }
    }
  });
}

/* -------------------------- Rendering -------------------------------------- */
function fillCurrentCard(nodeId, row){
  const isSoil = nodeId === "se01";
  document.getElementById("stamp").textContent =
    row?.ts ? ("Stand: " + new Date(row.ts).toLocaleString("de-DE")) : "Stand: ‚Äî";

  // Labels
  document.getElementById("labelTemp").textContent = isSoil ? "Boden-Temp." : "Temperatur";
  document.getElementById("labelHum").textContent  = isSoil ? "Boden-Feuchte" : "Luftfeuchte";

  // Werte
  let t, h, bat;
  if (isSoil){
    // se01: in _all.json hei√üen Felder temp_SOIL / water_SOIL
    t = row?.fields?.temp_SOIL;
    h = row?.fields?.water_SOIL;
  } else {
    t = row?.fields?.TempC_SHT ?? row?.fields?.TempC_SHT31;
    h = row?.fields?.Hum_SHT   ?? row?.fields?.Hum_SHT31;
  }
  bat = row?.fields?.BatV;

  document.getElementById("valTemp").textContent = (t!=null)? `${fmt(t,1)} ¬∞C` : "‚Äî";
  document.getElementById("valHum").textContent  = (h!=null)? `${fmt(h,1)} %`  : "‚Äî";
  document.getElementById("valBat").textContent  = (bat!=null)? `${fmt(bat,3)} V` : "‚Äî";

  // rechte Liste
  document.getElementById("listCurrent").innerHTML =
    `üå°Ô∏è Temperatur: <b>${(t!=null)? fmt(t,1)+" ¬∞C" : "‚Äî"}</b><br/>
     üíß ${isSoil?"Bodenfeuchte":"Luftfeuchte"}: <b>${(h!=null)? fmt(h,1)+" %" : "‚Äî"}</b><br/>
     ü™´ Batterie: <b>${(bat!=null)? fmt(bat,3)+" V" : "‚Äî"}</b>`;
}

async function render(){
  // 1) _all.json laden und IDs normalisieren
  const all = await (await fetch(ALL_JSON_URL, {cache:"no-store"})).json();
  all.forEach(o => { o.id = norm(o.id); });

  // 2) Node bestimmen
  const nodeId = pickNodeId(all);
  document.getElementById("titleNode").textContent = nodeId || "‚Äî";
  if (!nodeId){ 
    document.getElementById("msgHistory").textContent = "Kein Node gefunden.";
    document.getElementById("msgDaily").textContent = "Keine Tageswerte m√∂glich.";
    return;
  }

  // 3) Aktuelle Werte aus _all.json
  const row = all.find(o => norm(o.id) === nodeId) || null;
  fillCurrentCard(nodeId, row);

  // 4) Verlauf laden
  const histUrl = HISTORY_URL(nodeId);
  let hist = [];
  try {
    hist = await (await fetch(histUrl, {cache:"no-store"})).json();
  } catch(e){
    console.error("History laden fehlgeschlagen", e);
  }

  const hasSeries = Array.isArray(hist) && hist.length>0;
  const msgH = document.getElementById("msgHistory");
  if (!hasSeries){
    msgH.textContent = "Kein Verlauf gefunden.";
    if (chartHourly){ chartHourly.destroy(); chartHourly = null; }
    if (chartDaily){  chartDaily.destroy();  chartDaily  = null; }
    document.getElementById("msgDaily").textContent = "Keine Tageswerte m√∂glich (es fehlt Verlauf).";
    return;
  } else {
    msgH.textContent = "";
  }

  // 5) Charts zeichnen
  drawHourly(hist);
  document.getElementById("msgDaily").textContent = "";
  // Nur wenn gen√ºgend Zeitraum vorhanden ist, macht Tagesmittel Sinn
  const spanDays = (Date.parse(hist.at(-1).ts) - Date.parse(hist[0].ts)) / (1000*60*60*24);
  if (spanDays >= 1){
    drawDaily(hist);
  } else {
    if (chartDaily){ chartDaily.destroy(); chartDaily = null; }
    document.getElementById("msgDaily").textContent = "Keine Tageswerte m√∂glich (Zeitfenster < 24 h).";
  }
}

render();
</script>
</body>
</html>
