<script>
(() => {
  // ------- Hilfen (nicht an der linken Logik rütteln) -------
  const $ = id => document.getElementById(id);
  const fmt = (v,d=1,s="") => (v==null || !isFinite(+v)) ? "—" : (+v).toFixed(d).replace(".",",")+s;
  const fmtDate = ts => { if(!ts) return "—"; const d=new Date(ts); return isNaN(d)? "—" : d.toLocaleString("de-DE"); };
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));

  // Den Node-Namen wie in v0.18 (unverändert) aus der URL holen
  const qp = new URLSearchParams(location.search);
  const nodeIdRaw = qp.get("node") || "unknown";
  const nodeId = nodeIdRaw.toLowerCase();

  // ------- Netz & Gateways (per-node) -------
  const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeIdRaw)}.json`;
  $("netSource").textContent = "Quelle: " + netUrl;

  fetch(netUrl, { cache:"no-store" })
    .then(r => r.ok ? r.json() : null)
    .then(ns => {
      if(!ns) return;

      // Uplinks (24h) + Verlustquote Badge
      const frames = Number(ns.frames24 ?? ns.uplinks24 ?? 0);
      $("u24").textContent = isFinite(frames) ? frames : "—";

      const loss = clamp( (72 - (isFinite(frames)?frames:0)) / 72 * 100, 0, 100);
      const badge = $("lossBadge");
      badge.textContent = `${Math.round(loss)} %`;
      badge.classList.remove("loss-ok","loss-mid","loss-bad");
      if (loss < 10)      badge.classList.add("loss-ok");
      else if (loss <30)  badge.classList.add("loss-mid");
      else                badge.classList.add("loss-bad");

      // Letzter Uplink
      $("lastUplink").textContent = fmtDate(ns.last_ts || ns.lastTs || ns.last);

      // Gateways (Zahl oder Array)
      let gw = "—";
      if (typeof ns.gateways === "number") gw = ns.gateways;
      else if (Array.isArray(ns.gateways)) gw = ns.gateways.length;
      $("gwCount").textContent = gw;

      // Ø Batterie
      $("avgBat").textContent = fmt(ns.avg_bat_v ?? ns.avg_bat ?? ns.bat_v, 2, " V");

      // Bestes Signal
      const best = ns.best || {};
      const rssi = (best.rssi ?? ns.best_rssi);
      const snr  = (best.snr  ?? ns.best_snr);
      let bestTxt = "—";
      if (rssi!=null || snr!=null) {
        const r = (rssi!=null) ? `${rssi} dBm` : "–";
        const s = (snr !=null) ? `${snr} dB`  : "–";
        bestTxt = `${r} / ${s}`;
      }
      $("bestSig").textContent = bestTxt;

      // ADR
      const adr = (ns.adr!=null) ? String(ns.adr) :
                  (ns.adr_enabled!=null) ? String(ns.adr_enabled) : "—";
      $("adr").textContent = adr;

      // Punkte für diesen Node berechnen (gleich wie Liga)
      const scoreSelf = computeScore({
        frames24: frames,
        rssi: rssi, snr: snr,
        bat: (ns.avg_bat_v ?? ns.bat_v)
      });
      $("ligaScore").textContent = `${scoreSelf} Punkte`;
    })
    .catch(()=>{ /* still ok */ });

  // ------- Liga / Landesvergleich (Top-10) -------
  const allUrl = "/data/v2/net/netstats_all.json";
  $("ligaSource").textContent = "Quelle: " + allUrl;

  fetch(allUrl, { cache:"no-store" })
    .then(r => r.ok ? r.json() : null)
    .then(all => {
      if(!all || !Array.isArray(all)) return;

      // Robustes Mapping jedes Eintrags
      const rows = all.map(x => {
        const id = (x.id || x.device_id || x.node || "").toLowerCase();
        const frames24 = Number(x.frames24 ?? x.uplinks24 ?? 0);
        const rssi = (x.best?.rssi ?? x.rssi ?? x.best_rssi);
        const snr  = (x.best?.snr  ?? x.snr  ?? x.best_snr);
        const bat  = (x.avg_bat_v ?? x.bat_v ?? x.avg_battery);
        return { id, name: (x.name || x.id || x.device_id || id), frames24, rssi, snr, bat };
      });

      // Scoring & Sortierung
      rows.forEach(r => r.score = computeScore(r));
      rows.sort((a,b) => b.score - a.score);

      // Platz meines Nodes + Top-10
      const total = rows.length;
      const place = Math.max(1, rows.findIndex(r => r.id.includes(nodeId)) + 1);
      $("ligaPlace").textContent = `${place} / ${total}`;

      const top = rows.slice(0,10);
      const ol = $("ligaTop");
      ol.innerHTML = "";
      top.forEach((r, i) => {
        const li = document.createElement("li");
        const isMe = r.id.includes(nodeId);
        li.className = isMe ? "liga-me" : "";
        const details = [];
        if (isFinite(r.frames24)) details.push(`${r.frames24}/72`);
        if (r.rssi!=null) details.push(`RSSI ${r.rssi} dBm`);
        if (r.snr !=null) details.push(`SNR ${r.snr} dB`);
        if (r.bat !=null) details.push(`${r.bat.toFixed ? r.bat.toFixed(2) : r.bat} V`);
        li.textContent = `${i+1}. ${r.name} — ${r.score} Pkt (${details.join(", ")})`;
        ol.appendChild(li);
      });
    })
    .catch(()=>{ /* still ok */ });

  // ------- Scoring (70 % Tx, 20 % Signal, 10 % Batterie) -------
  function computeScore({frames24=0,rssi=null,snr=null,bat=null}){
    // Übertragung (0..100)
    const tx = clamp(frames24/72, 0, 1) * 100;

    // Signal: RSSI (-130..-60) & SNR (-20..10) -> 0..1
    let sigParts = [];
    if (rssi!=null && isFinite(+rssi)) {
      const r = clamp((+rssi - (-130)) / ( -60 - (-130) ), 0, 1); // -130 schlechter -> 0, -60 gut -> 1
      sigParts.push(r);
    }
    if (snr!=null && isFinite(+snr)) {
      const s = clamp((+snr - (-20)) / ( 10 - (-20) ), 0, 1); // -20 schlecht -> 0, 10 gut -> 1
      sigParts.push(s);
    }
    const sig = (sigParts.length ? (sigParts.reduce((a,b)=>a+b,0)/sigParts.length) : 0) * 100;

    // Batterie: 2.8..3.8 V -> 0..1
    let batPct = 0;
    if (bat!=null && isFinite(+bat)) {
      batPct = clamp((+bat - 2.8) / (3.8 - 2.8), 0, 1) * 100;
    }

    const total = 0.7*tx + 0.2*sig + 0.1*batPct;
    return Math.round(total);
  }
})();
</script>
