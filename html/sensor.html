<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Schulwaldsensor ‚Äì Details</title>

  <style>
    :root {
      --bg: #f4f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #5b6785;
      --ok: #e6f7ec;
      --ok-text: #0f5132;
      --accent: #0ea5e9;
      --border: #e5e7eb;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .wrap { max-width: 1100px; margin: 16px auto 48px; padding: 0 16px; }
    a.back { display:inline-block; margin:4px 0 12px; color:#0ea5e9; text-decoration:none; }
    h1 { font-size: clamp(28px, 4vw, 42px); margin:8px 0 20px; letter-spacing:.3px; }
    .grid { display:grid; grid-template-columns: 1fr 380px; gap:18px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 6px 24px rgba(15,23,42,.06); padding:18px 20px; }
    .pill { display:inline-flex; align-items:center; gap:10px; background:var(--ok); color:var(--ok-text); padding:8px 14px; border-radius:999px; font-weight:600; }
    .row { display:flex; flex-wrap:wrap; gap:18px; margin-top:12px; }
    .kv { display:flex; align-items:center; gap:10px; padding:10px 12px; background:#f8fafc; border-radius:12px; min-width:170px; }
    .kv b { font-size:18px; }
    .muted { color:var(--muted); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .section-title { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; margin:4px 0 14px; }
    .err { color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; padding:16px; border-radius:12px; }
    .src { margin-top:8px; color:var(--muted); }
    @media (max-width:980px){ .grid { grid-template-columns: 1fr; } }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <a class="back" href="/v2.html">‚Üê Zur Karte</a>
    <h1 id="title">Schulwaldsensor ‚Äî ‚Ä¶</h1>

    <div class="grid">
      <!-- Links: letzte Werte -->
      <div class="card">
        <div class="pill" id="status">‚è±Ô∏è Stand: ‚Äî</div>
        <div class="row">
          <div class="kv">üå°Ô∏è <div><div>Temperatur</div><b id="val-temp">‚Äî</b></div></div>
          <div class="kv">üíß <div><div>Luftfeuchte</div><b id="val-hum">‚Äî</b></div></div>
          <div class="kv">ü™´ <div><div>Batterie</div><b id="val-bat">‚Äî</b></div></div>
        </div>
        <div class="src">Quelle: <span class="muted">/data/v2/latest/_all.json</span></div>
      </div>

      <!-- Rechts: aktuelle Werte gespiegelt -->
      <div class="card">
        <div class="section-title">Aktuelle Werte</div>
        <div id="now-list" class="muted">‚Äî</div>
      </div>
    </div>

    <!-- Verlauf (Rohwerte) -->
    <div class="card" style="margin-top:18px;">
      <div class="section-title">üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</div>
      <canvas id="hist" height="140"></canvas>
      <div id="hist-hint" class="src"></div>
    </div>

    <!-- NEU: 31 Tage ‚Äì Tagesmittel -->
    <div class="card" style="margin-top:18px;">
      <div class="section-title">üìÜ 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
      <canvas id="hist30" height="150"></canvas>
      <div id="hist30-hint" class="src"></div>
    </div>

    <div id="err" class="err" style="display:none;"></div>
  </div>

<script>
(async () => {
  const qs = new URLSearchParams(location.search);
  const nodeId = (qs.get('node') || '').trim();
  const errBox = document.getElementById('err');
  const showErr = (msg) => { errBox.textContent = msg; errBox.style.display = 'block'; };

  // UI-Refs
  const elTitle = document.getElementById('title');
  const elStatus = document.getElementById('status');
  const elTemp   = document.getElementById('val-temp');
  const elHum    = document.getElementById('val-hum');
  const elBat    = document.getElementById('val-bat');
  const elNow    = document.getElementById('now-list');
  const elHint   = document.getElementById('hist-hint');
  const elHint30 = document.getElementById('hist30-hint');

  if (!nodeId) { showErr('‚ùå Kein Node angegeben (?node=<id>).'); return; }

  // ---------- _all.json laden ----------
  const ALL_URL = `/data/v2/latest/_all.json?nocache=${Date.now()}`;
  let latestArr = [];
  try {
    const r = await fetch(ALL_URL, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    latestArr = await r.json();
    if (!Array.isArray(latestArr)) throw new Error('Kein Array in _all.json');
  } catch (e) { showErr(`‚ùå _all.json konnte nicht gelesen werden. (${e.message})`); return; }

  // Datensatz suchen (IDs sind kurz, z.B. "kropp", "fahrdorf")
  const rec = latestArr.find(x => x && x.id === nodeId);
  if (!rec) { showErr(`‚ùå Node ‚Äû${nodeId}‚Äú nicht gefunden.`); return; }

  // ---------- Header/Boxen ----------
  elTitle.textContent = `Schulwaldsensor ‚Äî ${nodeId}`;
  try {
    const ts = new Date(rec.ts);
    const dt = ts.toLocaleString('de-DE', { timeZone: 'Europe/Berlin' });
    elStatus.textContent = `‚è±Ô∏è Stand: ${dt}`;
  } catch { elStatus.textContent = '‚è±Ô∏è Stand: ‚Äî'; }

  const f = rec.fields || {};
  const fmt = (v, suf='') => (v === undefined || v === null || Number.isNaN(v)) ? '‚Äî' : `${v}${suf}`;

  // Luft-Sensor bevorzugen; Boden als Fallback
  const tNow = (f.TempC_SHT ?? f.TempC_SHT31 ?? f.temp_SOIL ?? null);
  const hNow = (f.Hum_SHT ?? f.Hum_SHT31 ?? f.water_SOIL ?? null);

  elTemp.textContent = (tNow == null) ? '‚Äî' : `${Number(tNow).toFixed(1)} ¬∞C`;
  elHum.textContent  = (hNow == null) ? '‚Äî' : `${Number(hNow).toFixed(1)} %`;
  elBat.textContent  = fmt(f.BatV, ' V');

  elNow.innerHTML =
    `<div>üå°Ô∏è Temperatur: <b>${elTemp.textContent}</b></div>`+
    `<div>üíß Luftfeuchte: <b>${elHum.textContent}</b></div>`+
    `<div>üîã Batterie: <b>${elBat.textContent}</b></div>`;

  // ---------- History laden ----------
  // ---------- History laden (kurzer & alter langer Name) ----------
  function makeHistUrls(baseId){
    // M√∂gliche alte Suffixe
    const suffixes = ['', '-sn50v3', '-SN50_v3', '-lb', '-v2', '-sn50'];
    // Alle Kandidaten (kurz + lang) dedupliziert
    const ids = Array.from(new Set(suffixes.map(s => baseId + s)));
    // Zu URLs in beiden Schemata machen
    const cacheBust = `?t=${Date.now()}`;
    const urls = [];
    for (const id of ids){
      urls.push(`/data/v2/history/${encodeURIComponent(id)}.json${cacheBust}`);
      urls.push(`/data/v2/history_${encodeURIComponent(id)}.json${cacheBust}`);
    }
    return urls;
  }

  const histCandidates = makeHistUrls(nodeId);
  let hist = null, usedUrl = null;
  for (const url of histCandidates) {
    try {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) continue;
      const body = await r.text();
      if (!body || !body.trim().startsWith('[')) continue;
      hist = JSON.parse(body);
      if (!Array.isArray(hist)) { hist = null; continue; }
      usedUrl = url.replace(/\?t=\d+$/, '');
      break;
    } catch { /* next */ }
  }

  // ---------- Chart 1: Rohverlauf ----------
  const ctx = document.getElementById('hist').getContext('2d');

  if (!hist || !hist.length) {
    elHint.textContent = 'Kein Verlauf verf√ºgbar. Sucht: ' +
      '/data/v2/history/<node>.json oder /data/v2/history_<node>.json';
  } else {
    const labels = [];
    const tVals  = [];
    const hVals  = [];

    hist.forEach(p => {
      const d = new Date(p.ts);
      labels.push(d.toLocaleTimeString('de-DE', { hour: '2-digit', minute:'2-digit' }));
      tVals.push(p.t ?? p.temp ?? null);
      hVals.push(p.h ?? p.hum  ?? null);
    });

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Temperatur (¬∞C)', data: tVals, borderWidth: 2, tension: 0.25, yAxisID: 'y' },
          { label: 'Luftfeuchte (%)', data: hVals, borderWidth: 2, tension: 0.25, yAxisID: 'y1' }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y:  { title: { display:true, text: '¬∞C' } },
          y1: { position:'right', grid:{ drawOnChartArea:false }, title:{ display:true, text:'%' } }
        },
        parsing: false,
        plugins: { legend: { display:true } }
      }
    });
    elHint.textContent = `Sucht: ${usedUrl || '(n/a)'}`;
  }

  // ---------- Chart 2: 31 Tage ‚Äì Tagesmittel ----------
  const ctx30 = document.getElementById('hist30').getContext('2d');

  if (!hist || !hist.length) {
    elHint30.textContent = 'Keine Tageswerte m√∂glich (es fehlt Verlauf).';
  } else {
    // Bucketing nach lokalem Kalendertag (Europe/Berlin)
    const tz = 'Europe/Berlin';
    const bucket = new Map(); // key YYYY-MM-DD -> {tsMax, tSum,tN, hSum,hN}

    for (const p of hist) {
      const d = new Date(p.ts);
      // lokales Datum in YYYY-MM-DD
      const y = d.toLocaleString('de-DE', { timeZone: tz, year:'numeric' });
      const m = d.toLocaleString('de-DE', { timeZone: tz, month:'2-digit' });
      const day= d.toLocaleString('de-DE', { timeZone: tz, day:'2-digit' });
      const key = `${y}-${m}-${day}`;

      const t = (p.t ?? p.temp);
      const h = (p.h ?? p.hum);
      if (!bucket.has(key)) bucket.set(key, { tsMax: d.getTime(), tSum:0, tN:0, hSum:0, hN:0 });
      const b = bucket.get(key);
      if (d.getTime() > b.tsMax) b.tsMax = d.getTime();
      if (typeof t === 'number') { b.tSum += t; b.tN++; }
      if (typeof h === 'number') { b.hSum += h; b.hN++; }
    }

    // last 31 days timeline (inkl. L√ºcken)
    const days = [];
    const now = new Date();
    for (let i=30; i>=0; i--){
      const d = new Date(now);
      d.setDate(d.getDate() - i);
      const y = d.toLocaleString('de-DE', { timeZone: tz, year:'numeric' });
      const m = d.toLocaleString('de-DE', { timeZone: tz, month:'2-digit' });
      const day= d.toLocaleString('de-DE', { timeZone: tz, day:'2-digit' });
      const key = `${y}-${m}-${day}`;
      const label = `${day}.${m}.`;
      days.push({key, label});
    }

    const labels30 = [];
    const tAvg = [];
    const hAvg = [];

    for (const d of days) {
      labels30.push(d.label);
      const b = bucket.get(d.key);
      if (!b) { tAvg.push(null); hAvg.push(null); continue; }
      tAvg.push(b.tN ? +(b.tSum/b.tN).toFixed(1) : null);
      hAvg.push(b.hN ? +(b.hSum/b.hN).toFixed(1) : null);
    }

    new Chart(ctx30, {
      data: {
        labels: labels30,
        datasets: [
          { type:'line', label:'Temp √ò (¬∞C)', data:tAvg, borderWidth:2, tension:0.25, yAxisID:'y' },
          { type:'line', label:'Feuchte √ò (%)', data:hAvg, borderWidth:2, tension:0.25, yAxisID:'y1' }
        ]
      },
      options: {
        responsive:true,
        scales:{
          y:  { title:{display:true, text:'¬∞C'} },
          y1: { position:'right', grid:{drawOnChartArea:false}, title:{display:true, text:'%'} }
        },
        plugins:{
          legend:{display:true},
          tooltip:{ mode:'index', intersect:false }
        }
      }
    });

    // kleine Hilfezeile
    const haveDays = [...bucket.keys()].length;
    if (haveDays < 31) {
      elHint30.textContent = `Hinweis: Nur ${haveDays} Tag(e) mit Daten im Verlauf.`;
    } else {
      elHint30.textContent = '';
    }
  }
})();
</script>
</body>
</html>
