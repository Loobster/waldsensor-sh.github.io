<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schulwaldsensor ‚Äî Detail</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{ --card:#fff; --muted:#667; --soft:#eef2f7; }
    body{ margin:0; font: 16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#0e1320; background:#f6f8fb; }
    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px; }
    a.back{ color:#0b4da2; text-decoration:none; display:inline-flex; gap:.4rem; align-items:center; margin-bottom:8px; }
    h1{ font: 800 44px/1.1 system-ui; letter-spacing:.2px; margin:8px 0 18px; }
    .grid{ display:grid; grid-template-columns: 1fr 380px; gap:20px; }
    .card{ background:var(--card); border:1px solid #e9edf3; border-radius:16px; padding:16px; box-shadow:0 6px 20px rgba(10,20,40,.04); }
    .pill{ display:inline-block; background:#e9f7ea; color:#0f6a28; padding:8px 12px; border-radius:999px; font-weight:700; border:1px solid #d2efd7; }
    .kpirow{ display:flex; gap:16px; margin-top:14px; }
    .kpi{ flex:1; background:#f8fbff; padding:16px; border-radius:14px; border:1px solid #e7eef9; }
    .kpi b{ font-size:22px; }
    .muted{ color:var(--muted); }
    .src{ font: 600 14px/1.3 system-ui; color:#334; margin-top:10px; }
    .panel{ background:var(--card); border:1px solid #e9edf3; border-radius:16px; padding:16px; margin-top:20px; }
    .panel h3{ margin:0 0 8px; font:800 18px/1.2 system-ui; }
    .warn{ color:#a00; background:#fdeeee; border:1px solid #f7d3d3; padding:10px 12px; border-radius:10px; }
    canvas{ width:100% !important; height:340px !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <a class="back" href="/v2.html">‚Üê Zur Karte</a>
    <h1>Schulwaldsensor ‚Äî <span id="title">‚Ä¶</span></h1>

    <div class="grid">
      <div class="card">
        <div class="pill">Stand: <span id="stand">‚Äî</span></div>

        <div class="kpirow">
          <div class="kpi">
            <div class="muted">Temperatur</div>
            <b id="temp">‚Äî</b>
          </div>
          <div class="kpi">
            <div class="muted">Luftfeuchte</div>
            <b id="hum">‚Äî</b>
          </div>
          <div class="kpi">
            <div class="muted">Batterie</div>
            <b id="bat">‚Äî</b>
          </div>
        </div>

        <div class="src">Quelle: /data/v2/latest/_all.json</div>
      </div>

      <div class="card">
        <h3>Aktuelle Werte</h3>
        <div id="aktu" class="muted">‚Äî</div>
      </div>
    </div>

    <div class="panel">
      <h3>üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</h3>
      <canvas id="chart1"></canvas>
      <div id="hint1" class="muted"></div>
    </div>

    <div class="panel">
      <h3>üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</h3>
      <canvas id="chart2"></canvas>
      <div id="hint2" class="muted"></div>
    </div>

    <div id="err" style="margin-top:16px;"></div>
  </div>

<script>
function normalizeId(s){
  return String(s||'')
    .toLowerCase()
    .replace(/\r|\s+/g,'')
    .replace(/^waldsensor[_-]/,'')
    .replace(/_/g,'-')
    .replace(/-(sn\d.*|lsn\d.*|v\d+|lb)$/,'');
}

const qs = new URLSearchParams(location.search);
const wanted = normalizeId(qs.get('node') || '');

const fmtTs = ts => {
  try {
    return new Date(ts).toLocaleString("de-DE",{year:"numeric",month:"numeric",day:"numeric",hour:"2-digit",minute:"2-digit"});
  } catch { return ts || "‚Äî"; }
};

const el = id => document.getElementById(id);
el('title').textContent = wanted || '‚Ä¶';

function showError(msg){
  el('err').innerHTML = `<div class="warn">‚ùå ${msg}</div>`;
}

async function loadLatest(){
  const res = await fetch('/data/v2/latest/_all.json?t=' + Date.now(), {cache:'no-store'});
  if(!res.ok) throw new Error('latest fetch ' + res.status);
  const arr = await res.json();
  // robust: IDs normalisieren
  return arr.map(x => ({...x, id: normalizeId(x.id)}));
}

async function loadHistory(id){
  // zwei m√∂gliche Dateinamen unterst√ºtzen
  const paths = [
    `/data/v2/history/${id}.json`,
    `/data/v2/history/history_${id}.json`
  ];
  for (const p of paths){
    const res = await fetch(p + '?t=' + Date.now(), {cache:'no-store'});
    if (res.ok) return res.json();
  }
  return null;
}

function setKPIs(n){
  el('stand').textContent = fmtTs(n.ts);
  const f = n.fields || {};
  const temp = (typeof f.TempC_SHT31 === 'number') ? f.TempC_SHT31
             : (typeof f.TempC_SHT === 'number')  ? f.TempC_SHT
             : (typeof f.temp_SOIL === 'number')  ? f.temp_SOIL : null;
  const hum  = (typeof f.Hum_SHT31 === 'number') ? f.Hum_SHT31
             : (typeof f.Hum_SHT === 'number')   ? f.Hum_SHT
             : (typeof f.water_SOIL === 'number')? f.water_SOIL : null;
  const bat  = (typeof f.BatV === 'number') ? f.BatV : null;

  el('temp').textContent = temp==null ? '‚Äî' : `${temp.toFixed(1)} ¬∞C`;
  el('hum').textContent  = hum==null  ? '‚Äî' : `${hum.toFixed(1)} %`;
  el('bat').textContent  = bat==null  ? '‚Äî' : `${bat.toFixed(3)} V`;

  el('aktu').textContent =
    `üå°Ô∏è Temperatur: ${el('temp').textContent}  ¬∑  üíß Luftfeuchte: ${el('hum').textContent}  ¬∑  üîã Batterie: ${el('bat').textContent}`;
}

let chart1, chart2;

function drawHistory(raw){
  if (!raw || !raw.length){
    el('hint1').textContent = 'Kein Verlauf verf√ºgbar. Sucht: /data/v2/history/<node>.json oder /data/v2/history_history_<node>.json';
    return;
  }
  const labels = raw.map(r => r.ts && r.ts !== "0" ? r.ts.slice(0,10) : '‚Äî');
  const temps  = raw.map(r => (typeof r.t === 'number') ? r.t : null);
  const hums   = raw.map(r => (typeof r.h === 'number') ? r.h : null);

  const ctx1 = document.getElementById('chart1').getContext('2d');
  chart1 && chart1.destroy();
  chart1 = new Chart(ctx1, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Temperatur (¬∞C)', data: temps, borderWidth: 2, tension: .2 },
        { label: 'Luftfeuchte (%)', data: hums,  borderWidth: 2, tension: .2 }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: { x: { ticks:{ maxTicksLimit: 8 } }, y: { beginAtZero: false } }
    }
  });

  // 31-Tage Balken-Tagesmittel ‚Äì wenn genug Daten vorhanden
  const ctx2 = document.getElementById('chart2').getContext('2d');
  chart2 && chart2.destroy();
  chart2 = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Temp √ò (¬∞C)', data: temps, borderWidth: 1 },
        { label: 'Feuchte √ò (%)', data: hums, borderWidth: 1 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: { x: { ticks:{ maxTicksLimit: 12 } } }
    }
  });
}

(async function init(){
  try{
    const all = await loadLatest();
    const node = all.find(n => normalizeId(n.id) === wanted);
    if(!node){
      showError(`Node ‚Äû${wanted || '‚Äî'}‚Äú nicht gefunden.`);
      return;
    }
    setKPIs(node);

    const hist = await loadHistory(wanted);
    if (!hist){ el('hint1').textContent = 'Kein Verlauf gefunden.'; el('hint2').textContent = 'Keine Tageswerte m√∂glich.'; return; }
    drawHistory(hist);
  }catch(err){
    console.error(err);
    showError('Fehler beim Laden der Daten.');
  }
})();
</script>
</body>
</html>
