<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Schulwaldsensor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f9fb; }
    .wrap { max-width: 900px; margin: auto; padding: 1rem; }
    .back { display:inline-block; margin-bottom:1rem; text-decoration:none; color:#0366d6; }
    .card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: .5rem; box-shadow: 0 2px 5px rgba(0,0,0,.1);}
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    h1 { margin-top:0; }
    .value { font-size:1.2rem; }
    .muted { color:#666; font-size:.9rem; }
    canvas { width:100%!important; height:400px!important; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/v2.html" class="back">&larr; Zur Karte</a>
    <h1 id="title">Schulwaldsensor — …</h1>
    <div class="card grid">
      <div>
        <div id="stand" class="muted">⏱ Stand: —</div>
        <div class="value">🌡 <span id="temp">—</span> °C</div>
        <div class="value">💧 <span id="hum">—</span> %</div>
        <div class="value">🔋 <span id="bat">—</span> V</div>
        <div class="muted">Quelle: /data/v2/latest/_all.json</div>
      </div>
      <div>
        <h3>Aktuelle Werte</h3>
        <div>Temperatur: <span id="val-temp">—</span> °C</div>
        <div>Luftfeuchte: <span id="val-hum">—</span> %</div>
        <div>Batterie: <span id="val-bat">—</span> V</div>
      </div>
    </div>

    <div class="card">
      <h3>📊 Verlauf Temperatur & Luftfeuchtigkeit</h3>
      <canvas id="chart"></canvas>
      <div id="history-empty" class="muted hidden">Keine Verlaufsdaten gefunden.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  // --- Hilfsfunktionen
  const qs = new URLSearchParams(location.search);
  const nodeId = qs.get("id") || "unknown";

  document.getElementById("title").textContent = "Schulwaldsensor — " + nodeId;

  const LATEST_URL = "/data/v2/latest/_all.json";

  // Chart.js init
  const ctx = document.getElementById('chart').getContext('2d');
  window.chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Temperatur (°C)', borderColor: 'blue', fill:false, data: [] },
        { label: 'Luftfeuchte (%)', borderColor: 'green', fill:false, data: [] }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: false }
      }
    }
  });

  // ---- Latest laden
  (async () => {
    try{
      const res = await fetch(LATEST_URL + "?t=" + Date.now(), {cache:'no-store'});
      const arr = await res.json();
      const latest = arr.find(r => r.id === nodeId);
      if(!latest) throw new Error("Node nicht in _all.json");

      document.getElementById("stand").textContent = "⏱ Stand: " + (latest.ts || latest.time || "—");
      document.getElementById("temp").textContent = pickNum(latest.fields, ["TempC_SHT","TempC_SHT31","t"]) ?? "—";
      document.getElementById("hum").textContent  = pickNum(latest.fields, ["Hum_SHT","Hum_SHT31","h"]) ?? "—";
      document.getElementById("bat").textContent  = pickNum(latest.fields, ["BatV","batt"]) ?? "—";

      document.getElementById("val-temp").textContent = document.getElementById("temp").textContent;
      document.getElementById("val-hum").textContent  = document.getElementById("hum").textContent;
      document.getElementById("val-bat").textContent  = document.getElementById("bat").textContent;
    }catch(e){
      document.body.innerHTML = `<div class="wrap"><h2>❌ Node „${nodeId}“ nicht gefunden.</h2><div class="muted">_all.json konnte nicht gelesen werden.</div></div>`;
      return;
    }
  })();

  // ---- History laden
  const historyCandidates = [
    `/data/v2/history/${nodeId}.json`,
    `/data/v2/history_${nodeId}.json`
  ];

  const pickNum = (obj, keys) => {
    if (!obj) return null;
    for (const k of keys) {
      if (obj[k] != null && obj[k] !== "") {
        const n = Number(obj[k]);
        if (!isNaN(n)) return n;
      }
    }
    return null;
  };

  async function loadHistory(){
    let points = [];
    for(const url of historyCandidates){
      try{
        const res = await fetch(url + "?t=" + Date.now(), {cache:'no-store'});
        if(res.ok){
          const arr = await res.json();
          if(Array.isArray(arr) && arr.length){ points = arr; break; }
        }
      }catch{}
    }
    if(!points.length){
      document.getElementById("history-empty").classList.remove("hidden");
      return;
    }

    const labels = points.map(p=>{
      const d = new Date(p.ts || p.time || 0);
      return isNaN(d)? "" : d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"});
    });

    const temps = points.map(p=>pickNum(p,["t","TempC_SHT","TempC_SHT31","temp"]));
    const hums  = points.map(p=>pickNum(p,["h","Hum_SHT","Hum_SHT31","humidity"]));

    chart.data.labels = labels;
    chart.data.datasets[0].data = temps;
    chart.data.datasets[1].data = hums;
    chart.update();
  }

  loadHistory();
  </script>
</body>
</html>
