<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>ðŸŒ³ WALDSENSOR.SH â€“ Sensordaten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, sans-serif; margin: 1rem; background:#f9f9f9; color:#222; }
    h1,h2 { margin:0.5rem 0; }
    .card { background:#fff; padding:1rem; margin:0.5rem 0; border-radius:0.75rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
    canvas { width:100%; height:200px; }
  </style>
</head>
<body>
  <h1>ðŸŒ³ WALDSENSOR.SH â€“ Sensor Live-Daten</h1>
  <p>Diese Seite zeigt die aktuellen Werte aller angeschlossenen Nodes.</p>

  <section id="latest">
    <h2>Letzte Messwerte</h2>
    <div id="latest-wrap"></div>
  </section>

  <!-- ======== History (unterer Teil) ======== -->
  <section id="history" style="margin:1rem 0;">
    <h2>Verlauf (letzte 7 Tage)</h2>
    <div id="histograms"></div>
  </section>

  <script>
  const ALL_JSON   = "data/v2/latest/_all.json";
  const HIST_PATH  = "data/v2/history/";

  // bekannte Nodes
  const NODES = [
    { id: "breklum",  title: "Breklum" },
    { id: "fahrdorf", title: "Fahrdorf" },
    { id: "kropp",    title: "Kropp" },
    { id: "lsn50",    title: "LSN50" },
    { id: "s31",      title: "S31" },
    { id: "se01",     title: "SE01 (Boden)" }
  ];

  async function fetchJSON(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error(url+" â†’ "+r.status);
    return r.json();
  }
  function el(tag, attrs={}, ...kids){
    const x=document.createElement(tag);
    for(const [k,v] of Object.entries(attrs)) (k in x?x[k]=v:x.setAttribute(k,v));
    kids.forEach(k=>x.append(k));
    return x;
  }
  function fmt(ts){ return new Date(ts).toLocaleString("de-DE",{dateStyle:"short",timeStyle:"short"}); }

  // kleines Canvas-Chart
  function drawLine(canvas, series, opts={}) {
    const ctx=canvas.getContext("2d"), W=canvas.width, H=canvas.height;
    ctx.clearRect(0,0,W,H);
    if(!series.length){ctx.fillText("Keine Daten",10,20);return;}
    const xs=series.map(p=>p.x), ys=series.map(p=>p.y);
    const minX=Math.min(...xs), maxX=Math.max(...xs);
    const minY=Math.min(...ys), maxY=Math.max(...ys);
    const pad=30, sx=x=>pad+((x-minX)/(maxX-minX||1))*(W-2*pad),
                sy=y=>(H-pad)-((y-minY)/(maxY-minY||1))*(H-2*pad);
    ctx.beginPath();ctx.moveTo(pad,H-pad);ctx.lineTo(W-pad,H-pad);ctx.moveTo(pad,H-pad);ctx.lineTo(pad,pad);ctx.stroke();
    ctx.strokeStyle=opts.color||"#0a84ff";ctx.beginPath();
    series.forEach((p,i)=>{const X=sx(p.x),Y=sy(p.y);i?ctx.lineTo(X,Y):ctx.moveTo(X,Y);});ctx.stroke();
  }

  async function render(){
    // --- Latest ---
    const latest=await fetchJSON(ALL_JSON);
    const Lwrap=document.getElementById("latest-wrap"); Lwrap.innerHTML="";
    latest.forEach(node=>{
      const card=el("div",{className:"card"},
        el("h3",{},node.id),
        el("p",{},"Zeit: "+fmt(node.ts)),
        el("pre",{},JSON.stringify(node.fields,null,2))
      );
      Lwrap.append(card);
    });

    // --- History ---
    const Hwrap=document.getElementById("histograms"); Hwrap.innerHTML="";
    for(const n of NODES){
      try {
        const data=await fetchJSON(HIST_PATH+n.id+".json");
        const tSeries=data.filter(p=>p.t!=null).map(p=>({x:new Date(p.ts).getTime(),y:p.t}));
        const hSeries=data.filter(p=>p.h!=null).map(p=>({x:new Date(p.ts).getTime(),y:p.h}));
        const card=el("div",{className:"card"},
          el("h3",{},n.title),
          el("canvas",{width:400,height:200,id:"c"+n.id+"t"}),
          el("canvas",{width:400,height:200,id:"c"+n.id+"h"})
        );
        Hwrap.append(card);
        drawLine(card.querySelector("#c"+n.id+"t"),tSeries,{color:"red"});
        drawLine(card.querySelector("#c"+n.id+"h"),hSeries,{color:"blue"});
      } catch(err){ console.warn("History-Fehler",n.id,err); }
    }
  }
  render();
  </script>
</body>
</html>i
