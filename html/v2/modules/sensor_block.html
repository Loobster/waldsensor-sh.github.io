<!-- html/v2/modules/sensor_block.html -->
<div id="sensor-block" class="card">
  <div id="stand" class="pill">Stand: —</div>

  <div class="section leaf" id="secLeaf" style="display:none">
    <h4>🌿 Blatt-Sensor</h4>
    <div class="tiles">
      <div class="tile"><h3>Temperatur</h3><p id="leafTemp">—</p></div>
      <div class="tile"><h3>Feuchte</h3><p id="leafMoist">—</p></div>
      <div class="tile"><h3>Batterie</h3><p id="leafBat">—</p></div>
    </div>
  </div>

  <div class="section air" id="secAir" style="display:none">
    <h4>🌤️ Luft-Sensor</h4>
    <div class="tiles">
      <div class="tile"><h3>Temperatur</h3><p id="airTemp">—</p></div>
      <div class="tile"><h3>Feuchte</h3><p id="airHum">—</p></div>
      <div class="tile"><h3>Batterie</h3><p id="airBat">—</p></div>
    </div>
  </div>

  <div class="section soil" id="secSoil" style="display:none">
    <h4>🌱 Boden-Sensor</h4>
    <div class="tiles">
      <div class="tile"><h3>Bodentemperatur</h3><p id="soilTemp">—</p></div>
      <div class="tile"><h3>Bodenfeuchte</h3><p id="soilWater">—</p></div>
      <div class="tile"><h3>Batterie</h3><p id="soilBat">—</p></div>
    </div>
  </div>

  <div class="small-note">Quelle: /data/v2/latest/all.json</div>
</div>

<script>
const $=id=>document.getElementById(id);
const setTxt=(id,v)=>{const el=$(id);if(el)el.textContent=v;};
const fmtNum=(v,d=1,s="")=>v==null||!isFinite(+v)?"—":(+v).toFixed(d).replace(".",",")+s;
const fmtDate=ts=>{if(!ts)return"—";const d=new Date(ts);return isNaN(d)? "—":d.toLocaleString("de-DE");};
const qp=new URLSearchParams(location.search);
const nodeIdRaw=qp.get("node")||"unknown";
const nodeId=nodeIdRaw.toLowerCase();

// JSON laden
async function fetchJson(){
  const urls=["/data/v2/latest/all_enriched.json","/data/v2/latest/all.json"];
  for(const u of urls){
    try{
      const r=await fetch(u+"?_="+Date.now(),{cache:"no-store"});
      if(r.ok){
        const data=await r.json();
        if(Array.isArray(data)&&data.length>0)return data;
      }
    }catch(e){}
  }
  return [];
}

// Hilfsfunktionen wie in v0.12
const pick=(o,...keys)=>{for(const k of keys)if(o&&o[k]!=null)return o[k];return null;};
const getId=o=>(o?.id||o?.device_id||"").toLowerCase();

function extractValues(n){
  const f=n.fields||n;
  return{
    leafTemp:pick(f,"Leaf_Temperature","leaf_temp_c"),
    leafMoist:pick(f,"Leaf_Moisture","leaf_moist_pct"),
    airTemp:pick(f,"TempC_SHT","TempC_SHT31","temp_c"),
    airHum:pick(f,"Hum_SHT","Hum_SHT31","hum_pct"),
    soilTemp:pick(f,"temp_SOIL","temp_soil_c"),
    soilWater:pick(f,"water_SOIL","water_soil"),
    bat:pick(f,"BatV","bat_v"),
    ts:pick(n,"ts","ts_iso","time")
  };
}

// Anzeige
(async()=>{
  const data=await fetchJson();
  const nodes=data.filter(o=>getId(o).includes(nodeId));
  if(nodes.length===0)return;

  const values={leaf:{},air:{},soil:{}};
  const byId=id=>data.find(o=>getId(o)===id);

  // automatische Zusammenführung mehrerer Sensoren
  const possibleTypes=["llms","s31","se01","lls","bee"];
  for(const t of possibleTypes){
    const m=data.find(o=>getId(o).includes(`${nodeId.split("_")[0]}_${t}`));
    if(!m)continue;
    const val=extractValues(m);
    if(/llms/.test(t)){$("secLeaf").style.display="";Object.assign(values.leaf,val);}
    if(/s31/.test(t)){$("secAir").style.display="";Object.assign(values.air,val);}
    if(/se01/.test(t)){$("secSoil").style.display="";Object.assign(values.soil,val);}
  }

  const latestTs=[values.leaf.ts,values.air.ts,values.soil.ts].filter(Boolean).sort((a,b)=>new Date(b)-new Date(a))[0];
  if(latestTs)setTxt("stand","Stand: "+fmtDate(latestTs));

  setTxt("leafTemp",fmtNum(values.leaf.leafTemp,1," °C"));
  setTxt("leafMoist",fmtNum(values.leaf.leafMoist,1," %"));
  setTxt("leafBat",fmtNum(values.leaf.bat,2," V"));

  setTxt("airTemp",fmtNum(values.air.airTemp,1," °C"));
  setTxt("airHum",fmtNum(values.air.airHum,1," %"));
  setTxt("airBat",fmtNum(values.air.bat,2," V"));

  setTxt("soilTemp",fmtNum(values.soil.soilTemp,1," °C"));
  setTxt("soilWater",fmtNum(values.soil.soilWater,1," %"));
  setTxt("soilBat",fmtNum(values.soil.bat,2," V"));
})();
</script>
