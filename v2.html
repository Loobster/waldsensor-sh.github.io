<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH ‚Äì Karte</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb; --ink:#0d1b2a; --muted:#64748b; --good:#16a34a;
      --card:#fff; --radius:14px; --pad:12px;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
    #map{position:absolute; inset:0}
    .hud{position:absolute; left:12px; top:12px; display:flex; gap:10px; z-index:1000}
    .hud .card{background:var(--card); border-radius:var(--radius); box-shadow:0 10px 30px -20px rgba(0,0,0,.25), 0 1px 0 rgba(0,0,0,.06); padding:10px 12px; min-width:220px}
    .hud .k{font-size:12px; color:var(--muted); margin-bottom:4px}
    .hud .v{font-weight:800; letter-spacing:.2px}
    .ver{position:absolute; left:50%; transform:translateX(-50%); top:12px; z-index:1000; background:var(--card); border-radius:999px; padding:5px 10px; font-size:12px; color:#475569; box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .last{position:absolute; right:12px; top:12px; z-index:1000; background:var(--card); border-radius:var(--radius); padding:10px 12px; min-width:260px; box-shadow:0 10px 30px -20px rgba(0,0,0,.25), 0 1px 0 rgba(0,0,0,.06)}
    .last .line{display:flex; justify-content:space-between; gap:10px}
    .ok{color:var(--good); font-weight:700}
    .err{color:#b91c1c; font-weight:700}
    /* Popup kompakt & mittig (auf Mobile nicht vom Browser-UI verdecken) */
    .leaflet-popup-content{margin:8px 10px; min-width: 220px; max-width: 280px; font-size:14px}
    .pop h3{margin:.2rem 0 .4rem; font-size:16px}
    .pop .m{color:var(--muted); font-size:12px}
    .btn{display:inline-block; margin-top:6px; text-decoration:none; font-weight:700; color:#2563eb}
    .qr{display:block; margin-top:6px; font-size:12px; color:#475569; text-decoration:none}
    @media (min-width:900px){ .leaflet-popup-content{max-width:320px} }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Version in der Mitte oben -->
  <div class="ver">v0.14.1 ¬∑ ZDL</div>

  <!-- HUD links -->
  <div class="hud">
    <div class="card">
      <div class="k">Aktive Sensoren</div>
      <div class="v"><span id="count">‚Äî</span></div>
    </div>
    <div class="card">
      <div class="k">Stand</div>
      <div class="v" id="stand">‚Äî</div>
    </div>
  </div>

  <!-- HUD rechts (letzte Meldung) -->
  <div class="last">
    <div class="k">Letzte Node-Meldung</div>
    <div class="line"><div id="last_id">‚Äî</div><div id="last_ts">‚Äî</div></div>
    <div id="last_age" class="m">‚Äî</div>
  </div>

  <script>
    // ---------- Utils ----------
    const byId = (x)=>document.getElementById(x);
    const safeStr = (s)=> String(s ?? "").trim();
    const isSoil = (id)=>/(^|[-_])se01(lb)?$/i.test(String(id||""));
    const fmtNum = (v, d=1)=> (v==null || Number.isNaN(Number(v))) ? "‚Äî" : Number(v).toFixed(d).replace(".",",");

    function fmtDate(ts){
      if(!ts) return "‚Äî";
      const d = new Date(ts);
      if(Number.isNaN(+d)) return "‚Äî";
      return d.toLocaleString("de-DE");
    }
    function ageStr(ts){
      if(!ts) return "‚Äî";
      const d = new Date(ts);
      if(Number.isNaN(+d)) return "‚Äî";
      const sec = Math.max(0, (Date.now()-d.getTime())/1000);
      if (sec < 90) return "vor " + Math.round(sec) + " s";
      const min = sec/60;
      if (min < 90) return "vor " + Math.round(min) + " min";
      const h = min/60;
      return "vor " + Math.round(h) + " h";
    }

    // ---------- Leaflet Karte ----------
    const map = L.map('map', { zoomControl: true }).setView([54.3, 9.8], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const markers = L.layerGroup().addTo(map);

    // ---------- Rendering ----------
    function renderMarkers(list){
      markers.clearLayers();

      // letzte Meldung bestimmen
      let lastItem = null;
      for(const e of list){
        const t = e.ts ? new Date(e.ts).getTime() : 0;
        if(!lastItem || t > (lastItem.ts? new Date(lastItem.ts).getTime() : 0)) lastItem = e;
      }

      // HUD links/rechts
      byId("count").textContent = list.length;
      byId("stand").textContent = lastItem?.ts ? fmtDate(lastItem.ts) : "‚Äî";
      byId("last_id").textContent = lastItem?.id || "‚Äî";
      byId("last_ts").textContent = lastItem?.ts ? fmtDate(lastItem.ts) : "‚Äî";
      byId("last_age").textContent = lastItem?.ts ? ageStr(lastItem.ts) : "‚Äî";

      // Marker zeichnen
      list.forEach(e=>{
        const f = e.fields || {};
        const lat = f.lat ?? e.lat, lon = f.lon ?? e.lon;
        if(typeof lat !== "number" || typeof lon !== "number") return;

        const soil = isSoil(e.id);
        const temp = soil ? (f.temp_SOIL_num ?? f.temp_SOIL ?? null) : (f.TempC_SHT ?? f.TempC_SHT31 ?? null);
        const hum  = soil ? (f.water_SOIL_num ?? f.water_SOIL ?? null) : (f.Hum_SHT   ?? f.Hum_SHT31   ?? null);
        const bat  = f.BatV ?? null;

        const tTxt = soil ? (temp!=null? fmtNum(temp,1)+" ¬∞C (Boden)" : "‚Äî") : (temp!=null? fmtNum(temp,1)+" ¬∞C" : "‚Äî");
        const hTxt = soil ? (hum!=null?  fmtNum(hum,1)+" % Bodenwasser" : "‚Äî") : (hum!=null?  fmtNum(hum,0)+" %" : "‚Äî");
        const bTxt = bat!=null? fmtNum(bat,3)+" V" : "‚Äî";

        const sensorUrl = `/html/sensor.html?node=${encodeURIComponent(e.id)}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=90x90&data=${encodeURIComponent(location.origin+sensorUrl)}`;

        const html = `
          <div class="pop">
            <h3>Sensor: ${safeStr(e.id).replace(/_/g,"_").replace(/-/g,"-")}</h3>
            <div class="m">Zuletzt aktiv: ${fmtDate(e.ts)}</div>
            <div style="margin-top:6px;">
              <div>üå°Ô∏è ${tTxt}</div>
              <div>üíß ${hTxt}</div>
              <div>üîã ${bTxt}</div>
            </div>
            <a class="btn" href="${sensorUrl}">Statistik √∂ffnen</a>
            <a class="qr" href="${sensorUrl}" target="_blank" rel="noopener">
              <img src="${qrUrl}" alt="QR zum Sensor" width="90" height="90" />
            </a>
          </div>
        `;

        const m = L.marker([lat, lon]).addTo(markers);
        m.bindPopup(html, {autoPan:true, keepInView:true, maxWidth: 360});
      });
    }

    // ---------- Zero-Downtime Loader ----------
    window._lastAll = window._lastAll || [];

    async function loadLatestAndRender(){
      const prev = Array.isArray(window._lastAll) ? window._lastAll : [];
      try{
        const url = `/data/v2/latest/all.json?v=${Date.now()}`;
        const r = await fetch(url, {cache: 'no-store'});
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        const arr = await r.json();

        if (Array.isArray(arr) && arr.length > 0){
          window._lastAll = sanitizeAll(arr);
          renderMapSafe(window._lastAll);
        } else if (prev.length > 0){
          console.warn("all.json leer ‚Äì behalte vorherige Marker.");
          renderMapSafe(prev);
        } else {
          console.warn("Keine Daten verf√ºgbar.");
        }
      }catch(e){
        console.error("Fetch all.json fehlgeschlagen:", e);
        if (prev.length > 0){
          renderMapSafe(prev);
        }
      }
    }

    function sanitizeAll(arr){
      // IDs s√§ubern (keine Zeilenumbr√ºche, trim)
      return arr.map(x => {
        const id = safeStr(x.id||"");
        // TS in ISO lassen, sonst unver√§ndert
        return {...x, id};
      });
    }

    function renderMapSafe(list){
      if (!Array.isArray(list) || list.length===0) return;
      renderMarkers(list);
    }

    // Initial + zyklisch
    loadLatestAndRender();
    setInterval(loadLatestAndRender, 120000); // alle 2 Minuten

  </script>
</body>
</html>
