      const title = normId(first.id).split('-')[0] + '-' + normId(first.id).split('-')[1];

      const lastTs = first.ts ? formatDE(first.ts) : "—";
      const gwCount = f.gateway_count || 0;
      const batAvg = deNum(
        nodes.map(n => NUM(n.fields?.BatV)).filter(v => v).reduce((a,b)=>a+b,0) / nodes.length,
      2
    );

    let html = `<div class="popup">`;
    html += `<h3>${title} 
    html += `<h3>${title} <span class="status-badge status-excellent">${gwCount} Gateways</span></h3>`;
    html += `<div class="row"><span class="label">Letzte Meldung</span><span class="value">${lastTs}</span></div>`;
    html += `<div class="row"><span class="label">Durchschnittliche Batteriekapazität</span><span class="value">${batAvg} V</span></div>`;
    html += `<div class="row"><span class="label">Temperatur</span><span class="value">${getTemperature(f, true)} °C</span></div>`;
    html += `<div class="row"><span class="label">Luftfeuchtigkeit</span><span class="value">${getHumidity(f, true)} %</span></div>`;
    html += `<a href="https://example.com/${first.id}" class="btn">Weitere Details</a>`;
    html += `</div>`;
    return html;
  }
  </script>
</body>
</html>
