<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>WALDSENSOR.SH ‚Äì Karte (V2)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- QR-Code Generator -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    html, body { height:100%; margin:0; background:#eef3f7; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
    #map { height:100%; }

    .badge {
      position: absolute;
      z-index: 1000;
      background: white;
      color: #0f172a;
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(0,0,0,.15);
      font-weight: 600;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .badge-left  { left:14px;  top:14px;  }
    .badge-right { right:14px; top:14px;  }

    .qr-button {
      display:inline-block;
      margin-top:8px;
      padding:8px 12px;
      border-radius:12px;
      text-decoration:none;
      font-weight:600;
      background:#166534;        /* waldgr√ºn */
      color:#fff;
    }
    .qr-button:hover { filter:brightness(1.05); }

    .popup-wrap b { font-size:14px }
    .popup-wrap .meta { margin-top:4px; font-size:13px; color:#0f172a; }
    .popup-wrap hr { border:none; height:1px; background:#e5e7eb; margin:8px 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="badge-left"  class="badge badge-left">Letzte Aktualisierung: ‚Ä¶</div>
  <div id="badge-right" class="badge badge-right">Letzte Node-Meldung: ‚Ä¶</div>

  <script>
    // -------- Einstellungen --------
    const FETCH_URL = "/data/v2/latest/_all.json";   // Quelle aller Nodes
    const REFRESH_MS = 60_000 * 5;                   // alle 5 Minuten nachladen

    // Start-Ausschnitt (SH)
    const map = L.map('map').setView([54.5, 9.5], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);

    const leftBadge  = document.getElementById('badge-left');
    const rightBadge = document.getElementById('badge-right');

    function fmtTimeLocal(isoString) {
      try {
        const d = new Date(isoString);
        return d.toLocaleString('de-DE', {
          day:'2-digit', month:'2-digit', year:'numeric',
          hour:'2-digit', minute:'2-digit', second:'2-digit'
        });
      } catch { return '‚Äî'; }
    }

    function safeNum(v) {
      if (v === null || v === undefined || Number.isNaN(+v)) return '‚Äì';
      return (''+v).replace('.', ',');
    }

    async function loadAndRender() {
      // Zeitstempel (links) sofort setzen
      const now = new Date();
      leftBadge.textContent = `Letzte Aktualisierung: ${now.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`;

      let data;
      try {
        const res = await fetch(FETCH_URL, { cache:'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
        if (!Array.isArray(data)) throw new Error("Kein Array");
      } catch (e) {
        console.error("Laden fehlgeschlagen:", e);
        rightBadge.textContent = "Letzte Node-Meldung: ‚Äî (Fehler beim Laden)";
        return;
      }

      // Letzten Eintrag f√ºr Badge rechts suchen
      let newest = null;
      for (const r of data) {
        if (!r || !r.ts) continue;
        if (!newest || new Date(r.ts) > new Date(newest.ts)) newest = r;
      }
      if (newest) {
        rightBadge.textContent = `Letzte Node-Meldung: ${newest.id} ‚Äî ${fmtTimeLocal(newest.ts)}`;
      } else {
        rightBadge.textContent = "Letzte Node-Meldung: ‚Äî";
      }

      // Marker neu zeichnen
      markers.clearLayers();

      // OPTIONAL: feste Positionen ‚Äì werden genutzt, wenn im Datensatz keine lat/lon stehen
      const FIX_POS = {
        "breklum-sn50v3":  [54.60669, 8.98195],
        "s31-lb":          [54.65000, 8.96000],
        "kropp-sn50v3":    [54.41018, 9.52839],
        "fahrdorf-sn50v3": [54.50158, 9.58690],
        "lsn50-v2":        [54.557,   9.55]
      };

      for (const rec of data) {
        const id     = rec.id || "unbekannt";
        const fields = rec.fields || {};
        // Position ermitteln
        let lat = fields.lat ?? fields.Lat ?? null;
        let lon = fields.lon ?? fields.Lon ?? null;
        if ((lat===null || lon===null) && FIX_POS[id]) {
          [lat, lon] = FIX_POS[id];
        }
        if (lat === null || lon === null) continue; // ohne Koordinaten nicht anzeigen

        const temp = fields.TempC_SHT ?? fields.TempC_SHT31 ?? null;
        const hum  = fields.Hum_SHT  ?? fields.Hum_SHT31  ?? null;
        const vbat = fields.BatV ?? null;
        const when = rec.ts ? fmtTimeLocal(rec.ts) : '‚Äî';

        const popupHtml = `
          <div class="popup-wrap">
            <b>${id}</b>
            <div class="meta">Zeit: ${when}</div>
            <hr/>
            <div>üå°Ô∏è Temp: <b>${safeNum(temp)}</b> ¬∞C</div>
            <div>üíß Feuchte: <b>${safeNum(hum)}</b> %</div>
            <div>üîã Batterie: <b>${safeNum(vbat)}</b> V</div>
            <div id="qr-${id}" style="margin-top:10px;"></div>
            <div style="margin-top:6px;">
              <a class="qr-button" target="_blank"
                 href="html/sensor.html?node=${encodeURIComponent(id)}">Seite √∂ffnen</a>
            </div>
          </div>
        `;

        const m = L.marker([lat, lon]).bindPopup(popupHtml);
        m.on('popupopen', () => {
          const el = document.getElementById(`qr-${id}`);
          if (el && !el.dataset.done) {
            new QRCode(el, {
              text: `${location.origin}/html/sensor.html?node=${encodeURIComponent(id)}`,
              width: 128, height: 128
            });
            el.dataset.done = "1";
          }
        });
        markers.addLayer(m);
      }
    }

    loadAndRender();
    setInterval(loadAndRender, REFRESH_MS);
  </script>
</body>
</html>
