<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (V2)</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --pill-bg:#fff;
      --pill-text:#106e2a;
      --pill-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    .pill {
      position: fixed;
      z-index: 999;
      top: 14px;
      left: 14px;
      background: var(--pill-bg);
      color: var(--pill-text);
      padding: 10px 14px;
      border-radius: 14px;
      font: 600 18px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #e8e8e8;
    }

    .last-node {
      position: fixed;
      z-index: 999;
      top: 14px;
      right: 14px;
      background: #e9f3ff;
      color: #0b4da2;
      padding: 10px 14px;
      border-radius: 14px;
      font: 600 16px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #d6e6ff;
      max-width: 42ch;
      text-align: right;
    }

    .popup h3{
      margin:0 0 .25rem 0;
      font: 700 20px/1.25 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .popup hr{ border:0; height:1px; background:#ececec; margin:.5rem 0 .75rem; }
    .popup .kv{ margin:.15rem 0; }
    .popup .kv b{ font-weight:700; }
  </style>
</head>
<body>
  <div class="pill" id="stamp">Letzte Aktualisierung: –</div>
  <div class="last-node" id="last">Letzte Node-Meldung: –</div>
  <div id="map"></div>

  <script>
    // ------------------------------
    // Konfiguration
    // ------------------------------
    const DATA_URL = "/data/v2/latest/_all.json";  // GitHub Pages Pfad
    const AUTO_REFRESH_MS = 60_000;                // 60s neu laden

    // Manuelle Koordinaten (override), falls nicht im JSON (fields.lat/lon)
    // -> bitte bei Bedarf anpassen/ergänzen
    const MANUAL_LOC = {
      const MANUAL_LOC = {
      "breklum-sn50v3":  [54.60669, 8.98195], // Breklum
      "s31-lb":          [54.65000, 8.96000], // Bredstedt
      "kropp-sn50v3":    [54.41018, 9.52839], // Kropp
      "fahrdorf-sn50v3": [54.50158, 9.58690], // Fahrdorf
      // "lsn50-v2":      [LAT, LON],          // ggf. später ergänzen
     };

    // Felder, die in Popups NICHT angezeigt werden sollen
    const OMIT_FIELDS = new Set(["ADC1_V","EXTI_Trigger","Door_status"]);

    // ------------------------------
    // Map aufsetzen
    // ------------------------------
    const map = L.map("map", { zoomSnap: 0.25 });
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> Mitwirkende'
      }
    ).addTo(map);

    // sanfter Startfokus Schleswig-Holstein
    map.setView([54.4, 9.6], 8.25);

    let markersLayer = L.layerGroup().addTo(map);

    // ------------------------------
    // Helfer
    // ------------------------------
    function deTime(ts){
      try {
        return new Date(ts).toLocaleString("de-DE", {
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit", second:"2-digit"
        });
      } catch(_){ return ts || "–"; }
    }

    function cleanFields(fields){
      const out = {};
      for (const [k,v] of Object.entries(fields || {})){
        if (OMIT_FIELDS.has(k)) continue;
        if (v === undefined || v === null || v === "NULL") continue;
        if (typeof v === "number" && v === 0) continue; // „leere“ 0er weglassen
        out[k] = v;
      }
      return out;
    }

    function pickCoord(item){
      // 1) bevorzugt aus JSON feldern
      if (item?.fields?.lat !== undefined && item?.fields?.lon !== undefined){
        return [Number(item.fields.lat), Number(item.fields.lon)];
      }
      // 2) manueller Override
      if (MANUAL_LOC[item.id]) return MANUAL_LOC[item.id];
      return null;
    }

    function popupHtml(item){
      const f = cleanFields(item.fields);
      let html = `<div class="popup">`;
      html += `<h3>${item.id}</h3>`;
      html += `<div class="kv">Zeit: <b>${deTime(item.ts)}</b></div>`;
      html += `<hr/>`;

      // bevorzugt SHT31, fallback SHT
      if (typeof f.TempC_SHT31 === "number")
        html += `<div class="kv">Temp (SHT31): <b>${f.TempC_SHT31.toFixed(2)} °C</b></div>`;
      else if (typeof f.TempC_SHT === "number")
        html += `<div class="kv">Temp (SHT): <b>${f.TempC_SHT.toFixed(1)} °C</b></div>`;

      if (typeof f.Hum_SHT31 === "number")
        html += `<div class="kv">Hum (SHT31): <b>${f.Hum_SHT31.toFixed(2)} %</b></div>`;
      else if (typeof f.Hum_SHT === "number")
        html += `<div class="kv">Hum (SHT): <b>${f.Hum_SHT.toFixed(1)} %</b></div>`;

      if (typeof f.BatV === "number")
        html += `<div class="kv">Batterie: <b>${f.BatV.toFixed(2)} V</b></div>`;

      // Restliche sinnvolle Felder generisch anhängen (außer lat/lon)
      for (const [k,v] of Object.entries(f)){
        if (["TempC_SHT31","TempC_SHT","Hum_SHT31","Hum_SHT","BatV","lat","lon"].includes(k)) continue;
        html += `<div class="kv">${k}: <b>${v}</b></div>`;
      }

      html += `</div>`;
      return html;
    }

    function setStamp(tsArr){
      const pill = document.getElementById("stamp");
      const last = document.getElementById("last");
      if (!tsArr.length){
        pill.textContent = "Letzte Aktualisierung: –";
        last.textContent = "Letzte Node-Meldung: –";
        return;
      }
      const newest = tsArr.sort().at(-1);
      pill.textContent = "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
      last.textContent = "Letzte Node-Meldung: " + deTime(newest);
    }

    async function loadData(){
      // Cache-Busting, damit GitHub Pages nicht cached
      const url = `${DATA_URL}?t=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("fetch failed " + res.status);
      return res.json();
    }

    function render(data){
      markersLayer.clearLayers();
      const bounds = [];

      const timestamps = [];

      for (const item of (data || [])){
        if (item.ts) timestamps.push(item.ts);

        const coord = pickCoord(item);
        if (!coord) continue; // ohne Koordinate kein Marker

        const m = L.marker(coord).bindPopup(popupHtml(item));
        m.addTo(markersLayer);
        bounds.push(coord);
      }

      // Karte fokussieren, wenn wir Marker haben
      if (bounds.length){
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.12));
      }

      setStamp(timestamps);
    }

    async function run(){
      try{
        const data = await loadData();
        render(data);
      }catch(err){
        console.error(err);
        // Anzeige beibehalten, aber Stempel updaten:
        document.getElementById("stamp").textContent =
          "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
      }
    }

    // Initial & Auto-Refresh
    run();
    setInterval(run, AUTO_REFRESH_MS);
  </script>
</body>
</html>
