<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Waldsensor.SH – Karte V2</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .badge {
      position: fixed;
      z-index: 1000;
      background: rgba(255,255,255,0.96);
      color: #111;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 12px;
      padding: 8px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      font: 15px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      pointer-events: none;
    }
    /* linke Badge 60px nach rechts, damit Leaflet-Buttons frei bleiben */
    #badge-left  { top: 12px; left: 60px; }
    #badge-right { top: 12px; right: 12px; }

    .popup h3 { margin: 0 0 6px; font-size: 18px; }
    .popup .kv { margin: 3px 0; font-size: 15px; }
    .popup .kv b { display:inline-block; min-width: 145px; }
    .sep { margin: 10px 0; height:1px; background:#eee; }
    .qrbox {
      display:flex; align-items:center; gap:12px; margin-top:8px;
      padding:8px; border:1px solid #eee; border-radius:10px; background:#fafafa;
    }
    .btn {
      display:inline-block; padding:6px 10px; border-radius:8px;
      background:#d4edda; color:#fff; text-decoration:none; font-weight:600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <!-- feste Badges -->
  <div id="badge-left"  class="badge">Letzte Aktualisierung: –</div>
  <div id="badge-right" class="badge">Letzte Node-Meldung: –</div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
  (async function () {
    // -------- Einstellungen --------
    const ALL_URL   = '/data/v2/latest/_all.json';           // Datenquelle (unverändert)
    const FETCH_URL = ALL_URL + '?t=' + Date.now();          // Cache-Buster

    // Fallback-Koordinaten für 5 produktive Nodes
    const POSITIONS = {
      'breklum-sn50v3': { lat: 54.60669, lon: 8.98195 },
      's31-lb':         { lat: 54.65000, lon: 8.96000 }, // Bredstedt
      'se01-lb':        { lat: 54.65111, lon: 8.95688 }, // Bredstedt (nahe)
      'kropp-sn50v3':   { lat: 54.41018, lon: 9.52839 },
      'fahrdorf-sn50v3':{ lat: 54.50158, lon: 9.58690 }
    };

    // Technik-/Debug-Felder im Popup ausblenden (inkl. Node_type)
    const FIELDS_TO_IGNORE = new Set([
      'ADC1_V','Digital_IStatus','Door_status','EXTI_Trigger','TempC1','Work_mode',
      'Mod','conduct_SOIL','i_flag','s_flag','temp_DS18B20',
      'alt1','alt2','bw','chan1','f_cnt','freq1','gw1','gw2',
      'lat1','lat2','lon1','lon2','rssi1','rssi2','rx_time1','sf','snr1','snr2',
      'data_time','Data_time','Node_type' // <- entfernt "Node_type: —"
    ]);

    // -------- Karte --------
    const map = L.map('map', { zoomControl:true }).setView([54.6, 9.3], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Badges aktualisieren
    const leftBadge  = document.getElementById('badge-left');
    const rightBadge = document.getElementById('badge-right');
    function tickLocalClock(){
      const now = new Date();
      leftBadge.textContent = 'Letzte Aktualisierung: '
        + now.toLocaleTimeString('de-DE', {hour12:false});
    }
    tickLocalClock();
    setInterval(tickLocalClock, 1000);

    // -------- Daten laden --------
// -------- Daten laden --------
let data;
try {
  const url = FETCH_URL + "?t=" + new Date().getTime();   // Cache-Buster
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  data = await res.json();
  if (!Array.isArray(data)) throw new Error('JSON ist kein Array');
} catch(e) {
  console.error('Daten laden fehlgeschlagen:', e);
  rightBadge.textContent = 'Letzte Node-Meldung: — (Fehler beim Laden)';
  return;
}
    // Rechts: letzte Node-Meldung
    let latest = null;
    for (const r of data) {
      if (!latest || new Date(r.ts) > new Date(latest.ts)) latest = r;
    }
    if (latest) {
      rightBadge.textContent = `Letzte Node-Meldung: ${latest.id} — `
        + new Date(latest.ts).toLocaleString('de-DE', {hour12:false});
    } else {
      rightBadge.textContent = 'Letzte Node-Meldung: —';
    }

    // Anti-Overlap: kleiner Versatz bei exakt gleichen Koordinaten
    const coordCount = new Map();
    const key = (lat,lon)=> lat.toFixed(6)+','+lon.toFixed(6);
    function jitter(lat,lon){
      const k = key(lat,lon);
      const n = (coordCount.get(k) || 0);
      coordCount.set(k, n+1);
      if (n===0) return [lat,lon];
      const d = 0.00025 * n; // ~25m
      const a = (n%2===0) ? 1 : -1;
      return [lat + d*a, lon - d*a];
    }

    // -------- Marker & Popups --------
    for (const rec of data){
      const id = rec?.id || '';
      const f  = rec?.fields || {};

      // 1) Koordinaten: bevorzugt aus JSON, sonst Fallback
      let lat = Number(f.lat), lon = Number(f.lon);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        const pos = POSITIONS[id];
        if (pos) { lat = pos.lat; lon = pos.lon; }
      }
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
        // ohne Koordinaten kein Marker
        continue;
      }
      const [Jlat,Jlon] = jitter(lat, lon);

      // 2) Werte fürs Popup (Temp/Hum/Bat)
      const temp = (f.TempC_SHT31 ?? f.TempC_SHT ?? f.temp_SOIL);
      const hum  = (f.Hum_SHT31   ?? f.Hum_SHT   ?? f.water_SOIL);
      const bat  = f.BatV;

      const fmt = (v,unit='') => (v==null || Number.isNaN(Number(v)))
        ? '—'
        : (typeof v === 'number' ? v.toLocaleString('de-DE') : String(v)) + (unit?` ${unit}`:'');

      // Kurzname für QR/Link: Teil vor dem ersten Bindestrich
      const short = id.includes('-') ? id.split('-')[0] : id;
      const detailUrl = `https://www.waldsensor.sh/html/sensor.html?node=${encodeURIComponent(short)}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=140x140&data=${encodeURIComponent(detailUrl)}`;

      let html = `<div class="popup">`
               + `<h3>${id}</h3>`
               + `<div class="kv"><b>Zeit:</b> ${new Date(rec.ts).toLocaleString('de-DE',{hour12:false})}</div>`
               + `<div class="kv"><b>Temp:</b> ${fmt(temp,'°C')}</div>`
               + `<div class="kv"><b>Feuchte:</b> ${fmt(hum,'%')}</div>`
               + `<div class="kv"><b>Batterie:</b> ${fmt(bat,'V')}</div>`
               + `<div class="sep"></div>`;

      // restliche Felder – bereinigt
      for (const [k,v] of Object.entries(f)){
        if (FIELDS_TO_IGNORE.has(k)) continue;
        if (['TempC_SHT','TempC_SHT31','temp_SOIL','Hum_SHT','Hum_SHT31','water_SOIL','BatV','lat','lon'].includes(k)) continue;
        html += `<div class="kv"><b>${k}:</b> ${fmt(v)}</div>`;
      }

      // QR + Link
      html += `<div class="sep"></div>
               <div class="qrbox">
                 <img src="${qrUrl}" alt="QR" width="140" height="140" loading="lazy">
                 <div>
                   <div style="font-weight:600; margin-bottom:6px;">Sensor-Details</div>
                   <a class="btn" href="${detailUrl}" target="_blank" rel="noopener">Seite öffnen</a>
                   <div style="font-size:12px; color:#555; margin-top:6px;">oder QR-Code scannen</div>
                 </div>
               </div>
               </div>`;

      L.marker([Jlat, Jlon]).addTo(map).bindPopup(html);
    }
  })();
  </script>
</body>
</html>
