<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Waldsensor.SH – Karte</title>
  <!-- v2.html VERSION: v0.1 (nur: kompaktere Popups + SOIL-Felder/Statistik) -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --bg:#f8fafc; --card:#ffffff;
      --pad:12px; --radius:12px;
      --label:#334155; --val:#0b1324;
      --chip:#eef2ff; --chipText:#3730a3;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
    #app{display:flex;align-items:flex-start;gap:10px;padding:10px}
    .topbar{position:fixed;left:10px;top:10px;right:10px;display:flex;justify-content:space-between;align-items:center;z-index:500}
    .badge{background:var(--card);border-radius:999px;padding:6px 10px;box-shadow:0 2px 10px rgba(0,0,0,.06);font-weight:700}
    .muted{color:var(--muted)}
    #map{height:calc(100vh - 20px);width:100%;}
    /* kompakteres Popup */
    .leaflet-popup-content-wrapper{border-radius:12px;}
    .popup{min-width:240px;max-width:320px}
    .popup h3{margin:0 0 6px;font-size:16px;letter-spacing:.2px}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:center}
    .kv .k{color:var(--label);font-weight:600}
    .kv .v{color:var(--val);font-weight:800}
    .hr{height:1px;background:#e2e8f0;margin:8px 0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .chip{background:var(--chip);color:var(--chipText);font-weight:700;border-radius:999px;padding:4px 8px;font-size:12px}
    .btn{display:inline-block;text-decoration:none;background:#111827;color:#fff;padding:7px 10px;border-radius:8px;font-weight:700}
    .coords{font-family:ui-monospace,Menlo,Consolas,monospace;color:#475569;font-size:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="badge">WALDSENSOR.SH • <span id="nodeCount">–</span> Nodes</div>
    <div class="badge">Letzte Meldung: <span id="lastTs">–</span> &nbsp;<span class="muted">| v0.1</span></div>
  </div>
  <div id="app">
    <div id="map"></div>
  </div>

<script>
/* ===== Konfiguration (nur das Notwendige) ============================== */
const VERSION = "v0.1";
const DATA_URL = "/data/v2/latest/all.json";
const DENY = new Set(["lsn50"]); // dauerhaft ausblenden

// Manuelle Koordinaten (Fallback, werden nur genutzt, wenn im Datensatz lat/lon fehlen)
const MANUAL_LOC = {
  "hooge": [54.5582, 8.5464],
  "kropp": [54.4093988908855, 9.5285027323752],
  "neumuenstertl": [54.07586, 9.98926],
  "s31": [54.651105744662, 8.95686194107564]
};

// se01/se01lb erkennen (auch mit Prefix wie bredstedt-, Suffix _se01lb)
const isSoilNode = (id)=>/(^|[-_])se01(lb)?$/i.test(String(id||""));

/* ===== Helfer ========================================================== */
const byId = (s)=>document.getElementById(s);
const deTime = (ts)=>{
  if(!ts) return "–";
  try { return new Date(ts).toLocaleString("de-DE"); } catch { return "–"; }
};
const deNum = (n,d=1)=>{
  return (typeof n==="number" && Number.isFinite(n))
    ? n.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d})
    : "–";
};
const displayName = (id)=>{
  if(!id) return "";
  let s = String(id);
  s = s.replace(/_/g,"-");                    // Schacht_audorf → Schacht-audorf
  s = s.split("-").map(p=>p? p[0].toUpperCase()+p.slice(1) : p).join("-"); // Title-Case
  return s;
};
const normalizeId = (id)=>String(id||"").trim();

/* ===== Popup HTML (kompakt) =========================================== */
function popupHtml(item){
  const id = normalizeId(item.id);
  const f = item.fields || {};
  const soil = isSoilNode(id);

  // Wertezuordnung nach Node-Typ
  const temp = soil ? (typeof f.temp_SOIL==="number" ? f.temp_SOIL : null)
                    : (typeof f.TempC_SHT==="number" ? f.TempC_SHT
                       : (typeof f.TempC_SHT31==="number" ? f.TempC_SHT31 : null));
  const hum  = soil ? (typeof f.water_SOIL==="number" ? f.water_SOIL : null)
                    : (typeof f.Hum_SHT==="number" ? f.Hum_SHT
                       : (typeof f.Hum_SHT31==="number" ? f.Hum_SHT31 : null));
  const bat  = (typeof f.BatV==="number") ? f.BatV : null;

  const lat = (typeof f.lat==="number") ? f.lat : (MANUAL_LOC[id]?.[0] ?? null);
  const lon = (typeof f.lon==="number") ? f.lon : (MANUAL_LOC[id]?.[1] ?? null);

  const tLabel = soil ? "Bodentemperatur" : "Temperatur";
  const hLabel = soil ? "Bodenfeuchte"    : "Luftfeuchte";

  const nice = displayName(id);

  let html = `<div class="popup">
    <h3>Sensor: ${nice}</h3>
    <div class="row">
      <span class="chip">Zuletzt: ${deTime(item.ts)}</span>
      <a class="btn" href="/sensor.html?node=${encodeURIComponent(id)}">Statistik öffnen</a>
    </div>
    <div class="hr"></div>
    <div class="kv">
      <div class="k">BatV</div><div class="v">${bat!==null? deNum(bat,3)+" V":"–"}</div>
      <div class="k">${hLabel}</div><div class="v">${hum!==null? deNum(hum,1)+" %":"–"}</div>
      <div class="k">${tLabel}</div><div class="v">${temp!==null? deNum(temp,1)+" °C":"–"}</div>
    </div>
    <div class="hr"></div>
    <div class="coords">Koordinaten: ${lat!=null?lat.toFixed(5):"–"}, ${lon!=null?lon.toFixed(5):"–"}</div>
  </div>`;
  return html;
}

/* ===== Daten laden ===================================================== */
async function fetchLatest(){
  const url = `${DATA_URL}?_=${Date.now()}`; // Cache-Buster
  const r = await fetch(url,{cache:"no-store"});
  if(!r.ok) throw new Error("Datenquelle nicht erreichbar: "+r.status);
  const arr = await r.json();
  // Denylist anwenden + IDs normieren
  const list = (Array.isArray(arr) ? arr : []).map(it=>({...it,id:normalizeId(it.id)}))
    .filter(it=>!DENY.has(it.id.toLowerCase()));
  return list;
}

/* ===== Karte =========================================================== */
(async function main(){
  // Leaflet-Map
  const map = L.map('map',{zoomControl:true}).setView([54.3,9.6],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19, attribution:'© OpenStreetMap'
  }).addTo(map);

  // Daten
  let data=[];
  try{
    data = await fetchLatest();
  }catch(e){
    console.error(e);
  }

  // Letzte Meldung + Node-Zahl
  byId("nodeCount").textContent = data.length || "0";
  const latestTs = data.reduce((m,x)=> x?.ts && (!m || x.ts>m)? x.ts : m, null);
  byId("lastTs").textContent = deTime(latestTs);

  // Marker anlegen
  const group = L.featureGroup().addTo(map);
  data.forEach(item=>{
    const id = item.id;
    const f  = item.fields || {};
    let lat = (typeof f.lat==="number") ? f.lat : (MANUAL_LOC[id]?.[0] ?? null);
    let lon = (typeof f.lon==="number") ? f.lon : (MANUAL_LOC[id]?.[1] ?? null);
    if(lat==null || lon==null) return; // ohne Koordinaten kein Marker

    const marker = L.marker([lat,lon]).addTo(group);

    // Popup – mit autoPanPadding, damit nichts hinter dem oberen Rand verschwindet
    const pop = L.popup({
      maxWidth: 340,
      autoPan: true,
      autoPanPaddingTopLeft: [10, 60], // oben Platz lassen (Topbar)
      autoPanPaddingBottomRight: [10, 20],
      className: 'ws-popup'
    }).setContent(popupHtml(item));

    marker.on('click', ()=>{
      marker.bindPopup(pop).openPopup();
    });
  });

  if(group.getLayers().length){
    map.fitBounds(group.getBounds().pad(0.2));
  }
})();
</script>
</body>
</html>
