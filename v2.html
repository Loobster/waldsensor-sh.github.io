<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (V2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster optional (jetzt nicht genutzt, aber vorbereitet) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    :root{
      --pill-bg:#fff;
      --pill-text:#106e2a;
      --pill-shadow:0 2px 10px rgba(0,0,0,.15);
      --line:#e9eef3;
      --blue:#0b4da2;
      --blue-bg:#eef4ff;
      --muted:#6b7280;
      --ok:#106e2a;
    }
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    .pill {
      position: fixed;
      z-index: 1001;
      top: 12px;
      left: 70px;
      background: var(--pill-bg);
      color: var(--pill-text);
      padding: 8px 12px;
      border-radius: 14px;
      font: 600 15px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #e8e8e8;
      white-space: nowrap;
    }

    .last-node {
      position: fixed;
      z-index: 1001;
      top: 12px;
      right: 12px;
      background: #f6f9ff;
      color: var(--blue);
      padding: 8px 12px;
      border-radius: 14px;
      font: 600 14px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #d6e6ff;
      max-width: 46ch;
      text-align: right;
    }

    /* Popup kompakt & sauber */
    .leaflet-popup { z-index: 1002; }
    .leaflet-popup-content-wrapper { border-radius: 12px; }
    .leaflet-popup-content { margin: 8px 10px; }
    .popup { width: 280px; }
    .popup h3{
      margin:0 0 .35rem 0;
      font:700 17px/1.25 system-ui;
      word-break: break-word;
    }
    .sub {
      color: var(--muted);
      font: 500 12px/1.25 system-ui;
      margin: 2px 0 6px;
    }
    .hr { height:1px; background:var(--line); margin:6px 0 8px; }

    .row {
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 8px;
      margin: 4px 0;
      font: 600 14px/1.25 system-ui;
    }
    .row .label { color:#111; }
    .row .value { color:#0f172a; }

    .row.accent .value { color:#0b4da2; } /* leicht farbig hervorheben */

    .coords {
      color: var(--muted);
      font: 500 12px/1.25 system-ui;
      margin-top: 6px;
    }

    .qrrow {
      display:flex; gap:10px; align-items:center; margin-top:8px;
    }
    .qrbox { width: 110px; height: 110px; display:flex; align-items:center; justify-content:center; }
    .openbtn {
      display:inline-block; padding:10px 12px; border-radius:12px;
      background:var(--blue-bg); color:var(--blue); font:700 16px/1.1 system-ui;
      text-decoration:none; border:1px solid #d6e6ff; white-space:nowrap;
    }
    .hint { color:#667085; font:500 11px/1.3 system-ui; margin-top:4px; }
  </style>
</head>
<body>
  <div class="pill" id="stamp">Letzte Aktualisierung: – • Nodes: –</div>
  <div class="last-node" id="last">Letzte Node-Meldung: –</div>
  <div id="map"></div>

  <script>
    // ============================================================
    // KONSTANTEN
    // ============================================================
    const DATA_URL = "/data/v2/latest/all.json";
    const AUTO_REFRESH_MS = 60_000;

    // Denylist: dauerhaft ausschließen (case-insensitiv, nach Normalisierung)
    const DENY = new Set(["breklum","lsn50"]);

    // Im Popup ausblenden (Debug/Interne Felder)
    const OMIT_FIELDS = new Set(["ADC1_V","EXTI_Trigger","Door_status","lat","lon","alt","Data_time"]);

    // ============================================================
    // HILFE: ID-Normalisierung & Anzeigeformat
    // ============================================================
    function normalizeId(s){
      return String(s||'')
        .toLowerCase()
        .replace(/\r|\s+/g,'')             // \r/Spaces raus
        .replace(/^waldsensor[_-]/,'')     // Präfix weg
        .replace(/_/g,'-');                // _ -> -
    }

    function splitOrtModell(normId){
      // Erwartet Schemata wie: ort-s31lb / ort-se01lb / ort-sn50v3 / ort-lsn50v2 / usw.
      const parts = normId.split('-');
      if (parts.length >= 2){
        const modell = parts[parts.length - 1];
        const ort = parts.slice(0, parts.length - 1).join('-');
        return { ort, modell };
      }
      return { ort: normId, modell: "" };
    }

    function deTime(ts){
      try {
        return new Date(ts).toLocaleString("de-DE", {
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit", second:"2-digit"
        });
      } catch(_){ return ts || "–"; }
    }

    function deNum(n, digits=1){
      return (typeof n === "number" && Number.isFinite(n))
        ? n.toLocaleString("de-DE", { minimumFractionDigits: digits, maximumFractionDigits: digits })
        : "–";
    }

    function cleanFields(fields){
      const out = {};
      for (const [k,v] of Object.entries(fields || {})){
        if (OMIT_FIELDS.has(k)) continue;
        if (v === undefined || v === null || v === "NULL") continue;
        if (typeof v === "number" && !Number.isFinite(v)) continue;
        out[k] = v;
      }
      return out;
    }

    function pickCoord(item){
      const f = item?.fields || {};
      if (typeof f.lat !== "undefined" && typeof f.lon !== "undefined"){
        const la = Number(f.lat), lo = Number(f.lon);
        if (Number.isFinite(la) && Number.isFinite(lo)) return [la, lo];
      }
      // kein Fallback mehr: wenn keine Koords -> kein Marker
      return null;
    }

    function latestRecord(data){
      let best = null, bestT = -Infinity;
      for (const r of (data||[])){
        if (!r || !r.ts) continue;
        const t = new Date(r.ts).getTime();
        if (!Number.isNaN(t) && t > bestT){ bestT = t; best = r; }
      }
      return best;
    }

    // ============================================================
    // POPUP HTML
    // ============================================================
    function popupHtml(item){
      const f = cleanFields(item.fields);
      const norm = normalizeId(item.id);
      const { ort, modell } = splitOrtModell(norm);

      // Preferred Felder
      const temp = (typeof f.TempC_SHT31 === "number") ? f.TempC_SHT31
                  : (typeof f.TempC_SHT   === "number") ? f.TempC_SHT
                  : (typeof f.TempC1      === "number") ? f.TempC1 : null;

      const hum  = (typeof f.Hum_SHT31 === "number") ? f.Hum_SHT31
                  : (typeof f.Hum_SHT   === "number") ? f.Hum_SHT : null;

      const bat  = (typeof f.BatV       === "number") ? f.BatV : null;

      let html = `<div class="popup">`;
      html += `<h3>${ort}${modell ? " – " + modell.toUpperCase() : ""}</h3>`;
      html += `<div class="sub">Zuletzt aktiv: ${deTime(item.ts)}</div>`;
      html += `<div class="hr"></div>`;

      if (temp !== null) html += `<div class="row accent"><span class="label">Temperatur</span><span class="value">${deNum(temp,1)} °C</span></div>`;
      if (hum  !== null) html += `<div class="row accent"><span class="label">Luftfeuchte</span><span class="value">${deNum(hum,1)} %</span></div>`;
      if (bat  !== null) html += `<div class="row"><span class="label">Batterie</span><span class="value">${deNum(bat,3)} V</span></div>`;

      // Restliche Felder kompakt
      for (const [k,v] of Object.entries(f)){
        if (["TempC_SHT31","TempC_SHT","TempC1","Hum_SHT31","Hum_SHT","BatV"].includes(k)) continue;
        html += `<div class="row"><span class="label">${k}</span><span class="value">${v}</span></div>`;
      }

      // Koordinaten (falls vorhanden)
      const la = Number(item?.fields?.lat), lo = Number(item?.fields?.lon);
      if (Number.isFinite(la) && Number.isFinite(lo)){
        html += `<div class="coords">Koordinaten: ${la.toFixed(5)}, ${lo.toFixed(5)}</div>`;
      }

      // QR + Link
      const shortId = norm;
      const url = `https://www.waldsensor.sh/html/sensor.html?node=${shortId}`;
      html += `
        <div class="qrrow">
          <div class="qrbox" id="qrcode-${shortId}"></div>
          <a class="openbtn" href="${url}" target="_blank" rel="noopener">Statistik öffnen</a>
        </div>
        <div class="hint">ID: <b>${shortId}</b></div>
      `;
      return html + `</div>`;
    }

    // ============================================================
    // LEAFLET SETUP
    // ============================================================
    const map = L.map("map", { zoomSnap: 0.25 });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);
    map.setView([54.4, 9.6], 8.25);

    let markersLayer = L.layerGroup().addTo(map);
    let lastGoodData = []; // für stabilen Badge-Text bei kurzzeitig leeren Arrays

    // Popup-Autoscroll, damit obere Popups nicht „aus dem Bild“ ragen
    map.on('popupopen', (e) => {
      try {
        const px = map.project(e.popup._latlng);
        px.y -= 120; // Popup-Höhe grob
        map.panTo(map.unproject(px), { animate:true });
      } catch(_){}
    });

    // ============================================================
    // DATENLADE / RENDER
    // ============================================================
    async function loadData(){
      const res = await fetch(`${DATA_URL}?t=${Date.now()}`, { cache:"no-store" });
      if (!res.ok) throw new Error("fetch failed " + res.status);
      return res.json();
    }

    function render(raw){
      // IDs normalisieren + Denylist + nur gültige Koordinaten
      const data = (raw||[])
        .map(x => ({...x, id: normalizeId(x.id)}))
        .filter(x => !DENY.has(x.id))
        .filter(x => !!pickCoord(x));

      markersLayer.clearLayers();
      const bounds = [];

      for (const item of data){
        const coord = pickCoord(item);
        if (!coord) continue;

        const marker = L.marker(coord).bindPopup(popupHtml(item));
        marker.on("popupopen", () => {
          const shortId = item.id;
          const url = `https://www.waldsensor.sh/html/sensor.html?node=${shortId}`;
          const qrDiv = document.getElementById(`qrcode-${shortId}`);
          if (qrDiv && !qrDiv.hasChildNodes()) {
            QRCode.toCanvas(url, { errorCorrectionLevel: 'M', width: 108 }, (err, canvas) => {
              if (!err) qrDiv.appendChild(canvas);
            });
          }
        });
        marker.addTo(markersLayer);
        bounds.push(coord);
      }

      if (bounds.length) map.fitBounds(L.latLngBounds(bounds).pad(0.12));

      // Badge links oben: Zeit + Node-Zahl
      const stampEl = document.getElementById("stamp");
      stampEl.textContent = `Letzte Aktualisierung: ${new Date().toLocaleTimeString("de-DE")} • Nodes: ${data.length}`;

      // Badge rechts: Letzte Node-Meldung – fällt nur auf „–“ zurück, wenn wir noch nie etwas hatten
      const lastEl = document.getElementById("last");
      const base = data.length ? data : (lastGoodData.length ? lastGoodData : []);
      const lastRec = latestRecord(base);
      if (lastRec){
        lastEl.textContent = `Letzte Node-Meldung: ${deTime(lastRec.ts)} — ${lastRec.id}`;
      } else {
        lastEl.textContent = "Letzte Node-Meldung: –";
      }

      if (data.length) lastGoodData = data;
    }

    async function runOnce(){
      try{
        const raw = await loadData();
        render(raw);
      } catch(err){
        console.error(err);
        const stampEl = document.getElementById("stamp");
        stampEl.textContent = `Letzte Aktualisierung: ${new Date().toLocaleTimeString("de-DE")} • Nodes: –`;
        // lastGoodData nutzt weiterhin den letzten gültigen Stand für rechts oben
        const lastEl = document.getElementById("last");
        const lastRec = latestRecord(lastGoodData);
        lastEl.textContent = lastRec
          ? `Letzte Node-Meldung: ${deTime(lastRec.ts)} — ${lastRec.id}`
          : "Letzte Node-Meldung: –";
      }
    }

    runOnce();
    setInterval(runOnce, AUTO_REFRESH_MS);
  </script>
</body>
</html>
