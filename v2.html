<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WALDSENSOR.SH – Karte</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- QRCode -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root{
    --ink:#111827; --muted:#6b7280; --ok:#e6f9ef;
    --brand:#2563eb; --bg:rgba(255,255,255,.92);
  }
  html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
  #map{height:100%;}

  /* Badges */
  .badge{position:absolute; z-index:500; background:#fff; border-radius:14px;
         box-shadow:0 6px 20px rgba(0,0,0,.12); padding:10px 14px; font-weight:700}
  .badge small{font-weight:600;color:var(--muted)}
  #meta-left{left:18px; top:18px; color:#065f46; background:#e7f7ef; border:1px solid #c5ecd9}
  #meta-right{right:18px; top:18px; color:#1e3a8a; background:#eaf1ff; border:1px solid #d7e3ff}

  /* Popup kompakt */
  .ws-popup .leaflet-popup-content{margin:10px 14px;}
  .ws-popup .leaflet-popup-content-wrapper{
    border-radius:16px; padding:0; background:var(--bg);
    box-shadow:0 18px 50px rgba(0,0,0,.18); max-width:420px; width:min(60vw,420px);
  }
  .ws-popup .leaflet-popup-tip{background:var(--bg)}
  .p-title{font-size:28px; font-weight:900; letter-spacing:.2px; margin:14px 0 8px; color:#0f172a}
  .p-kv{display:grid; grid-template-columns:auto 1fr; gap:4px 16px; align-items:baseline}
  .k{color:var(--muted); font-weight:700}
  .v{font-weight:800}
  .p-hr{height:1px; background:#e5e7eb; margin:10px 0 14px}
  .qr-wrap{display:flex; gap:16px; align-items:center; margin-top:8px}
  .btn{display:inline-block; text-decoration:none; font-weight:800; color:#0f3b67;
       background:#eaf2ff; border:2px solid #d7e6ff; padding:14px 18px; border-radius:16px}
  .p-foot{margin-top:10px; color:#334155; font-family:ui-monospace,Menlo,Consolas,monospace}

  /* kleinere Bildschirme */
  @media (max-width:480px){
    .p-title{font-size:22px}
    .ws-popup .leaflet-popup-content-wrapper{width:min(88vw,420px)}
  }
</style>
</head>
<body>
<div id="map"></div>

<!-- Badges -->
<div id="meta-left" class="badge"><small>Letzte Aktualisierung:</small> <span id="lastUpdate">–</span> &nbsp; • &nbsp;<small>Nodes:</small> <span id="nodeCount">0</span></div>
<div id="meta-right" class="badge"><small>Letzte Node-Meldung:</small> <span id="lastNode">–</span></div>

<script>
(function(){
  const fmtDE = (n,d=1)=> (n==null||Number.isNaN(+n)) ? "—" : (+n).toFixed(d).replace(".",",");
  const toTitle = (s)=> {
    if(!s) return "";
    // schacht_audorf -> Schacht-Audorf, bredstedt_se01lb -> Bredstedt-Se01lb
    return String(s).replace(/_/g,"-").split("-").map(w=>{
      if (/^(se0?1lb|s\d{2}lb|lsn50v2)$/i.test(w)) return w[0].toUpperCase()+w.slice(1);
      return w.charAt(0).toUpperCase()+w.slice(1);
    }).join("-");
  };
  const isSoilNode = (id)=>/(^|[-_])se01(lb)?$/i.test(String(id||""));

  const map = L.map('map',{ zoomControl:true }).setView([54.5, 9.5], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  let all = [];

  function buildPopupHTML(n){
    const f = n.fields||{};
    const soil = isSoilNode(n.id);

    const temp = soil ? (f.temp_SOIL ?? f.soil_temp ?? f.temp_soil ?? null)
                      : (f.TempC_SHT ?? f.TempC_SHT31 ?? f.temp ?? null);
    const hum  = soil ? (f.water_SOIL ?? f.soil_water ?? f.SOILWater ?? f.water_soil ?? null)
                      : (f.Hum_SHT   ?? f.Hum_SHT31   ?? f.hum  ?? null);
    const bat  = f.BatV ?? f.battery ?? null;

    const humLabel = soil ? "Bodenwasser" : "Luftfeuchte";
    const tLabel   = soil ? "Bodentemperatur" : "Temperatur";

    const ts = n.ts ? new Date(n.ts) : null;
    const lastTs = ts ? ts.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})
                      + ", " + ts.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"}) : "—";

    const lat = f.lat, lon = f.lon;

    const href = `/html/sensor.html?node=${encodeURIComponent(n.id)}`;

    // Container + QR-Target (wird bei popupopen befüllt)
    return `
      <div class="p">
        <div class="p-title">Sensor: ${toTitle(n.id)}</div>

        <div class="p-kv" style="margin-bottom:4px">
          <div class="k">Zuletzt aktiv</div><div class="v">${lastTs}</div>
          <div class="k">Koordinaten</div><div class="v">${fmtDE(lat,5)}, ${fmtDE(lon,5)}</div>
        </div>

        <div class="p-hr"></div>

        <div class="p-kv" style="row-gap:10px">
          <div class="k">${tLabel}</div><div class="v">${temp!=null? fmtDE(temp,1)+" °C":"—"}</div>
          <div class="k">${humLabel}</div><div class="v">${hum!=null? fmtDE(hum,1)+" %":"—"}</div>
          <div class="k">Batterie</div><div class="v">${bat!=null? fmtDE(bat,3)+" V":"—"}</div>
        </div>

        <div class="qr-wrap">
          <div id="qr-${n.id}" style="width:150px;height:150px;"></div>
          <a class="btn" href="${href}">Statistik öffnen</a>
        </div>

        <div class="p-foot">Link nutzt ID: ${n.id}</div>
      </div>
    `;
  }

  function addMarkers(){
    all.forEach(n=>{
      const f = n.fields||{};
      if (typeof f.lat!=="number" || typeof f.lon!=="number") return;
      const m = L.marker([f.lat,f.lon]).addTo(map);

      const pop = L.popup({
        closeButton:true,
        autoPan:true,
        className:'ws-popup'
      }).setContent( buildPopupHTML(n) );

      m.on('click', ()=>{
        // Popup öffnen und gleichzeitig den Marker in die Mitte holen
        map.setView(m.getLatLng(), map.getZoom(), {animate:false});
        m.bindPopup(pop).openPopup();
      });

      // QR befüllen, sobald Popup sichtbar
      m.on('popupopen', (ev)=>{
        const nodeId = n.id;
        const el = document.getElementById(`qr-${nodeId}`);
        if (el && !el.dataset.done){
          const url = `${location.origin}/html/sensor.html?node=${encodeURIComponent(nodeId)}`;
          try { new QRCode(el,{text:url,width:150,height:150}); el.dataset.done="1"; } catch(_){}
        }
      });
    });
  }

  function updateBadges(){
    // Nodes-Anzahl
    document.getElementById('nodeCount').textContent = all.length;

    // Letzte Aktualisierung = max(ts)
    let newest = null, newestNode = null;
    for(const n of all){
      if(!n.ts) continue;
      const t = +new Date(n.ts);
      if (!newest || t>newest){ newest = t; newestNode = n; }
    }
    const dt = newest ? new Date(newest) : null;
    document.getElementById('lastUpdate').textContent = dt
      ? dt.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit",second:"2-digit"})
      : "–";

    document.getElementById('lastNode').textContent = newestNode
      ? dt.toLocaleDateString("de-DE",{day:"2-digit",month:"2-digit",year:"numeric"})
        + ", " + dt.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"})
        + " — " + toTitle(newestNode.id)
      : "–";
  }

  async function load(){
    const r = await fetch("/data/v2/latest/all.json",{cache:"no-store"});
    const a = await r.json();
    // Normalize ids (trim)
    all = a.map(x=>({...x,id:String(x.id||"").trim()}));
    updateBadges();
    addMarkers();
  }

  load().catch(console.error);
})();
</script>
</body>
</html>
