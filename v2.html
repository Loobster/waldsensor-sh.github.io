<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WALDSENSOR.SH – Live-Karte (v2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .badge {
      position: fixed;
      z-index: 1000;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      border-radius: 14px;
      padding: 10px 14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 18px;
      color: #0c2a1b;
      border: 1px solid rgba(0,0,0,0.08);
      backdrop-filter: saturate(180%) blur(6px);
    }
    .badge-left  { top: 12px; left: 60px; }  /* frei von +/– */
    .badge-right { top: 12px; right: 12px; }

    /* Popups freundlich & neutral (kein dunkles Grün) */
    .leaflet-popup-content { color:#111; }
    .popup { color:#111; }
    .popup h3 { margin: 0 0 6px 0; font-size: 20px; font-weight: 700; }
    .popup .kv { margin: 2px 0; }
    .popup .kv b { display:inline-block; width: 120px; }
    .popup .hr { height: 1px; background: #e7ecef; margin: 8px 0; }
    .popup .qrbox {
      display:flex; gap:14px; align-items:center; padding:10px; border:1px solid #e7ecef; border-radius:12px; background:#fafdfb;
    }
    .popup .qrbox button {
      cursor:pointer; border:0; border-radius:10px; padding:9px 14px; background:#1976d2; color:#fff; font-weight:600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="leftBadge"  class="badge badge-left">Letzte Aktualisierung: …</div>
  <div id="rightBadge" class="badge badge-right">Letzte Node-Meldung: —</div>

  <script>
    // -------- Konfiguration --------
    const FETCH_URL = '/data/v2/latest/_all.json?nocache=' + Date.now();

    // IDs, die NICHT angezeigt werden sollen (Zombie etc.)
    const HIDE_IDS = new Set(['lsn50-v2']);

    // Feste Positionen (weil lat/lon im _all.json bewusst fehlen)
    const POSITIONS = {
      'breklum-sn50v3': [54.60669, 8.98195],
      'kropp-sn50v3'  : [54.41018, 9.52839],
      'fahrdorf-sn50v3': [54.50158, 9.58690],
      's31-lb'        : [54.65000, 8.96000],
      'se01-lb'       : [54.65000, 8.96000]
      // 'lsn50-v2' absichtlich NICHT, der ist in HIDE_IDS
    };

    // Bei exakt gleichen Koordinaten Marker minimal versetzen (einige Meter),
    // damit zwei Marker am selben Ort beide anklickbar sind.
    const usedCoords = new Map(); // key "lat,lon" -> count

    function nudgeIfDuplicate([lat, lon]) {
      const key = lat.toFixed(5)+','+lon.toFixed(5); // Raster ~ Meterbereich
      const count = (usedCoords.get(key) || 0);
      usedCoords.set(key, count+1);

      if (count === 0) return [lat, lon]; // erstes Exemplar unverändert

      // pro Duplikat kleine Spirale (ca. ~10–20 m) um den Punkt
      const d = 0.00015 * count;               // Abstand (≈ 15 m * count)
      const angle = (count * 137.508) * Math.PI / 180; // Goldener Winkel
      return [lat + d*Math.sin(angle), lon + d*Math.cos(angle)];
    }

    function shortName(id) {
      const i = id.indexOf('-');
      return i>0 ? id.slice(0,i) : id;
    }
    function fmtNum(v, dec=1) {
      if (v===null || v===undefined || isNaN(v)) return '—';
      return Number(v).toLocaleString('de-DE', {minimumFractionDigits:dec, maximumFractionDigits:dec});
    }
    function fmtTimeLocal(ts) {
      const d = new Date(ts);
      return d.toLocaleString('de-DE', {
        day:'2-digit', month:'2-digit', year:'numeric',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }

    // -------- Karte --------
    const map = L.map('map').setView([54.5, 9.5], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const markerLayer = L.layerGroup().addTo(map);

    const leftBadge  = document.getElementById('leftBadge');
    const rightBadge = document.getElementById('rightBadge');

    async function loadAndRender() {
      leftBadge.textContent = 'Letzte Aktualisierung: ' + new Date().toLocaleTimeString('de-DE');

      let data;
      try {
        const res = await fetch(FETCH_URL + '?t=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
        if (!Array.isArray(data)) throw new Error('JSON ist kein Array');
      } catch (e) {
        console.error('Fetch fehlgeschlagen:', e);
        rightBadge.textContent = 'Letzte Node-Meldung: — (Fehler beim Laden)';
        return;
      }

      if (data.length === 0) {
        markerLayer.clearLayers();
        rightBadge.textContent = 'Letzte Node-Meldung: —';
        return;
      }

      // neueste Meldung
      const newest = data.reduce((a,b) =>
        (new Date(a.ts).getTime() > new Date(b.ts).getTime()) ? a : b
      );
      rightBadge.textContent = `Letzte Node-Meldung: ${newest.id} — ${fmtTimeLocal(newest.ts)}`;

      // Marker neu aufbauen
      markerLayer.clearLayers();
      usedCoords.clear();

      data.forEach(rec => {
        const id = rec.id;
        if (HIDE_IDS.has(id)) return; // z. B. Zombie ausblenden

        const basePos = POSITIONS[id];
        if (!basePos) { console.warn('Keine Koordinate für', id); return; }

        const pos = nudgeIfDuplicate(basePos.slice());

        const f = rec.fields || {};
        const temp = f.TempC_SHT ?? f.TempC_SHT31 ?? f.TempC ?? null;
        const hum  = f.Hum_SHT  ?? f.Hum_SHT31  ?? null;
        const bat  = f.BatV     ?? null;

        const html =
          `<div class="popup">
             <h3>${id}</h3>
             <div class="kv"><b>Zeit:</b> ${fmtTimeLocal(rec.ts)}</div>
             <div class="kv"><b>Temp:</b> ${fmtNum(temp,1)} °C</div>
             <div class="kv"><b>Feuchte:</b> ${fmtNum(hum,1)} %</div>
             <div class="kv"><b>Batterie:</b> ${fmtNum(bat,3)} V</div>
             <div class="hr"></div>
             <div class="qrbox">
               <div>
                 <img alt="QR" width="96" height="96"
                      src="https://api.qrserver.com/v1/create-qr-code/?size=192x192&data=${encodeURIComponent(location.origin + '/html/sensor.html?node=' + id)}" />
               </div>
               <div>
                 <div><b>Sensor-Details</b></div>
                 <button onclick="location.href='/html/sensor.html?node=${encodeURIComponent(id)}'">Seite öffnen</button>
               </div>
             </div>
           </div>`;

        L.marker(pos, { title: id })
          .bindPopup(html, { maxWidth: 420 })
          .addTo(markerLayer);
      });
    }

    loadAndRender();
    setInterval(loadAndRender, 60 * 1000);
  </script>
</body>
</html>
