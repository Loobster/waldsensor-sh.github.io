<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH ‚Äì Gateway-Karte</title>
  <meta name="version" content="v0.21b" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root {
      --ink:#0f172a;
      --muted:#64748b;
      --bg:#f6f8fb;
      --card:#ffffff;
      --success:#10b981;
      --gateway:#8b5cf6;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #map{position:absolute;inset:0}

    .badge{background:var(--card);box-shadow:0 8px 30px -16px rgba(0,0,0,.25),0 1px 0 rgba(0,0,0,.06);
      border-radius:12px;padding:8px 12px;font-size:14px;font-weight:700;color:var(--ink)}
    .badge small{display:block;font-weight:600;color:var(--muted);margin-top:2px;font-size:12px}
    .hud-left{position:fixed;left:64px;top:12px;z-index:500;display:flex;flex-direction:column;gap:8px}
    .hud-right{position:fixed;right:16px;top:16px;z-index:500;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .hud-center{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:500}

    .leaflet-popup-content-wrapper{border-radius:12px;box-shadow:0 12px 40px -18px rgba(0,0,0,.35)}
    .leaflet-popup-content{margin:16px}
    .popup{min-width:280px;max-width:320px;font-size:13px;line-height:1.4}
    .popup h3{margin:0 0 12px;font-size:17px;font-weight:800;display:flex;align-items:center;gap:8px}
    .popup hr{border:none;border-top:1px solid #e5e7eb;margin:12px 0}
    .row{display:flex;justify-content:space-between;gap:12px;margin:6px 0;align-items:center}
    .label{color:var(--muted);font-weight:600;font-size:12px}
    .value{font-weight:700;font-size:13px}
    .status-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;
      font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;background:#d1fae5;color:#065f46}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
    .info-card{background:#f9fafb;padding:8px;border-radius:6px;text-align:center}
    .info-card .num{font-size:18px;font-weight:800;color:var(--ink);display:block}
    .info-card .lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px}
    .gw-list{margin:8px 0}
    .gw-item{background:#f9fafb;padding:6px;border-radius:6px;margin:4px 0;font-size:12px}
    .gw-item strong{display:block;color:var(--gateway);font-size:11px;margin-bottom:2px}
    .gw-item .signal{display:flex;justify-content:space-between;font-size:11px}
    .sensor-type{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;margin:8px 0 4px}
    .popup .btn{display:block;margin-top:12px;padding:10px;background:#1d4ed8;color:white;border-radius:8px;font-weight:700;text-decoration:none;text-align:center}
    .marker-node{width:22px;height:22px;background:var(--success);border:4px solid white;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.2);animation:pulse 2s ease-in-out infinite}
    @keyframes pulse {0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.6)}50%{box-shadow:0 0 0 8px rgba(16,185,129,0)}}
    .marker-gateway{width:20px;height:20px;background:var(--gateway);border:3px solid white;border-radius:4px;transform:rotate(45deg);box-shadow:0 2px 8px rgba(0,0,0,.3)}
    .hop-line{stroke:var(--gateway);stroke-width:2;stroke-dasharray:8,4;fill:none;opacity:0.6;animation:dash 20s linear infinite}
    @keyframes dash{to{stroke-dashoffset:-1000}}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud-left">
    <div class="badge" id="nodesBadge">Nodes: ‚Äì</div>
    <div class="badge" id="gatewaysBadge">Gateways: ‚Äì</div>
  </div>

  <div class="hud-center">
    <div class="badge">v0.21b Multi-Sensor Standorte (29.10.2025)</div>
  </div>

  <div class="hud-right">
    <div class="badge" id="lastBadge">Letzte Meldung: ‚Äì<small id="lastBadgeAge">‚Äî</small></div>
    <div class="badge" id="packetBadge">Verbindungen: ‚Äì<small id="packetDetail">‚Äî</small></div>
  </div>

  <script>
    // -------------------- Helpers --------------------
    const NUM = x => { const n = typeof x==="number"?x:(typeof x==="string"?Number(x.replace(",",".")):NaN); return Number.isFinite(n)?n:null; };
    const isValidISO = ts => !!ts && typeof ts==="string" && Number.isFinite(Date.parse(ts));
    const formatDE = ts => isValidISO(ts)?new Date(ts).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"‚Äî";
    const relAge = ts => { if(!isValidISO(ts))return"‚Äî"; const m=Math.floor((Date.now()-Date.parse(ts))/60000); if(m<0)return"0 min"; if(m<60)return`${m} min`; const h=Math.floor(m/60),r=m%60; return`${h} h ${r} min`; };
    const deNum=(n,d=1)=>(typeof n==="number"&&Number.isFinite(n))?n.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d}):"‚Äì";
    const normId=id=>String(id||"").trim().replace(/_/g,"-").replace(/schacht[-_]?audorf/i,"Schacht-Audorf");
    const isSoilNode=id=>/(^|[-_])se01(lb)?$/i.test(String(id||""));
    const getTemperature=(f,s)=>s?NUM(f.temp_SOIL):NUM(f.TempC_SHT)??NUM(f.TempC_SHT31);
    const getHumidity=(f,s)=>s?NUM(f.water_SOIL):NUM(f.Hum_SHT)??NUM(f.Hum_SHT31);
    const getTempLabel=s=>s?"Bodentemperatur":"Temperatur";
    const getHumLabel=s=>s?"Bodenfeuchte":"Luftfeuchte";

    // Basis-Schl√ºssel eines Standortes (z. B. "waldsensor-bredstedt")
    function getLocationKey(id){
      return String(id||"")
        .replace(/_/g,"-")
        .replace(/[-_](s31lb|se01lb|llms01)$/i,'')
        .toLowerCase();
    }
    function findRelatedNodes(nodes,baseId){
      const key=getLocationKey(baseId);
      return nodes.filter(n=>getLocationKey(n.id)===key);
    }

    // -------------------- Multi-Sensor Popup --------------------
    function multiSensorPopupHtml(nodes) {
      // Titel = "waldsensor-" + <basis>
      const baseRaw = getLocationKey(nodes[0].id).replace(/^waldsensor-?/i,'');
      const title = `waldsensor-${baseRaw}`;

      // letzter Kontakt = max(ts)
      const lastTs = nodes.reduce((acc,n)=>{
        return !isValidISO(n.ts) ? acc : (!acc || Date.parse(n.ts)>Date.parse(acc) ? n.ts : acc);
      }, null);

      // √ò Batterie
      const batVals = nodes.map(n=>NUM(n.fields?.BatV)).filter(v=>Number.isFinite(v));
      const batAvg = batVals.length ? batVals.reduce((a,b)=>a+b,0)/batVals.length : null;

      // Gateways aller Nodes zusammenf√ºhren (nach ID deduplizieren)
      const gwMap = new Map();
      nodes.forEach(n=>{
        (n.gateway_details||[]).forEach((gw,i)=>{
          const id = gw.id || gw.name || `gw-${i}`;
          if(!gwMap.has(id)){
            gwMap.set(id, { id, name: gw.name||gw.id, lat: gw.lat, lon: gw.lon,
              rssi: [], snr: [] });
          }
          // RSSI/SNR ggf. aus Feldern rssi1/snr1... des jeweiligen Datensatzes ziehen
          const f=n.fields||{};
          const idx = i+1;
          const rssi = NUM(f[`rssi${idx}`]); if(Number.isFinite(rssi)) gwMap.get(id).rssi.push(rssi);
          const snr  = NUM(f[`snr${idx}`]);  if(Number.isFinite(snr))  gwMap.get(id).snr.push(snr);
        });
      });
      const gws = Array.from(gwMap.values()).map(g=>({
        ...g,
        rssi: g.rssi.length ? Math.round(g.rssi.reduce((a,b)=>a+b,0)/g.rssi.length) : null,
        snr:  g.snr.length  ? Math.round((g.snr.reduce((a,b)=>a+b,0)/g.snr.length)*10)/10 : null
      }));

      // Netzwerk-Basisinfos (von erstem Datensatz, falls vorhanden)
      const f0 = nodes[0].fields||{};
      const sf = NUM(f0.sf);
      const bw = f0.bw ? (f0.bw/1000)+'kHz' : '‚Äì';

      let html = `<div class="popup">`;
      html += `<h3>${normId(title)} <span class="status-badge">${nodes.length} Sensoren</span></h3>`;
      html += `<div class="row"><span class="label">Letzter Kontakt</span><span class="value">${formatDE(lastTs)}</span></div>`;
      html += `<hr/>`;

      html += `<div class="info-grid">`;
      html += `<div class="info-card"><span class="num">${gws.length}</span><span class="lbl">Gateways</span></div>`;
      html += `<div class="info-card"><span class="num">${batAvg!==null?deNum(batAvg,2):'‚Äì'}</span><span class="lbl">√ò Batterie (V)</span></div>`;
      if (sf) html += `<div class="info-card"><span class="num">SF${sf}</span><span class="lbl">Spreading Factor</span></div>`;
      html += `<div class="info-card"><span class="num">${bw}</span><span class="lbl">Bandwidth</span></div>`;
      html += `</div>`;

      // Gateways-Liste
      if (gws.length){
        html += `<hr/><strong style="font-size:12px;color:var(--gateway)">Empfangende Gateways:</strong>`;
        html += `<div class="gw-list">`;
        gws.forEach(g=>{
          html += `<div class="gw-item">`;
          html += `<strong>${g.name||g.id}</strong>`;
          html += `<div class="signal"><span>RSSI: ${g.rssi!==null?g.rssi+' dBm':'‚Äì'}</span><span>SNR: ${g.snr!==null?g.snr+' dB':'‚Äì'}</span></div>`;
          html += `</div>`;
        });
        html += `</div>`;
      }

      // Sensorbl√∂cke
      nodes.forEach(n => {
        const f = n.fields || {};
        const soil = isSoilNode(n.id);
        const isLeaf = /llms01/i.test(n.id);

        html += `<hr/>`;
        if (isLeaf) {
          html += `<div class="sensor-type">üçÉ Blatt-Sensor</div>`;
          html += `<div class="row"><span class="label">Blatttemperatur</span><span class="value">${NUM(f.Leaf_Temperature) ? deNum(NUM(f.Leaf_Temperature),1)+' ¬∞C' : '‚Äì'}</span></div>`;
          html += `<div class="row"><span class="label">Blattfeuchte</span><span class="value">${NUM(f.Leaf_Moisture) ? deNum(NUM(f.Leaf_Moisture),1)+' %' : '‚Äì'}</span></div>`;
        } else if (soil) {
          html += `<div class="sensor-type">üå± Boden-Sensor</div>`;
          html += `<div class="row"><span class="label">Bodentemperatur</span><span class="value">${NUM(f.temp_SOIL) ? deNum(NUM(f.temp_SOIL),1)+' ¬∞C' : '‚Äì'}</span></div>`;
          html += `<div class="row"><span class="label">Bodenfeuchte</span><span class="value">${NUM(f.water_SOIL) ? deNum(NUM(f.water_SOIL),1)+' %' : '‚Äì'}</span></div>`;
        } else {
          html += `<div class="sensor-type">üå°Ô∏è Luft-Sensor</div>`;
          const temp = NUM(f.TempC_SHT) ?? NUM(f.TempC_SHT31);
          const hum  = NUM(f.Hum_SHT) ?? NUM(f.Hum_SHT31);
          html += `<div class="row"><span class="label">Lufttemperatur</span><span class="value">${Number.isFinite(temp)?deNum(temp,1)+' ¬∞C':'‚Äì'}</span></div>`;
          html += `<div class="row"><span class="label">Luftfeuchte</span><span class="value">${Number.isFinite(hum)?deNum(hum,1)+' %':'‚Äì'}</span></div>`;
        }
        html += `<div class="row"><span class="label">Batterie</span><span class="value">${NUM(f.BatV) ? deNum(NUM(f.BatV),2)+' V' : '‚Äì'}</span></div>`;
      });

      // Detail-Button (zeigt irgendeinen beteiligten Node)
      const statHref = `/html/sensor.html?node=${encodeURIComponent(nodes[0].id)}`;
      html += `<a class="btn" href="${statHref}" target="_blank" rel="noopener">Detailansicht √∂ffnen ‚Üí</a>`;
      html += `</div>`;
      return html;
    }

    // -------------------- Standard-Popup --------------------
    function nodePopupHtml(item, all){
      // Neu: Multi-Sensor pr√ºfung GENERALISIERT (nicht mehr auf festen Ortsnamen begrenzt)
      const rel = findRelatedNodes(all||[item], item.id);
      if (rel.length > 1) return multiSensorPopupHtml(rel);

      const f=item.fields||{};
      const title=normId(item.id);
      const when=formatDE(item.ts);
      const gwCount=(item.gateway_details||[]).length;
      const soil=isSoilNode(item.id);
      const temp=getTemperature(f,soil);
      const hum=getHumidity(f,soil);
      const bat=NUM(f.BatV);const sf=NUM(f.sf);

      let html=`<div class="popup"><h3>${title} <span class="status-badge">AKTIV</span></h3>
      <div class="row"><span class="label">Letzter Kontakt</span><span class="value">${when}</span></div><hr/>
      <div class="info-grid">
        <div class="info-card"><span class="num">${gwCount}</span><span class="lbl">Gateways</span></div>
        <div class="info-card"><span class="num">${bat?deNum(bat,2):'‚Äì'}</span><span class="lbl">Batterie (V)</span></div>
        ${sf?`<div class="info-card"><span class="num">SF${sf}</span><span class="lbl">Spreading Factor</span></div>`:''}
        <div class="info-card"><span class="num">${f.bw?(f.bw/1000)+'kHz':'‚Äì'}</span><span class="lbl">Bandwidth</span></div>
      </div>`;

      html+=`<hr/><div class="sensor-type">${soil?'üå± Boden-Sensor':'üå°Ô∏è Luft-Sensor'}</div>`;
      if(temp!==null)html+=`<div class="row"><span class="label">${getTempLabel(soil)}</span><span class="value">${deNum(temp,1)} ¬∞C</span></div>`;
      if(hum!==null)html+=`<div class="row"><span class="label">${getHumLabel(soil)}</span><span class="value">${deNum(hum,1)} %</span></div>`;

      const gws=item.gateway_details||[];
      if(gws.length>0){
        html+=`<hr/><strong style="font-size:12px;color:var(--gateway)">Empfangende Gateways:</strong><div class="gw-list">`;
        gws.forEach((gw,i)=>{const rssi=f[`rssi${i+1}`];const snr=f[`snr${i+1}`];
          html+=`<div class="gw-item"><strong>${gw.name||gw.id}</strong><div class="signal"><span>RSSI: ${rssi?rssi+' dBm':'‚Äì'}</span><span>SNR: ${snr?snr+' dB':'‚Äì'}</span></div></div>`;
        });
        html+=`</div>`;
      }
      html+=`<a class="btn" href="/html/sensor.html?node=${encodeURIComponent(item.id)}" target="_blank">Detailansicht √∂ffnen ‚Üí</a></div>`;
      return html;
    }

    function gatewayPopupHtml(gw,count){
      return `<div class="popup"><h3 style="color:var(--gateway)">Gateway: ${gw.name||gw.id}</h3>
      <div class="row"><span class="label">Aktive Nodes</span><span class="value">${count}</span></div>
      <div class="row"><span class="label">Position</span><span class="value">${deNum(gw.lat,5)} / ${deNum(gw.lon,5)}</span></div></div>`;
    }

    async function fetchJson(url){
      const bust=`_=${Date.now()}`;
      const u=url+(url.includes("?")?"&":"?")+bust;
      const r=await fetch(u,{cache:"no-store"});
      if(!r.ok) throw new Error(r.status);
      const d=await r.json();
      if(!Array.isArray(d)||!d.length) throw new Error("empty");
      return d;
    }
    const latestOfAll=n=>n.reduce((a,c)=>!isValidISO(c.ts)?a:(!a||Date.parse(c.ts)>Date.parse(a)?c.ts:a),null);

    // -------------------- Leaflet Map --------------------
    const map=L.map('map',{zoomControl:true,minZoom:5}).setView([54.3,9.7],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

    const svg=document.createElementNS("http://www.w3.org/2000/svg","svg");
    Object.assign(svg.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:"400"});
    map.getPanes().overlayPane.appendChild(svg);

    function drawHopLines(nodes){
      svg.innerHTML="";
      const bounds=map.getBounds(),size=map.getSize(),topLeft=map.latLngToContainerPoint(bounds.getNorthWest());
      svg.setAttribute("width",size.x);svg.setAttribute("height",size.y);
      svg.style.left=topLeft.x+"px";svg.style.top=topLeft.y+"px";
      nodes.forEach(n=>{
        const f=n.fields||{},lat=NUM(f.lat),lon=NUM(f.lon);
        if(!lat||!lon)return;
        (n.gateway_details||[]).forEach(gw=>{
          if(!gw.lat||!gw.lon)return;
          const nP=map.latLngToContainerPoint([lat,lon]),gP=map.latLngToContainerPoint([gw.lat,gw.lon]);
          const line=document.createElementNS("http://www.w3.org/2000/svg","line");
          line.setAttribute("class","hop-line");
          line.setAttribute("x1",nP.x);line.setAttribute("y1",nP.y);
          line.setAttribute("x2",gP.x);line.setAttribute("y2",gP.y);
          svg.appendChild(line);
        });
      });
    }

    // -------------------- Render --------------------
    async function render(){
      const nodesBadge = document.getElementById("nodesBadge");
      const gatewaysBadge = document.getElementById("gatewaysBadge");
      const lastBadge = document.getElementById("lastBadge");
      const lastBadgeAge = document.getElementById("lastBadgeAge");
      const packetBadge = document.getElementById("packetBadge");
      const packetDetail = document.getElementById("packetDetail");

      try {
        const nodes = await fetchJson("/data/v2/latest/all_enriched.json");
        nodesBadge.textContent = `Nodes: ${nodes.length}`;

        const usedGateways = new Map();
        let totalConnections = 0;
        const pts = [];

        nodes.forEach(n => {
          const f = n.fields || {};
          const lat = NUM(f.lat);
          const lon = NUM(f.lon);
          if (!lat || !lon) return;

          const m = L.marker([lat, lon], { icon: L.divIcon({ className: '', html: '<div class="marker-node"></div>', iconSize: [22, 22], iconAnchor: [11, 11] }) }).addTo(map);
          m.bindPopup(nodePopupHtml(n, nodes), { maxWidth: 320 });
          pts.push([lat, lon]);

          const gws = n.gateway_details || [];
          gws.forEach(gw => {
            if (!usedGateways.has(gw.id)) usedGateways.set(gw.id, { gw, count: 0 });
            usedGateways.get(gw.id).count++;
            totalConnections++;
          });
        });

        usedGateways.forEach(({ gw, count }) => {
          if (!gw.lat || !gw.lon) return;
          const m = L.marker([gw.lat, gw.lon], { icon: L.divIcon({ className: '', html: '<div class="marker-gateway"></div>', iconSize: [20, 20], iconAnchor: [10, 10] }) }).addTo(map);
          m.bindPopup(gatewayPopupHtml(gw, count), { maxWidth: 280 });
          pts.push([gw.lat, gw.lon]);
        });

        gatewaysBadge.textContent = `Gateways: ${usedGateways.size}`;
        packetBadge.firstChild.nodeValue = `Verbindungen: ${totalConnections}`;
        packetDetail.textContent = nodes.length ? `√ò ${(totalConnections / nodes.length).toFixed(1)} pro Node` : "‚Äî";

        const lastTs = latestOfAll(nodes);
        lastBadge.firstChild.nodeValue = `Letzte Meldung: ${formatDE(lastTs)}`;
        lastBadgeAge.textContent = isValidISO(lastTs) ? `vor ${relAge(lastTs)}` : "‚Äî";

        if (pts.length) {
          const b = L.latLngBounds(pts);
          map.fitBounds(b.pad(0.15));
        }

        setTimeout(() => {
          drawHopLines(nodes);
          map.on('zoomend moveend', () => drawHopLines(nodes));
        }, 500);

      } catch (e) {
        console.error(e);
        nodesBadge.textContent = `Fehler beim Laden`;
        gatewaysBadge.textContent = `Gateways: ‚Äì`;
      }
    }

    render();
    setInterval(render, 120000);
  </script>
</body>
</html>
