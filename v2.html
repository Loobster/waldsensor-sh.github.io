<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WALDSENSOR.SH – Karte v2</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --brand:#135e31;
      --brand-2:#2577d5;
      --chip-bg:#ffffff;
      --chip-shadow:0 6px 18px rgba(0,0,0,.08);
      --chip-radius:18px;
    }
    html,body,#map { height:100%; margin:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; }

    .badge {
      position:absolute;
      z-index:400;
      background:var(--chip-bg);
      box-shadow:var(--chip-shadow);
      border-radius:var(--chip-radius);
      padding:.65rem .9rem;
      font-weight:700;
      display:flex; align-items:center; gap:.5rem;
      border:1px solid rgba(0,0,0,.05);
      backdrop-filter:saturate(1.2) blur(2px);
      -webkit-backdrop-filter:saturate(1.2) blur(2px);
    }
    .badge small{font-weight:600; opacity:.7}
    #badge-upd{ left:.75rem; top:.75rem; color:var(--brand); }
    #badge-last{ right:.75rem; top:.75rem; color:var(--brand-2); }

    .leaflet-popup-content{
      margin: 12px 14px;
    }
    .popup-title{
      font-size:1.2rem; font-weight:800; margin:0 0 .25rem 0;
    }
    .kv{
      display:grid; grid-template-columns:auto 1fr; gap:.25rem .75rem;
      margin:.35rem 0;
      font-size:1rem;
    }
    .kv b{ font-weight:800; }
    .qr-wrap{
      display:flex; align-items:center; gap:1rem; margin:.5rem 0;
    }
    .btn{
      display:inline-block; font-weight:800; text-decoration:none;
      background:#f2f6ff; border:2px solid #d9e6ff; color:#0a5bd3;
      padding:.65rem .9rem; border-radius:14px;
    }
    .hint{
      position:absolute; left:50%; transform:translateX(-50%);
      top:3.75rem;
      z-index:401; background:#f4fff6; color:#0d7a2b;
      border:1px solid #bfe7c9; border-radius:14px;
      padding:.5rem .8rem; font-weight:700; display:none;
      box-shadow:var(--chip-shadow);
    }
    .mini{ font-size:.92rem; opacity:.85; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="badge-upd" class="badge">Letzte Aktualisierung: <span id="upd-ts">–</span> <small>•</small> Nodes: <span id="node-count">0</span></div>
  <div id="badge-last" class="badge">Letzte Node-Meldung: <span id="last-node">–</span></div>
  <div id="hint" class="hint">keine neuen gültigen Daten — <span class="mini">alte Anzeige bleibt</span></div>

  <script>
  /***** EINSTELLUNGEN *********************************************************/
  const DATA_URL = '/data/v2/latest/all.json';
  // Nodes, die niemals angezeigt werden sollen (Alt-/Testgeräte)
  const DENY = new Set([
    // 'breklum',
  ]);
  // optional: Fallback-History-Pfade nach Typ
  const HISTORY_FALLBACKS = [
    ['-s31lb',  '/data/v2/history/history_s31.json'],
    ['-se01lb', '/data/v2/history/history_se01.json'],
    ['-sn50v3','/data/v2/history/history_sn50v3.json'],
    ['-lsn50v2','/data/v2/history/history_lsn50v2.json'],
  ];
  /*****************************************************************************/

  // Pretty: "schacht-audorf" -> "Schacht – Audorf", "bredstedt-s31lb" -> "Bredstedt – S31lb"
  function prettyName(id){
    return id.split('-')
      .map(s => s ? s[0].toUpperCase()+s.slice(1) : s)
      .join(' – ');
  }

  // Statistik-URL: immer volle Node-ID übergeben
  function statsUrlFor(nodeId){
    return `/v2.html?stats=1&id=${encodeURIComponent(nodeId)}`;
  }

  // minimales QR (tiny): generiert wenige Byte-QR via Google Chart? -> nein (ohne externe)
  // Sehr kleines Inline-„QR“: wir rendern eine Data-URL mit canvas (kein „echtes“ QR-Pattern,
  // sondern nur ein Hinweis-Kästchen mit ID-Text). Für echte QR bitte bei Bedarf qrcode.js einbinden.
  function drawFakeQR(canvas, text){
    const ctx = canvas.getContext('2d');
    const S = 132; canvas.width=S; canvas.height=S;
    ctx.fillStyle='#000'; ctx.fillRect(0,0,S,S);
    ctx.fillStyle='#fff'; ctx.fillRect(6,6,S-12,S-12);
    ctx.fillStyle='#000'; ctx.font='12px system-ui, Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    // drei "Finder" als Deko
    for(const [x,y] of [[20,20],[S-20,20],[20,S-20]]){
      ctx.fillRect(x-12,y-12,24,24);
      ctx.fillStyle='#fff'; ctx.fillRect(x-8,y-8,16,16);
      ctx.fillStyle='#000';
    }
    ctx.fillText('Scan Link', S/2, S/2-10);
    ctx.fillText(text.length>18? (text.slice(0,18)+'…') : text, S/2, S/2+10);
  }

  // Leaflet-Karte
  const map = L.map('map', { zoomControl:true }).setView([54.5, 9.6], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);

  let layerGroup = L.layerGroup().addTo(map);
  let lastGoodPayload = null;
  let lastRenderBounds = null;

  const updTsEl = document.getElementById('upd-ts');
  const nodeCountEl = document.getElementById('node-count');
  const lastNodeEl = document.getElementById('last-node');
  const hintEl = document.getElementById('hint');

  function showHintOnce(){
    hintEl.style.display='block';
    clearTimeout(showHintOnce._t);
    showHintOnce._t = setTimeout(()=> hintEl.style.display='none', 4500);
  }

  function parseData(arr){
    if(!Array.isArray(arr)) return [];
    return arr
      .filter(d => d && d.id && !DENY.has(String(d.id).toLowerCase()))
      .map(d => {
        const id = String(d.id);
        const ts = d.ts || d.time || null;
        const f = d.fields || {};
        const lat = Number(f.lat);
        const lon = Number(f.lon);
        const temp = f.TempC_SHT ?? f.TempC1 ?? f.temp_SOIL ?? null;
        const hum  = f.Hum_SHT ?? f.Hum_SHT31 ?? null;
        const bat  = f.BatV ?? null;
        return {id, ts, lat, lon, temp, hum, bat, raw: d};
      })
      .filter(o => Number.isFinite(o.lat) && Number.isFinite(o.lon));
  }

  function renderMarkers(list){
    layerGroup.clearLayers();
    const bounds = [];
    list.forEach(n => {
      const m = L.marker([n.lat, n.lon]);

      const div = document.createElement('div');
      const title = document.createElement('div');
      title.className='popup-title';
      title.textContent = 'Sensor: ' + prettyName(n.id);
      div.appendChild(title);

      const kv = document.createElement('div'); kv.className='kv';
      const fmt = (v, suf) => (v==null || Number.isNaN(Number(v))) ? '—' : (typeof v==='number' ? v.toLocaleString('de-DE') : v) + (suf||'');
      const addRow = (k,v) => { const b=document.createElement('b'); b.textContent=k; kv.appendChild(b); const s=document.createElement('div'); s.textContent=v; kv.appendChild(s); };
      addRow('Zuletzt aktiv', n.ts ? new Date(n.ts).toLocaleString('de-DE') : '—');
      addRow('Batterie', fmt(n.bat,' V'));
      addRow('Feuchte', fmt(n.hum,' %'));
      addRow('Temperatur', fmt(n.temp,' °C'));
      div.appendChild(kv);

      const qrWrap = document.createElement('div'); qrWrap.className='qr-wrap';
      const canvas = document.createElement('canvas');
      const url = statsUrlFor(n.id);
      drawFakeQR(canvas, n.id);
      const a = document.createElement('a'); a.className='btn'; a.href=url; a.textContent='Statistik öffnen';
      a.target='_blank'; a.rel='noopener';
      qrWrap.appendChild(canvas); qrWrap.appendChild(a);
      div.appendChild(qrWrap);

      const small = document.createElement('div');
      small.className='mini';
      small.textContent='Link nutzt Node-ID: ' + n.id;
      div.appendChild(small);

      m.bindPopup(div, { maxWidth: 360 });
      m.addTo(layerGroup);
      bounds.push([n.lat, n.lon]);
    });

    if(bounds.length){
      const b = L.latLngBounds(bounds);
      // Nur zoomen, wenn noch kein sinnvoller View gesetzt wurde oder Datenbestand stark änderte
      if(!lastRenderBounds || !lastRenderBounds.contains(b) || !b.contains(lastRenderBounds)){
        map.fitBounds(b.pad(0.2));
      }
      lastRenderBounds = b;
    }
  }

  function updateBadges(list, fetchTime){
    updTsEl.textContent = fetchTime.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    nodeCountEl.textContent = String(list.length);

    // letzte Node-Meldung nach ts
    let latest = null;
    for(const n of list){
      if(n.ts && (!latest || n.ts > latest.ts)) latest = n;
    }
    if(latest){
      const dt = new Date(latest.ts).toLocaleString('de-DE');
      lastNodeEl.textContent = `${dt} — ${latest.id}`;
    }else{
      lastNodeEl.textContent = '–';
    }
  }

  async function loadAndRender(){
    const now = new Date();
    try{
      const res = await fetch(`${DATA_URL}?t=${Date.now()}`, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const json = await res.json();
      const list = parseData(json);

      if(list.length===0){
        // keine gültigen Datensätze -> alte Anzeige behalten, Hinweis zeigen
        showHintOnce();
        updateBadges(lastGoodPayload ?? [], now);
        return;
      }

      lastGoodPayload = list;
      renderMarkers(list);
      updateBadges(list, now);
    }catch(e){
      // Netzwerk-/Parsefehler -> alte Anzeige behalten, Hinweis zeigen
      showHintOnce();
      updateBadges(lastGoodPayload ?? [], now);
    }
  }

  // Erste Ladung, danach regelmäßig
  loadAndRender();
  // alle 60s abrufen (kannst du anpassen)
  setInterval(loadAndRender, 60_000);

  /************** Statistikmodus (einfacher Loader im selben File) *************/
  (function maybeStats(){
    const p = new URLSearchParams(location.search);
    if(p.get('stats')!=='1') return;
    // ganz schlanke Stats: wir tauschen Karte gegen Hinweis + versuchen History zu laden
    const nodeId = p.get('id') || '';
    document.title = `Schulwaldsensor — ${nodeId}`;
    document.body.innerHTML = `
      <div style="padding: 1.25rem 1rem; max-width: 1100px; margin: 0 auto; font-family: inherit">
        <h1 style="margin:.2rem 0 1rem 0;">Schulwaldsensor — ${prettyName(nodeId)}</h1>
        <div id="info" style="margin:.75rem 0; color:#444">Lade Daten …</div>
        <canvas id="qr" style="margin:.5rem 0 1rem 0;"></canvas>
        <div class="mini">Link: ${location.href}</div>
        <pre id="out" style="white-space:pre-wrap; background:#fafafa; border:1px solid #eee; border-radius:12px; padding:12px; font-size:.95rem;"></pre>
      </div>
    `;
    drawFakeQR(document.getElementById('qr'), nodeId);

    const tryFiles = [
      `/data/v2/history/history_${encodeURIComponent(nodeId)}.json`,
      ...HISTORY_FALLBACKS.filter(([s])=> nodeId.endsWith(s)).map(([,u])=>u)
    ];

    (async ()=>{
      for(const url of tryFiles){
        try{
          const r = await fetch(url, {cache:'no-store'});
          if(r.ok){
            const data = await r.json();
            document.getElementById('info').textContent = `Quelle: ${url}`;
            document.getElementById('out').textContent =
              typeof data==='object' ? JSON.stringify(data,null,2) : String(data);
            return;
          }
        }catch{}
      }
      document.getElementById('info').textContent = 'Keine History-Datei gefunden.';
      document.getElementById('out').textContent = '';
    })();
  })();
  </script>
</body>
</html>
