<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Waldsensor v2 – Übersicht</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#5b6785;--border:#e5e7eb;--accent:#0ea5e9
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .topbar{display:flex;align-items:center;gap:12px;max-width:1100px;margin:10px auto 8px;padding:0 12px}
    .badge{margin-left:auto;background:#ecfeff;border:1px solid #cffafe;color:#0369a1;border-radius:999px;padding:6px 10px;font-weight:600}
    #map{height:calc(100vh - 70px);max-width:1100px;margin:0 auto;border-radius:14px;box-shadow:0 6px 24px rgba(15,23,42,.06);border:1px solid var(--border)}
    .popup{min-width:260px}
    .popup h3{margin:0 0 6px;font-size:18px}
    .popup .kv{display:flex;justify-content:space-between;gap:8px}
    .hr{height:1px;background:var(--border);margin:8px 0}
    .qrbox{display:flex;gap:12px;align-items:center}
    .qrbox button{border:1px solid var(--border);background:#f8fafc;border-radius:10px;padding:6px 10px;cursor:pointer}
    .qrbox img{border:1px solid var(--border);border-radius:8px}
  </style>
</head>
<body>
  <div class="topbar">
    <h1 style="font-size:20px;margin:0">Waldsensor – Livekarte</h1>
    <span id="right-badge" class="badge">Letzte Node-Meldung: —</span>
  </div>
  <div id="map"></div>

<script>
(async () => {
  // ---------- Basiskarte ----------
  const map = L.map('map', { zoomControl: true });
  // Schleswig-Holstein grob zentrieren
  map.setView([54.3, 9.8], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  // ---------- Positionen (BEISPIELE) ----------
  // WICHTIG: Ersetze diese Beispiele durch euren großen POSITIONS-Block aus deiner bisherigen v2.html!
  const POSITIONS = {
    // Basis-IDs als Schlüssel sind am robustesten:
    // 'kropp': [54.405, 9.515],
    // 'breklum': [54.626, 9.184],
    // 'fahrdorf': [54.492, 9.594],
    // 'lsn50': [54.3, 9.8],
    // 's31': [54.3, 9.8],
    // 'se01': [54.3, 9.8],
  };

  // Falls ihr bisher Suffix-IDs als Schlüssel genutzt habt, kein Problem:
  // Der Code unten sucht automatisch erst basisId, dann fullId im Mapping.

  // ---------- Helfer ----------
  const rightBadge = document.getElementById('right-badge');
  const markerLayer = L.layerGroup().addTo(map);
  const usedCoords = new Set(); // leichte Versetzung bei Doppelbelegung

  function fmtNum(v, digits=1) {
    if (v === null || v === undefined || Number.isNaN(v)) return '—';
    const n = Number(v);
    return Number.isFinite(n) ? n.toFixed(digits) : '—';
  }
  function fmtTimeLocal(ts) {
    try {
      return new Date(ts).toLocaleString('de-DE', { timeZone: 'Europe/Berlin' });
    } catch { return '—'; }
  }
  function nudgeIfDuplicate(pos){
    // sorgt dafür, dass Marker an identischer Position leicht versetzt werden
    const key = pos.join(',');
    if (usedCoords.has(key)) {
      pos[0] += (Math.random()-0.5)*0.0018;
      pos[1] += (Math.random()-0.5)*0.0018;
      return nudgeIfDuplicate(pos);
    }
    usedCoords.add(key);
    return pos;
  }

  // ---------- Daten laden ----------
  const ALL_URL = '/data/v2/latest/_all.json?nocache=' + Date.now();
  let data = [];
  try {
    const r = await fetch(ALL_URL, { cache: 'no-store' });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    data = await r.json();
    if (!Array.isArray(data)) throw new Error('Kein Array in _all.json');
  } catch (e) {
    console.error('Fetch fehlgeschlagen:', e);
    rightBadge.textContent = 'Letzte Node-Meldung: — (Fehler beim Laden)';
    return;
  }

  if (data.length === 0) {
    markerLayer.clearLayers();
    rightBadge.textContent = 'Letzte Node-Meldung: —';
    return;
  }

  // neueste Meldung
  const newest = data.reduce((a,b) =>
    (new Date(a.ts).getTime() > new Date(b.ts).getTime()) ? a : b
  );
  rightBadge.textContent = `Letzte Node-Meldung: ${newest.id} — ${fmtTimeLocal(newest.ts)}`;

  // Marker neu aufbauen
  markerLayer.clearLayers();
  usedCoords.clear();

  data.forEach(rec => {
    const fullId = String(rec.id || '').trim();        // z.B. "kropp-sn50v3"
    if (!fullId) return;

    const baseId = fullId.replace(/-.*/, '');          // <<< WICHTIG: Suffix entfernen, z.B. "kropp"
    // 1) Bevorzugt Position unter Basis-ID, 2) sonst unter voller ID
    let basePos = POSITIONS[baseId] || POSITIONS[fullId];
    if (!basePos) { console.warn('Keine Koordinate für', fullId, '(basis:', baseId, ')'); return; }

    const pos = nudgeIfDuplicate(basePos.slice());

    const f = rec.fields || {};
    const temp = f.TempC_SHT ?? f.TempC_SHT31 ?? f.TempC ?? null;
    const hum  = f.Hum_SHT  ?? f.Hum_SHT31  ?? null;
    const bat  = f.BatV     ?? null;

    // <<< EINZIGE RELEVANTE FUNKTIONSÄNDERUNG:
    // Für QR-Code und Link wird die BASIS-ID (ohne Suffix) genutzt,
    // damit v1/sensor.html wieder für alle Nodes funktioniert.
    const detailUrl = '/html/sensor.html?node=' + encodeURIComponent(baseId);
    const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=192x192&data='
                + encodeURIComponent(location.origin + detailUrl);

    const html =
      `<div class="popup">
         <h3>${fullId}</h3>
         <div class="kv"><b>Zeit:</b> <span>${fmtTimeLocal(rec.ts)}</span></div>
         <div class="kv"><b>Temp:</b> <span>${fmtNum(temp,1)} °C</span></div>
         <div class="kv"><b>Feuchte:</b> <span>${fmtNum(hum,1)} %</span></div>
         <div class="kv"><b>Batterie:</b> <span>${fmtNum(bat,3)} V</span></div>
         <div class="hr"></div>
         <div class="qrbox">
           <img alt="QR" width="96" height="96" src="${qrUrl}" />
           <div>
             <div><b>Sensor-Details</b></div>
             <button onclick="location.href='${detailUrl}'">Seite öffnen</button>
             <div style="margin-top:6px;color:#6b7280;font-size:12px">
               Link nutzt Basis-ID: <code>${baseId}</code>
             </div>
           </div>
         </div>
       </div>`;

    L.marker(pos).addTo(markerLayer).bindPopup(html);
  });

})();
</script>
</body>
</html>
