<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH ‚Äì v2</title>
  <!-- version: v04 (2025-09-27) -->
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --ok:#e6f9ec; --ok-ink:#0f5132;
      --blue:#e8f1ff; --blue-ink:#1e3a8a; --bg:#f6f8fb; --card:#fff;
    }
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;background:var(--bg);color:var(--ink)}
    #map{height:100vh;width:100vw}
    /* Badges */
    .ws-badge{position:fixed;z-index:9000;display:inline-block;background:#fff;border-radius:14px;
      box-shadow:0 6px 24px -18px rgba(0,0,0,.6), 0 1px 0 rgba(0,0,0,.08);padding:10px 16px;font-weight:800}
    .ws-badge small{font-weight:700;color:var(--muted)}
    .ws-left{left:18px;top:20px;background:var(--ok);color:var(--ok-ink)}
    .ws-right{right:18px;top:20px;background:var(--blue);color:var(--blue-ink)}
    /* Kompaktes Popup (‚âà70% der bisherigen Gr√∂√üe) + tiefer positioniert */
    .ws-popup .leaflet-popup-content{margin:8px 10px;min-width:220px;max-width:280px}
    .ws-popup h3{margin:0 0 6px;font-size:16px;font-weight:900}
    .ws-popup .meta{font-size:13px;color:var(--muted);margin:2px 0}
    .ws-popup .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;margin:8px 0 6px}
    .ws-popup .kv .k{color:var(--muted);font-size:13px}
    .ws-popup .kv .v{font-weight:800}
    .ws-popup .qr{display:flex;align-items:center;gap:12px;margin:8px 0}
    .ws-popup .qr canvas, .ws-popup .qr img{width:96px;height:96px}
    .ws-popup .btn{display:inline-block;background:#1e3a8a;color:#fff;text-decoration:none;
      font-weight:800;border-radius:10px;padding:8px 12px}
    /* Auf kleineren Screens die Badges nicht verdecken lassen */
    @media (max-width:520px){ .ws-badge{padding:8px 12px} .ws-popup .leaflet-popup-content{max-width:260px} }
  </style>

  <!-- Leaflet + QRCode + Chart (Chart nur in Statistikmodus ben√∂tigt, l√§dt aber klein) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <script>
    // ---------- gemeinsame Helfer ----------
    const $ = (id)=>document.getElementById(id);
    const fmt = (n,d=1)=> (n==null||Number.isNaN(n)) ? "‚Äî" : Number(n).toFixed(d).replace(".",",");
    const prettyTitle = (id)=> (id||"").replace(/[_]/g,"-").split("-").map(s=>s? s[0].toUpperCase()+s.slice(1):s).join("-");
    const isSoilNode = (id)=>/(^|[-_])se01([-_]|$)/i.test(id||"");
    const num = (v)=> (v==null?null:Number(String(v).replace(",", ".")));

    function pickFieldsFromObj(source,nodeId){
      const f = source?.fields || source || {};
      if(isSoilNode(nodeId)){
        return { t:num(f.temp_SOIL), h:num(f.water_SOIL), bat:num(f.BatV), humLabel:"Bodenwasser" };
      }
      // SN50v3, S31-LB, Fallback LSN50v2
      const temp = f.TempC_SHT ?? f.TempC_SHT31 ?? f.TempC1 ?? null;
      const hum  = f.Hum_SHT   ?? f.Hum_SHT31   ?? null;
      return { t:num(temp), h:num(hum), bat:num(f.BatV), humLabel:"Luftfeuchte" };
    }

    function qs(k){const u=new URL(location.href);return u.searchParams.get(k)}
  </script>
</head>

<body>

<!-- Badges (nur Map-Modus sichtbar) -->
<div id="badgeLeft" class="ws-badge ws-left" style="display:none">Letzte Aktualisierung: <span id="lastUp">‚Äì</span> <small>‚Ä¢ Nodes: <span id="nodeCount">0</span></small></div>
<div id="badgeRight" class="ws-badge ws-right" style="display:none">Letzte Node-Meldung: <span id="lastNode">‚Äì</span></div>

<div id="map" style="display:none"></div>

<!-- Statistik-Ansicht (wird bei ?stats=1 angezeigt) -->
<div id="statsWrap" style="display:none;max-width:1180px;margin:0 auto;padding:20px">
  <div style="margin-bottom:8px;"><a href="/v2.html" style="text-decoration:none;color:#2563eb;font-weight:700">‚Üê Zur Karte</a></div>
  <h1 style="margin:6px 0 18px;font-weight:900;letter-spacing:.2px">Schulwaldsensor ‚Äî <span id="s_title">‚Ä¶</span>
    <small style="font-size:12px;font-weight:800;color:#94a3b8;margin-left:8px">v04</small>
  </h1>

  <div style="display:grid;gap:18px;grid-template-columns:1fr 1fr">
    <div style="background:var(--card);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15)">
      <div style="margin-bottom:10px"><span style="background:var(--ok);color:#0f5132;border-radius:999px;padding:6px 10px;font-weight:800">Stand: <span id="s_stand">‚Äî</span></span></div>
      <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
        <div style="background:#eef2f7;border-radius:12px;padding:14px 16px">
          <div style="color:var(--muted);font-size:14px;margin-bottom:6px">Temperatur</div>
          <div id="s_temp" style="font-size:22px;font-weight:900">‚Äî</div>
        </div>
        <div style="background:#eef2f7;border-radius:12px;padding:14px 16px">
          <div id="s_hum_label" style="color:var(--muted);font-size:14px;margin-bottom:6px">Luftfeuchte</div>
          <div id="s_hum" style="font-size:22px;font-weight:900">‚Äî</div>
        </div>
        <div style="grid-column:1/-1;background:#eef2f7;border-radius:12px;padding:14px 16px">
          <div style="color:var(--muted);font-size:14px;margin-bottom:6px">Batterie</div>
          <div id="s_bat" style="font-size:22px;font-weight:900">‚Äî</div>
        </div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">Quelle: <span style="font-family:ui-monospace,Menlo,Consolas,monospace">/data/v2/latest/all.json</span></div>
    </div>

    <div style="background:var(--card);border-radius:14px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15)">
      <div style="font-weight:900;margin:0 0 10px">Netz &amp; Gateways</div>
      <div id="s_net">‚Äî</div>
      <div style="margin-top:8px;color:var(--muted);font-size:13px">Quelle: <span id="s_net_path" style="font-family:ui-monospace,Menlo,Consolas,monospace">‚Äî</span></div>
    </div>
  </div>

  <div style="background:var(--card);border-radius:14px;padding:16px;margin-top:18px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15)">
    <div style="font-weight:900;margin:0 0 10px">üìä Verlauf Temperatur &amp; Luftfeuchtigkeit</div>
    <canvas id="s_hourly"></canvas>
    <div style="margin-top:8px;color:var(--muted);font-size:13px">Sucht: <span id="s_hist_path" style="font-family:ui-monospace,Menlo,Consolas,monospace">/data/v2/history/&lt;node&gt;.json</span></div>
    <div id="s_hist_err" style="display:none;color:#b91c1c;font-weight:800;margin-top:6px"></div>
    <div id="s_no_hourly" style="display:none;color:var(--muted);font-size:13px;margin-top:6px">Kein Verlauf gefunden.</div>
  </div>

  <div style="background:var(--card);border-radius:14px;padding:16px;margin-top:18px;box-shadow:0 1px 0 rgba(0,0,0,.04),0 10px 30px -20px rgba(0,0,0,.15)">
    <div style="font-weight:900;margin:0 0 10px">üóìÔ∏è 31 Tage ‚Äî Tagesmittel (Temp / Feuchte)</div>
    <canvas id="s_daily"></canvas>
    <div id="s_no_daily" style="display:none;color:var(--muted);font-size:13px;margin-top:6px">Keine Tageswerte m√∂glich (es fehlt Verlauf).</div>
  </div>
</div>

<script>
(async function main(){
  const isStats = (qs("stats")==="1");
  if(isStats){ return initStats(); }
  $('map').style.display = 'block';
  $('badgeLeft').style.display = 'inline-block';
  $('badgeRight').style.display = 'inline-block';

  // Map mit Auto-Pan Padding, damit Badges oben nicht verdecken
  const map = L.map('map', {
    zoomControl:true, preferCanvas:true,
    center:[54.4, 9.7], zoom:9,
    maxZoom:18, minZoom:6,
    autoPanPaddingTopLeft: L.point(20, 80), // Platz f√ºr linke Badge
    autoPanPaddingBottomRight: L.point(20, 20)
  });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // Daten laden
  const r = await fetch('/data/v2/latest/all.json',{cache:'no-store'});
  const data = r.ok ? await r.json() : [];
  const nodes = Array.isArray(data) ? data : [];
  $('nodeCount').textContent = String(nodes.length || 0);

  // Neueste Meldung
  let newest = null;
  for(const it of nodes){
    if(it?.ts){
      const t = new Date(it.ts).getTime();
      if(!newest || t > newest.t) newest = {id:it.id, t, ts:it.ts};
    }
  }
  if(newest){
    $('lastUp').textContent = new Date(newest.t).toLocaleTimeString('de-DE');
    $('lastNode').textContent = new Date(newest.t).toLocaleString('de-DE') + ' ‚Äî ' + (newest.id||'');
  }

  // Marker + Popups
  const markers = [];
  for(const it of nodes){
    const id = it.id || '';
    const lat = it.fields?.lat ?? it.lat;
    const lon = it.fields?.lon ?? it.lon;
    if(!(Number.isFinite(lat) && Number.isFinite(lon))) continue;

    const pf = pickFieldsFromObj(it, id);
    const title = prettyTitle(id);
    const statsLink = `/v2.html?stats=1&id=${encodeURIComponent(id)}`;
    const deepLink = `https://www.waldsensor.sh/v2.html?stats=1&id=${encodeURIComponent(id)}`;

    const html = `
      <div class="ws-popup">
        <h3>Sensor: ${title}</h3>
        <div class="meta">Zuletzt aktiv: ${it.ts ? new Date(it.ts).toLocaleString('de-DE') : '‚Äî'}</div>
        <div class="kv">
          <div class="k">Batterie</div><div class="v">${pf.bat!=null? fmt(pf.bat,3)+' V':'‚Äî'}</div>
          <div class="k">${pf.humLabel}</div><div class="v">${pf.h!=null? fmt(pf.h,1)+' %':'‚Äî'}</div>
          <div class="k">Temperatur</div><div class="v">${pf.t!=null? fmt(pf.t,1)+' ¬∞C':'‚Äî'}</div>
        </div>
        <div class="qr"><div id="qr_${CSS.escape(id)}"></div>
          <div>
            <a class="btn" href="${statsLink}">Statistik √∂ffnen</a>
            <div style="margin-top:6px;color:#64748b;font-size:12px">Link nutzt Node-ID: <span style="font-family:ui-monospace">${id}</span></div>
          </div>
        </div>
      </div>
    `;

    const m = L.marker([lat, lon]).addTo(map);
    m.bindPopup(html, {
      className: 'ws-popup',
      maxWidth: 320,
      offset: L.point(0, 18) // Popup etwas weiter nach unten
    }).on('popupopen', () => {
      // QR erst rendern, wenn Container sicher im DOM
      const el = document.querySelector(`#qr_${CSS.escape(id)}`);
      if (el && !el.dataset.done) {
        try {
          new QRCode(el, { text: deepLink, width: 96, height: 96, correctLevel: QRCode.CorrectLevel.M });
          el.dataset.done = '1';
        } catch(e) {
          // Fallback ohne Abbruch
          el.innerHTML = '<div style="font-size:12px;color:#b91c1c">QR konnte nicht erzeugt werden</div>';
        }
      }
    });
    markers.push(m);
  }

  if(markers.length){
    const g = L.featureGroup(markers);
    map.fitBounds(g.getBounds().pad(0.2));
  }
})();

// -------------------- Statistikmodus --------------------
async function initStats(){
  $('statsWrap').style.display = 'block';
  const id = (qs('id') || qs('node') || '').trim();
  const wanted = id || null;

  // latest laden
  const r = await fetch('/data/v2/latest/all.json',{cache:'no-store'});
  const latest = r.ok ? await r.json() : [];
  let entry = null;
  if(wanted){
    entry = latest.find(x=>x.id===wanted) || latest.find(x=> (x.id||'').toLowerCase()===wanted.toLowerCase());
  }
  if(!entry) entry = latest[0] || {};

  const nodeId = entry.id || wanted || '‚Äî';
  const soil = isSoilNode(nodeId);
  $('s_title').textContent = prettyTitle(nodeId);
  $('s_stand').textContent = entry.ts ? new Date(entry.ts).toLocaleString('de-DE') : '‚Äî';

  const pf = pickFieldsFromObj(entry, nodeId);
  $('s_temp').textContent = pf.t!=null ? fmt(pf.t,1)+' ¬∞C' : '‚Äî';
  $('s_hum').textContent  = pf.h!=null ? fmt(pf.h,1)+(soil?' %':' %') : '‚Äî';
  $('s_hum_label').textContent = pf.humLabel;
  $('s_bat').textContent  = pf.bat!=null ? fmt(pf.bat,3)+' V' : '‚Äî';

  // Netstats
  const netUrl = `/data/v2/net/netstats_${encodeURIComponent(nodeId)}.json`;
  $('s_net_path').textContent = netUrl;
  try{
    const nr = await fetch(netUrl,{cache:'no-store'});
    if(nr.ok){
      const d = await nr.json();
      const ts = d.last_ts ? new Date(d.last_ts).toLocaleString('de-DE') : '‚Äî';
      $('s_net').innerHTML = `Letzte 24 h: <b>${d.frames24||0}</b> Uplinks<br>Letzter Uplink: <b>${ts}</b>`;
    }else{
      $('s_net').textContent = 'nicht gefunden';
    }
  }catch(e){ $('s_net').textContent = 'Fehler beim Laden'; }

  // History laden und in {ts,t,h} normieren
  const hUrl = `/data/v2/history/${encodeURIComponent(nodeId)}.json`;
  $('s_hist_path').textContent = hUrl;
  let hist = [];
  try{
    const hr = await fetch(hUrl,{cache:'no-store'});
    if(hr.ok){
      const raw = await hr.json();
      if(Array.isArray(raw)){
        hist = raw.filter(x=>x&&x.ts).map(x=>{
          const pf2 = pickFieldsFromObj(x, nodeId);
          return { ts:x.ts, t:pf2.t, h:pf2.h };
        }).sort((a,b)=> new Date(a.ts)-new Date(b.ts));
      }
    }else{
      $('s_hist_err').style.display='block';
      $('s_hist_err').textContent = `Fehler beim Laden (${hr.status}) von ${hUrl}`;
    }
  }catch(e){
    $('s_hist_err').style.display='block';
    $('s_hist_err').textContent = `Fehler: ${e?.message||e}`;
  }

  // 7 Tage Verlauf
  const seven = Date.now() - 7*24*3600*1000;
  const recent = hist.filter(x=> new Date(x.ts).getTime() >= seven);
  if(recent.length){
    $('s_no_hourly').style.display='none';
    const ctx = $('s_hourly').getContext('2d');
    const labels = recent.map(x=>x.ts);
    const tLabel = soil? 'Bodentemperatur [¬∞C]' : 'Temperatur [¬∞C]';
    const hLabel = soil? 'Bodenwasser [%]'      : 'Luftfeuchte [%]';
    new Chart(ctx,{type:'line',data:{
      labels,
      datasets:[
        {label:tLabel, data:recent.map(x=>x.t), yAxisID:'y1'},
        {label:hLabel, data:recent.map(x=>x.h), yAxisID:'y2'}
      ]},
      options:{
        responsive:true, interaction:{mode:'index',intersect:false},
        scales:{
          x:{ticks:{callback:(v,i)=>{const d=new Date(labels[i]);return d.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit'})+' '+d.toLocaleTimeString('de-DE',{hour:'2-digit'})+'h'}}},
          y1:{position:'left', grid:{drawOnChartArea:false}},
          y2:{position:'right', min:0, max:100}
        },
        plugins:{legend:{position:'top'}}
      }
    });
  }else{
    $('s_no_hourly').style.display='block';
  }

  // 31 Tage Tagesmittel
  const days = groupDaily(hist);
  if(days.length){
    $('s_no_daily').style.display='none';
    const ctxD = $('s_daily').getContext('2d');
    const labels = days.map(d=>d.day);
    const tLabel = soil? '√ò Bodentemperatur [¬∞C]' : '√ò Temperatur [¬∞C]';
    const hLabel = soil? '√ò Bodenwasser [%]'      : '√ò Luftfeuchte [%]';
    new Chart(ctxD,{type:'bar',data:{
      labels,
      datasets:[
        {type:'bar',  label:hLabel, data:days.map(d=>d.h), yAxisID:'y2'},
        {type:'line', label:tLabel, data:days.map(d=>d.t), yAxisID:'y1'}
      ]},
      options:{
        responsive:true, interaction:{mode:'index',intersect:false},
        scales:{ y1:{position:'left', grid:{drawOnChartArea:false}}, y2:{position:'right', min:0, max:100} },
        plugins:{legend:{position:'top'}}
      }
    });
  }else{
    $('s_no_daily').style.display='block';
  }

  function groupDaily(items){
    const m = new Map();
    for(const it of items){
      const d = new Date(it.ts);
      const key = d.getUTCFullYear()+"-"+String(d.getUTCMonth()+1).padStart(2,"0")+"-"+String(d.getUTCDate()).padStart(2,"0");
      if(!m.has(key)) m.set(key,{n:0,tsum:0,hsum:0});
      const o = m.get(key);
      if(typeof it.t==='number') o.tsum += it.t;
      if(typeof it.h==='number') o.hsum += it.h;
      o.n++;
    }
    const out=[];
    for(const [k,v] of m.entries()){
      out.push({day:k, t: v.n? v.tsum/v.n : null, h: v.n? v.hsum/v.n : null});
    }
    out.sort((a,b)=> a.day.localeCompare(b.day));
    return out.slice(-31);
  }
}
</script>
</body>
</html>
