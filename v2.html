<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WALDSENSOR.SH ‚Äì Gateway-Karte</title>
  <meta name="version" content="v2.22 ‚Äì SiteCluster Edition (03.11.2025)"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{--ink:#0f172a;--muted:#64748b;--bg:#f6f8fb;--card:#fff;--success:#10b981;--gateway:#8b5cf6;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    #map{position:absolute;inset:0}
    .badge{background:var(--card);box-shadow:0 8px 30px -16px rgba(0,0,0,.25);
      border-radius:12px;padding:8px 12px;font-size:14px;font-weight:700;color:var(--ink)}
    .badge small{display:block;font-weight:600;color:var(--muted);margin-top:2px;font-size:12px}
    .hud-left{position:fixed;left:64px;top:12px;z-index:500;display:flex;flex-direction:column;gap:8px}
    .hud-right{position:fixed;right:16px;top:16px;z-index:500;display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .hud-center{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:500}
    .leaflet-popup-content-wrapper{border-radius:12px;box-shadow:0 12px 40px -18px rgba(0,0,0,.35)}
    .leaflet-popup-content{margin:16px}
    .popup{min-width:280px;max-width:320px;font-size:13px;line-height:1.4}
    .popup h3{margin:0 0 12px;font-size:17px;font-weight:800;display:flex;align-items:center;gap:8px}
    .popup hr{border:none;border-top:1px solid #e5e7eb;margin:12px 0}
    .row{display:flex;justify-content:space-between;gap:12px;margin:6px 0;align-items:center}
    .label{color:var(--muted);font-weight:600;font-size:12px}
    .value{font-weight:700;font-size:13px}
    .status-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;
      font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;background:#d1fae5;color:#065f46}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
    .info-card{background:#f9fafb;padding:8px;border-radius:6px;text-align:center}
    .info-card .num{font-size:18px;font-weight:800;color:var(--ink);display:block}
    .info-card .lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px}
    .gw-list{margin:8px 0}
    .gw-item{background:#f9fafb;padding:6px;border-radius:6px;margin:4px 0;font-size:12px}
    .gw-item strong{display:block;color:var(--gateway);font-size:11px;margin-bottom:2px}
    .gw-item .signal{display:flex;justify-content:space-between;font-size:11px}
    .sensor-type{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;margin:8px 0 4px}
    .popup .btn{display:block;margin-top:12px;padding:10px;background:#1d4ed8;color:white;border-radius:8px;font-weight:700;text-decoration:none;text-align:center}
    .marker-node{width:22px;height:22px;background:var(--success);border:4px solid white;border-radius:50%;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.6)}50%{box-shadow:0 0 0 8px rgba(16,185,129,0)}}
    .marker-gateway{width:20px;height:20px;background:var(--gateway);border:3px solid white;border-radius:4px;
      transform:rotate(45deg);box-shadow:0 2px 8px rgba(0,0,0,.3)}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hud-left">
    <div class="badge" id="nodesBadge">Nodes: ‚Äì</div>
    <div class="badge" id="gatewaysBadge">Gateways: ‚Äì</div>
  </div>
  <div class="hud-center">
    <div class="badge">v2.22 ‚Äì SiteCluster Edition (03.11.2025)</div>
  </div>
  <div class="hud-right">
    <div class="badge" id="lastBadge">Letzte Meldung: ‚Äì<small id="lastBadgeAge">‚Äî</small></div>
    <div class="badge" id="packetBadge">Verbindungen: ‚Äì<small id="packetDetail">‚Äî</small></div>
  </div>

<script>
const NUM=x=>{const n=typeof x==="number"?x:(typeof x==="string"?Number(x.replace(",",".")):NaN);return Number.isFinite(n)?n:null;};
const isValidISO=ts=>!!ts&&typeof ts==="string"&&Number.isFinite(Date.parse(ts));
const formatDE=ts=>isValidISO(ts)?new Date(ts).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"‚Äî";
const relAge=ts=>{if(!isValidISO(ts))return"‚Äî";const m=Math.floor((Date.now()-Date.parse(ts))/60000);if(m<60)return`${m} min`;const h=Math.floor(m/60),r=m%60;return`${h} h ${r} min`;};
const deNum=(n,d=1)=>(typeof n==="number"&&Number.isFinite(n))?n.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d}):"‚Äì";
function getLocationKey(id){const parts=String(id||"").toLowerCase().replace(/_/g,"-").split("-");return parts.length>1?parts.slice(0,-1).join("-"):parts[0];}
function findRelatedNodes(nodes,base){const key=getLocationKey(base);return nodes.filter(n=>getLocationKey(n.id)===key);}
function multiSensorPopupHtml(nodes){
  const title=getLocationKey(nodes[0].id).replace(/^waldsensor-?/i,'waldsensor-');
  const lastTs=nodes.reduce((a,n)=>!isValidISO(n.ts)?a:(!a||Date.parse(n.ts)>Date.parse(a)?n.ts:a),null);
  const batVals=nodes.map(n=>NUM(n.fields?.BatV)).filter(Number.isFinite);
  const batAvg=batVals.length?batVals.reduce((a,b)=>a+b,0)/batVals.length:null;
  const gwSet=new Map();
  nodes.forEach(n=>(n.gateway_details||[]).forEach((g,i)=>{if(!gwSet.has(g.id))gwSet.set(g.id,g);}));
  const gws=[...gwSet.values()];
  const bwVals=nodes.map(n=>n.fields?.bw?NUM(n.fields.bw)/1000:null).filter(Number.isFinite);
  const bwAvg=bwVals.length?(bwVals.reduce((a,b)=>a+b,0)/bwVals.length).toFixed(1)+' kHz':'‚Äì';

  let html=`<div class="popup"><h3>${title}<span class="status-badge">${nodes.length} Sensoren</span></h3>`;
  html+=`<div class="row"><span class="label">Letzter Kontakt</span><span class="value">${formatDE(lastTs)}</span></div><hr/>`;
  html+=`<div class="info-grid">
    <div class="info-card"><span class="num">${gws.length||'‚Äì'}</span><span class="lbl">Gateways</span></div>
    <div class="info-card"><span class="num">${batAvg?deNum(batAvg,2):'‚Äì'}</span><span class="lbl">√ò Batterie (V)</span></div>
    <div class="info-card"><span class="num">${bwAvg}</span><span class="lbl">Bandwidth</span></div>
  </div><hr/>`;

  const order=['llms01','s31lb','lsn50v2','se01lb'];
  nodes.sort((a,b)=>order.indexOf(a.id.split('-').pop())-order.indexOf(b.id.split('-').pop()));

  nodes.forEach(n=>{
    const f=n.fields||{},id=n.id.toLowerCase();
    if(/llms01/.test(id))html+=`<div class="sensor-type">üçÉ Blatt-Sensor</div>
      <div class="row"><span class="label">Blatttemperatur</span><span class="value">${deNum(NUM(f.Leaf_Temperature),1)} ¬∞C</span></div>
      <div class="row"><span class="label">Blattfeuchte</span><span class="value">${deNum(NUM(f.Leaf_Moisture),1)} %</span></div>
      <div class="row"><span class="label">Batterie</span><span class="value">${deNum(NUM(f.BatV),2)} V</span></div>`;
    else if(/se01/.test(id))html+=`<div class="sensor-type">üå± Boden-Sensor</div>
      <div class="row"><span class="label">Bodentemperatur</span><span class="value">${deNum(NUM(f.temp_SOIL),1)} ¬∞C</span></div>
      <div class="row"><span class="label">Bodenfeuchte</span><span class="value">${deNum(NUM(f.water_SOIL),1)} %</span></div>
      <div class="row"><span class="label">Batterie</span><span class="value">${deNum(NUM(f.BatV),2)} V</span></div>`;
    else html+=`<div class="sensor-type">üå°Ô∏è Luft-Sensor</div>
      <div class="row"><span class="label">Lufttemperatur</span><span class="value">${deNum(NUM(f.TempC_SHT31)||NUM(f.TempC_SHT),1)} ¬∞C</span></div>
      <div class="row"><span class="label">Luftfeuchte</span><span class="value">${deNum(NUM(f.Hum_SHT31)||NUM(f.Hum_SHT),1)} %</span></div>
      <div class="row"><span class="label">Batterie</span><span class="value">${deNum(NUM(f.BatV),2)} V</span></div>`;
  });

// --- Erg√§nze Bandwidth & Gateways √ºber Netstats-Datei, falls leer ---
if ((!sf || bw === '‚Äì' || gws.length === 0) && nodes.length) {
  const nid = nodes[0].id;
  const netUrl = `/data/v2/net/netstats_${nid}.json`;
  fetch(netUrl)
    .then(r => r.ok ? r.json() : null)
    .then(nd => {
      if (!nd) return;
      if (nd.gateways && nd.gateways.length) {
        html = html.replace('0</span><span class="lbl">Gateways',
          nd.gateways.length + '</span><span class="lbl">Gateways');
      }
      if (nd.bw) {
        html = html.replace('‚Äì</span><span class="lbl">Bandwidth',
          nd.bw + ' kHz</span><span class="lbl">Bandwidth');
      }
    })
    .catch(err => console.warn('Kein Netstats-Fallback f√ºr', nid, err));
}
html+=`<a class="btn" href="/html/sensor.html?node=${encodeURIComponent(nodes[0].id)}" target="_blank" rel="noopener">Detailansicht √∂ffnen ‚Üí</a>`;
return html;  

}
function nodePopupHtml(item,all){const rel=findRelatedNodes(all||[item],item.id);if(rel.length>1)return multiSensorPopupHtml(rel);
  const f=item.fields||{},gwCount=(item.gateway_details||[]).length;let html=`<div class="popup"><h3>${item.id}<span class="status-badge">AKTIV</span></h3>
  <div class="row"><span class="label">Letzter Kontakt</span><span class="value">${formatDE(item.ts)}</span></div><hr/>
  <div class="info-grid"><div class="info-card"><span class="num">${gwCount}</span><span class="lbl">Gateways</span></div>
  <div class="info-card"><span class="num">${deNum(NUM(f.BatV),2)}</span><span class="lbl">Batterie (V)</span></div></div></div>`;
  return html;}
async function fetchJson(u){const r=await fetch(u+"?_="+Date.now());if(!r.ok)throw new Error(r.status);return await r.json();}
const map=L.map('map').setView([54.3,9.7],8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
async function render(){
  try{const nodes=await fetchJson("/data/v2/latest/all_enriched.json");
    document.getElementById("nodesBadge").textContent=`Nodes: ${nodes.length}`;
    const used=new Map();nodes.forEach(n=>{
      const f=n.fields||{},lat=NUM(f.lat),lon=NUM(f.lon);
      if(!lat||!lon)return;
      L.marker([lat,lon],{icon:L.divIcon({className:'',html:'<div class="marker-node"></div>',iconSize:[22,22],iconAnchor:[11,11]})})
        .addTo(map).bindPopup(nodePopupHtml(n,nodes),{maxWidth:320});
      (n.gateway_details||[]).forEach(g=>{if(!used.has(g.id))used.set(g.id,g);});
    });
    document.getElementById("gatewaysBadge").textContent=`Gateways: ${used.size}`;
  }catch(e){console.error(e);}
}
render();setInterval(render,120000);
</script>
</body>
</html>
