<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>WALDSENSOR.SH – Karte V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .badge {
      position: absolute;
      top: 10px;
      padding: 6px 12px;
      background: white;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    #leftBadge { left: 10px; }
    #rightBadge { right: 10px; }
    .popup-qr {
      text-align: center;
      margin-top: 8px;
    }
    .qr-button {
      display: inline-block;
      margin-top: 6px;
      padding: 6px 10px;
      background: linear-gradient(45deg, #6fdc6f, #9ff49f); /* helles Grün */
      color: black;
      text-decoration: none;
      border-radius: 4px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="leftBadge" class="badge">Letzte Aktualisierung: —</div>
  <div id="rightBadge" class="badge">Letzte Node-Meldung: —</div>

  <script>
    const FETCH_URL = "data/v2/latest/_all.json";
    const leftBadge  = document.getElementById('leftBadge');
    const rightBadge = document.getElementById('rightBadge');

    const map = L.map('map').setView([54.3, 9.7], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>'
    }).addTo(map);

    let markers = {};

    // -------- Badge für Nodes --------
    async function updateLatestBadge() {
      try {
        const url = FETCH_URL + "?t=" + Date.now();   // Cache-Buster
        const res = await fetch(url, { cache:'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('JSON ist kein Array');

        // jüngsten Datensatz bestimmen
        data.sort((a,b) => new Date(b.ts) - new Date(a.ts));
        const newest = data[0];

        if (newest) {
          const ts = new Date(newest.ts);
          rightBadge.textContent =
            `Letzte Node-Meldung ${newest.id.replace(/-.*/, '')} — ` +
            ts.toLocaleString('de-DE', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
        } else {
          rightBadge.textContent = 'Letzte Node-Meldung: —';
        }
      } catch (e) {
        console.error('Daten laden fehlgeschlagen:', e);
        rightBadge.textContent = 'Letzte Node-Meldung: — (Fehler beim Laden)';
      }
    }

    // alle 60 Sekunden Badge aktualisieren
    setInterval(updateLatestBadge, 60_000);

    // -------- Karte aktualisieren --------
    async function loadData() {
      try {
        const res = await fetch(FETCH_URL + "?t=" + Date.now(), { cache:'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('JSON ist kein Array');

        // Update-Text links
        leftBadge.textContent = "Letzte Aktualisierung: " +
          new Date().toLocaleString('de-DE', {hour:'2-digit', minute:'2-digit', second:'2-digit'});

        // Marker neu setzen
        for (const rec of data) {
          const id = rec.id;
          const coords = rec.fields;
          if (!coords || !coords.lat || !coords.lon) continue;

          if (markers[id]) map.removeLayer(markers[id]);

          const marker = L.marker([coords.lat, coords.lon]).addTo(map);
          let popupHtml = `<b>${id}</b><br>`;
          for (const [k,v] of Object.entries(rec.fields)) {
            if (typeof v === "number") {
              popupHtml += `${k}: ${v}<br>`;
            }
          }
          popupHtml += `<div class="popup-qr"><canvas id="qr-${id}"></canvas><br>
                        <a class="qr-button" href="html/sensor.html?node=${id}" target="_blank">Seite öffnen</a></div>`;

          marker.bindPopup(popupHtml);
          marker.on('popupopen', () => {
            const canvas = document.getElementById(`qr-${id}`);
            if (canvas) {
              QRCode.toCanvas(canvas, 
                window.location.origin + "/html/sensor.html?node=" + id,
                { width: 100 }, err => { if (err) console.error(err); });
            }
          });
          markers[id] = marker;
        }

        // auch rechts sofort Badge aktualisieren
        updateLatestBadge();

      } catch(e) {
        console.error("Fehler beim Laden:", e);
        leftBadge.textContent = "Letzte Aktualisierung: — (Fehler)";
      }
    }

    // sofort und alle 5 Minuten Karte neu laden
    loadData();
    setInterval(loadData, 300_000);
  </script>
</body>
</html>
