<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WALDSENSOR.SH Karte v0.11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    .leaflet-popup-content-wrapper {
      font-family: system-ui, sans-serif;
      font-size: 14px;
      transform: scale(0.7); /* kompakter */
      transform-origin: top left;
    }

    .badge {
      display:inline-block;
      background:#fff;
      border-radius:20px;
      padding:3px 10px;
      margin:3px;
      font-family:system-ui,sans-serif;
      font-size:13px;
      box-shadow:0 1px 4px rgba(0,0,0,0.3);
    }

    .btn {
      display:inline-block;
      background:#007BFF;
      color:#fff !important;
      padding:6px 12px;
      border-radius:6px;
      font-size:14px;
      text-decoration:none;
      font-weight:600;
    }
    .btn:hover { background:#0056b3; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// ========== Hilfsfunktionen ==========
function prettyName(id){
  return String(id||"")
    .replace(/_/g,"-")
    .split("-").map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join("-");
}

function fmt(val, unit=""){ return (val==null || val==="") ? "—" : val.toFixed(1)+" "+unit; }

function isSoilNode(id){ return /(^|[-_])se01(lb)?$/i.test(String(id||"")); }

// ========== Karte ==========
const map = L.map('map').setView([54.3,9.7], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'&copy; OpenStreetMap'
}).addTo(map);

// Badges
const brandDiv = L.control({position:'topleft'});
brandDiv.onAdd = ()=> {
  const d = L.DomUtil.create('div','badge');
  d.id="brandBadge";
  d.innerHTML = "WALDSENSOR.SH / v0.11";
  return d;
};
brandDiv.addTo(map);

const nodesDiv = L.control({position:'topleft'});
nodesDiv.onAdd = ()=> {
  const d = L.DomUtil.create('div','badge');
  d.id="nodesBadge";
  d.innerHTML = "Nodes: —";
  return d;
};
nodesDiv.addTo(map);

const lastDiv = L.control({position:'topleft'});
lastDiv.onAdd = ()=> {
  const d = L.DomUtil.create('div','badge');
  d.id="lastBadge";
  d.innerHTML = "Letzte Node-Meldung: —";
  return d;
};
lastDiv.addTo(map);

// Popup-Bau
function buildPopupHTML(n){
  const f = n.fields||{};
  const soil = isSoilNode(n.id);
  const temp = soil ? f.temp_SOIL : (f.TempC_SHT ?? f.TempC_SHT31);
  const hum  = soil ? f.water_SOIL : (f.Hum_SHT ?? f.Hum_SHT31);
  const bat  = f.BatV;

  const html = `
    <div>
      <strong>Sensor: ${prettyName(n.id)}</strong><br/>
      Zuletzt aktiv:<br/> ${new Date(n.ts*1000).toLocaleString("de-DE")}<hr/>
      Batterie <strong>${fmt(bat,"V")}</strong><br/>
      ${soil ? "Bodenfeuchte" : "Luftfeuchte"} ${fmt(hum, soil?"%":"%")}<br/>
      ${soil ? "Bodentemperatur" : "Temperatur"} ${fmt(temp,"°C")}<br/>
      <div id="qr_${n.id}" style="margin:6px 0;"></div>
      <a class="btn" href="/html/sensor.html?node=${encodeURIComponent(n.id)}" target="_blank">Statistik öffnen</a><br/>
      <small>Link nutzt ID: ${n.id}</small>
    </div>`;
  return html;
}

// QR-Code bei Popup-Open erzeugen
map.on('popupopen', ev=>{
  const el = ev.popup.getElement().querySelector('div[id^="qr_"]');
  if(el && !el.dataset.done){
    new QRCode(el, {text: window.location.origin+"/html/sensor.html?node="+encodeURIComponent(el.id.slice(3)), width:80, height:80});
    el.dataset.done="1";
  }
});

// ========== Robust-Loader ==========
const LS_KEY = 'v2:lastGoodAllJson_v1';
function loadCached(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'[]')}catch{return[]} }
function saveCached(arr){ try{localStorage.setItem(LS_KEY, JSON.stringify(arr))}catch{} }

async function fetchWithTimeout(url, ms=8000){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), ms);
  try{ return await fetch(url,{cache:'no-store',signal:ctrl.signal}); }
  finally{ clearTimeout(t); }
}

async function getAllJsonSafe(){
  for(let attempt=0; attempt<2; attempt++){
    try{
      const r = await fetchWithTimeout('/data/v2/latest/all.json',8000);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const arr = await r.json();
      const valid = Array.isArray(arr)? arr.filter(x=>x?.id && x?.fields?.lat && x?.fields?.lon):[];
      if(valid.length>0){ saveCached(valid); return valid; }
    }catch(_){}
    await new Promise(res=>setTimeout(res,1200));
  }
  const cached = loadCached();
  return cached.length>0? cached:[];
}

let __refreshTicket=0;
const __state={markers:[],lastIds:new Set()};

function drawMarkers(nodes){
  const created=[];
  nodes.forEach(n=>{
    const m=L.marker([n.fields.lat,n.fields.lon]).addTo(map);
    m.bindPopup(buildPopupHTML(n));
    created.push(m);
  });
  return created;
}

async function refreshMapSafe(){
  const my=++__refreshTicket;
  const data=await getAllJsonSafe();
  if(my!==__refreshTicket) return;
  if(data.length===0) return;

  // Badges updaten
  document.getElementById("nodesBadge").innerHTML="Nodes: "+data.length;
  const lastTs = Math.max(...data.map(x=>x.ts||0));
  document.getElementById("lastBadge").innerHTML="Letzte Node-Meldung: "+(lastTs>0?new Date(lastTs*1000).toLocaleString("de-DE"):"—");

  // Marker erneuern
  __state.markers.forEach(m=>m.remove&&m.remove());
  __state.markers = drawMarkers(data);
}

refreshMapSafe();
setInterval(refreshMapSafe,45000);
</script>
</body>
</html>
