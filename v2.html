<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>WALDSENSOR.SH – Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#f6f8fb; --ink:#0d1b2a; --muted:#64748b; --ok:#e6f4ea; --ok-ink:#166534;
      --card:#fff; --radius:16px; --shadow:0 6px 30px -18px rgba(0,0,0,.25), 0 1px 0 rgba(0,0,0,.06);
      --accent:#0b6b61;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif}
    #map{position:absolute; inset:64px 0 0 0}

    /* Top bar */
    .topbar{position:fixed; inset:0 0 auto 0; height:64px; background:#063e39; color:#fff;
      display:flex; align-items:center; gap:14px; padding:10px 14px; z-index:1000}
    .brand{font-weight:900; letter-spacing:.2px}
    .spacer{flex:1}

    /* Badges */
    .badge{background:var(--card); color:var(--ink); border-radius:16px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; justify-content:center; padding:10px 14px; min-width:210px}
    .badge h4{margin:0 0 6px; font-size:14px; color:var(--muted); font-weight:800}
    .badge .big{font-size:24px; font-weight:900}
    .badge.small{min-width:auto; padding:8px 12px}
    .badge.small .big{font-size:14px; font-weight:800}
    .row{position:fixed; display:flex; gap:12px; z-index:900}
    .row.left{top:76px; left:10px}
    .row.center{top:76px; left:50%; transform:translateX(-50%)}
    .row.right{top:76px; right:10px; max-width:46vw}

    /* Link-Stil */
    a.clean{color:#0b6b61; text-decoration:none; font-weight:700}
    a.clean:hover{text-decoration:underline}

    /* Popup (Leaflet) feinjustieren */
    .leaflet-popup-content{margin:10px 12px; line-height:1.25}
    .popup-head{font-weight:800; margin-bottom:6px}
    .popup-grid{font-size:13px; color:var(--muted)}
    .popup-grid b{color:var(--ink)}
  </style>
</head>
<body>
  <div class="topbar">
    <a href="/index.html" class="clean" style="color:#fff;text-decoration:none;">← Zur Startseite</a>
    <div class="brand">Schulwaldsensor</div>
    <div class="spacer"></div>
    <div class="badge small"><div class="big" id="version">v0.14.1 · ZDL</div></div>
  </div>

  <!-- Badges oben links / rechts -->
  <div class="row left">
    <div class="badge">
      <h4>Aktive Sensoren</h4>
      <div class="big" id="nodesCount">—</div>
    </div>
    <div class="badge">
      <h4>Stand</h4>
      <div class="big" id="standNow">—</div>
    </div>
  </div>
  <div class="row right">
    <div class="badge" style="min-width:360px;">
      <h4><b>Letzte Node-Meldung</b></h4>
      <div class="big"><span id="lastNode">—</span></div>
      <div style="font-size:14px; color:var(--muted)"><span id="lastTs">—</span> · <span id="lastAgo">—</span></div>
    </div>
  </div>

  <div id="map"></div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    // ---------- kleine Helfer ----------
    const $ = id => document.getElementById(id);
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const deDate = ts => {
      if(!ts) return "—";
      const d = new Date(ts);
      if(isNaN(d)) return "—";
      return d.toLocaleString("de-DE");
    };
    const ago = ts => {
      if(!ts) return "—";
      const t = new Date(ts).getTime();
      if(!isFinite(t)) return "—";
      const s = Math.max(0, Math.floor((Date.now()-t)/1000));
      if(s<60) return `${s}s`;
      const m = Math.floor(s/60);
      if(m<60) return `vor ${m} min`;
      const h = Math.floor(m/60);
      return `vor ${h} h`;
    };

    // ---------- Map ----------
    const map = L.map('map',{attributionControl:true}).setView([54.40, 9.75], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    function renderMarkers(list){
      // komplette Schicht neu aufbauen – aber Erst NACH erfolgreichem Fetch!
      const layer = L.layerGroup();
      list.forEach(rec=>{
        const lat = rec.fields?.lat ?? rec.lat;
        const lon = rec.fields?.lon ?? rec.lon;
        if(typeof lat !== "number" || typeof lon !== "number") return;
        const m = L.marker([lat,lon]);
        const t = rec.fields || {};
        const temp = (t.TempC_SHT ?? t.TempC_SHT31);
        const hum  = (t.Hum_SHT ?? t.Hum_SHT31);
        const bat  = (t.BatV ?? t.bat ?? null);

        const lines = [];
        lines.push(`<div class="popup-head">Sensor: <b>${rec.id}</b></div>`);
        lines.push(`<div class="popup-grid">Zuletzt aktiv: <b>${deDate(rec.ts || rec.time)}</b></div>`);
        if(bat!=null) lines.push(`<div class="popup-grid">Batterie: <b>${Number(bat).toFixed(3)} V</b></div>`);
        if(hum!=null) lines.push(`<div class="popup-grid">Luftfeuchte: <b>${Number(hum).toFixed(1)}%</b></div>`);
        if(temp!=null) lines.push(`<div class="popup-grid">Temperatur: <b>${Number(temp).toFixed(1)} °C</b></div>`);
        lines.push(`<div style="margin-top:6px;"><a class="clean" href="/html/sensor.html?node=${encodeURIComponent(rec.id)}">Statistik öffnen ↗</a></div>`);
        m.bindPopup(lines.join(""));
        layer.addLayer(m);
      });
      // vorhandene Marker austauschen (kein Flackern)
      map.removeLayer(markersLayer);
      markersLayer = layer.addTo(map);
    }

    // ---------- Daten laden – robust ----------
    const DATA_URL = "/data/v2/latest/all.json";
    let lastGood = null;     // zuletzt gute Daten (werden bei Fehler NICHT überschrieben)

    async function fetchLatest(){
      const ctrl = new AbortController();
      const to = setTimeout(()=>ctrl.abort(), 8000);
      try{
        const r = await fetch(DATA_URL,{cache:"no-store",signal:ctrl.signal});
        clearTimeout(to);
        if(!r.ok) throw new Error("HTTP "+r.status);
        const arr = await r.json();
        if(!Array.isArray(arr) || arr.length===0) throw new Error("empty array");
        // Minimale Plausibilität: muss id + ts haben
        const sane = arr.filter(x => x && x.id && (x.ts||x.time));
        if(sane.length===0) throw new Error("no sane records");
        lastGood = sane;                         // nur jetzt ersetzen
        updateUI(sane);
      }catch(e){
        console.warn("fetchLatest: fallback to lastGood:", e.message||e);
        if(lastGood) updateUI(lastGood);        // Stale zeigen
        // sonst: UI nicht anrühren (kein Leeren!)
      }
    }

    function updateUI(list){
      // 1) Badges links
      $("nodesCount").textContent = list.length;
      $("standNow").textContent = deDate(Date.now());

      // 2) Letzte Node-Meldung (max ts)
      let last = null;
      for(const it of list){
        const t = new Date(it.ts||it.time).getTime();
        if(!isFinite(t)) continue;
        if(!last || t > last.t){ last = {id:it.id, t, ts:(it.ts||it.time)}; }
      }
      if(last){
        $("lastNode").textContent = last.id;
        $("lastTs").textContent   = deDate(last.ts);
        $("lastAgo").textContent  = ago(last.ts);
      }

      // 3) Marker rendern
      renderMarkers(list);
    }

    // initial & Polling
    (async ()=>{
      await fetchLatest();
      // alle 60s versuchen – UI wird nur bei „guten“ Daten aktualisiert
      setInterval(fetchLatest, 60000);
    })();
  </script>
</body>
</html>
