
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (v06)</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* v06 */
    :root{
      --ink:#1f2937; --muted:#6b7280; --green:#065f46; --greenbg:#e6f9ef;
      --blue:#1d4ed8; --badge:#ffffff; --badge-shadow:0 8px 22px rgba(0,0,0,.12);
      --radius:16px
    }
    html,body{height:100%;margin:0}
    #map{height:100%;width:100%}

    .badge{
      position:fixed; z-index:999; background:var(--badge); color:var(--ink);
      padding:12px 16px; border-radius:999px; box-shadow:var(--badge-shadow);
      font:600 15px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif
    }
    .badge small{color:var(--muted);font-weight:700}
    .badge-left{top:18px;left:18px}
    .badge-right{top:18px;right:18px}

    .leaflet-popup-content{margin:14px 18px}
    .popup h3{
      margin:0 0 8px; font:800 26px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      color:#0f172a
    }
    .kv{display:grid;grid-template-columns:auto 1fr;gap:8px 18px;margin:8px 0 14px}
    .k{color:#334155;font-weight:700}
    .v{color:#0f172a;font-weight:800}
    .hr{height:1px;background:#e5e7eb;margin:10px 0 14px}
    .qr-wrap{display:flex;align-items:center;gap:14px}
    .qr{width:128px;height:128px;border-radius:12px;overflow:hidden}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;min-width:220px;
      background:#e8f0fe;color:#0b3dd9;font:800 20px/1.15 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue",sans-serif;
      padding:16px 18px;border-radius:14px;text-decoration:none;border:2px solid #cfe0ff
    }
    .foot{margin-top:10px;color:#475569;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  </style>
  <!-- v06 -->
</head>
<body>
  <div class="badge badge-left" id="badgel">
    <small>Letzte Aktualisierung:</small> &nbsp;<span id="lastUpd">–</span> &nbsp;•&nbsp; <small>Nodes:</small> <span id="count">0</span>
  </div>
  <div class="badge badge-right" id="badger">
    <small>Letzte Node-Meldung:</small> &nbsp;<span id="lastNode">–</span>
  </div>

  <div id="map"></div>

  <script>
  // ===== Helpers (nur das Nötige, v06) =======================================
  const $ = (id)=>document.getElementById(id);
  const fmt = (n,d=1)=> (n==null||Number.isNaN(n)) ? "–" : Number(n).toFixed(d).replace(".",",");

  // se01/se01lb erkennen (auch mit Prefix wie bredstedt-, Suffix _se01lb)
  const isSoilNode = (id)=>/(^|[-_])se01(lb)?$/i.test(String(id||""));

  // Name hübsch: _ → -, Wörter groß
  const displayName = (id)=> String(id||"")
      .replace(/_/g,"-")
      .replace(/\b([a-z])/gi,m=>m.toUpperCase());

  const statLinkFor = (id)=> `/html/sensor.html?node=${encodeURIComponent(id)}`;

  // ===== Karte ===============================================================
  const map = L.map('map',{zoomControl:true}).setView([54.5,9.5], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // ===== Daten laden und Marker setzen ======================================
  async function loadAll(){
    const r = await fetch('/data/v2/latest/all.json',{cache:'no-store'});
    if(!r.ok) throw new Error('all.json nicht erreichbar: '+r.status);
    const arr = await r.json();

    // Nur Einträge mit Koordinaten
    const nodes = arr.filter(x => x && x.fields && typeof x.fields.lat==='number' && typeof x.fields.lon==='number');

    // Badges
    $('count').textContent = String(nodes.length);
    // Letzte Aktualisierung (größtes ts in all.json oder jetzt)
    const newest = nodes
      .map(n=>new Date(n.ts||0).getTime())
      .reduce((a,b)=>Math.max(a,b),0);
    $('lastUpd').textContent = newest ? new Date(newest).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '–';

    // Letzte Node-Meldung als „Datum, Uhrzeit — id“
    if(newest){
      const last = nodes.find(n=>new Date(n.ts||0).getTime()===newest) || null;
      const when = new Date(newest).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'});
      $('lastNode').textContent = last ? `${when} — ${last.id}` : when;
    }else{
      $('lastNode').textContent = '–';
    }

    // Marker

    // Werte je nach Node-Typ
    const soil = isSoilNode(n.id);
    const f = n.fields||{};
    let temp, hum, humLabel, bat;

    if (soil) {
      temp = f.temp_SOIL ?? f.soil_temp ?? f.temp_soil ?? null;
      hum  = f.water_SOIL ?? f.soil_water ?? f.SOILWater ?? f.water_soil ?? null;
      humLabel = "Bodenwasser";
    } else {
      temp = f.TempC_SHT ?? f.TempC_SHT31 ?? f.temp ?? null;
      hum  = f.Hum_SHT   ?? f.Hum_SHT31   ?? f.hum  ?? null;
      humLabel = "Luftfeuchte";
    }
    bat = f.BatV ?? f.battery ?? null;


      // Popup HTML
      const pretty = displayName(n.id);
      const html = `
        <div class="popup">
          <h3>Sensor: ${pretty}</h3>
          <div class="kv">
            <div class="k">Zuletzt aktiv</div>
            <div class="v">${n.ts ? new Date(n.ts).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '–'}</div>

            <div class="k">Koordinaten</div>
            <div class="v">${fmt(lat,5)},&nbsp;${fmt(lon,5)}</div>
          </div>

          <div class="hr"></div>

          <div class="kv">
            <div class="k">${soil?'Bodentemperatur':'Temperatur'}</div>
            <div class="v">${temp!=null ? fmt(temp,1)+' °C' : '–'}</div>

            <div class="k">${soil?'Bodenwasser':'Luftfeuchte'}</div>
            <div class="v">${hum!=null ? fmt(hum,1)+' %' : '–'}</div>

            <div class="k">Batterie</div>
            <div class="v">${bat!=null ? fmt(bat,3)+' V' : '–'}</div>
          </div>

          <div class="qr-wrap">
            <div class="qr" id="qr_${CSS.escape(n.id)}"></div>
            <a class="btn" href="${statLinkFor(n.id)}">Statistik öffnen</a>
          </div>

          <div class="foot">Link nutzt ID: ${n.id}</div>
        </div>
      `;

      m.bindPopup(html,{autoPan:true,autoPanPadding:[30,30],keepInView:true,closeButton:true,maxWidth:420});

      m.on('popupopen', (e)=>{
        // QR in vorhandenes Div malen
        const divId = `qr_${n.id}`;
        const el = document.getElementById(divId);
        if(el && !el.dataset.ok){
          try{
            new QRCode(el, { text: statLinkFor(n.id), width:128, height:128, correctLevel: QRCode.CorrectLevel.M });
            el.dataset.ok = "1";
          }catch{}
        }
        // Popup mittig ins Sichtfenster holen (leichter Offset nach oben)
        setTimeout(()=> {
          const ll = e.popup.getLatLng();
          map.panTo(ll,{animate:true,duration:0.25});
        }, 10);
      });
    });
  }

  loadAll().catch(err=>{
    console.error(err);
    $('lastUpd').textContent = 'Fehler';
  });
  </script>
</body>
</html>
