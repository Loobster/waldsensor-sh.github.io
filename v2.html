<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (V2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    .pill {
      position: fixed;
      z-index: 1001;
      top: 14px;
      left: 70px;
      background: #fff;
      color: #106e2a;
      padding: 8px 12px;
      border-radius: 12px;
      font: 600 14px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      border: 1px solid #e8e8e8;
    }
    .last-node {
      position: fixed;
      z-index: 1001;
      top: 14px;
      right: 14px;
      background: #e9f3ff;
      color: #0b4da2;
      padding: 8px 12px;
      border-radius: 12px;
      font: 600 14px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      border: 1px solid #d6e6ff;
      max-width: 42ch;
      text-align: right;
    }

    .leaflet-popup { z-index: 1002; }
    .popup { width:260px; font:500 14px/1.3 system-ui; }
    .popup h3{ margin:0 0 .25rem 0; font:700 16px/1.2 system-ui; }
    .popup hr{ border:0; height:1px; background:#ececec; margin:.5rem 0 .5rem; }
    .row{ display:flex; justify-content:space-between; margin:.2rem 0; }
    .row .label{ color:#555; }
    .row .value{ color:#0b4da2; font-weight:600; }
    .qrrow { display:flex; gap:10px; align-items:center; margin-top:6px; }
    .qrrow canvas{ width:80px!important; height:80px!important; }
    .openbtn {
      display:inline-block; padding:8px 12px; border-radius:10px;
      background:#eef4ff; color:#0b4da2; font:600 14px/1.2 system-ui;
      text-decoration:none; border:1px solid #d6e6ff;
    }
    .hint { color:#666; font:500 11px/1.3 system-ui; margin-top:4px; }
  </style>
</head>
<body>
  <div class="pill" id="stamp">Stand: –</div>
  <div class="last-node" id="last">Letzte Node-Meldung: –</div>
  <div id="map"></div>

  <script>
    const DATA_URL = "/data/v2/latest/all.json";
    const AUTO_REFRESH_MS = 60_000;

    const MANUAL_LOC = {
      "breklum":  [54.60669, 8.98195],
      "s31":      [54.65000, 8.96000],
      "se01":     [54.65005, 8.96005],
      "kropp":    [54.41018, 9.52839],
      "fahrdorf": [54.50158, 9.58690]
    };

    const OMIT_FIELDS = new Set(["ADC1_V","EXTI_Trigger","Door_status","lat","lon"]);
    const IGNORE_IDS = new Set(["lsn50"]);

    function normalizeId(s){
      return String(s||'')
        .toLowerCase()
        .replace(/\r|\s+/g,'')
        .replace(/^waldsensor[_-]/,'')
        .replace(/_/g,'-')
        .replace(/-(sn\d.*|lsn\d.*|v\d+|lb)$/,'');
    }
    function deTime(ts){
      try {
        return new Date(ts).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
      } catch(_){ return ts||"–"; }
    }
    function deNum(n,d=1){ return (typeof n==="number"&&Number.isFinite(n))? n.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d}):"–"; }
    function cleanFields(fields){
      const out={};
      for(const [k,v] of Object.entries(fields||{})){
        if(OMIT_FIELDS.has(k)) continue;
        if(v==null||v==="NULL"|| (typeof v==="number"&&!Number.isFinite(v))) continue;
        out[k]=v;
      }
      return out;
    }
    function pickCoord(item){
      const f=item?.fields||{};
      if(f.lat!==undefined&&f.lon!==undefined){
        const la=Number(f.lat), lo=Number(f.lon);
        if(Number.isFinite(la)&&Number.isFinite(lo)) return [la,lo];
      }
      const short=normalizeId(item.id);
      if(MANUAL_LOC[short]) return MANUAL_LOC[short];
      return null;
    }
    function popupHtml(item){
      const f=cleanFields(item.fields);
      const shortId=normalizeId(item.id);
      const temp=(typeof f.TempC_SHT31==="number")?f.TempC_SHT31:(typeof f.TempC_SHT==="number")?f.TempC_SHT:null;
      const hum =(typeof f.Hum_SHT31==="number")?f.Hum_SHT31:(typeof f.Hum_SHT==="number")?f.Hum_SHT:null;
      const bat =(typeof f.BatV==="number")?f.BatV:null;
      let html=`<div class="popup"><h3>${shortId}</h3>`;
      html+=`<div class="row"><span class="label">Zeit</span><span class="value">${deTime(item.ts)}</span></div><hr/>`;
      if(bat!==null) html+=`<div class="row"><span class="label">Batterie</span><span class="value">${deNum(bat,3)} V</span></div>`;
      if(hum!==null) html+=`<div class="row"><span class="label">Luftfeuchte</span><span class="value">${deNum(hum,1)} %</span></div>`;
      if(temp!==null) html+=`<div class="row"><span class="label">Temperatur</span><span class="value">${deNum(temp,1)} °C</span></div>`;
      html+=`<div class="qrrow"><div id="qrcode-${shortId}"></div><a class="openbtn" href="https://www.waldsensor.sh/html/sensor.html?node=${shortId}" target="_blank">Seite öffnen</a></div>`;
      html+=`<div class="hint">Link nutzt Basis-ID: <b>${shortId}</b></div></div>`;
      return html;
    }
    function latestRecord(data){
      let best=null, bestT=-Infinity;
      for(const r of(data||[])){ if(!r||!r.ts) continue; const t=new Date(r.ts).getTime(); if(!Number.isNaN(t)&&t>bestT){bestT=t; best=r;} }
      return best;
    }

    const map=L.map("map",{zoomSnap:0.25});
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'}).addTo(map);
    map.setView([54.4,9.6],8.25);
    const markers=L.layerGroup().addTo(map);

    let LAST_GOOD=null;
    function updateMap(raw){
      if(!raw||!Array.isArray(raw)){console.warn("no data");return;}
      LAST_GOOD=raw;
      markers.clearLayers();
      const bounds=[];
      for(const item of raw){
        const short=normalizeId(item.id);
        if(IGNORE_IDS.has(short)) continue;
        const coord=pickCoord(item);
        if(!coord) continue;
        const marker=L.marker(coord).bindPopup(popupHtml(item));
        marker.on("popupopen",()=>{
          const qrDiv=document.getElementById(`qrcode-${short}`);
          if(qrDiv&&!qrDiv.hasChildNodes()){
            QRCode.toCanvas(`https://www.waldsensor.sh/html/sensor.html?node=${short}`,{errorCorrectionLevel:'M',width:80},(err,canvas)=>{if(!err)qrDiv.appendChild(canvas);});
          }
        });
        marker.addTo(markers);
        bounds.push(coord);
      }
      if(bounds.length) map.fitBounds(L.latLngBounds(bounds).pad(0.12));
      document.getElementById("stamp").textContent="Stand: "+new Date().toLocaleString("de-DE");
      const lastEl=document.getElementById("last"); const lastRec=latestRecord(raw);
      lastEl.textContent=lastRec? "Letzte Node-Meldung: "+deTime(lastRec.ts)+" — "+normalizeId(lastRec.id):"Letzte Node-Meldung: –";
    }

    async function loadAndRender(){
      try{
        const res=await fetch(DATA_URL+"?t="+Date.now(),{cache:"no-store"});
        if(!res.ok) throw new Error("fetch failed "+res.status);
        const data=await res.json();
        updateMap(data);
      }catch(e){
        console.error(e);
        if(LAST_GOOD) updateMap(LAST_GOOD);
      }
    }
    loadAndRender();
    setInterval(loadAndRender,AUTO_REFRESH_MS);
  </script>
</body>
</html>
