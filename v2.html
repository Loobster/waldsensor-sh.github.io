<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>WALDSENSOR.SH – Karte v08</title>
  <!-- Version v08 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
    .custom-popup .leaflet-popup-content-wrapper {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      padding: 6px 8px;
      max-width: 260px;
      transform: scale(0.85);
    }
    .popup-title {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .popup-label {
      color: #555;
      font-size: 13px;
    }
    .popup-value {
      font-weight: bold;
      color: #000;
    }
    .qr-container { text-align:center; margin-top:6px; }
    .stats-btn {
      display:inline-block;
      background:#1E40AF;
      color:#fff;
      padding:5px 10px;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      margin-top:4px;
    }
    .stats-btn:hover { background:#2563EB; }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// ====== Helper ======
const $ = (s, r=document) => r.querySelector(s);
const fmtV  = (v, d=1) => (v==null || isNaN(v)) ? "—" : Number(v).toFixed(d).replace(".", ",");
const cap = (str) => str.split(/[-_]/).map(w => w.charAt(0).toUpperCase()+w.slice(1)).join("-");

// Id → „Soil-Node?“
const isSoilId = (id) => /(^|[-_])se01(lb)?$/i.test(id) || /_se01lb$/i.test(id);

// Feldauswahl je Node
function extractFields(entry){
  const f = entry.fields || {};
  if (isSoilId(entry.id) || ("temp_SOIL" in f) || ("water_SOIL" in f)){
    return {
      bat: f.BatV ?? null,
      temp: f.temp_SOIL ?? null,
      hum:  f.water_SOIL ?? null, // Bodenwasser (%)
      tempLabel: "Bodentemperatur",
      humLabel:  "Bodenfeuchte"
    };
  }
  return {
    bat: f.BatV ?? null,
    temp: f.TempC_SHT ?? f.TempC_SHT31 ?? null,
    hum:  f.Hum_SHT   ?? f.Hum_SHT31   ?? null,
    tempLabel: "Temperatur",
    humLabel:  "Luftfeuchte"
  };
}

// ====== Map ======
const map = L.map('map', { zoomControl: true }).setView([54.5, 9.7], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// Popup mittig halten
map.on('popupopen', (e)=> {
  // leicht nach oben versetzen, damit der Marker unterhalb sichtbar bleibt
  map.panTo(e.popup.getLatLng(), { animate:true });
});

// ====== Daten laden und Marker zeichnen ======
async function loadLatest(){
  const r = await fetch('/data/v2/latest/all.json', { cache: 'no-store' });
  if(!r.ok) throw new Error('latest/all.json nicht erreichbar');
  const arr = await r.json();
  return Array.isArray(arr) ? arr : [];
}

function buildPopupHTML(entry){
  const disp = cap(entry.id.replace(/_/g,'-'));
  const dt   = entry.ts ? new Date(entry.ts) : null;
  const { bat, temp, hum, tempLabel, humLabel } = extractFields(entry);

  const qrId = `qr_${entry.id.replace(/[^a-z0-9]/gi,'_')}_${Math.random().toString(36).slice(2,7)}`;
  const statsUrl = `/v2.html?stats=1&id=${encodeURIComponent(entry.id)}`;

  const html = `
    <div class="popup-title">Sensor: ${disp}</div>
    <div class="popup-label">Zuletzt aktiv</div>
    <div class="popup-value" style="margin-bottom:6px;">${dt ? dt.toLocaleDateString('de-DE',{day:'2-digit',month:'2-digit',year:'numeric'})+", "+dt.toLocaleTimeString('de-DE') : "—"}</div>
    <hr style="border:none;border-top:1px solid #e5e7eb;margin:6px 0;">
    <div class="popup-label">Batterie</div>
    <div class="popup-value" style="margin-bottom:6px;">${bat!=null? fmtV(bat,3)+' V' : '—'}</div>
    ${temp!=null || hum!=null ? `
      <div class="popup-label">${humLabel}</div>
      <div class="popup-value" style="margin-bottom:6px;">${hum!=null? fmtV(hum,1)+' %' : '—'}</div>
      <div class="popup-label">${tempLabel}</div>
      <div class="popup-value" style="margin-bottom:6px;">${temp!=null? fmtV(temp,1)+' °C' : '—'}</div>
    ` : ``}
    <div class="qr-container">
      <div id="${qrId}"></div>
      <a class="stats-btn" href="${statsUrl}">Statistik<br>öffnen</a>
    </div>
    <div class="popup-label" style="margin-top:6px;">Link nutzt ID: <span class="popup-value" style="font-weight:600">${entry.id}</span></div>
  `;
  return { html, qrId, statsUrl };
}

async function main(){
  try{
    const list = await loadLatest();

    list
      .filter(x => typeof x.lat === 'number' && typeof x.lon === 'number')
      .forEach((entry) => {
        const marker = L.marker([entry.lat, entry.lon]).addTo(map);

        const { html, qrId, statsUrl } = buildPopupHTML(entry);
        marker.bindPopup(html, { className: 'custom-popup', autoPan:true, keepInView:false });

        marker.on('popupopen', () => {
          const el = document.getElementById(qrId);
          if (el && !el.dataset.done){
            new QRCode(el, {
              text: statsUrl,
              width: 120, height: 120, correctLevel: QRCode.CorrectLevel.M
            });
            el.dataset.done = "1";
          }
        });
      });

  }catch(e){
    console.error(e);
    alert('Fehler beim Laden der Karte: '+ (e?.message || e));
  }
}

main();
</script>
</body>
</html>

<!-- bump 2025-09-28T11:06:19Z -->
