<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (V2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }
    .pill, .last-node {
      position: fixed; z-index: 1001; padding: 6px 10px;
      border-radius: 12px; font: 600 14px/1.3 system-ui, sans-serif;
      box-shadow: 0 2px 6px rgba(0,0,0,.15); background: #fff;
      border:1px solid #e0e0e0;
    }
    .pill { top:10px; left:60px; color:#106e2a; }
    .last-node { top:10px; right:10px; color:#0b4da2; }
    .leaflet-popup { z-index:1002; }
    .popup { width:260px; font:14px/1.3 system-ui,sans-serif; }
    .popup h3 { margin:0 0 4px; font:700 18px/1.2 system-ui; }
    .row { display:flex; justify-content:space-between; margin:2px 0; }
    .label { color:#555; font-weight:500; }
    .value { color:#0b4da2; font-weight:700; }
    .qrrow { display:flex; gap:10px; align-items:center; margin-top:6px; }
    .qrrow canvas { width:80px!important; height:80px!important; }
    .openbtn {
      display:inline-block; padding:8px 12px; border-radius:10px;
      background:#eef4ff; color:#0b4da2; font:600 14px system-ui;
      text-decoration:none; border:1px solid #d6e6ff;
    }
    .hint { color:#666; font:500 12px/1.3 system-ui; margin-top:4px; }
  </style>
</head>
<body>
  <div class="pill" id="stamp">Stand: –</div>
  <div class="last-node" id="last">Letzte Node-Meldung: –</div>
  <div id="map"></div>

  <script>
    const DATA_URL = "/data/v2/latest/all.json";
    const AUTO_REFRESH_MS = 60_000;
    const IGNORE_IDS = new Set(["lsn50"]);
    let LAST_GOOD_DATA = [];

    const MANUAL_LOC = {
      "breklum":[54.60669,8.98195],
      "kropp":[54.41018,9.52839],
      "fahrdorf":[54.50158,9.58690],
      "se01":[54.65005,8.96005],
      "s31":[54.65000,8.96000]
    };

    function normalizeId(s){
      return String(s||"").toLowerCase()
        .replace(/\s+/g,"").replace(/^waldsensor[_-]/,"")
        .replace(/_/g,"-").replace(/-(sn\d.*|lsn\d.*|v\d+|lb)$/,"");
    }
    function deTime(ts){
      try{
        return new Date(ts).toLocaleString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});
      }catch{ return ts||"–"; }
    }
    function deNum(n,d=1){
      return (typeof n==="number"&&Number.isFinite(n))
        ? n.toLocaleString("de-DE",{minimumFractionDigits:d,maximumFractionDigits:d})
        : "–";
    }
    function cleanFields(f){
      const out={}; for(const[k,v] of Object.entries(f||{})){
        if(v==null||v==="NULL") continue;
        if(typeof v==="number"&&!Number.isFinite(v)) continue;
        out[k]=v;
      } return out;
    }
    function pickCoord(item){
      const f=item?.fields||{};
      if(f.lat!=null&&f.lon!=null){
        const la=Number(f.lat), lo=Number(f.lon);
        if(Number.isFinite(la)&&Number.isFinite(lo)&&Math.abs(la)<=90&&Math.abs(lo)<=180)
          return [la,lo];
      }
      const short=normalizeId(item.id);
      return MANUAL_LOC[short]||null;
    }
    function popupHtml(item){
      const f=cleanFields(item.fields); const shortId=normalizeId(item.id);
      const temp=(f.TempC_SHT31??f.TempC_SHT); const hum=(f.Hum_SHT31??f.Hum_SHT);
      const bat=f.BatV??null;
      let html=`<div class="popup"><h3>${shortId}</h3>`;
      html+=`<div class="row"><span class="label">Zeit</span><span class="value">${deTime(item.ts)}</span></div><hr/>`;
      if(bat!==null) html+=`<div class="row"><span class="label">Batterie</span><span class="value">${deNum(bat,3)} V</span></div>`;
      if(hum!==undefined) html+=`<div class="row"><span class="label">Hum</span><span class="value">${deNum(hum,1)} %</span></div>`;
      if(temp!==undefined) html+=`<div class="row"><span class="label">Temp</span><span class="value">${deNum(temp,1)} °C</span></div>`;
      const url=`https://www.waldsensor.sh/html/sensor.html?node=${shortId}`;
      html+=`<div class="qrrow"><div id="qrcode-${shortId}"></div><a class="openbtn" href="${url}" target="_blank">Seite öffnen</a></div>`;
      html+=`<div class="hint">Link nutzt Basis-ID: <b>${shortId}</b></div></div>`;
      return html;
    }

    const map=L.map("map",{zoomSnap:0.25}).setView([54.4,9.6],8.25);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"&copy; <a href='https://www.openstreetmap.org/copyright'>OSM</a>"}).addTo(map);
    const markers={};

    function updateMap(data){
      const seen=new Set();
      for(const item of data){
        const id=normalizeId(item.id);
        if(!id||IGNORE_IDS.has(id)) continue;
        const coord=pickCoord(item); if(!coord) continue;
        seen.add(id);
        if(markers[id]){
          markers[id].setLatLng(coord).setPopupContent(popupHtml(item));
        } else {
          const m=L.marker(coord).bindPopup(popupHtml(item));
          m.on("popupopen",()=>{const qrDiv=document.getElementById(`qrcode-${id}`); if(qrDiv&&!qrDiv.hasChildNodes()){QRCode.toCanvas(`https://www.waldsensor.sh/html/sensor.html?node=${id}`,{width:80},(err,canvas)=>{if(!err)qrDiv.appendChild(canvas);});}});
          m.addTo(map); markers[id]=m;
        }
      }
      for(const id of Object.keys(markers)){
        if(!seen.has(id)){ map.removeLayer(markers[id]); delete markers[id]; }
      }
      document.getElementById("stamp").textContent="Stand: "+new Date().toLocaleTimeString("de-DE");
      const lastRec=data.reduce((a,b)=>!a||new Date(b.ts)>new Date(a.ts)?b:a,null);
      document.getElementById("last").textContent=lastRec?"Letzte Node-Meldung: "+deTime(lastRec.ts)+" — "+normalizeId(lastRec.id):"Letzte Node-Meldung: –";
    }

    async function run(){
      try{
        const res=await fetch(DATA_URL+"?t="+Date.now(),{cache:"no-store"});
        if(!res.ok) throw new Error("fetch "+res.status);
        const raw=await res.json();
        if(Array.isArray(raw)&&raw.length){ LAST_GOOD_DATA=raw; updateMap(raw); }
        else if(LAST_GOOD_DATA.length){ updateMap(LAST_GOOD_DATA); }
      }catch(e){ console.error(e); if(LAST_GOOD_DATA.length) updateMap(LAST_GOOD_DATA); }
    }
    run(); setInterval(run,AUTO_REFRESH_MS);
  </script>
</body>
</html>
