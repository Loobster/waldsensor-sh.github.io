<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDSENSOR.SH – Karte (V2)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <!-- (Optional) MarkerCluster – geladen wie bei dir, aktuell nicht genutzt -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    :root{
      --pill-bg:#fff;
      --pill-text:#106e2a;
      --pill-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    html, body { height:100%; margin:0; }
    #map { height:100%; width:100%; }

    .pill {
      position: fixed;
      z-index: 999;
      top: 14px;
      left: 70px;
      background: var(--pill-bg);
      color: var(--pill-text);
      padding: 10px 14px;
      border-radius: 14px;
      font: 600 18px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #e8e8e8;
    }

    .last-node {
      position: fixed;
      z-index: 999;
      top: 14px;
      right: 14px;
      background: #e9f3ff;
      color: #0b4da2;
      padding: 10px 14px;
      border-radius: 14px;
      font: 600 16px/1.2 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      box-shadow: var(--pill-shadow);
      border: 1px solid #d6e6ff;
      max-width: 42ch;
      text-align: right;
    }

    .popup h3{ margin:0 0 .25rem 0; font:700 20px/1.25 system-ui; }
    .popup hr{ border:0; height:1px; background:#ececec; margin:.5rem 0 .75rem; }
    .popup .kv{ margin:.15rem 0; }
    .popup .kv b{ font-weight:700; }

    .popup .actions{
      display:flex; align-items:center; gap:12px; margin-top:8px;
    }
    .popup .btn{
      display:inline-block; padding:10px 14px; border-radius:10px;
      border:1px solid #dfe4ea; background:#fff; text-decoration:none; font-weight:600; color:#0b4da2;
    }
    .popup .qr{ width:128px; height:128px; }
    .popup .hint{ margin-top:6px; color:#6b7280; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="pill" id="stamp">Letzte Aktualisierung: –</div>
  <div class="last-node" id="last">Letzte Node-Meldung: –</div>
  <div id="map"></div>

  <script>
    const DATA_URL = "/data/v2/latest/_all.json";
    const AUTO_REFRESH_MS = 60_000;

    // Manuelle Fallback-Positionen (wie bei dir – plus 5-m-Versatz: s31-lb minimal nach Osten)
    const MANUAL_LOC = {
      "breklum-sn50v3":  [54.60669, 8.98195],
      "s31-lb":          [54.65000, 8.960077],  // ~5 m Ost-Versatz
      "se01-lb":         [54.65000, 8.960000],
      "kropp-sn50v3":    [54.41018, 9.52839],
      "fahrdorf-sn50v3": [54.50158, 9.58690],
    };

    const OMIT_FIELDS = new Set(["ADC1_V","EXTI_Trigger","Door_status"]);

    const map = L.map("map", { zoomSnap: 0.25 });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
    }).addTo(map);
    map.setView([54.4, 9.6], 8.25);

    let markersLayer = L.layerGroup().addTo(map);

    // ---------- Helfer ----------
    function deTime(ts){
      try {
        return new Date(ts).toLocaleString("de-DE", {
          year:"numeric", month:"2-digit", day:"2-digit",
          hour:"2-digit", minute:"2-digit", second:"2-digit"
        });
      } catch(_){ return ts || "–"; }
    }

    function cleanFields(fields){
      const out = {};
      for (const [k,v] of Object.entries(fields || {})){
        if (OMIT_FIELDS.has(k)) continue;
        if (v === undefined || v === null || v === "NULL") continue;
        if (typeof v === "number" && v === 0) continue;
        out[k] = v;
      }
      return out;
    }

    // kleine Entzerrung für identische Koordinaten (ca. 5–8 m)
    const seenCoords = new Map(); // key "lat,lon" -> count
    function deOverlap(lat, lon, id){
      const key = `${lat.toFixed(6)},${lon.toFixed(6)}`;
      const n = (seenCoords.get(key) || 0) + 1;
      seenCoords.set(key, n);
      if (n === 1) return [lat, lon];

      // deterministischer kleiner Offset je ID+Index
      const seed = (id || "") + ":" + n;
      let h = 0; for (let i=0;i<seed.length;i++) h = ((h<<5)-h) + seed.charCodeAt(i) | 0;
      const angle = (h >>> 0) % 360;                 // 0..359
      const radius_m = 5 + ((h>>>9) % 3);            // 5..7 m
      const dLat = (radius_m / 111320) * Math.cos(angle*Math.PI/180);
      const dLon = (radius_m / (111320 * Math.cos(lat*Math.PI/180))) * Math.sin(angle*Math.PI/180);
      return [lat + dLat, lon + dLon];
    }

    function pickCoord(item){
      // 1) item.fields.lat/lon
      if (item?.fields && item.fields.lat != null && item.fields.lon != null) {
        const lat = Number(item.fields.lat), lon = Number(item.fields.lon);
        if (Number.isFinite(lat) && Number.isFinite(lon)) return deOverlap(lat, lon, item.id);
      }
      // 2) item.lat/lon
      if (item && item.lat != null && item.lon != null) {
        const lat = Number(item.lat), lon = Number(item.lon);
        if (Number.isFinite(lat) && Number.isFinite(lon)) return deOverlap(lat, lon, item.id);
      }
      // 3) Fallback manuell
      if (MANUAL_LOC[item?.id]) {
        const [lat, lon] = MANUAL_LOC[item.id];
        return deOverlap(Number(lat), Number(lon), item.id);
      }
      return null;
    }

    function baseId(id){
      if (!id) return "unbekannt";
      const i = id.indexOf("-");
      return i > 0 ? id.slice(0, i) : id;
    }

    function popupHtml(item){
      const f = cleanFields(item.fields);
      let html = `<div class="popup"><h3>${item.id || "unbekannt"}</h3>`;
      html += `<div class="kv">Zeit: <b>${deTime(item.ts)}</b></div><hr/>`;

      const temp = (typeof f.TempC_SHT31 === "number") ? f.TempC_SHT31
                  : (typeof f.TempC_SHT   === "number") ? f.TempC_SHT
                  : undefined;
      const hum  = (typeof f.Hum_SHT31   === "number") ? f.Hum_SHT31
                  : (typeof f.Hum_SHT     === "number") ? f.Hum_SHT
                  : undefined;

      if (temp !== undefined) html += `<div class="kv">Temp: <b>${temp.toFixed(1)} °C</b></div>`;
      if (hum  !== undefined) html += `<div class="kv">Feuchte: <b>${hum.toFixed(0)} %</b></div>`;
      if (typeof f.BatV === "number") html += `<div class="kv">Batterie: <b>${f.BatV.toFixed(2)} V</b></div>`;

      for (const [k,v] of Object.entries(f)){
        if (["TempC_SHT31","TempC_SHT","Hum_SHT31","Hum_SHT","BatV","lat","lon"].includes(k)) continue;
        html += `<div class="kv">${k}: <b>${v}</b></div>`;
      }

      const bid = baseId(item.id);
      const url = `https://www.waldsensor.sh/html/sensor.html?node=${encodeURIComponent(bid)}`;
      html += `<div class="actions">
        <a class="btn" href="${url}" target="_blank" rel="noopener">Seite öffnen</a>
        <div id="qr-${item.id}" class="qr"></div>
      </div>
      <div class="hint">Link nutzt Basis-ID: <code>${bid}</code></div>`;

      return html + `</div>`;
    }

    function latestRecord(data){
      let best = null, bestT = -Infinity;
      for (const r of (data||[])){
        if (!r || !r.ts) continue;
        const t = Date.parse(r.ts);
        if (Number.isFinite(t) && t > bestT){ bestT = t; best = r; }
      }
      return best;
    }

    async function loadData(){
      const url = `${DATA_URL}?t=${Date.now()}`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("fetch failed " + res.status);
      return res.json();
    }

    function render(data){
      seenCoords.clear();
      markersLayer.clearLayers();

      const bounds = [];
      for (const item of (data || [])){
        const coord = pickCoord(item);
        if (!coord) continue;

        const marker = L.marker(coord).bindPopup(popupHtml(item));
        marker.on("popupopen", () => {
          const qrDiv = document.getElementById(`qr-${item.id}`);
          if (qrDiv && !qrDiv.hasChildNodes()) {
            const bid = baseId(item.id);
            const url = `https://www.waldsensor.sh/html/sensor.html?node=${encodeURIComponent(bid)}`;
            QRCode.toCanvas(url, { errorCorrectionLevel: 'M', width: 128 }, (err, canvas) => {
              if (!err) qrDiv.appendChild(canvas);
            });
          }
        });
        marker.addTo(markersLayer);
        bounds.push(coord);
      }
      if (bounds.length) map.fitBounds(L.latLngBounds(bounds).pad(0.12));

      // Stempel links
      document.getElementById("stamp").textContent =
        "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");

      // Neueste Meldung rechts
      const lastEl = document.getElementById("last");
      const lastRec = latestRecord(data);
      if (lastRec){
        lastEl.textContent = "Letzte Node-Meldung: " + deTime(lastRec.ts) + " – " + baseId(lastRec.id);
      } else {
        lastEl.textContent = "Letzte Node-Meldung: –";
      }
    }

    async function run(){
      try{ render(await loadData()); }
      catch(err){
        console.error(err);
        document.getElementById("stamp").textContent =
          "Letzte Aktualisierung: " + new Date().toLocaleTimeString("de-DE");
      }
    }

    run();
    setInterval(run, AUTO_REFRESH_MS);
  </script>
</body>
</html>
