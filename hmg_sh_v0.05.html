<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>HMG SH v0.05 ‚Äì Reichweitenkarte</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="../data/gateways_SH_NETZ.js"></script>
<script src="../data/sh_outline.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
html, body { height: 100%; margin: 0; }
#map { width: 100%; height: 100%; }
.info {
    padding: 6px 8px;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}
.legend { line-height: 18px; }
.legend i {
    width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7;
}
</style>
</head>

<body>

<div id="map"></div>

<script>

// Basiskarte
var map = L.map('map').setView([54.5, 9.5], 8);

// Hintergrundlayer
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OSM contributors'
}).addTo(map);

// Marker Layer: Gateways
var gwLayer = L.layerGroup();

gateways.features.forEach(function(gw) {
    var icon = L.icon({
        iconUrl: '../icons/gateway.png',
        iconSize: [28, 28]
    });

    L.marker([gw.geometry.coordinates[1], gw.geometry.coordinates[0]], {icon: icon})
        .bindPopup("<b>Gateway:</b> " + gw.properties.name + "<br>H√∂he: " + gw.properties.alt + " m")
        .addTo(gwLayer);
});

// Kontrollfeld rechts oben
var overlays = {
    "Gateways": gwLayer
};

L.control.layers({}, overlays, {collapsed: true}).addTo(map);

// Score Pane (nicht interaktiv)
map.createPane('scorePane');
map.getPane('scorePane').style.pointerEvents = 'none';

var lastCircle = null;

// Klickfunktion
map.on('click', function(e) {

    // SH-Grenzen pr√ºfen
    const lonlat = [e.latlng.lng, e.latlng.lat];

    if (!turf.booleanPointInPolygon(lonlat, sh_outline)) {
        L.popup()
          .setLatLng(e.latlng)
          .setContent("üìç Au√üerhalb von Schleswig-Holstein.")
          .openOn(map);
        return;
    }

    // N√§chsten Gateway finden
    var minDist = Infinity;
    var nearestGW = null;

    gateways.features.forEach(function(gw) {
        var gwLat = gw.geometry.coordinates[1];
        var gwLon = gw.geometry.coordinates[0];

        var dist = map.distance([e.latlng.lat, e.latlng.lng], [gwLat, gwLon]);
        if (dist < minDist) {
            minDist = dist;
            nearestGW = gw;
        }
    });

    // Distanz in km
    var distKm = (minDist / 1000).toFixed(2);

    // Bewertung
    var scoreColor = "#d73027";
    var scoreText = "schwach";

    if (distKm <= 6) { scoreColor = "#1a9850"; scoreText = "gut"; }
    else if (distKm <= 10) { scoreColor = "#fee08b"; scoreText = "ok"; }

    // Kreis aktualisieren
    if (lastCircle) lastCircle.remove();

    lastCircle = L.circle(e.latlng, {
        radius: 1000,
        color: scoreColor,
        fillColor: scoreColor,
        fillOpacity: 0.35,
        pane: 'scorePane'
    }).addTo(map);

    // Popup anzeigen
    L.popup()
        .setLatLng(e.latlng)
        .setContent(
            "<b>üìç Potenzieller Sensor-Standort</b><br>" +
            "Entfernung zum n√§chsten Gateway: <b>" + distKm + " km</b><br>" +
            "Bewertung: <b>" + scoreText + "</b><br>" +
            "Gateway: " + nearestGW.properties.name
        )
        .openOn(map);
});

// Legende
var legend = L.control({position: 'bottomright'});

legend.onAdd = function () {
    var div = L.DomUtil.create('div', 'info legend');
    div.innerHTML =
        '<i style="background:#1a9850"></i> gut<br>' +
        '<i style="background:#fee08b"></i> ok<br>' +
        '<i style="background:#d73027"></i> schwach<br>';
    return div;
};

legend.addTo(map);

</script>

</body>
</html>
