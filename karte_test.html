<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Waldsensor SH – Testkarte mit Blinken</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .blinking-marker {
      animation: blinker 1s linear infinite;
    }
    @keyframes blinker {
      50% { opacity: 0.2; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="scripts/oms.min.js"></script>

  <script>
    const map = L.map("map").setView([54.5, 9.0], 9);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>',
    }).addTo(map);

    const oms = new OverlappingMarkerSpiderfier(map);
    const gatewayInfo = {};

    fetch("data/gateways.json")
      .then(res => res.json())
      .then(gws => {
        gws.forEach(gw => gatewayInfo[gw.id] = gw);
        loadData();
        setInterval(loadData, 60000);
      });

    function loadData() {
      const files = ["s31-lb", "se01-lb", "testsensor-Fahrdorf"].map(id => `data/${id}.json`);
      const now = new Date();

      files.forEach(url => {
        fetch(url)
          .then(res => res.json())
          .then(data => {
            const { node, time, gateways } = data;
            const payloadTime = new Date(time);
            const diff = now - payloadTime;
            if (diff > 10 * 60 * 1000) return;

            const nodePos = gateways[0]; // Position vom Node (nicht GW!)
            const nodeLatLng = [nodePos.lat, nodePos.lon];

            const popup = `<b>Sensor ${node}</b><br>Letzte Übertragung: ${payloadTime.toLocaleString()}`;
            const nodeMarker = L.marker(nodeLatLng).bindPopup(popup).addTo(map);
            oms.addMarker(nodeMarker);

            // Blinke die Gateways, die diesen Node empfangen haben
            gateways.forEach(gw => {
              const gwMeta = gatewayInfo[gw.id];
              if (!gwMeta) return;
              const gwMarker = L.circleMarker([gwMeta.lat, gwMeta.lon], {
                radius: 8,
                color: "red",
                className: "blinking-marker"
              }).bindPopup(`<b>Gateway:</b> ${gwMeta.name || gw.id}`).addTo(map);

              setTimeout(() => map.removeLayer(gwMarker), 3000);
            });
          });
      });
    }
  </script>
</body>
</html>
