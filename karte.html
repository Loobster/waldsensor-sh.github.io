<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>WALDSENSOR.SH ‚Äì Live-Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100vh; width: 100%; }
    .blink {
      animation: blinker 1s ease-in-out 3;
    }
    @keyframes blinker {
      50% { opacity: 0.2; }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    console.log("üöÄ Karte geladen");

    const map = L.map('map').setView([54.5, 9.0], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let nodeMarkers = {};
    let gwMarkers = {};
    let connectionLines = [];

    async function loadDataAndUpdateMap() {
      // Alte Linien l√∂schen
      connectionLines.forEach(line => map.removeLayer(line));
      connectionLines = [];

      // Gateways laden
      const gateways = await fetch('data/gateways.json').then(r => r.json());

      // Nodes laden
      const nodes = await fetch('data/nodes.json').then(r => r.json());

      for (const node of nodes) {
        const nodeId = node.id;

        // Node-Marker setzen (einmalig)
        if (!nodeMarkers[nodeId]) {
          const marker = L.marker([node.lat, node.lon], { title: node.name });
          marker.bindPopup(`<strong>${node.name}</strong><br>ID: ${nodeId}`);
          marker.addTo(map);
          nodeMarkers[nodeId] = marker;
        }

        // Sensor-JSON laden
        try {
          const res = await fetch(`data/${nodeId}.json`);
          if (!res.ok) continue;
          const data = await res.json();

          // Gateways visualisieren
          data.gateways.forEach(gw => {
            const gwData = gateways[gw.id];
            if (!gwData || !gwData.lat || !gwData.lon) return;

            // Marker neu oder aktualisieren
            let gwMarker = gwMarkers[gw.id];
            if (!gwMarker) {
              gwMarker = L.circleMarker([gwData.lat, gwData.lon], {
                radius: 6,
                color: 'red',
                fillOpacity: 0.8
              }).addTo(map);
              gwMarkers[gw.id] = gwMarker;
            }

            // Popup + Blinken
            gwMarker.setStyle({ color: 'red' });
            gwMarker.bindPopup(`
              <strong>Gateway:</strong> ${gwData.name}<br>
              <strong>ID:</strong> ${gw.id}<br>
              RSSI: ${gw.rssi ?? "?"} dBm<br>
              SNR: ${gw.snr ?? "?"} dB
            `);
            gwMarker._path.classList.add('blink');

            // Linie vom Node zum Gateway
            const line = L.polyline([[node.lat, node.lon], [gwData.lat, gwData.lon]], {
              color: 'red',
              weight: 1,
              dashArray: '5, 5'
            }).addTo(map);
            connectionLines.push(line);
          });
        } catch (err) {
          console.warn(`‚ö†Ô∏è Fehler beim Laden von ${nodeId}.json:`, err);
        }
      }
    }

    // Initialer Aufruf
    loadDataAndUpdateMap();

    // Automatisch alle 30 Sekunden
    setInterval(loadDataAndUpdateMap, 30000);
  </script>
</body>
</html>
